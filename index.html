<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fff9f9">
    <meta name="version" content="1.9.0">
    <meta name="build-date" content="2026-01-13 13:30">
    <title>üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; 
            background: #ffffff; 
            color: #1a1a1a; 
            line-height: 1.6; 
            user-select: none; 
            -webkit-user-select: none; 
            caret-color: transparent;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: contain;
        }
        input, textarea, select { user-select: text; -webkit-user-select: text; caret-color: auto; }
        
        
        .newyear-title {
            display: inline-flex;
            align-items: center;
            position: relative;
            padding: 8px 12px;
            background: linear-gradient(135deg, #fff9f9 0%, #ffe4e6 25%, #fff1f2 50%, #ffe4e6 75%, #fff9f9 100%);
            background-size: 200% 200%;
            animation: gradientShift 4s ease-in-out infinite;
            border-radius: 14px;
            box-shadow: 
                0 0 15px rgba(244, 114, 182, 0.3),
                0 0 30px rgba(251, 113, 133, 0.15),
                0 4px 20px rgba(198, 40, 40, 0.2),
                inset 0 0 20px rgba(255,255,255,0.9);
            overflow: hidden;
            border: 2px solid transparent;
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .newyear-title::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #f472b6, #fb7185, #fda4af, #fb7185, #f472b6);
            background-size: 300% 300%;
            animation: borderGlow 3s ease-in-out infinite;
            border-radius: 16px;
            z-index: -1;
        }
        .newyear-title * {
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .newyear-title::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 30%, rgba(255,182,193,0.6) 2px, transparent 2px),
                radial-gradient(circle at 30% 70%, rgba(255,192,203,0.5) 1.5px, transparent 1.5px),
                radial-gradient(circle at 70% 25%, rgba(255,182,193,0.55) 2px, transparent 2px),
                radial-gradient(circle at 90% 65%, rgba(255,192,203,0.5) 1.5px, transparent 1.5px);
            animation: petalFloat 3s ease-in-out infinite;
            pointer-events: none;
        }
        
        .newyear-title .title-sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 6px #fff, 0 0 12px #ffc0cb;
            animation: sparkle 2s ease-in-out infinite;
            z-index: 3;
        }
        .newyear-title .title-sparkle:nth-child(1) { top: 15%; left: 8%; animation-delay: 0s; }
        .newyear-title .title-sparkle:nth-child(2) { top: 70%; left: 25%; animation-delay: 0.7s; }
        .newyear-title .title-sparkle:nth-child(3) { top: 25%; right: 15%; animation-delay: 1.4s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        .newyear-title .title-svg {
            height: 36px;
            width: auto;
            position: relative;
            z-index: 2;
        }
        .newyear-title .title-svg .plum-left,
        .newyear-title .title-svg .plum-right {
            animation: plumSway 2.5s ease-in-out infinite;
            transform-origin: left bottom;
        }
        .newyear-title .title-svg .plum-right {
            animation-delay: 0.5s;
            transform-origin: right bottom;
        }
        @keyframes plumSway {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.02); }
            75% { transform: rotate(2deg) scale(1.02); }
        }
        
        
        .guild-select-title {
            text-align: center;
            margin-bottom: 40px;
        }
        .guild-select-title .newyear-box {
            display: inline-flex;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, #fff9f9 0%, #ffe4e6 25%, #fff1f2 50%, #ffe4e6 75%, #fff9f9 100%);
            background-size: 200% 200%;
            animation: gradientShift 4s ease-in-out infinite;
            border-radius: 20px;
            box-shadow: 
                0 0 20px rgba(244, 114, 182, 0.4),
                0 0 40px rgba(251, 113, 133, 0.2),
                0 8px 32px rgba(198, 40, 40, 0.2),
                inset 0 0 30px rgba(255,255,255,0.9);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            background-clip: padding-box;
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .guild-select-title .newyear-box::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #f472b6, #fb7185, #fda4af, #fb7185, #f472b6);
            background-size: 300% 300%;
            animation: borderGlow 3s ease-in-out infinite;
            border-radius: 22px;
            z-index: -1;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; opacity: 0.7; }
            50% { background-position: 100% 50%; opacity: 1; }
        }
        .guild-select-title .newyear-box * {
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .guild-select-title .newyear-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,182,193,0.6) 4px, transparent 4px),
                radial-gradient(circle at 25% 70%, rgba(255,192,203,0.5) 3px, transparent 3px),
                radial-gradient(circle at 75% 25%, rgba(255,182,193,0.55) 3.5px, transparent 3.5px),
                radial-gradient(circle at 90% 75%, rgba(255,192,203,0.5) 3px, transparent 3px),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8) 2px, transparent 2px);
            animation: petalFloat 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes petalFloat {
            0%, 100% { opacity: 0.6; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-5px) scale(1.1); }
        }
        
        
        .guild-select-title .petal-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        .guild-select-title .falling-petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(ellipse at center, #ffc0cb 0%, #ffb6c1 50%, transparent 70%);
            border-radius: 50% 0 50% 50%;
            opacity: 0;
            animation: petalFall 4s ease-in-out infinite;
        }
        .guild-select-title .falling-petal:nth-child(1) { left: 10%; animation-delay: 0s; }
        .guild-select-title .falling-petal:nth-child(2) { left: 25%; animation-delay: 0.8s; }
        .guild-select-title .falling-petal:nth-child(3) { left: 40%; animation-delay: 1.6s; }
        .guild-select-title .falling-petal:nth-child(4) { left: 55%; animation-delay: 2.4s; }
        .guild-select-title .falling-petal:nth-child(5) { left: 70%; animation-delay: 3.2s; }
        .guild-select-title .falling-petal:nth-child(6) { left: 85%; animation-delay: 0.4s; }
        @keyframes petalFall {
            0% { top: -10px; opacity: 0; transform: rotate(0deg) translateX(0); }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { top: 100%; opacity: 0; transform: rotate(360deg) translateX(20px); }
        }
        
        
        .guild-select-title .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #ffc0cb, 0 0 30px #ff69b4;
            animation: sparkle 2s ease-in-out infinite;
        }
        .guild-select-title .sparkle:nth-child(1) { top: 20%; left: 15%; animation-delay: 0s; }
        .guild-select-title .sparkle:nth-child(2) { top: 70%; left: 30%; animation-delay: 0.5s; }
        .guild-select-title .sparkle:nth-child(3) { top: 30%; right: 20%; animation-delay: 1s; }
        .guild-select-title .sparkle:nth-child(4) { top: 60%; right: 10%; animation-delay: 1.5s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .guild-select-title .select-title-svg {
            height: 60px;
            width: auto;
            position: relative;
            z-index: 2;
        }
        .guild-select-title .select-title-svg .plum-left,
        .guild-select-title .select-title-svg .plum-right {
            animation: plumBlossom 3s ease-in-out infinite;
            transform-origin: left bottom;
        }
        .guild-select-title .select-title-svg .plum-right {
            animation-delay: 0.5s;
            transform-origin: right bottom;
        }
        @keyframes plumBlossom {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.03); }
            75% { transform: rotate(2deg) scale(1.03); }
        }
        
        .lock-banner { background: #ef4444; color: white; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; display: none; animation: slideDown 0.3s ease; }
        .lock-banner.active { display: block; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .top-bar { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid #e5e7eb; padding: 16px 24px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .top-bar h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
        .top-actions { display: flex; gap: 12px; align-items: center; }
        .search-input { padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; width: 180px; transition: all 0.2s; background: #f9fafb; }
        .search-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn-common { padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .btn-user-add { background: #3b82f6; color: white; font-weight: 600; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .btn-user-add:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-user-add.disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .btn-excel { background: #10b981; color: white; }
        .btn-admin { background: #1f2937; color: white; position: relative; }
        .btn-admin.logged-in { background: #4b5563; cursor: default; }
        .btn-log { background: #f59e0b; color: white; }
        .btn-manage { background: #6366f1; color: white; }
        .btn-guild-add { background: #8b5cf6; color: white; }
        .btn-lock { background: #ef4444; color: white; }
        .btn-bulk { background: #db2777; color: white; }
        .btn-bulk:hover { background: #be185d; }
        .btn-approve { background: #059669; color: white; }
        .btn-approve:hover { background: #047857; }
        .btn-rename { background: #8b5cf6; color: white; }
        .btn-rename:hover { background: #7c3aed; }
        .btn-reset-pw { padding: 4px 8px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-reset-pw:hover { background: #dc2626; }
        
        
        .pending-badge { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; }

        
        .guild-select-container { max-width: 1200px; margin: 0 auto; padding: 60px 24px; }
        .guild-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .guild-btn { background: #ffffff; border: 2px solid #e5e7eb; border-radius: 16px; padding: 30px 24px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 16px; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .guild-btn * { user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .guild-btn:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15); }
        .guild-btn:active { transform: translateY(-2px); }
        .guild-btn-badge { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
        .guild-btn:nth-child(4n+1) .guild-btn-badge { background: #3b82f6; }
        .guild-btn:nth-child(4n+2) .guild-btn-badge { background: #10b981; }
        .guild-btn:nth-child(4n+3) .guild-btn-badge { background: #f59e0b; }
        .guild-btn:nth-child(4n+4) .guild-btn-badge { background: #ef4444; }
        .guild-btn-info { flex: 1; }
        .guild-btn-name { font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .guild-btn-count { font-size: 14px; color: #6b7280; }
        .guild-btn-arrow { font-size: 24px; color: #9ca3af; transition: transform 0.3s; }
        .guild-btn:hover .guild-btn-arrow { transform: translateX(4px); color: #3b82f6; }

        
        .admin-dropdown { position: relative; display: none; }
        .admin-dropdown.active { display: inline-block; }
        .admin-dropdown-btn { 
            display: flex; align-items: center; gap: 6px;
            padding: 10px 16px; border-radius: 8px; border: none;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .admin-dropdown-btn::after { content: '‚ñº'; font-size: 10px; margin-left: 4px; transition: transform 0.2s; }
        .admin-dropdown:hover .admin-dropdown-btn::after, 
        .admin-dropdown:focus-within .admin-dropdown-btn::after { transform: rotate(180deg); }
        .admin-dropdown-menu {
            position: absolute; top: 100%; left: 0; margin-top: 4px;
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 180px;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.2s; z-index: 100;
        }
        .admin-dropdown:hover .admin-dropdown-menu,
        .admin-dropdown:focus-within .admin-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .admin-dropdown-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; cursor: pointer; transition: background 0.15s;
            border: none; background: none; width: 100%; text-align: left;
            font-size: 13px; color: #374151;
        }
        .admin-dropdown-item:first-child { border-radius: 12px 12px 0 0; }
        .admin-dropdown-item:last-child { border-radius: 0 0 12px 12px; }
        .admin-dropdown-item:hover { background: #f3f4f6; }
        .admin-dropdown-item.danger { color: #dc2626; }
        .admin-dropdown-item.danger:hover { background: #fef2f2; }
        .admin-dropdown-divider { height: 1px; background: #e5e7eb; margin: 4px 0; }
        
        .dropdown-member { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .dropdown-member:hover { background: linear-gradient(135deg, #2563eb, #1e40af); }
        .dropdown-guild { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .dropdown-guild:hover { background: linear-gradient(135deg, #059669, #047857); }
        .dropdown-data { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .dropdown-data:hover { background: linear-gradient(135deg, #d97706, #b45309); }
        .dropdown-system { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .dropdown-system:hover { background: linear-gradient(135deg, #7c3aed, #6d28d9); }

        
        .guild-detail-container { max-width: 900px; margin: 0 auto; padding: 40px 24px; display: none; }
        .guild-detail-container.active { display: block; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .back-btn:hover { background: #e5e7eb; }
        .guild-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .guild-detail-badge { width: 12px; height: 12px; border-radius: 50%; }
        .guild-detail-title { font-size: 24px; font-weight: 700; color: #111827; }
        .guild-detail-count { font-size: 14px; color: #6b7280; margin-left: auto; }

        .container { max-width: 1600px; margin: 0 auto; padding: 40px 24px; display: none; grid-template-columns: repeat(auto-fit, minmax(min(100%, 360px), 1fr)); gap: 24px; }
        .card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { border-color: #d1d5db; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; }
        .guild-badge { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: #9ca3af; }
        .card:nth-child(4n+1) .guild-badge { background: #3b82f6; }
        .card:nth-child(4n+2) .guild-badge { background: #10b981; }
        .card:nth-child(4n+3) .guild-badge { background: #f59e0b; }
        .card:nth-child(4n+4) .guild-badge { background: #ef4444; }
        .card-header h2 { font-size: 16px; font-weight: 600; color: #111827; letter-spacing: -0.3px; }
        .card-body { padding: 0; }
        .card-body table { width: 100%; border-collapse: collapse; }
        .card-body thead { background: #f9fafb; border-bottom: 1px solid #f3f4f6; }
        .card-body th { padding: 12px 16px; font-weight: 500; color: #6b7280; font-size: 13px; text-align: left; letter-spacing: 0.3px; }
        .card-body th:first-child { width: 60%; }
        .card-body th:last-child { width: 40%; text-align: right; padding-right: 20px; }
        .card-body td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; height: 60px; }
        .card-body td:first-child { overflow: visible; }
        .card-body td:last-child { text-align: right; width: 40%; padding-right: 20px; }
        .player-cell { display: flex; align-items: center; gap: 4px; flex-wrap: nowrap; }
        .card-body tbody tr { height: 60px; cursor: pointer; -webkit-tap-highlight-color: rgba(59, 130, 246, 0.1); }
        .card-body tbody tr:hover { background: #f0f9ff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-body tbody tr:active { background: #dbeafe; }
        .card-body tbody tr:last-child td { border-bottom: none; }
        .card-body tbody tr { border-bottom: 2px solid #e5e7eb; }
        .rank-number { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; font-size: 14px; font-weight: 700; margin-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .rank-number:hover { transform: scale(1.05); }
        tbody tr:nth-child(1) .rank-number { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #92400e; box-shadow: 0 4px 6px rgba(255,215,0,0.4); }
        tbody tr:nth-child(2) .rank-number { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #57534e; box-shadow: 0 4px 6px rgba(192,192,192,0.4); }
        tbody tr:nth-child(3) .rank-number { background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); color: #78350f; box-shadow: 0 4px 6px rgba(205,127,50,0.4); }
        tbody tr:nth-child(n+4) .rank-number { background: #f3f4f6; color: #374151; font-weight: 600; }
        .player-name { 
            font-weight: 500; 
            color: #111827; 
            cursor: pointer; 
            padding: 6px 10px; 
            border-radius: 6px; 
            transition: all 0.2s; 
            display: inline-block; 
            vertical-align: middle;
            user-select: none;
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.1);
        }
        .player-name:hover { 
            background: #e0e7ff; 
            color: #2563eb; 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-name:active {
            transform: translateY(0);
            background: #c7d2fe;
        }
        .power-value { font-weight: 600; color: #3b82f6; cursor: pointer; transition: all 0.15s ease; padding: 6px 12px; border-radius: 6px; display: inline-block; }
        .power-value:hover { background: #eff6ff; color: #2563eb; }
        
        
        .power-value.blurred { 
            filter: blur(8px); 
            user-select: none; 
            pointer-events: none;
            color: #9ca3af;
        }
        .power-value.blurred:hover {
            background: transparent;
        }
        
        
        .spec-icons { font-size: 11px; margin-left: 2px; color: #666; display: inline-block; cursor: pointer; vertical-align: middle; flex-shrink: 0; white-space: nowrap; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; animation: fadeIn 0.2s ease; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal { background: #ffffff; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; max-height: calc(100vh - 40px); display: flex; flex-direction: column; animation: slideUp 0.3s ease; position: relative; margin: 20px auto; }
        .modal.modal-lg { max-width: 900px; }
        .modal-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border: none; background: #f3f4f6; border-radius: 50%; color: #6b7280; font-size: 24px; line-height: 1; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .modal-close-btn:hover { background: #e5e7eb; color: #374151; transform: rotate(90deg); }
        .modal-header { padding: 24px 24px 16px; border-bottom: 1px solid #f3f4f6; flex-shrink: 0; }
        .modal-header h3 { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .modal-header p { font-size: 14px; color: #6b7280; margin: 0; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; min-height: 0; }
        .table-scroll-container { max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; -webkit-overflow-scrolling: touch; }
        .common-table { width: 100%; font-size: 13px; table-layout: auto; border-collapse: collapse; }
        .common-table th { position: sticky; top: 0; background: #f3f4f6; text-align: center; padding: 12px 8px; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .common-table td { text-align: center; padding: 10px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .common-table tbody tr:hover { background: #f9fafb; }
        .common-table tbody tr:active { background: #f3f4f6; }
        
        .common-table.table-wide { min-width: 800px; }
        .common-table.table-wide td { white-space: nowrap; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; color: #111827; transition: all 0.15s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0; background: #ffffff; border-radius: 0 0 16px 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .btn-cancel { background: #f3f4f6; color: #6b7280; }
        .btn-cancel:hover { background: #e5e7eb; color: #374151; }
        .btn-primary { background: #3b82f6; color: #ffffff; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: #ffffff; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: #ffffff; }
        .btn-danger:hover { background: #dc2626; }
        .alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 40px 16px 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08); z-index: 2000; animation: alertPopIn 0.3s ease; max-width: 400px; min-width: 250px; }
        @keyframes alertPopIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .alert-close { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border: none; background: #f3f4f6; border-radius: 50%; color: #6b7280; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .alert-close:hover { background: #e5e7eb; color: #374151; }
        .alert-success { border-left: 4px solid #10b981; }
        .alert-error { border-left: 4px solid #ef4444; }
        .alert-title { font-weight: 600; color: #111827; margin-bottom: 4px; }
        .alert-message { font-size: 14px; color: #6b7280; margin: 0; }
        
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .checkbox-label { display: flex; align-items: center; font-size: 14px; cursor: pointer; background: #f3f4f6; padding: 8px 12px; border-radius: 6px; }
        .checkbox-label input { margin-right: 8px; }
        
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { background: #f9fafb; padding: 10px; border-radius: 8px; font-size: 14px; }
        .info-label { color: #6b7280; font-size: 12px; display: block; margin-bottom: 4px; }
        .info-val { font-weight: 600; color: #111827; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
        .badge-on { background: #dbeafe; color: #1e40af; }
        .badge-off { background: #f3f4f6; color: #9ca3af; }
        .spec-count { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 4px; background: #dbeafe; color: #1e40af; }
        .spec-count.zero { background: #f3f4f6; color: #9ca3af; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
        .spec-input-group { display: flex; flex-direction: column; }
        .spec-input-group label { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
        .form-input.small { padding: 8px 12px; font-size: 14px; }
        
        
        .time-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        @media (max-width: 768px) {
            .top-bar { padding: 14px 16px; flex-direction: column; align-items: flex-start; }
            .top-actions { width: 100%; flex-wrap: wrap; }
            .search-input { flex-grow: 1; width: auto; }
            .container { padding: 24px 16px; gap: 20px; }
            
            
            .modal-overlay { padding: 10px; align-items: flex-start; }
            .modal { 
                width: 95%; 
                max-height: calc(100vh - 20px);
                margin: 10px auto;
                border-radius: 12px;
            }
            .modal.modal-lg { 
                max-width: 95%; 
            }
            .modal-header { 
                padding: 20px 16px 12px; 
            }
            .modal-header h3 { 
                font-size: 16px; 
                padding-right: 30px; 
            }
            .modal-body { 
                padding: 16px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; 
            }
            .modal-footer { 
                padding: 12px 16px;
                flex-shrink: 0;
            }
            .modal-close-btn {
                top: 12px;
                right: 12px;
                width: 28px;
                height: 28px;
                font-size: 20px;
            }
            .table-scroll-container {
                max-height: 300px; 
            }
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            .form-group {
                margin-bottom: 16px; 
            }
            .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            
            td { 
                padding: 10px 12px; 
            }
            .player-name { 
                font-size: 13px;
            }
            .rank-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
                margin-right: 8px;
            }
            .spec-icons {
                font-size: 11px;
            }
            .power-value {
                font-size: 13px;
                padding: 4px 8px;
            }
            
            
            .guild-select-container { padding: 30px 16px; }
            .guild-select-title .newyear-box { padding: 10px 16px; }
            .guild-select-title .select-title-svg { height: 40px; }
            .newyear-title .title-svg { height: 30px; }
            .guild-buttons { gap: 12px; }
            .guild-btn { padding: 20px 16px; }
            .guild-btn-name { font-size: 16px; }
            .guild-btn-count { font-size: 12px; }
            
            
            .guild-detail-container { padding: 20px 16px; }
            .guild-detail-title { font-size: 20px; }
            .back-btn { padding: 8px 14px; font-size: 13px; }
            
            
            .table-scroll-container { 
                max-height: 300px; 
            }
            
            
            .btn { 
                padding: 10px 16px; 
                font-size: 13px; 
            }
            
            
            .form-input { 
                padding: 10px 12px; 
                font-size: 14px; 
            }
            
            
            .spec-grid, .time-input-group { 
                grid-template-columns: 1fr; 
            }
        }
        
        
        @media (max-width: 480px) {
            .top-bar { padding: 12px; }
            .top-actions { gap: 8px; }
            .btn-user-add { padding: 8px 12px; font-size: 12px; }
            .search-input { font-size: 14px; padding: 8px 12px; min-width: 0; }
            
            .newyear-title { padding: 6px 10px; }
            .newyear-title .title-svg { height: 26px; }
            
            .guild-select-container { padding: 20px 12px; }
            .guild-select-title .newyear-box { padding: 8px 12px; }
            .guild-select-title .select-title-svg { height: 35px; }
            .guild-buttons { gap: 10px; }
            .guild-btn { padding: 16px 12px; }
            .guild-btn-name { font-size: 14px; }
            
            .modal { width: 98%; margin: 5px auto; }
            .modal-header { padding: 16px 12px 10px; }
            .modal-header h3 { font-size: 15px; }
            .modal-body { padding: 12px; }
            .modal-footer { padding: 10px 12px; }
            
            .common-table th, .common-table td { padding: 8px 6px; font-size: 12px; }
            .player-name { font-size: 12px; }
            .power-value { font-size: 12px; padding: 3px 6px; }
            .rank-number { width: 20px; height: 20px; font-size: 10px; }
            
            .alert { max-width: 90%; min-width: 200px; padding: 12px 30px 12px 16px; }
            .alert-title { font-size: 13px; }
            .alert-message { font-size: 12px; }
            
            
            .guild-select-title .falling-petal:nth-child(n+4) { display: none; }
            .guild-select-title .sparkle:nth-child(n+3) { display: none; }
        }
        
        
        @media (min-width: 768px) and (max-width: 1024px) {
            .top-bar { padding: 16px 20px; flex-direction: row; }
            .top-actions { width: auto; }
            .container { grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 30px 20px; }
            
            .guild-select-container { padding: 50px 30px; }
            .guild-select-title .newyear-box { padding: 14px 20px; }
            .guild-select-title .select-title-svg { height: 50px; }
            .guild-buttons { grid-template-columns: repeat(2, 1fr); }
            
            .modal.modal-lg { max-width: 90%; }
            .modal-body { max-height: calc(100vh - 200px); }
        }
        
        
        @media (min-width: 1024px) and (max-width: 1440px) {
            .container { grid-template-columns: repeat(3, 1fr); max-width: 1200px; }
            .guild-buttons { grid-template-columns: repeat(3, 1fr); }
        }
        
        
        @media (min-width: 1024px) { .container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1440px) { .container { grid-template-columns: repeat(4, 1fr); max-width: 1440px; } }
        
        
        @media (hover: none) and (pointer: coarse) {
            .btn, .guild-btn, .admin-dropdown-item { 
                min-height: 44px; 
            }
            .form-input, .form-select {
                min-height: 44px;
                font-size: 16px; 
            }
            .modal-close-btn {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }
            
            .btn:hover, .guild-btn:hover { transform: none; }
            .admin-dropdown-item:hover { background: transparent; }
            
            .btn:active, .guild-btn:active { 
                transform: scale(0.98); 
                opacity: 0.9;
            }
        }
        
        
        @media (max-height: 500px) and (orientation: landscape) {
            .modal { max-height: 95vh; }
            .modal-body { max-height: calc(95vh - 120px); }
            .guild-select-container { padding: 20px 24px; }
            .guild-select-title { margin-bottom: 20px; }
        }
        
        
        .newyear-title, .newyear-box, .plum-left, .plum-right, .falling-petal, .sparkle {
            will-change: transform, opacity;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        
        @media (prefers-reduced-motion: reduce) {
            .plum-left, .plum-right, .falling-petal, .sparkle, .newyear-title, .newyear-box {
                animation: none !important;
            }
            .newyear-title::after, .newyear-box::after {
                animation: none !important;
            }
        }
        
        
        @media (horizontal-viewport-segments: 2) {
            
            .container { grid-template-columns: repeat(2, 1fr); }
        }
        
        
        @supports (padding: max(0px)) {
            .top-bar {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
            .modal {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div id="lockBanner" class="lock-banner">‚õî ÌòÑÏû¨ Ï†ïÎ≥¥ ÏàòÏ†ïÏù¥ Ïû†Í≤®ÏûàÏäµÎãàÎã§</div>

    <div class="top-bar">
        <h1 id="mainTitle" class="newyear-title" style="cursor: pointer;" onclick="showGuildSelect()">
            <!-- Î∞òÏßùÏù¥ -->
            <div class="title-sparkle"></div>
            <div class="title-sparkle"></div>
            <div class="title-sparkle"></div>
            
            <svg class="title-svg" viewBox="0 0 500 50" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="petalGradMain" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#fff0f3"/>
                        <stop offset="70%" stop-color="#ffc0cb"/>
                        <stop offset="100%" stop-color="#ff8fa3"/>
                    </radialGradient>
                </defs>
                <!-- ÏôºÏ™Ω Îß§Ìôî -->
                <g class="plum-left">
                    <path d="M5 42 Q15 35 25 38 Q35 36 42 28" stroke="#5d4037" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M25 38 Q28 30 32 24" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    <g transform="translate(40, 26) scale(0.8)">
                        <ellipse cx="0" cy="-6" rx="3" ry="5" fill="url(#petalGradMain)"/>
                        <ellipse cx="5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(72)"/>
                        <ellipse cx="3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(144)"/>
                        <ellipse cx="-3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(216)"/>
                        <ellipse cx="-5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(288)"/>
                        <circle cx="0" cy="0" r="2.5" fill="#ffeb3b"/>
                    </g>
                    <circle cx="28" cy="35" r="3" fill="#ffb6c1"/>
                    <circle cx="18" cy="40" r="2.5" fill="#ffc0cb"/>
                </g>
                <text x="250" y="33" text-anchor="middle" font-family="'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" font-size="22" font-weight="700" fill="#c62828">
                    üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê
                </text>
                <!-- Ïò§Î•∏Ï™Ω Îß§Ìôî (ÏßÅÏ†ë Í∑∏Î¶¨Í∏∞) -->
                <g class="plum-right">
                    <path d="M495 42 Q485 35 475 38 Q465 36 458 28" stroke="#5d4037" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M475 38 Q472 30 468 24" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    <g transform="translate(460, 26) scale(0.8)">
                        <ellipse cx="0" cy="-6" rx="3" ry="5" fill="url(#petalGradMain)"/>
                        <ellipse cx="5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(72)"/>
                        <ellipse cx="3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(144)"/>
                        <ellipse cx="-3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(216)"/>
                        <ellipse cx="-5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(288)"/>
                        <circle cx="0" cy="0" r="2.5" fill="#ffeb3b"/>
                    </g>
                    <circle cx="472" cy="35" r="3" fill="#ffb6c1"/>
                    <circle cx="482" cy="40" r="2.5" fill="#ffc0cb"/>
                </g>
            </svg>
        </h1>
        <div class="top-actions">
            <a href="?page=dia" style="text-decoration: none;">
                <button class="btn-common" style="padding: 8px 14px; background: #8b5cf6; color: white;">üìã Í≤åÏãúÌåê</button>
            </a>
            <button id="addUserBtn" class="btn-common btn-user-add">‚ûï ÏÇ¨Ïö©Ïûê Îì±Î°ù</button>
            <div style="display: flex; gap: 4px;">
                <input type="text" id="searchInput" class="search-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                <button id="searchBtn" class="btn-common" style="padding: 8px 12px; background: #3b82f6; color: white;">üîç</button>
            </div>
            
            <!-- ÌöåÏõê Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="memberDropdown">
                <button class="admin-dropdown-btn dropdown-member">üë• ÌöåÏõê Í¥ÄÎ¶¨</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="approveBtn">‚úÖ ÏäπÏù∏ Í¥ÄÎ¶¨ <span id="pendingBadge" class="pending-badge" style="display:none; margin-left:auto;">0</span></button>
                    <button class="admin-dropdown-item" id="bulkAddBtn">üìù ÏùºÍ¥Ñ Îì±Î°ù</button>
                    <button class="admin-dropdown-item" id="userManageBtn">üë§ Ïú†Ï†Ä Í¥ÄÎ¶¨</button>
                    <div class="admin-dropdown-divider"></div>
                    <button class="admin-dropdown-item danger" id="bulkDeleteBtn">üóëÔ∏è ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú</button>
                </div>
            </div>
            
            <!-- Í∏∏Îìú Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="guildDropdown">
                <button class="admin-dropdown-btn dropdown-guild">üè∞ Í∏∏Îìú Í¥ÄÎ¶¨</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="guildMoveBtn">üöÄ Í∏∏Îìú Ïù¥Îèô</button>
                    <button class="admin-dropdown-item" id="guildAddBtn">‚ûï Í∏∏Îìú Ï∂îÍ∞Ä</button>
                    <div class="admin-dropdown-divider"></div>
                    <button class="admin-dropdown-item danger" id="guildDeleteBtn">üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú</button>
                </div>
            </div>
            
            <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="dataDropdown">
                <button class="admin-dropdown-btn dropdown-data">üìä Îç∞Ïù¥ÌÑ∞</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="spreadsheetBtn">üìã Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïó∞Îèô</button>
                    <button class="admin-dropdown-item" id="syncExcludeBtn">üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨</button>
                    <button class="admin-dropdown-item" id="excelBtn">üîó Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±</button>
                    <button class="admin-dropdown-item" id="backupManageBtn">üì¶ Ï£ºÍ∞Ñ Î∞±ÏóÖ</button>
                </div>
            </div>
            
            <!-- ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="systemDropdown">
                <button class="admin-dropdown-btn dropdown-system">‚öôÔ∏è ÏãúÏä§ÌÖú</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="lockManageBtn">üîí Ïû†Í∏à ÏÑ§Ï†ï</button>
                    <button class="admin-dropdown-item" id="deletedUsersBtn">üóëÔ∏è ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê</button>
                    <div class="admin-dropdown-divider super-admin-only" style="display:none;"></div>
                    <button class="admin-dropdown-item super-admin-only" id="logViewBtn" style="display:none;">üìù Î°úÍ∑∏ ÌôïÏù∏</button>
                    <button class="admin-dropdown-item super-admin-only" id="statsViewBtn" style="display:none;">üìä Ï†ëÏÜç ÌÜµÍ≥Ñ</button>
                    <button class="admin-dropdown-item super-admin-only" id="adminManageBtn" style="display:none;">üëë Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨</button>
                    <div style="border-top: 1px solid #e5e7eb; margin: 8px 0;"></div>
                    <button class="admin-dropdown-item" id="versionInfoBtn">‚ÑπÔ∏è Î≤ÑÏ†Ñ Ï†ïÎ≥¥</button>
                </div>
            </div>
            
            <button id="adminLoginBtn" class="btn-common btn-admin">Í¥ÄÎ¶¨Ïûê</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent">
            <button class="modal-close-btn" onclick="closeModal()" title="Îã´Í∏∞">√ó</button>
            <div class="modal-header">
                <h3 id="modalTitle">Ï†úÎ™©</h3>
                <p id="modalSubtitle">Î∂ÄÏ†úÎ™©</p>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" id="modalSubmit">ÌôïÏù∏</button>
            </div>
        </div>
    </div>
    
    <div class="container" id="mainContainer"></div>
    
    
    <div class="guild-select-container" id="guildSelectContainer">
        <div class="guild-select-title">
            <div class="newyear-box">
                <!-- Îñ®Ïñ¥ÏßÄÎäî ÍΩÉÏûé -->
                <div class="petal-container">
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                </div>
                <!-- Î∞òÏßùÏù¥ -->
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                
                <svg class="select-title-svg" viewBox="0 0 500 70" xmlns="http://www.w3.org/2000/svg">
                    <!-- ÌïúÏßÄ ÌÖçÏä§Ï≤ò Î∞∞Í≤Ω Ìå®ÌÑ¥ -->
                    <defs>
                        <pattern id="hanji" patternUnits="userSpaceOnUse" width="100" height="100">
                            <rect fill="#fffaf5" width="100" height="100"/>
                            <circle cx="10" cy="10" r="0.5" fill="#f5e6d3" opacity="0.5"/>
                            <circle cx="50" cy="30" r="0.3" fill="#f5e6d3" opacity="0.4"/>
                            <circle cx="80" cy="60" r="0.4" fill="#f5e6d3" opacity="0.3"/>
                            <circle cx="30" cy="80" r="0.5" fill="#f5e6d3" opacity="0.4"/>
                        </pattern>
                        <!-- Îß§ÌôîÍΩÉ Í∑∏ÎùºÎç∞Ïù¥ÏÖò -->
                        <radialGradient id="petalGrad" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="#fff0f3"/>
                            <stop offset="70%" stop-color="#ffc0cb"/>
                            <stop offset="100%" stop-color="#ff8fa3"/>
                        </radialGradient>
                    </defs>
                    
                    <!-- ÏôºÏ™Ω Îß§Ìôî Í∞ÄÏßÄ -->
                    <g class="plum-left">
                        <!-- Í∞ÄÏßÄ -->
                        <path d="M5 55 Q20 45 35 50 Q50 48 60 35" stroke="#5d4037" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M35 50 Q38 40 45 30" stroke="#5d4037" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M50 42 Q55 35 52 25" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        
                        <!-- Îß§ÌôîÍΩÉ 1 (5Ïûé) -->
                        <g transform="translate(55, 32)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                            <circle cx="-1" cy="-1" r="0.8" fill="#ff6b6b"/>
                            <circle cx="1" cy="0" r="0.8" fill="#ff6b6b"/>
                            <circle cx="0" cy="1" r="0.8" fill="#ff6b6b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ 2 -->
                        <g transform="translate(38, 45) scale(0.7)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ Î¥âÏò§Î¶¨ -->
                        <circle cx="48" cy="26" r="4" fill="#ffb6c1"/>
                        <circle cx="25" cy="48" r="3" fill="#ffc0cb"/>
                        
                        <!-- 2027 -->
                        <text x="30" y="65" font-size="10" font-weight="bold" fill="#c62828" font-family="serif">2027</text>
                    </g>
                    
                    <!-- Í∞ÄÏö¥Îç∞ ÌÖçÏä§Ìä∏ -->
                    <text x="250" y="42" text-anchor="middle" font-family="'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" font-size="26" font-weight="700" fill="#c62828">
                        Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                    </text>
                    <text x="250" y="58" text-anchor="middle" font-family="serif" font-size="11" fill="#d32f2f" opacity="0.7">
                        Êñ∞Âπ¥Á¶èÂ§ö ¬∑ ÏÉàÌï¥ Î≥µ ÎßéÏù¥ Î∞õÏúºÏÑ∏Ïöî
                    </text>
                    
                    <!-- Ïò§Î•∏Ï™Ω Îß§Ìôî Í∞ÄÏßÄ (ÏßÅÏ†ë Í∑∏Î¶¨Í∏∞) -->
                    <g class="plum-right">
                        <!-- Í∞ÄÏßÄ -->
                        <path d="M495 55 Q480 45 465 50 Q450 48 440 35" stroke="#5d4037" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M465 50 Q462 40 455 30" stroke="#5d4037" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M450 42 Q445 35 448 25" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        
                        <!-- Îß§ÌôîÍΩÉ 1 -->
                        <g transform="translate(445, 32)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                            <circle cx="-1" cy="-1" r="0.8" fill="#ff6b6b"/>
                            <circle cx="1" cy="0" r="0.8" fill="#ff6b6b"/>
                            <circle cx="0" cy="1" r="0.8" fill="#ff6b6b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ 2 -->
                        <g transform="translate(462, 45) scale(0.7)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ Î¥âÏò§Î¶¨ -->
                        <circle cx="452" cy="26" r="4" fill="#ffb6c1"/>
                        <circle cx="475" cy="48" r="3" fill="#ffc0cb"/>
                    </g>
                </svg>
            </div>
        </div>
        <div class="guild-buttons" id="guildButtons"></div>
    </div>
    
    
    <div class="guild-detail-container" id="guildDetailContainer">
        <button class="back-btn" onclick="showGuildSelect()">‚Üê Í∏∏Îìú Î™©Î°ùÏúºÎ°ú</button>
        <div class="guild-detail-header">
            <div class="guild-detail-badge" id="detailBadge"></div>
            <h2 class="guild-detail-title" id="detailTitle"></h2>
            <span class="guild-detail-count" id="detailCount"></span>
        </div>
        <div class="card">
            <div class="card-body">
                <table>
                    <thead><tr><th>ÌîåÎ†àÏù¥Ïñ¥</th><th>Ï†ÑÌà¨Î†•</th></tr></thead>
                    <tbody id="detailList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, getDoc, query, orderBy, limit, deleteDoc, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrW07jxkT-I5k7LXT_IKVdw3o4s45ZRE0",
            authDomain: "guild-power-rank.firebaseapp.com",
            projectId: "guild-power-rank",
            storageBucket: "guild-power-rank.firebasestorage.app",
            messagingSenderId: "312765940928",
            appId: "1:312765940928:web:bdf388e3cdd4f32e699925",
            measurementId: "G-QPVZKMLS70"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ïï± Î≤ÑÏ†Ñ Ï†ïÎ≥¥
        const APP_VERSION = '1.9.0';
        const APP_BUILD_DATE = '2026-01-13 13:30';
        const APP_CHANGELOG = [
            { version: '1.9.0', date: '2026-01-13 13:30', changes: [
                'üìã Í≤åÏãúÌåê Ï†ÑÎ©¥ Í∞úÌé∏',
                '‚öôÔ∏è Ïπ¥ÌÖåÍ≥†Î¶¨ ÎèôÏ†Å Í¥ÄÎ¶¨ (Ï∂îÍ∞Ä/ÏÇ≠Ï†ú)',
                'üìå Í≥µÏßÄÏÇ¨Ìï≠ Í≥†Ï†ï Í∏∞Îä•',
                'üîß Î≤ÑÍ∑∏ ÏàòÏ†ï (Í∏∏Îìú/Î≤ÑÌäº ÏûëÎèô Ïò§Î•ò)'
            ]},
            { version: '1.8.9', date: '2026-01-13 13:00', changes: [
                'üîí Ï†ÑÌà¨Î†• ÎßàÏä§ÌÇπ ÏÑ§Ï†ï Í∏∞Îä• (ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©)',
                'üìã Í≤åÏãúÌåê Ïπ¥ÌÖåÍ≥†Î¶¨ Î∂ÑÎ•ò (Í≥µÏßÄ/Ï£ºÍ∞ÑÎ∞±ÏóÖ/Ïù¥Î≤§Ìä∏/Í∞ÄÏù¥Îìú)',
                'üîó Í≤åÏãúÍ∏Ä ÎßÅÌÅ¨ Ï≤®Î∂Ä Í∏∞Îä• (Î∞îÎ°úÍ∞ÄÍ∏∞ Î≤ÑÌäº)',
                'üì¶ Ï£ºÍ∞Ñ Î∞±ÏóÖ Ïãú ÏûêÎèô Í≤åÏãúÍ∏Ä Îì±Î°ù'
            ]},
            { version: '1.8.8', date: '2026-01-13 12:30', changes: [
                'üìã Í≥µÏßÄÏÇ¨Ìï≠ Í≤åÏãúÌåê Í∏∞Îä• Ï∂îÍ∞Ä (/dia)',
                '‚úèÔ∏è ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö© Í∏ÄÏì∞Í∏∞/ÏàòÏ†ï/ÏÇ≠Ï†ú',
                'üëÅÔ∏è Ï°∞ÌöåÏàò Í∏∞Îä•'
            ]},
            { version: '1.8.7', date: '2026-01-13 12:00', changes: [
                '‚öîÔ∏è Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Ïãú Í∏∏ÎìúÎ≥Ñ ÌÅ¥Îûú Î¨òÏã§ Ï∞®Í∞ê Í∏∞Îä•',
                'üè∑Ô∏è Ï∞®Í∞ê Ï†ÅÏö©Îêú Í≥µÏú† ÌéòÏù¥ÏßÄÏóê Ï∞®Í∞ê Ï†ïÎ≥¥ Î∞∞ÎÑà ÌëúÏãú',
                'üìä Í∏∏ÎìúÎ≥Ñ ÌòÑÌô©Ïóê Ï∞®Í∞ê Î±ÉÏßÄ ÌëúÏãú'
            ]},
            { version: '1.8.6', date: '2026-01-13 11:40', changes: [
                'üîó ÌòÑÏû¨ Ï†ÑÌà¨Î†• Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Í∏∞Îä•',
                'üì± Ïπ¥Ïπ¥Ïò§ÌÜ° Îì± Î©îÏã†Ï†ÄÎ°ú Î∞îÎ°ú Í≥µÏú† Í∞ÄÎä•',
                'üé® Í≥µÏú† ÌéòÏù¥ÏßÄ ÍπîÎÅîÌïú ÎîîÏûêÏù∏'
            ]},
            { version: '1.8.5', date: '2026-01-13 11:20', changes: [
                'üîó Î∞±ÏóÖ Í≥µÏú† ÎßÅÌÅ¨ Í∏∞Îä• Í∞úÏÑ†',
                'üìã Î∞±ÏóÖ Î™©Î°ùÏóê Í≥µÏú† Î≤ÑÌäº Ï∂îÍ∞Ä'
            ]},
            { version: '1.8.4', date: '2026-01-13 11:00', changes: [
                'üîß Î°úÍ∑∏ ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ Î≤ÑÍ∑∏ ÏàòÏ†ï',
                '‚ö° Î°úÍ∑∏ Î°úÎî© ÏµúÏ†ÅÌôî (ÏµúÍ∑º 1000Í±¥)',
                'üìç ÏúÑÏπò ÌïúÍ∏Ä Î≥ÄÌôò Í∞ïÌôî'
            ]},
            { version: '1.8.3', date: '2026-01-12 11:40', changes: [
                'üìç ÏúÑÏπò ÌïúÍ∏Ä Î≥ÄÌôò Ï†ÑÎ©¥ Í∞úÏÑ† (ÏòÅÏñ¥ ÏÑûÏûÑ ÏôÑÏ†Ñ Ìï¥Í≤∞)',
                'üó∫Ô∏è 200Í∞ú Ïù¥ÏÉÅ ÌïúÍµ≠ ÏßÄÏó≠ ÏßÄÏõê (ÎèÑ, Ïãú, Íµ∞, Íµ¨)',
                'üîß Í∏∞Ï°¥ Î°úÍ∑∏ ÏúÑÏπòÎèÑ ÏûêÎèô ÌïúÍ∏Ä Î≥ÄÌôò'
            ]},
            { version: '1.8.2', date: '2026-01-12 11:30', changes: [
                'üîß Î≤ÑÏ†Ñ Ï†ïÎ≥¥ ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©ÏúºÎ°ú Î≥ÄÍ≤Ω',
                '‚úèÔ∏è Ï†úÏûëÏûê Ï†ïÎ≥¥ Î≥ÄÍ≤Ω',
                '‚è∞ ÏãúÍ∞ÑÎåÄ ÌëúÏãú ÏàòÏ†ï'
            ]},
            { version: '1.8.1', date: '2026-01-12 11:20', changes: [
                'üìã Ïú†Ï†Ä Î°úÍ∑∏ Î≤ÑÌäº ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©',
                'üìã Ïú†Ï†Ä Î°úÍ∑∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ (IP/ÏúÑÏπò/Í∏∞Í∏∞ Ìè¨Ìï®)',
                'üîß IP Ï°∞Ìöå API Í∞úÏÑ† (unknown Î≤ÑÍ∑∏ ÏàòÏ†ï)'
            ]},
            { version: '1.8.0', date: '2026-01-12 11:00', changes: [
                'üìä Ï†ëÏÜç ÌÜµÍ≥Ñ Í∏∞Îä• Ï∂îÍ∞Ä',
                'üîç ÌÜµÍ≥Ñ Í≤ÄÏÉâ (ÎãâÎÑ§ÏûÑ/ÏßÄÏó≠/Í∏∞Í∏∞)',
                'üì± Ï†úÏ°∞ÏÇ¨Î≥Ñ ÌïÑÌÑ∞ (ÏÇºÏÑ±/Ïï†Ìîå/PC)'
            ]},
            { version: '1.7.2', date: '2026-01-12 10:50', changes: [
                'üìç ÏúÑÏπò ÌïúÍ∏Ä Î≥ÄÌôò (Busan Dongnae ‚Üí Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú ÎèôÎûòÍµ¨)',
                'üó∫Ô∏è 150Í∞ú Ïù¥ÏÉÅ ÌïúÍµ≠ ÏßÄÏó≠ ÏßÄÏõê'
            ]},
            { version: '1.7.1', date: '2026-01-12 10:40', changes: [
                'üì± Í∏∞Í∏∞ ÏÑ∏Î∂ÑÌôî (Í∞§Îü≠ÏãúÌè¥Îìú6, ÌîåÎ¶Ω5, S24Ïö∏Ìä∏Îùº Îì±)',
                'üì± Í∞§Îü≠Ïãú AÏãúÎ¶¨Ï¶à ÏßÄÏõê'
            ]},
            { version: '1.7.0', date: '2026-01-12 10:30', changes: [
                'üìç ÏúÑÏπò Ï†ïÎ≥¥ Íµ≠Í∞Ä Ìè¨Ìï® ÌëúÏãú',
                'üì± Í∏∞Í∏∞ Ï†ïÎ≥¥ ÏûêÎèô Î≥ÄÌôò (Í∏∞Ï°¥ Î°úÍ∑∏ÎèÑ Ï†ÅÏö©)'
            ]},
            { version: '1.6.3', date: '2026-01-12 10:20', changes: [
                'üêõ Ï†ïÎ≥¥ ÏàòÏ†ï Ïãú Î≥ÄÍ≤Ω ÏóÜÏúºÎ©¥ Î°úÍ∑∏ Ï†ÄÏû• Ïïà Ìï®',
                'üêõ ÎçîÎ∏îÌÅ¥Î¶≠ Î∞©ÏßÄ (Ï§ëÎ≥µ Î°úÍ∑∏ Î∞©ÏßÄ)'
            ]},
            { version: '1.6.2', date: '2026-01-12 10:10', changes: [
                'üìã ÏÉÅÏÑ∏ Ï†ïÎ≥¥Ïóê Î°úÍ∑∏ Î≥¥Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä',
                'üìã Ïú†Ï†ÄÎ≥Ñ Î°úÍ∑∏ Ï°∞Ìöå Í∏∞Îä•'
            ]},
            { version: '1.6.1', date: '2026-01-12 10:00', changes: [
                'üìã ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê ÌïÑÌÑ∞ (Í∏∏Îìú/ÏÇ¨Ïú†/ÏÇ≠Ï†úÏûê)',
                'üìã ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌåùÏóÖ'
            ]},
            { version: '1.6.0', date: '2026-01-12 09:50', changes: [
                'üëë Í¥ÄÎ¶¨Ïûê Ï†ëÏÜç Î°úÍ∑∏ Í∏∞Î°ù (ÏàòÎèô/ÏûêÎèô)',
                'üëë Í¥ÄÎ¶¨Ïûê ÏïÑÏù¥Îîî ÌÅ¥Î¶≠ Ïãú Ï†ëÏÜç Î°úÍ∑∏ ÌôïÏù∏'
            ]},
            { version: '1.5.4', date: '2026-01-12 09:40', changes: [
                'üîí Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïó∞Îèô ÏÑ§Ï†ï ÏàòÏ†ï Í∂åÌïú Î∂ÑÎ¶¨',
                'üì¶ Î∞±ÏóÖ ÏÉùÏÑ± ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©'
            ]},
            { version: '1.5.3', date: '2026-01-12 09:30', changes: [
                'üì± Í∏∞Í∏∞ Ï†ïÎ≥¥ Í∞ÑÎûµÌôî (PC-ÌÅ¨Î°¨, ÏïÑÏù¥Ìè∞-ÏÇ¨ÌååÎ¶¨)',
                'üìç Ï†ëÏÜç ÏúÑÏπò ÌëúÏãú Í∏∞Îä•'
            ]},
            { version: '1.5.2', date: '2026-01-12 09:20', changes: [
                'üîí Ïû†Í∏à ÏÑ§Ï†ï/Ìï¥Ï†ú ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©',
                'üìÖ 2Ï£º Î∞òÎ≥µ Ïû†Í∏à ÏãúÏûë/Ï¢ÖÎ£å ÏßÅÏ†ë ÏßÄÏ†ï'
            ]},
            { version: '1.5.1', date: '2026-01-12 09:10', changes: [
                'üè† Í∏∏Îìú Î≥ÄÍ≤Ω/Ï†ÑÌà¨Î†• ÏàòÏ†ï/Ïä§Ìéô ÏàòÏ†ï Î°úÍ∑∏ ÌÉÄÏûÖ Î∂ÑÎ¶¨',
                '‚≠ê Ïä§Ìéô ÏàòÏ†ï Î°úÍ∑∏ ÎèÖÎ¶Ω ÌëúÏãú'
            ]},
            { version: '1.5.0', date: '2026-01-12 09:00', changes: [
                'üîç Î°úÍ∑∏Ïóê IP Í≤ÄÏÉâ ÌïÑÌÑ∞ Ï∂îÍ∞Ä',
                'üëë Í¥ÄÎ¶¨Ïûê ÌïÑÌÑ∞: ÏûëÏóÖ ÏóÜÎäî Í¥ÄÎ¶¨ÏûêÎèÑ ÌëúÏãú'
            ]},
            { version: '1.4.3', date: '2026-01-12 08:50', changes: [
                'üîß Î™®Îã¨ Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê Î≤ÑÍ∑∏ ÏàòÏ†ï',
                '‚úÖ Í∏∏Îìú Ïù¥Îèô/ÎãâÎ≥Ä ÌõÑ "Ï≤òÎ¶¨ Ï§ë" ÏÉÅÌÉú Ìï¥Í≤∞'
            ]},
            { version: '1.4.2', date: '2026-01-12 08:40', changes: [
                'üîó Î∞±ÏóÖ Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Í∏∞Îä•'
            ]},
            { version: '1.4.1', date: '2026-01-12 08:30', changes: [
                'üë§ Î∞±ÏóÖ ÏÉùÏÑ±Ïûê Ïù¥Î¶Ñ ÏûÖÎ†•',
                '‚öôÔ∏è Ï†ÑÌà¨Î†• Ïª§Ïä§ÌÖÄ ÌïÑÌÑ∞ (Î≤îÏúÑ ÏßÅÏ†ë ÏÑ§Ï†ï)',
                'üìä Ï†ÑÌà¨Î†• ÌïÑÌÑ∞ 150ÎßåÍπåÏßÄ ÌôïÏû•'
            ]},
            { version: '1.4.0', date: '2026-01-12 08:20', changes: [
                'üîç Î∞±ÏóÖ ÏÉÅÏÑ∏ ÌïÑÌÑ∞ Í∏∞Îä•',
                'üìä Ï†ÑÌà¨Î†• Ï¶ùÍ∞êÎ≥Ñ/Í∏∏ÎìúÎ≥Ñ/Ï†ÑÌà¨Î†•ÎåÄÎ≥Ñ ÌïÑÌÑ∞',
                'üî§ Ïù¥Î¶ÑÏàú/Ï†ÑÌà¨Î†•Ïàú Ï†ïÎ†¨ ÏòµÏÖò'
            ]},
            { version: '1.3.2', date: '2026-01-12 08:10', changes: [
                '‚òëÔ∏è Ï≤¥ÌÅ¨Î∞ïÏä§ Ìñâ ÌÅ¥Î¶≠ ÌÜ†Í∏Ä ÏßÄÏõê',
                'üíæ ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú ÏÑ†ÌÉù ÏÉÅÌÉú Ïú†ÏßÄ'
            ]},
            { version: '1.3.1', date: '2026-01-12 08:00', changes: [
                'üìã Î°úÍ∑∏ ÏÉÅÏÑ∏ ÏàòÏ†ïÏ†Ñ/ÌõÑ ÌååÏã± Í∞úÏÑ†',
                'üöÄ Í∏∏Îìú Ïù¥Îèô Î°úÍ∑∏Ïóê ÎãâÎÑ§ÏûÑ Ï†ÑÏ≤¥ ÌëúÏãú'
            ]},
            { version: '1.3.0', date: '2026-01-12 07:50', changes: [
                'üìù Î°úÍ∑∏ ÌïÑÌÑ∞ Í∏∞Îä• (ÎåÄÏÉÅ/ÏûëÏóÖÏú†Ìòï/ÏûëÏóÖÏûê)',
                'üëÜ Î°úÍ∑∏ Ìñâ ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏Î≥¥Í∏∞',
                '‚úèÔ∏è Ï†ïÎ≥¥ ÏàòÏ†ï ‚Üí Ï†ÑÌà¨Î†• ÏàòÏ†ï Î™ÖÏπ≠ Î≥ÄÍ≤Ω'
            ]},
            { version: '1.2.1', date: '2026-01-12 07:30', changes: [
                'üîß Î°úÍ∑∏ ÌÖåÏù¥Î∏î ÏµúÏ†ÅÌôî',
                'üí¨ Ìà¥ÌåÅ Í∏∞Îä• Ï∂îÍ∞Ä'
            ]},
            { version: '1.2.0', date: '2026-01-12 07:00', changes: [
                'üì± Î™®Î∞îÏùº/ÌÉúÎ∏îÎ¶ø Î∞òÏùëÌòï ÏµúÏ†ÅÌôî',
                'üé® UI Ï†ÑÎ©¥ Í∞úÏÑ†'
            ]},
            { version: '1.1.0', date: '2026-01-12 05:00', changes: [
                'üíæ Î∞±ÏóÖ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú',
                'üîí ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïû†Í∏à ÏÑ§Ï†ï',
                'üîÑ Î™®Îã¨ Ïä§ÌÉù ÏãúÏä§ÌÖú'
            ]},
            { version: '1.0.0', date: '2026-01-12 00:00', changes: [
                'üéâ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê Ï∂úÏãú',
                'üå∏ ÏÑ§ÎÇ† ÌÖåÎßà (Îß§ÌôîÍΩÉ ÎîîÏûêÏù∏)'
            ]}
        ];

       
        let allGuildData = [];
        let guildList = []; 
        let isAdmin = false;
        let isSuperAdmin = false;
        let loggedInUser = null;
        let loggedInAdminId = null;
        let lockStartTime = 0;
        let lockEndTime = 0;
        let biweeklyBaseTime = 0; // 2Ï£º Î∞òÎ≥µ Í∏∞Ï§Ä ÏãúÍ∞Ñ
        let spreadsheetConfig = null;
        let syncExcludeList = []; // Î∂ÑÎ∞∞ Ï†úÏô∏ Î™©Î°ù
        let powerMaskingEnabled = false; // Ï†ÑÌà¨Î†• ÎßàÏä§ÌÇπ ÏÑ§Ï†ï
        const _0x = { a: "dGpkYWxzOTMyOA==", b: "dG5hbHM5MzI4QEA=" };
        
       
        const ADMIN_SESSION_TIMEOUT = 2 * 60 * 60 * 1000;
        let adminSessionTimer = null;
        
       
        function resetAdminSessionTimer() {
            if (!isAdmin) return;
            
           
            sessionStorage.setItem('adminLastActivity', Date.now().toString());
            
           
            if (adminSessionTimer) {
                clearTimeout(adminSessionTimer);
            }
            
           
            adminSessionTimer = setTimeout(() => {
                if (isAdmin) {
                    adminLogout(true);
                }
            }, ADMIN_SESSION_TIMEOUT);
        }
        
       
        async function adminLogout(isAuto = false) {
            isAdmin = false;
            isSuperAdmin = false;
            loggedInAdminId = null;
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('isSuperAdmin');
            sessionStorage.removeItem('adminLastActivity');
            sessionStorage.removeItem('loggedInAdminId');
            
            if (adminSessionTimer) {
                clearTimeout(adminSessionTimer);
                adminSessionTimer = null;
            }
            
            if (isAuto) {
                showAlert('2ÏãúÍ∞Ñ ÎèôÏïà ÌôúÎèôÏù¥ ÏóÜÏñ¥ ÏûêÎèô Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§', 'error');
            } else {
                showAlert('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§', 'success');
            }
            
           
            updateAdminUI();
            await loadData();
        }
        
       
        function checkAdminSession() {
            const lastActivity = sessionStorage.getItem('adminLastActivity');
            if (lastActivity && isAdmin) {
                const elapsed = Date.now() - parseInt(lastActivity);
                if (elapsed >= ADMIN_SESSION_TIMEOUT) {
                   
                    adminLogout(true);
                    return false;
                } else {
                   
                    resetAdminSessionTimer();
                }
            }
            return true;
        }
        
       
        ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'].forEach(eventType => {
            document.addEventListener(eventType, () => {
                if (isAdmin) {
                    resetAdminSessionTimer();
                }
            }, { passive: true });
        });

       
        function toKST(timestamp) {
           
            return new Date(timestamp + (9 * 60 * 60 * 1000));
        }

        function fromKST(dateString) {
           
           
            return new Date(dateString + ':00+09:00').getTime();
        }

        function formatKSTDateTime(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function toDatetimeLocalValue(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

       
        async function init() {
            // Í≥µÏú† ÎßÅÌÅ¨ Ï≤¥ÌÅ¨
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            if (shareId) {
                await showSharedBackup(shareId);
                return;
            }
            
            // Í≤åÏãúÌåê ÌéòÏù¥ÏßÄ Ï≤¥ÌÅ¨
            const page = urlParams.get('page');
            if (page === 'dia') {
                await showBoardPage();
                return;
            }
           
            if (sessionStorage.getItem('isAdmin') === 'true') { 
                isAdmin = true;
                if (sessionStorage.getItem('isSuperAdmin') === 'true') {
                    isSuperAdmin = true;
                }
               
                loggedInAdminId = sessionStorage.getItem('loggedInAdminId') || null;
                
               
                if (!checkAdminSession()) {
                    return;
                }
                
                updateAdminUI(); 
                await checkPendingUsers();
                await checkDuplicateNicknames();
            } else {
               
                const autoLoggedIn = await tryAutoLogin();
                if (autoLoggedIn && isAdmin) {
                    await checkDuplicateNicknames();
                }
            }
            
           
            await checkAutoLogin();
            
            await checkLockStatus();
            await loadSpreadsheetConfig();
            await loadData();
        }
        
        // Í≥µÏú†Îêú Î∞±ÏóÖ ÌëúÏãú
        async function showSharedBackup(shareId) {
            document.body.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%); padding: 20px;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div class="loading-spinner" style="width:40px; height:40px; border:4px solid #f3f4f6; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
                            <p style="margin-top: 16px; color: #6b7280;">Î°úÎî© Ï§ë...</p>
                        </div>
                    </div>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            `;
            
            try {
                const shareDoc = await getDoc(doc(db, "sharedBackups", shareId));
                if (!shareDoc.exists()) {
                    document.body.innerHTML = `
                        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                                <h1 style="font-size: 24px; color: #374151; margin-bottom: 12px;">Í≥µÏú† ÎßÅÌÅ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h1>
                                <p style="color: #6b7280;">ÎßÅÌÅ¨Í∞Ä ÎßåÎ£åÎêòÏóàÍ±∞ÎÇò ÏûòÎ™ªÎêú ÎßÅÌÅ¨ÏûÖÎãàÎã§.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const share = shareDoc.data();
                const backup = share.backupData;
                const users = backup.users || [];
                const guildStats = backup.guildStats || {};
                const backupTime = formatDateTime(backup.createdAt);
                const guildDeductions = share.guildDeductions || {};
                
                // Ï∞®Í∞ê Ï†ïÎ≥¥ Î∞∞ÎÑà ÏÉùÏÑ±
                let deductionBannerHtml = '';
                const deductionEntries = Object.entries(guildDeductions).filter(([_, v]) => v > 0);
                if (deductionEntries.length > 0) {
                    const deductionItems = deductionEntries.map(([guild, amount]) => 
                        `<span style="background:#fef3c7; padding:4px 10px; border-radius:12px; font-size:13px; white-space:nowrap;">
                            <strong>${guild}</strong> -${amount.toLocaleString()}
                        </span>`
                    ).join('');
                    deductionBannerHtml = `
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                            <p style="color: #92400e; font-size: 14px; font-weight: 600; margin: 0 0 10px;">‚öîÔ∏è ÌÅ¥Îûú Î¨òÏã§ Ï∞®Í∞ê Ï†ÅÏö©Îê®</p>
                            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;">
                                ${deductionItems}
                            </div>
                        </div>
                    `;
                }
                
                // Ï†ÑÏ≤¥ ÌèâÍ∑† Ï†ÑÌà¨Î†• (0 Ï†úÏô∏)
                const activeUsers = users.filter(u => u.power > 0);
                const totalAvgPower = activeUsers.length > 0 ? Math.round(backup.totalPower / activeUsers.length) : 0;
                
                // Í∏∏ÎìúÎ≥Ñ ÌÜµÍ≥Ñ HTML (Ï∞®Í∞ê Ï†ïÎ≥¥ Ìè¨Ìï®)
                let guildStatsHtml = '';
                Object.keys(guildStats).sort().forEach(guild => {
                    const stats = guildStats[guild];
                    const deduction = guildDeductions[guild] || 0;
                    // Ìï¥Îãπ Í∏∏ÎìúÏùò Ï†ÑÌà¨Î†• > 0Ïù∏ Ïú†Ï†ÄÎßå Ïπ¥Ïö¥Ìä∏
                    const guildActiveUsers = users.filter(u => u.guild === guild && u.power > 0);
                    const activeCount = guildActiveUsers.length;
                    const avgPower = activeCount > 0 ? Math.round(stats.totalPower / activeCount).toLocaleString() : '0';
                    const diffSign = stats.totalDiff >= 0 ? '+' : '';
                    const diffColor = stats.totalDiff >= 0 ? '#10b981' : '#ef4444';
                    const deductionBadge = deduction > 0 ? `<span style="background:#fee2e2; color:#dc2626; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:6px;">-${deduction.toLocaleString()}</span>` : '';
                    guildStatsHtml += `<tr>
                        <td style="padding: 12px; font-weight: 600;">${guild}${deductionBadge}</td>
                        <td style="padding: 12px; text-align: center;">${stats.count}Î™Ö</td>
                        <td style="padding: 12px; text-align: right;">${avgPower}</td>
                        <td style="padding: 12px; text-align: right; color: ${diffColor}; font-weight: 600;">${diffSign}${stats.totalDiff.toLocaleString()}</td>
                    </tr>`;
                });
                
                // Ïú†Ï†Ä Î™©Î°ù HTML
                let usersHtml = '';
                users.forEach((u, idx) => {
                    const diffSign = u.diff >= 0 ? '+' : '';
                    const diffColor = u.diff > 0 ? '#10b981' : u.diff < 0 ? '#ef4444' : '#6b7280';
                    const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1);
                    let icons = '';
                    if (u.shape_legend > 0) icons += 'üõ°Ô∏è';
                    if (u.shape_myth > 0) icons += 'üëë';
                    if (u.mount_legend > 0) icons += 'üê¥';
                    if (u.mount_myth > 0) icons += 'ü¶Ñ';
                    usersHtml += `<tr>
                        <td style="padding: 10px; text-align: center;">${medal}</td>
                        <td style="padding: 10px; font-weight: 500;">${u.name}</td>
                        <td style="padding: 10px; text-align: center;">${u.guild}</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600;">${u.power.toLocaleString()}</td>
                        <td style="padding: 10px; text-align: right; color: ${diffColor}; font-weight: 500;">${diffSign}${u.diff.toLocaleString()}</td>
                        <td style="padding: 10px; text-align: center;">${u.shape_legend || 0}</td>
                        <td style="padding: 10px; text-align: center;">${u.shape_myth || 0}</td>
                        <td style="padding: 10px; text-align: center;">${u.mount_legend || 0}</td>
                        <td style="padding: 10px; text-align: center;">${u.mount_myth || 0}</td>
                    </tr>`;
                });
                
                const totalDiff = backup.totalDiff || 0;
                const diffSign = totalDiff >= 0 ? '+' : '';
                const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                
                document.title = share.pageTitle;
                document.body.innerHTML = `
                    <div style="min-height: 100vh; background: linear-gradient(135deg, #fef2f2 0%, #fff7ed 100%); padding: 20px;">
                        <div style="max-width: 1000px; margin: 0 auto;">
                            <!-- Ìó§Îçî -->
                            <div style="text-align: center; padding: 30px 20px; margin-bottom: 24px;">
                                <h1 style="font-size: 28px; font-weight: 700; color: #c62828; margin: 0 0 8px;">${share.headerName}</h1>
                                <p style="color: #6b7280; font-size: 14px;">${share.description || ''}</p>
                            </div>
                            
                            <!-- Î∞±ÏóÖ Ï†ïÎ≥¥ -->
                            <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;">
                                <p style="color: #6b7280; font-size: 13px; margin: 0;">üìÖ Î∞±ÏóÖ ÏùºÏãú: <strong>${backupTime}</strong> (KST)</p>
                                ${backup.createdBy ? `<p style="color: #6b7280; font-size: 13px; margin: 4px 0 0;">üë§ ÏÉùÏÑ±Ïûê: <strong>${backup.createdBy}</strong></p>` : ''}
                            </div>
                            
                            <!-- Ï∞®Í∞ê Ï†ïÎ≥¥ Î∞∞ÎÑà -->
                            ${deductionBannerHtml}
                            
                            <!-- ÏöîÏïΩ Ïπ¥Îìú -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center;">
                                    <p style="color: #92400e; font-size: 12px; margin: 0;">Ï¥ù Ïù∏Ïõê</p>
                                    <p style="color: #b45309; font-size: 24px; font-weight: 700; margin: 8px 0 0;">${backup.totalUsers}Î™Ö</p>
                                </div>
                                <div style="background: #d1fae5; padding: 20px; border-radius: 12px; text-align: center;">
                                    <p style="color: #065f46; font-size: 12px; margin: 0;">Ï¥ù Ï†ÑÌà¨Î†•</p>
                                    <p style="color: #047857; font-size: 24px; font-weight: 700; margin: 8px 0 0;">${backup.totalPower.toLocaleString()}</p>
                                </div>
                                <div style="background: #dbeafe; padding: 20px; border-radius: 12px; text-align: center;">
                                    <p style="color: #1e40af; font-size: 12px; margin: 0;">ÌèâÍ∑† Ï†ÑÌà¨Î†•</p>
                                    <p style="color: #1d4ed8; font-size: 24px; font-weight: 700; margin: 8px 0 0;">${totalAvgPower.toLocaleString()}</p>
                                </div>
                                <div style="background: #e0e7ff; padding: 20px; border-radius: 12px; text-align: center;">
                                    <p style="color: #3730a3; font-size: 12px; margin: 0;">Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</p>
                                    <p style="color: ${diffColor}; font-size: 24px; font-weight: 700; margin: 8px 0 0;">${diffSign}${totalDiff.toLocaleString()}</p>
                                </div>
                            </div>
                            
                            <!-- Í∏∏ÎìúÎ≥Ñ ÌòÑÌô© -->
                            <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin: 0 0 16px;">üìä Í∏∏ÎìúÎ≥Ñ ÌòÑÌô©</h3>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                                <th style="padding: 12px; text-align: left; font-weight: 600;">Í∏∏Îìú</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600;">Ïù∏Ïõê</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600;">ÌèâÍ∑† Ï†ÑÌà¨Î†•</th>
                                                <th style="padding: 12px; text-align: right; font-weight: 600;">Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</th>
                                            </tr>
                                        </thead>
                                        <tbody>${guildStatsHtml}</tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Ï†ÑÏ≤¥ Î™ÖÎã® -->
                            <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin: 0 0 16px;">üë• Ï†ÑÏ≤¥ Î™ÖÎã® (${users.length}Î™Ö)</h3>
                                <div style="max-height: 600px; overflow-x: auto; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
                                        <thead style="position: sticky; top: 0; background: white;">
                                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">ÏàúÏúÑ</th>
                                                <th style="padding: 10px; text-align: left; font-weight: 600;">ÎãâÎÑ§ÏûÑ</th>
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">Í∏∏Îìú</th>
                                                <th style="padding: 10px; text-align: right; font-weight: 600;">Ï†ÑÌà¨Î†•</th>
                                                <th style="padding: 10px; text-align: right; font-weight: 600;">Ï¶ùÍ∞ê</th>
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">üõ°Ô∏èÌòïÏÉÅÏ†Ñ</th>
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">üëëÌòïÏÉÅÏã†</th>
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">üê¥ÌÉàÍ≤ÉÏ†Ñ</th>
                                                <th style="padding: 10px; text-align: center; font-weight: 600;">ü¶ÑÌÉàÍ≤ÉÏã†</th>
                                            </tr>
                                        </thead>
                                        <tbody>${usersHtml}</tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Ìë∏ÌÑ∞ -->
                            <div style="text-align: center; padding: 30px; color: #9ca3af; font-size: 12px;">
                                <p>Made with ‚ù§Ô∏è by ÏóêÎπÑÏ∏Ñ</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch(e) {
                console.error(e);
                document.body.innerHTML = `
                    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h1 style="font-size: 24px; color: #374151; margin-bottom: 12px;">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</h1>
                            <p style="color: #6b7280;">Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // ==================== Í≤åÏãúÌåê Í∏∞Îä• ====================
        async function showBoardPage() {
            // ÏÑ∏ÏÖò Ï≤¥ÌÅ¨
            if (sessionStorage.getItem('isAdmin') === 'true') { 
                isAdmin = true;
                if (sessionStorage.getItem('isSuperAdmin') === 'true') {
                    isSuperAdmin = true;
                }
                loggedInAdminId = sessionStorage.getItem('loggedInAdminId') || null;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('post');
            
            if (postId) {
                await showPostDetail(postId);
            } else {
                await showBoardList();
            }
        }
        

        // Í≤åÏãúÌåê Î™©Î°ù
        async function showBoardList() {
            document.title = 'üìã Í≤åÏãúÌåê - Ïò§Ïä§Ïπ¥2';
            
            // FirebaseÏóêÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
            let categories = [{ id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üìã', color: '#6366f1' }];
            try {
                const catDoc = await getDoc(doc(db, "config", "boardCategories"));
                if (catDoc.exists() && catDoc.data().list) {
                    categories = [{ id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üìã', color: '#6366f1' }, ...catDoc.data().list];
                } else {
                    // Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉùÏÑ±
                    const defaultCats = [
                        { id: 'notice', name: 'Í≥µÏßÄÏÇ¨Ìï≠', icon: 'üì¢', color: '#ef4444' },
                        { id: 'dia', name: 'Îã§Ïù¥ÏïÑ', icon: 'üíé', color: '#3b82f6' },
                        { id: 'backup', name: 'Ï£ºÍ∞ÑÎ∞±ÏóÖ', icon: 'üíæ', color: '#10b981' }
                    ];
                    await setDoc(doc(db, "config", "boardCategories"), { list: defaultCats });
                    categories = [{ id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üìã', color: '#6366f1' }, ...defaultCats];
                }
            } catch(e) { console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú Ïò§Î•ò:', e); }
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î•º windowÏóê Ï†ÄÏû• (Îã§Î•∏ Ìï®ÏàòÏóêÏÑú ÏÇ¨Ïö©)
            window.boardCategories = categories;
            
            const categoryTabs = categories.map(cat => 
                `<button class="category-tab" data-category="${cat.id}" style="--cat-color: ${cat.color};">${cat.icon} ${cat.name}</button>`
            ).join('');
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏòµÏÖò (Í∏ÄÏì∞Í∏∞Ïö©) - 'Ï†ÑÏ≤¥' Ï†úÏô∏
            const categoryOptions = categories.filter(c => c.id !== 'all').map(cat => 
                `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
            ).join('');
            
            document.body.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px;">
                    <div style="max-width: 900px; margin: 0 auto;">
                        <!-- Ìó§Îçî -->
                        <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                                <div>
                                    <h1 style="font-size: 24px; font-weight: 700; color: #1e40af; margin: 0 0 4px;">üìã Í≤åÏãúÌåê</h1>
                                    <p style="color: #64748b; font-size: 14px; margin: 0;">Ïò§Ïä§Ïπ¥2 Í∏∏Îìú Í≤åÏãúÌåê</p>
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <a href="${window.location.pathname}" style="text-decoration: none;">
                                        <button style="padding: 10px 16px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">üè† Î©îÏù∏ÏúºÎ°ú</button>
                                    </a>
                                    ${isSuperAdmin ? `
                                        <button onclick="openCategoryManageModal()" style="padding: 10px 16px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">‚öôÔ∏è Ïπ¥ÌÖåÍ≥†Î¶¨</button>
                                        <button onclick="openWritePostModal()" style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">‚úèÔ∏è Í∏ÄÏì∞Í∏∞</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ -->
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;" id="categoryTabs">
                            ${categoryTabs}
                        </div>
                        
                        <!-- Í≤åÏãúÍ∏Ä Î™©Î°ù -->
                        <div style="background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                            <div id="boardList" style="min-height: 200px;">
                                <div style="text-align: center; padding: 40px;">
                                    <div style="width:40px; height:40px; border:4px solid #f3f4f6; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
                                    <p style="margin-top: 16px; color: #6b7280;">Î°úÎî© Ï§ë...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ìë∏ÌÑ∞ -->
                        <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 12px;">
                            Made with ‚ù§Ô∏è by ÏóêÎπÑÏ∏Ñ
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin { to { transform: rotate(360deg); } }
                    .category-tab { padding: 8px 16px; border: 2px solid #e2e8f0; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
                    .category-tab:hover { border-color: var(--cat-color); color: var(--cat-color); }
                    .category-tab.active { background: var(--cat-color); color: white; border-color: var(--cat-color); }
                    .post-row { display: flex; padding: 16px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s; align-items: center; gap: 12px; }
                    .post-row:hover { background: #f8fafc; }
                    .post-row:last-child { border-bottom: none; }
                    .post-row.pinned { background: #fef3c7; }
                    .post-row.pinned:hover { background: #fde68a; }
                    .post-title { font-weight: 500; color: #1e293b; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                    .post-meta { display: flex; gap: 12px; font-size: 13px; color: #94a3b8; flex-shrink: 0; }
                    .post-badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 8px; }
                    .post-badge.new { background: #dbeafe; color: #1d4ed8; }
                    .post-badge.pinned { background: #fef3c7; color: #d97706; }
                    .board-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto; }
                    .board-modal { background: white; border-radius: 16px; max-width: 600px; margin: 40px auto; padding: 24px; }
                    .board-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
                    .board-input:focus { outline: none; border-color: #3b82f6; }
                    .board-textarea { min-height: 200px; resize: vertical; font-family: inherit; }
                    .board-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; }
                    .board-select { padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; width: 100%; }
                </style>
                
                <!-- Í∏ÄÏì∞Í∏∞/ÏàòÏ†ï Î™®Îã¨ -->
                <div id="boardModalOverlay" class="board-modal-overlay" onclick="if(event.target===this) closeBoardModal()">
                    <div class="board-modal">
                        <h2 id="boardModalTitle" style="font-size: 20px; font-weight: 600; color: #1e293b; margin: 0 0 20px;">‚úèÔ∏è Í∏ÄÏì∞Í∏∞</h2>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                            <select id="postCategoryInput" class="board-select">
                                ${categoryOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Ï†úÎ™©</label>
                            <input type="text" id="postTitleInput" class="board-input" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="100">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">ÎÇ¥Ïö©</label>
                            <textarea id="postContentInput" class="board-input board-textarea" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">üîó ÎßÅÌÅ¨ Ï≤®Î∂Ä (ÏÑ†ÌÉù)</label>
                            <input type="text" id="postLinkInput" class="board-input" placeholder="https://... (Î∞îÎ°úÍ∞ÄÍ∏∞ Î≤ÑÌäºÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§)">
                            <input type="text" id="postLinkTextInput" class="board-input" placeholder="Î≤ÑÌäº ÌÖçÏä§Ìä∏ (Ïòà: Ï†ÑÌà¨Î†• ÌòÑÌô© Î≥¥Í∏∞)" style="margin-top: 8px;">
                        </div>
                        <div style="margin-bottom: 20px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="postPinnedInput" style="width: 18px; height: 18px;">
                                <span style="font-size: 14px; font-weight: 500; color: #92400e;">üìå Í≥µÏßÄÏÇ¨Ìï≠ (Î™©Î°ù ÏÉÅÎã®Ïóê Í≥†Ï†ï)</span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 8px;">
                            <button onclick="closeBoardModal()" class="board-btn" style="background: #f1f5f9; color: #475569;">Ï∑®ÏÜå</button>
                            <button id="boardSubmitBtn" onclick="submitPost()" class="board-btn" style="background: #3b82f6; color: white;">Îì±Î°ù</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ -->
                <div id="categoryModalOverlay" class="board-modal-overlay" onclick="if(event.target===this) closeCategoryModal()">
                    <div class="board-modal">
                        <h2 style="font-size: 20px; font-weight: 600; color: #1e293b; margin: 0 0 20px;">‚öôÔ∏è Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨</h2>
                        <div id="categoryList" style="margin-bottom: 20px;"></div>
                        <div style="border-top: 1px solid #e2e8f0; padding-top: 16px;">
                            <p style="font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 12px;">‚ûï ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä</p>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <input type="text" id="newCatIcon" class="board-input" placeholder="ÏïÑÏù¥ÏΩò (Ïòà: üì¢)" style="width: 80px;">
                                <input type="text" id="newCatName" class="board-input" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ" style="flex: 1;">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="newCatId" class="board-input" placeholder="ID (ÏòÅÎ¨∏)" style="flex: 1;">
                                <input type="color" id="newCatColor" value="#6366f1" style="width: 50px; height: 44px; border: 1px solid #e2e8f0; border-radius: 8px;">
                                <button onclick="addCategory()" class="board-btn" style="background: #10b981; color: white;">Ï∂îÍ∞Ä</button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px;">
                            <button onclick="closeCategoryModal()" class="board-btn" style="background: #f1f5f9; color: #475569;">Îã´Í∏∞</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadBoardList(this.dataset.category);
                });
            });
            
            // Í∏∞Î≥∏ 'Ï†ÑÏ≤¥' ÌôúÏÑ±Ìôî
            document.querySelector('.category-tab[data-category="all"]').classList.add('active');
            
            await loadBoardList('all');
        }
        
        // Í≤åÏãúÍ∏Ä Î™©Î°ù Î°úÎìú
        async function loadBoardList(category = 'all') {
            try {
                const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                
                const boardList = document.getElementById('boardList');
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
                let posts = [];
                snap.forEach((docSnap) => {
                    const post = docSnap.data();
                    post.id = docSnap.id;
                    if (category === 'all' || post.category === category) {
                        posts.push(post);
                    }
                });
                
                // Í≥µÏßÄÏÇ¨Ìï≠(isPinned) Î®ºÏ†Ä, Í∑∏ Îã§Ïùå ÏµúÏã†Ïàú
                posts.sort((a, b) => {
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;
                    return b.createdAt - a.createdAt;
                });
                
                if (posts.length === 0) {
                    boardList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                            <p style="color: #64748b; font-size: 16px;">Îì±Î°ùÎêú Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    `;
                    return;
                }
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const categories = window.boardCategories || [];
                const getCatInfo = (catId) => {
                    const cat = categories.find(c => c.id === catId);
                    return cat ? { name: cat.name, icon: cat.icon, color: cat.color } : { name: catId, icon: 'üìã', color: '#6366f1' };
                };
                
                let html = '';
                posts.forEach((post) => {
                    const date = new Date(post.createdAt).toLocaleDateString('ko-KR');
                    const isNew = (Date.now() - post.createdAt) < 3 * 24 * 60 * 60 * 1000;
                    const catInfo = getCatInfo(post.category);
                    const pinnedClass = post.isPinned ? ' pinned' : '';
                    
                    html += `
                        <div class="post-row${pinnedClass}" onclick="location.href='?page=dia&post=${post.id}'">
                            ${post.isPinned ? '<span class="post-badge pinned">üìå Í≥µÏßÄ</span>' : `<span class="post-badge" style="background:${catInfo.color}20; color:${catInfo.color};">${catInfo.icon} ${catInfo.name}</span>`}
                            <div class="post-title">
                                ${isNew && !post.isPinned ? '<span class="post-badge new">NEW</span>' : ''}
                                ${post.title}
                                ${post.link ? 'üîó' : ''}
                            </div>
                            <div class="post-meta">
                                <span>üëÅÔ∏è ${post.views || 0}</span>
                                <span>${date}</span>
                            </div>
                        </div>
                    `;
                });
                
                boardList.innerHTML = html;
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä Î°úÎìú Ïò§Î•ò:', e);
                document.getElementById('boardList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.
                    </div>
                `;
            }
        }
        
        // Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏
        async function showPostDetail(postId) {
            document.body.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px;">
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="text-align: center; padding: 40px;">
                            <div style="width:40px; height:40px; border:4px solid #f3f4f6; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
                            <p style="margin-top: 16px; color: #6b7280;">Î°úÎî© Ï§ë...</p>
                        </div>
                    </div>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            `;
            
            try {
                const postRef = doc(db, "posts", postId);
                const postDoc = await getDoc(postRef);
                
                if (!postDoc.exists()) {
                    document.body.innerHTML = `
                        <div style="min-height: 100vh; background: #f9fafb; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                                <h1 style="font-size: 24px; color: #374151; margin-bottom: 12px;">Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h1>
                                <a href="?page=dia" style="color: #3b82f6;">Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä
                await updateDoc(postRef, {
                    views: (postDoc.data().views || 0) + 1
                });
                
                const post = postDoc.data();
                const createdDate = formatDateTime(post.createdAt);
                const updatedDate = post.updatedAt ? formatDateTime(post.updatedAt) : null;
                
                // ÎÇ¥Ïö©ÏóêÏÑú Ï§ÑÎ∞îÍøà Ï≤òÎ¶¨
                const contentHtml = (post.content || '').replace(/\n/g, '<br>');
                
                // ÎßÅÌÅ¨ Î≤ÑÌäº
                const linkButtonHtml = post.link ? `
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px dashed #e2e8f0; text-align: center;">
                        <a href="${post.link}" target="_blank" style="display: inline-block; padding: 14px 32px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 15px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transition: transform 0.2s, box-shadow 0.2s;">
                            üîó ${post.linkText || 'Î∞îÎ°úÍ∞ÄÍ∏∞'}
                        </a>
                    </div>
                ` : '';
                
                // Í≥µÏßÄÏÇ¨Ìï≠ Î∞∞ÏßÄ
                const pinnedBadge = post.isPinned ? `<span style="background: #fef3c7; color: #d97706; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">üìå Í≥µÏßÄÏÇ¨Ìï≠</span>` : '';
                
                document.title = `${post.title} - Ïò§Ïä§Ïπ¥2 Í≤åÏãúÌåê`;
                document.body.innerHTML = `
                    <div style="min-height: 100vh; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px;">
                        <div style="max-width: 900px; margin: 0 auto;">
                            <!-- Ìó§Îçî -->
                            <div style="margin-bottom: 20px;">
                                <a href="?page=dia" style="display: inline-flex; align-items: center; gap: 6px; color: #64748b; text-decoration: none; font-size: 14px;">
                                    ‚Üê Î™©Î°ùÏúºÎ°ú
                                </a>
                            </div>
                            
                            <!-- Í≤åÏãúÍ∏Ä -->
                            <div style="background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                                <!-- Ï†úÎ™© ÏòÅÏó≠ -->
                                <div style="padding: 24px; border-bottom: 1px solid #f1f5f9;">
                                    <div style="margin-bottom: 8px; display: flex; gap: 8px; align-items: center;">
                                        ${pinnedBadge}
                                    </div>
                                    <h1 style="font-size: 22px; font-weight: 600; color: #1e293b; margin: 0 0 12px; line-height: 1.4;">${post.title}</h1>
                                    <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: #94a3b8;">
                                        <span>‚úçÔ∏è ${post.author || 'Í¥ÄÎ¶¨Ïûê'}</span>
                                        <span>üìÖ ${createdDate}</span>
                                        <span>üëÅÔ∏è ${(post.views || 0) + 1}</span>
                                        ${updatedDate ? `<span style="color: #f59e0b;">‚úèÔ∏è ÏàòÏ†ïÎê® ${updatedDate}</span>` : ''}
                                    </div>
                                </div>
                                
                                <!-- ÎÇ¥Ïö© ÏòÅÏó≠ -->
                                <div style="padding: 24px; min-height: 200px; line-height: 1.8; color: #374151; font-size: 15px;">
                                    ${contentHtml}
                                    ${linkButtonHtml}
                                </div>
                                
                                <!-- Î≤ÑÌäº ÏòÅÏó≠ -->
                                ${isSuperAdmin ? `
                                <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 8px;">
                                    <button onclick="editPost('${postId}')" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">‚úèÔ∏è ÏàòÏ†ï</button>
                                    <button onclick="deletePost('${postId}')" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">üóëÔ∏è ÏÇ≠Ï†ú</button>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Ìë∏ÌÑ∞ -->
                            <div style="text-align: center; padding: 20px; color: #94a3b8; font-size: 12px;">
                                Made with ‚ù§Ô∏è by ÏóêÎπÑÏ∏Ñ
                            </div>
                        </div>
                    </div>
                `;
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ïò§Î•ò:', e);
                document.body.innerHTML = `
                    <div style="min-height: 100vh; background: #f9fafb; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h1 style="font-size: 24px; color: #374151; margin-bottom: 12px;">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</h1>
                            <a href="?page=dia" style="color: #3b82f6;">Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
                        </div>
                    </div>
                `;
            }
        }
        
        // Í∏ÄÏì∞Í∏∞ Î™®Îã¨ Ïó¥Í∏∞
        window.openWritePostModal = function() {
            document.getElementById('boardModalTitle').textContent = '‚úèÔ∏è Í∏ÄÏì∞Í∏∞';
            document.getElementById('postCategoryInput').value = document.getElementById('postCategoryInput').options[0]?.value || 'notice';
            document.getElementById('postTitleInput').value = '';
            document.getElementById('postContentInput').value = '';
            document.getElementById('postLinkInput').value = '';
            document.getElementById('postLinkTextInput').value = '';
            document.getElementById('postPinnedInput').checked = false;
            document.getElementById('boardSubmitBtn').onclick = () => submitPost();
            document.getElementById('boardModalOverlay').style.display = 'block';
        };
        
        // Í≤åÏãúÍ∏Ä ÏàòÏ†ï
        window.editPost = async function(postId) {
            try {
                const postDoc = await getDoc(doc(db, "posts", postId));
                if (!postDoc.exists()) {
                    alert('Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                const post = postDoc.data();
                
                // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏòµÏÖò
                const categories = window.boardCategories || [];
                const categoryOptions = categories.filter(c => c.id !== 'all').map(cat => 
                    `<option value="${cat.id}" ${post.category === cat.id ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                ).join('');
                
                // ÏàòÏ†ï Î™®Îã¨ ÌëúÏãú
                document.body.innerHTML += `
                    <div id="editModalOverlay" style="display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto;">
                        <div style="background: white; border-radius: 16px; max-width: 600px; margin: 40px auto; padding: 24px;">
                            <h2 style="font-size: 20px; font-weight: 600; color: #1e293b; margin: 0 0 20px;">‚úèÔ∏è Í≤åÏãúÍ∏Ä ÏàòÏ†ï</h2>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                                <select id="editCategoryInput" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                    ${categoryOptions}
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Ï†úÎ™©</label>
                                <input type="text" id="editTitleInput" value="${post.title}" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;" maxlength="100">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">ÎÇ¥Ïö©</label>
                                <textarea id="editContentInput" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; min-height: 200px; resize: vertical; font-family: inherit;">${post.content}</textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">üîó ÎßÅÌÅ¨</label>
                                <input type="text" id="editLinkInput" value="${post.link || ''}" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                <input type="text" id="editLinkTextInput" value="${post.linkText || ''}" placeholder="Î≤ÑÌäº ÌÖçÏä§Ìä∏" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; margin-top: 8px;">
                            </div>
                            <div style="margin-bottom: 20px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="editPinnedInput" ${post.isPinned ? 'checked' : ''} style="width: 18px; height: 18px;">
                                    <span style="font-size: 14px; font-weight: 500; color: #92400e;">üìå Í≥µÏßÄÏÇ¨Ìï≠ (Î™©Î°ù ÏÉÅÎã®Ïóê Í≥†Ï†ï)</span>
                                </label>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                                <button onclick="document.getElementById('editModalOverlay').remove()" style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">Ï∑®ÏÜå</button>
                                <button onclick="updatePost('${postId}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">ÏàòÏ†ï ÏôÑÎ£å</button>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä ÏàòÏ†ï Ïò§Î•ò:', e);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        
        // Í≤åÏãúÍ∏Ä ÏóÖÎç∞Ïù¥Ìä∏
        window.updatePost = async function(postId) {
            const category = document.getElementById('editCategoryInput').value;
            const title = document.getElementById('editTitleInput').value.trim();
            const content = document.getElementById('editContentInput').value.trim();
            const link = document.getElementById('editLinkInput').value.trim();
            const linkText = document.getElementById('editLinkTextInput').value.trim();
            const isPinned = document.getElementById('editPinnedInput').checked;
            
            if (!title) {
                alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const updateData = {
                    category: category,
                    title: title,
                    content: content,
                    isPinned: isPinned,
                    updatedAt: Date.now()
                };
                
                if (link) {
                    updateData.link = link;
                    updateData.linkText = linkText || 'Î∞îÎ°úÍ∞ÄÍ∏∞';
                } else {
                    updateData.link = null;
                    updateData.linkText = null;
                }
                
                await updateDoc(doc(db, "posts", postId), updateData);
                
                alert('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                location.reload();
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', e);
                alert('ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        
        // Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú
        window.deletePost = async function(postId) {
            if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            try {
                await deleteDoc(doc(db, "posts", postId));
                alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                location.href = '?page=dia';
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä ÏÇ≠Ï†ú Ïò§Î•ò:', e);
                alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        
        // Î™®Îã¨ Îã´Í∏∞
        window.closeBoardModal = function() {
            document.getElementById('boardModalOverlay').style.display = 'none';
        };
        
        // Í≤åÏãúÍ∏Ä Îì±Î°ù
        window.submitPost = async function() {
            const category = document.getElementById('postCategoryInput').value;
            const title = document.getElementById('postTitleInput').value.trim();
            const content = document.getElementById('postContentInput').value.trim();
            const link = document.getElementById('postLinkInput').value.trim();
            const linkText = document.getElementById('postLinkTextInput').value.trim();
            const isPinned = document.getElementById('postPinnedInput').checked;
            
            if (!title) {
                alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            try {
                const postId = `post_${Date.now()}`;
                const postData = {
                    category: category,
                    title: title,
                    content: content,
                    author: 'ÏóêÎπÑÏ∏Ñ',
                    views: 0,
                    isPinned: isPinned,
                    createdAt: Date.now()
                };
                
                // ÎßÅÌÅ¨Í∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
                if (link) {
                    postData.link = link;
                    postData.linkText = linkText || 'Î∞îÎ°úÍ∞ÄÍ∏∞';
                }
                
                await setDoc(doc(db, "posts", postId), postData);
                
                alert('Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
                closeBoardModal();
                await loadBoardList('all');
                
            } catch(e) {
                console.error('Í≤åÏãúÍ∏Ä Îì±Î°ù Ïò§Î•ò:', e);
                alert('Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨
        window.openCategoryManageModal = async function() {
            document.getElementById('categoryModalOverlay').style.display = 'block';
            await loadCategoryList();
        };
        
        window.closeCategoryModal = function() {
            document.getElementById('categoryModalOverlay').style.display = 'none';
        };
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù Î°úÎìú
        async function loadCategoryList() {
            const categories = (window.boardCategories || []).filter(c => c.id !== 'all');
            const listEl = document.getElementById('categoryList');
            
            if (categories.length === 0) {
                listEl.innerHTML = '<p style="color: #6b7280; text-align: center;">Îì±Î°ùÎêú Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            let html = '';
            categories.forEach((cat, idx) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="flex: 1; font-weight: 500;">${cat.name}</span>
                        <span style="font-size: 12px; color: #6b7280;">${cat.id}</span>
                        <span style="width: 24px; height: 24px; border-radius: 4px; background: ${cat.color};"></span>
                        <button onclick="deleteCategory('${cat.id}')" style="padding: 6px 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">ÏÇ≠Ï†ú</button>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä
        window.addCategory = async function() {
            const icon = document.getElementById('newCatIcon').value.trim();
            const name = document.getElementById('newCatName').value.trim();
            const id = document.getElementById('newCatId').value.trim().toLowerCase();
            const color = document.getElementById('newCatColor').value;
            
            if (!icon || !name || !id) {
                alert('Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!/^[a-z0-9]+$/.test(id)) {
                alert('IDÎäî ÏòÅÎ¨∏ ÏÜåÎ¨∏ÏûêÏôÄ Ïà´ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }
            
            try {
                const categories = (window.boardCategories || []).filter(c => c.id !== 'all');
                
                if (categories.find(c => c.id === id)) {
                    alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî IDÏûÖÎãàÎã§.');
                    return;
                }
                
                categories.push({ id, name, icon, color });
                await setDoc(doc(db, "config", "boardCategories"), { list: categories });
                
                window.boardCategories = [{ id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üìã', color: '#6366f1' }, ...categories];
                
                // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
                document.getElementById('newCatIcon').value = '';
                document.getElementById('newCatName').value = '';
                document.getElementById('newCatId').value = '';
                
                await loadCategoryList();
                alert('Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                
            } catch(e) {
                console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä Ïò§Î•ò:', e);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        
        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†ú
        window.deleteCategory = async function(catId) {
            if (!confirm(`'${catId}' Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÌï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Í≤åÏãúÍ∏ÄÏùÄ Ïú†ÏßÄÎê©ÎãàÎã§.`)) return;
            
            try {
                const categories = (window.boardCategories || []).filter(c => c.id !== 'all' && c.id !== catId);
                await setDoc(doc(db, "config", "boardCategories"), { list: categories });
                
                window.boardCategories = [{ id: 'all', name: 'Ï†ÑÏ≤¥', icon: 'üìã', color: '#6366f1' }, ...categories];
                
                await loadCategoryList();
                alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                
            } catch(e) {
                console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†ú Ïò§Î•ò:', e);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        };
        // ==================== Í≤åÏãúÌåê Í∏∞Îä• ÎÅù ====================
       
        async function checkDuplicateNicknames() {
            if (!isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                const nicknameMap = {};
                
                querySnapshot.forEach((docSnap) => {
                    const user = docSnap.data();
                    const name = user.name;
                    const guild = user.guild;
                    
                    if (!nicknameMap[name]) {
                        nicknameMap[name] = [];
                    }
                    nicknameMap[name].push(guild);
                });
                
               
                const duplicates = [];
                for (const [name, guilds] of Object.entries(nicknameMap)) {
                    if (guilds.length > 1) {
                        duplicates.push({ name, guilds });
                    }
                }
                
                if (duplicates.length > 0) {
                    let alertMsg = '‚ö†Ô∏è Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Î∞úÍ≤¨!\n\n';
                    duplicates.forEach(dup => {
                        alertMsg += `‚Ä¢ ${dup.name}: ${dup.guilds.join(', ')}\n`;
                    });
                    alertMsg += '\nÏú†Ï†Ä Í¥ÄÎ¶¨ÏóêÏÑú Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî.';
                    
                   
                    showDuplicateAlert(duplicates);
                }
            } catch (e) {
                console.error('Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Ï≤¥ÌÅ¨ Ïò§Î•ò:', e);
            }
        }
        
       
        function showDuplicateAlert(duplicates) {
            openLargeModal('‚ö†Ô∏è Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Í≤ΩÍ≥†', 'Îã§Î•∏ Í∏∏ÎìúÏóê ÎèôÏùºÌïú ÎãâÎÑ§ÏûÑÏù¥ Ï°¥Ïû¨Ìï©ÎãàÎã§');
            
            let html = `
                <div style="background:#fef2f2; border:2px solid #ef4444; border-radius:12px; padding:20px; margin-bottom:16px;">
                    <p style="color:#dc2626; font-weight:600; margin-bottom:12px;">üö® ÏïÑÎûò ÎãâÎÑ§ÏûÑÏù¥ Ïó¨Îü¨ Í∏∏ÎìúÏóê Ï§ëÎ≥µÎêòÏñ¥ ÏûàÏäµÎãàÎã§!</p>
                    <p style="color:#7f1d1d; font-size:13px;">ÎèôÏùºÏù∏Ïù¥ÎùºÎ©¥ ÌïòÎÇòÎ°ú ÌÜµÌï©ÌïòÍ≥†, Îã§Î•∏ ÏÇ¨ÎûåÏù¥ÎùºÎ©¥ ÎãâÎÑ§ÏûÑÏùÑ Î≥ÄÍ≤ΩÌï¥Ï£ºÏÑ∏Ïöî.</p>
                </div>
                <div class="table-scroll-container">
                    <table class="common-table">
                        <thead>
                            <tr>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>ÏÜåÏÜç Í∏∏Îìú</th>
                                <th>Ï§ëÎ≥µ Í∞úÏàò</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            duplicates.forEach(dup => {
                html += `<tr>
                    <td><strong style="color:#dc2626;">${dup.name}</strong></td>
                    <td>${dup.guilds.map(g => `<span style="background:#fee2e2; padding:2px 8px; border-radius:4px; margin:2px; display:inline-block;">${g}</span>`).join(' ')}</td>
                    <td><span style="background:#ef4444; color:white; padding:2px 8px; border-radius:4px; font-weight:600;">${dup.guilds.length}Í∞ú</span></td>
                </tr>`;
            });
            
            html += `</tbody></table></div>
                <div style="margin-top:16px; text-align:right;">
                    <button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>
                </div>`;
            
            setModalBody(html);
            document.getElementById('modalFooter').style.display = 'none';
        }
        
       
        async function checkAutoLogin() {
            const autoLogin = localStorage.getItem('autoLogin');
            if (autoLogin) {
                try {
                    const data = JSON.parse(autoLogin);
                    const userDoc = await getDoc(doc(db, "users", data.username));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                       
                        if (userData.password === data.password) {
                            loggedInUser = data.username;
                            console.log('ÏûêÎèô Î°úÍ∑∏Ïù∏:', loggedInUser);
                        } else {
                           
                            localStorage.removeItem('autoLogin');
                        }
                    } else {
                       
                        localStorage.removeItem('autoLogin');
                    }
                } catch (e) {
                    console.error('ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏóêÎü¨:', e);
                    localStorage.removeItem('autoLogin');
                }
            }
        }

        async function loadSpreadsheetConfig() {
            try {
                const docRef = doc(db, "config", "spreadsheet");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    spreadsheetConfig = docSnap.data();
                    syncExcludeList = spreadsheetConfig.excludeList || [];
                    powerMaskingEnabled = spreadsheetConfig.powerMaskingEnabled || false;
                }
            } catch (e) {
                console.log("Spreadsheet config error", e);
            }
        }

        async function checkLockStatus() {
            try {
                const docRef = doc(db, "config", "system");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lockStartTime = data.lockStartTime || 0;
                    lockEndTime = data.lockEndTime || 0;
                    biweeklyBaseTime = data.biweeklyBaseTime || 0;
                    
                    // 2Ï£º Î∞òÎ≥µÏù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÍ≥†, ÌòÑÏû¨ Ïû†Í∏à Í∏∞Í∞ÑÏù¥ ÏßÄÎÇ¨ÏúºÎ©¥ Îã§Ïùå Í∏∞Í∞ÑÏúºÎ°ú ÏûêÎèô Í∞±Ïã†
                    if (biweeklyBaseTime > 0 && lockEndTime > 0) {
                        const now = Date.now();
                        if (now > lockEndTime) {
                            // Îã§Ïùå 2Ï£º Í∏∞Í∞Ñ Í≥ÑÏÇ∞
                            const twoWeeksMs = 14 * 24 * 60 * 60 * 1000;
                            let newStart = lockStartTime;
                            let newEnd = lockEndTime;
                            
                            // ÌòÑÏû¨ ÏãúÍ∞ÑÏù¥ ÏßÄÎÇ† ÎïåÍπåÏßÄ 2Ï£ºÏî© Ï∂îÍ∞Ä
                            while (newEnd < now) {
                                newStart += twoWeeksMs;
                                newEnd += twoWeeksMs;
                            }
                            
                            // Firebase ÏóÖÎç∞Ïù¥Ìä∏
                            await setDoc(docRef, {
                                lockStartTime: newStart,
                                lockEndTime: newEnd,
                                biweeklyBaseTime: biweeklyBaseTime,
                                lockType: 'biweekly'
                            });
                            
                            lockStartTime = newStart;
                            lockEndTime = newEnd;
                            console.log('2Ï£º Î∞òÎ≥µ Ïû†Í∏à ÏûêÎèô Í∞±Ïã†:', formatKSTDateTime(newStart), '~', formatKSTDateTime(newEnd));
                        }
                    }
                }
                updateLockUI();
            } catch (e) { console.log("Config error", e); }
        }

        function isSystemLocked() { 
            const now = Date.now();
            return (lockStartTime > 0 && lockEndTime > 0 && now >= lockStartTime && now <= lockEndTime); 
        }

        function updateLockUI() {
            const banner = document.getElementById('lockBanner');
            const addUserBtn = document.getElementById('addUserBtn');
            if (isSystemLocked() && !isSuperAdmin) {
                banner.classList.add('active');
                addUserBtn.classList.add('disabled');
                const remainMs = lockEndTime - Date.now();
                const remainHours = Math.ceil(remainMs / (1000 * 60 * 60));
                const biweeklyText = biweeklyBaseTime > 0 ? ' (2Ï£º Î∞òÎ≥µ)' : '';
                banner.innerText = `‚õî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§ | Í∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)}${biweeklyText} (ÏïΩ ${remainHours}ÏãúÍ∞Ñ ÎÇ®Ïùå)`;
            } else {
                banner.classList.remove('active');
                addUserBtn.classList.remove('disabled');
            }
        }

        async function checkPendingUsers() {
            if (!isAdmin) return;
            const q = query(collection(db, "pendingUsers"));
            const snapshot = await getDocs(q);
            const count = snapshot.size;
            
            const badge = document.getElementById('pendingBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
                showAlert(`ÏäπÏù∏ ÏöîÏ≤≠Ïù¥ ${count}Í∞ú ÎèÑÏ∞©ÌïòÏòÄÏäµÎãàÎã§`, 'success');
            } else {
                badge.style.display = 'none';
            }
        }

        function updateAdminUI() {
            const btn = document.getElementById('adminLoginBtn');
            if(isAdmin) {
                btn.textContent = isSuperAdmin ? 'ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎãò' : 'Í¥ÄÎ¶¨ÏûêÎãò'; 
                btn.classList.add('logged-in');
                document.querySelectorAll('.admin-only').forEach(el => {
                    if(el.classList.contains('admin-dropdown')) {
                        el.style.display = 'inline-block';
                    } else if(el.classList.contains('admin-dropdown-item')) {
                        el.style.display = 'flex';
                    } else if(el.classList.contains('admin-dropdown-divider')) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'inline-flex';
                    }
                });
               
                if(isSuperAdmin) {
                    document.querySelectorAll('.super-admin-only').forEach(el => {
                        if(el.classList.contains('admin-dropdown-item')) {
                            el.style.display = 'flex';
                        } else if(el.classList.contains('admin-dropdown-divider')) {
                            el.style.display = 'block';
                        } else {
                            el.style.display = 'inline-flex';
                        }
                    });
                } else {
                    document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
                }
                updateLockUI();
            } else {
               
                btn.textContent = 'Í¥ÄÎ¶¨Ïûê';
                btn.classList.remove('logged-in');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            }
        }

        const formatDateTime = (d) => {
            const date = toKST(d);
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${String(date.getUTCDate()).padStart(2,'0')} ` +
                   `${String(date.getUTCHours()).padStart(2,'0')}:${String(date.getUTCMinutes()).padStart(2,'0')}:${String(date.getUTCSeconds()).padStart(2,'0')}`;
        };

        async function getIp() { 
            try { 
                // Ï≤´ Î≤àÏß∏ ÏãúÎèÑ: ipify
                const res = await fetch('https://api.ipify.org?format=json', { timeout: 3000 }); 
                return (await res.json()).ip; 
            } catch (e) { 
                try {
                    // Îëê Î≤àÏß∏ ÏãúÎèÑ: ipapi.co
                    const res2 = await fetch('https://ipapi.co/ip/', { timeout: 3000 });
                    return await res2.text();
                } catch (e2) {
                    try {
                        // ÏÑ∏ Î≤àÏß∏ ÏãúÎèÑ: ifconfig.me
                        const res3 = await fetch('https://ifconfig.me/ip', { timeout: 3000 });
                        return await res3.text();
                    } catch (e3) {
                        return '-';
                    }
                }
            } 
        }
        
        // User Agent ÌååÏã± Ìï®Ïàò
        function parseUserAgent(ua) {
            if (!ua) return 'Ïïå Ïàò ÏóÜÏùå';
            
            let device = '';
            let browser = '';
            
            // Í∏∞Í∏∞ Í∞êÏßÄ - Îçî ÏÑ∏Î∂ÑÌôî
            if (/iPhone/.test(ua)) {
                // iPhone Î™®Îç∏ ÏÑ∏Î∂Ä Ï†ïÎ≥¥ (iOS Î≤ÑÏ†ÑÏúºÎ°ú Ï∂îÏ†ï)
                if (/iPhone.*OS\s*(\d+)/.test(ua)) {
                    const ver = parseInt(ua.match(/iPhone.*OS\s*(\d+)/)[1]);
                    if (ver >= 18) device = 'ÏïÑÏù¥Ìè∞16';
                    else if (ver >= 17) device = 'ÏïÑÏù¥Ìè∞15';
                    else if (ver >= 16) device = 'ÏïÑÏù¥Ìè∞14';
                    else if (ver >= 15) device = 'ÏïÑÏù¥Ìè∞13';
                    else if (ver >= 14) device = 'ÏïÑÏù¥Ìè∞12';
                    else device = 'ÏïÑÏù¥Ìè∞';
                } else {
                    device = 'ÏïÑÏù¥Ìè∞';
                }
            } else if (/iPad/.test(ua)) {
                device = 'ÏïÑÏù¥Ìå®Îìú';
            // Í∞§Îü≠Ïãú S ÏãúÎ¶¨Ï¶à ÏÑ∏Î∂ÑÌôî
            } else if (/SM-S93[89]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS24Ïö∏Ìä∏Îùº';
            } else if (/SM-S92[16]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS24+';
            } else if (/SM-S92[01]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS24';
            } else if (/SM-S91[89]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS23Ïö∏Ìä∏Îùº';
            } else if (/SM-S91[16]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS23+';
            } else if (/SM-S91[01]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS23';
            } else if (/SM-S90[89]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS22Ïö∏Ìä∏Îùº';
            } else if (/SM-S90[16]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS22+';
            } else if (/SM-S90[01]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS22';
            } else if (/SM-G99[89]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS21Ïö∏Ìä∏Îùº';
            } else if (/SM-G99[16]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS21+';
            } else if (/SM-G99[01]/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúS21';
            // Í∞§Îü≠Ïãú Ìè¥Îìú ÏãúÎ¶¨Ï¶à ÏÑ∏Î∂ÑÌôî
            } else if (/SM-F956/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú6';
            } else if (/SM-F946/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú5';
            } else if (/SM-F936/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú4';
            } else if (/SM-F926/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú3';
            } else if (/SM-F916/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú2';
            } else if (/SM-F9\d+/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌè¥Îìú';
            // Í∞§Îü≠Ïãú ÌîåÎ¶Ω ÏãúÎ¶¨Ï¶à ÏÑ∏Î∂ÑÌôî
            } else if (/SM-F756/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω6';
            } else if (/SM-F731/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω5';
            } else if (/SM-F721/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω4';
            } else if (/SM-F711/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω3';
            } else if (/SM-F700/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω';
            } else if (/SM-F7\d+/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÌîåÎ¶Ω';
            // Í∞§Îü≠Ïãú ÎÖ∏Ìä∏ ÏãúÎ¶¨Ï¶à
            } else if (/SM-N98\d/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÎÖ∏Ìä∏20';
            } else if (/SM-N97\d/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÎÖ∏Ìä∏10';
            } else if (/SM-N9\d+/i.test(ua)) {
                device = 'Í∞§Îü≠ÏãúÎÖ∏Ìä∏';
            // Í∞§Îü≠Ïãú A ÏãúÎ¶¨Ï¶à
            } else if (/SM-A\d+/i.test(ua)) {
                const match = ua.match(/SM-A(\d)\d+/i);
                if (match) {
                    device = `Í∞§Îü≠ÏãúA${match[1]}0ÏãúÎ¶¨Ï¶à`;
                } else {
                    device = 'Í∞§Îü≠ÏãúAÏãúÎ¶¨Ï¶à';
                }
            } else if (/Samsung|SM-/i.test(ua)) {
                device = 'Í∞§Îü≠Ïãú';
            } else if (/Android/.test(ua)) {
                device = 'ÏïàÎìúÎ°úÏù¥Îìú';
            } else if (/Macintosh/.test(ua)) {
                device = 'Îß•';
            } else if (/Windows/.test(ua)) {
                device = 'PC';
            } else if (/Linux/.test(ua)) {
                device = 'Î¶¨ÎàÖÏä§';
            } else {
                device = 'Í∏∞ÌÉÄ';
            }
            
            // Î∏åÎùºÏö∞Ï†Ä Í∞êÏßÄ
            if (/Whale/.test(ua)) {
                browser = 'Ïõ®Ïùº';
            } else if (/SamsungBrowser/.test(ua)) {
                browser = 'ÏÇºÏÑ±Î∏åÎùºÏö∞Ï†Ä';
            } else if (/Edg/.test(ua)) {
                browser = 'Ïó£ÏßÄ';
            } else if (/Firefox/.test(ua)) {
                browser = 'ÌååÏù¥Ïñ¥Ìè≠Ïä§';
            } else if (/OPR|Opera/.test(ua)) {
                browser = 'Ïò§ÌéòÎùº';
            } else if (/Chrome/.test(ua) && !/Chromium/.test(ua)) {
                browser = 'ÌÅ¨Î°¨';
            } else if (/Safari/.test(ua) && !/Chrome/.test(ua)) {
                browser = 'ÏÇ¨ÌååÎ¶¨';
            } else {
                browser = 'Í∏∞ÌÉÄ';
            }
            
            return `${device}-${browser}`;
        }
        
        // ÏòÅÏñ¥ ÏúÑÏπò ‚Üí ÌïúÍ∏Ä Î≥ÄÌôò Ìï®Ïàò
        function translateLocation(loc) {
            if (!loc || loc === '-' || loc === '') return '-';
            
            // Î™®Îì† Î≥ÄÌôò Îßµ ÌÜµÌï© (Í∏¥ Î¨∏ÏûêÏó¥Î∂ÄÌÑ∞ Î≥ÄÌôòÌïòÍ∏∞ ÏúÑÌï¥ Ï†ïÎ†¨)
            const translateMap = {
                // Íµ≠Í∞ÄÎ™Ö
                'South Korea': 'ÎåÄÌïúÎØºÍµ≠', 'Korea': 'ÎåÄÌïúÎØºÍµ≠',
                'United States': 'ÎØ∏Íµ≠', 'USA': 'ÎØ∏Íµ≠',
                'Japan': 'ÏùºÎ≥∏', 'China': 'Ï§ëÍµ≠', 'Taiwan': 'ÎåÄÎßå',
                'Vietnam': 'Î≤†Ìä∏ÎÇ®', 'Thailand': 'ÌÉúÍµ≠', 'Philippines': 'ÌïÑÎ¶¨ÌïÄ',
                'Singapore': 'Ïã±Í∞ÄÌè¨Î•¥', 'Malaysia': 'ÎßêÎ†àÏù¥ÏãúÏïÑ', 'Indonesia': 'Ïù∏ÎèÑÎÑ§ÏãúÏïÑ',
                'Australia': 'Ìò∏Ï£º', 'Canada': 'Ï∫êÎÇòÎã§', 'United Kingdom': 'ÏòÅÍµ≠', 'UK': 'ÏòÅÍµ≠',
                'Germany': 'ÎèÖÏùº', 'France': 'ÌîÑÎûëÏä§', 'Italy': 'Ïù¥ÌÉàÎ¶¨ÏïÑ', 'Spain': 'Ïä§ÌéòÏù∏',
                'Russia': 'Îü¨ÏãúÏïÑ', 'India': 'Ïù∏ÎèÑ', 'Brazil': 'Î∏åÎùºÏßà', 'Mexico': 'Î©ïÏãúÏΩî',
                
                // Í¥ëÏó≠Ïãú/ÌäπÎ≥ÑÏãú
                'Seoul': 'ÏÑúÏö∏', 'Busan': 'Î∂ÄÏÇ∞', 'Incheon': 'Ïù∏Ï≤ú',
                'Daegu': 'ÎåÄÍµ¨', 'Daejeon': 'ÎåÄÏ†Ñ', 'Gwangju-si': 'Í¥ëÏ£º', 
                'Ulsan': 'Ïö∏ÏÇ∞', 'Sejong': 'ÏÑ∏Ï¢Ö',
                
                // ÎèÑ (Í∏¥ Í≤ÉÎ∂ÄÌÑ∞)
                'Gyeongsangnam-do': 'Í≤ΩÎÇ®', 'Gyeongsangbuk-do': 'Í≤ΩÎ∂Å',
                'Chungcheongnam-do': 'Ï∂©ÎÇ®', 'Chungcheongbuk-do': 'Ï∂©Î∂Å',
                'Jeollanam-do': 'Ï†ÑÎÇ®', 'Jeollabuk-do': 'Ï†ÑÎ∂Å',
                'Gyeonggi-do': 'Í≤ΩÍ∏∞', 'Gangwon-do': 'Í∞ïÏõê', 'Jeju-do': 'Ï†úÏ£º',
                'South Gyeongsang': 'Í≤ΩÎÇ®', 'North Gyeongsang': 'Í≤ΩÎ∂Å',
                'South Chungcheong': 'Ï∂©ÎÇ®', 'North Chungcheong': 'Ï∂©Î∂Å',
                'South Jeolla': 'Ï†ÑÎÇ®', 'North Jeolla': 'Ï†ÑÎ∂Å',
                'Gyeonggi': 'Í≤ΩÍ∏∞', 'Gangwon': 'Í∞ïÏõê', 'Jeju': 'Ï†úÏ£º',
                'Jeonbuk': 'Ï†ÑÎ∂Å',
                
                // Í≤ΩÍ∏∞ÎèÑ ÎèÑÏãú
                'Suwon-si': 'ÏàòÏõê', 'Suwon': 'ÏàòÏõê',
                'Seongnam-si': 'ÏÑ±ÎÇ®', 'Seongnam': 'ÏÑ±ÎÇ®',
                'Goyang-si': 'Í≥†Ïñë', 'Goyang': 'Í≥†Ïñë',
                'Yongin-si': 'Ïö©Ïù∏', 'Yongin': 'Ïö©Ïù∏',
                'Bucheon-si': 'Î∂ÄÏ≤ú', 'Bucheon': 'Î∂ÄÏ≤ú',
                'Ansan-si': 'ÏïàÏÇ∞', 'Ansan': 'ÏïàÏÇ∞',
                'Anyang-si': 'ÏïàÏñë', 'Anyang': 'ÏïàÏñë',
                'Namyangju-si': 'ÎÇ®ÏñëÏ£º', 'Namyangju': 'ÎÇ®ÏñëÏ£º',
                'Hwaseong-si': 'ÌôîÏÑ±', 'Hwaseong': 'ÌôîÏÑ±',
                'Pyeongtaek-si': 'ÌèâÌÉù', 'Pyeongtaek': 'ÌèâÌÉù',
                'Siheung-si': 'ÏãúÌù•', 'Siheung': 'ÏãúÌù•',
                'Gimpo-si': 'ÍπÄÌè¨', 'Gimpo': 'ÍπÄÌè¨',
                'Gwangmyeong-si': 'Í¥ëÎ™Ö', 'Gwangmyeong': 'Í¥ëÎ™Ö',
                'Gwangju-si': 'Í¥ëÏ£ºÏãú', 'Gwangju': 'Í¥ëÏ£º',
                'Hanam-si': 'ÌïòÎÇ®', 'Hanam': 'ÌïòÎÇ®',
                'Osan-si': 'Ïò§ÏÇ∞', 'Osan': 'Ïò§ÏÇ∞',
                'Icheon-si': 'Ïù¥Ï≤ú', 'Icheon': 'Ïù¥Ï≤ú',
                'Anseong-si': 'ÏïàÏÑ±', 'Anseong': 'ÏïàÏÑ±',
                'Uijeongbu-si': 'ÏùòÏ†ïÎ∂Ä', 'Uijeongbu': 'ÏùòÏ†ïÎ∂Ä',
                'Paju-si': 'ÌååÏ£º', 'Paju': 'ÌååÏ£º',
                'Yangju-si': 'ÏñëÏ£º', 'Yangju': 'ÏñëÏ£º',
                'Pocheon-si': 'Ìè¨Ï≤ú', 'Pocheon': 'Ìè¨Ï≤ú',
                'Dongducheon-si': 'ÎèôÎëêÏ≤ú', 'Dongducheon': 'ÎèôÎëêÏ≤ú',
                'Guri-si': 'Íµ¨Î¶¨', 'Guri': 'Íµ¨Î¶¨',
                'Gunpo-si': 'Íµ∞Ìè¨', 'Gunpo': 'Íµ∞Ìè¨',
                'Uiwang-si': 'ÏùòÏôï', 'Uiwang': 'ÏùòÏôï',
                'Yeoju-si': 'Ïó¨Ï£º', 'Yeoju': 'Ïó¨Ï£º',
                
                // Í≤ΩÏÉÅÎÇ®ÎèÑ ÎèÑÏãú
                'Changwon-si': 'Ï∞ΩÏõê', 'Changwon': 'Ï∞ΩÏõê',
                'Gimhae-si': 'ÍπÄÌï¥', 'Gimhae': 'ÍπÄÌï¥',
                'Jinju-si': 'ÏßÑÏ£º', 'Jinju': 'ÏßÑÏ£º',
                'Yangsan-si': 'ÏñëÏÇ∞', 'Yangsan': 'ÏñëÏÇ∞',
                'Geoje-si': 'Í±∞Ï†ú', 'Geoje': 'Í±∞Ï†ú',
                'Sacheon-si': 'ÏÇ¨Ï≤ú', 'Sacheon': 'ÏÇ¨Ï≤ú',
                'Tongyeong-si': 'ÌÜµÏòÅ', 'Tongyeong': 'ÌÜµÏòÅ',
                'Miryang-si': 'Î∞ÄÏñë', 'Miryang': 'Î∞ÄÏñë',
                
                // Í≤ΩÏÉÅÎ∂ÅÎèÑ ÎèÑÏãú
                'Pohang-si': 'Ìè¨Ìï≠', 'Pohang': 'Ìè¨Ìï≠',
                'Gumi-si': 'Íµ¨ÎØ∏', 'Gumi': 'Íµ¨ÎØ∏',
                'Gyeongju-si': 'Í≤ΩÏ£º', 'Gyeongju': 'Í≤ΩÏ£º',
                'Andong-si': 'ÏïàÎèô', 'Andong': 'ÏïàÎèô',
                'Yeongju-si': 'ÏòÅÏ£º', 'Yeongju': 'ÏòÅÏ£º',
                'Sangju-si': 'ÏÉÅÏ£º', 'Sangju': 'ÏÉÅÏ£º',
                'Gimcheon-si': 'ÍπÄÏ≤ú', 'Gimcheon': 'ÍπÄÏ≤ú',
                'Yeongcheon-si': 'ÏòÅÏ≤ú', 'Yeongcheon': 'ÏòÅÏ≤ú',
                'Mungyeong-si': 'Î¨∏Í≤Ω', 'Mungyeong': 'Î¨∏Í≤Ω',
                
                // Ï∂©Ï≤≠ÎÇ®ÎèÑ ÎèÑÏãú
                'Cheonan-si': 'Ï≤úÏïà', 'Cheonan': 'Ï≤úÏïà',
                'Asan-si': 'ÏïÑÏÇ∞', 'Asan': 'ÏïÑÏÇ∞',
                'Seosan-si': 'ÏÑúÏÇ∞', 'Seosan': 'ÏÑúÏÇ∞',
                'Dangjin-si': 'ÎãπÏßÑ', 'Dangjin': 'ÎãπÏßÑ',
                'Nonsan-si': 'ÎÖºÏÇ∞', 'Nonsan': 'ÎÖºÏÇ∞',
                'Gongju-si': 'Í≥µÏ£º', 'Gongju': 'Í≥µÏ£º',
                'Boryeong-si': 'Î≥¥Î†π', 'Boryeong': 'Î≥¥Î†π',
                
                // Ï∂©Ï≤≠Î∂ÅÎèÑ ÎèÑÏãú
                'Cheongju-si': 'Ï≤≠Ï£º', 'Cheongju': 'Ï≤≠Ï£º',
                'Chungju-si': 'Ï∂©Ï£º', 'Chungju': 'Ï∂©Ï£º',
                'Jecheon-si': 'Ï†úÏ≤ú', 'Jecheon': 'Ï†úÏ≤ú',
                
                // Ï†ÑÎùºÎ∂ÅÎèÑ ÎèÑÏãú
                'Jeonju-si': 'Ï†ÑÏ£º', 'Jeonju': 'Ï†ÑÏ£º',
                'Gunsan-si': 'Íµ∞ÏÇ∞', 'Gunsan': 'Íµ∞ÏÇ∞',
                'Iksan-si': 'ÏùµÏÇ∞', 'Iksan': 'ÏùµÏÇ∞',
                'Namwon-si': 'ÎÇ®Ïõê', 'Namwon': 'ÎÇ®Ïõê',
                'Gimje-si': 'ÍπÄÏ†ú', 'Gimje': 'ÍπÄÏ†ú',
                'Jeongeup-si': 'Ï†ïÏùç', 'Jeongeup': 'Ï†ïÏùç',
                
                // Ï†ÑÎùºÎÇ®ÎèÑ ÎèÑÏãú
                'Yeosu-si': 'Ïó¨Ïàò', 'Yeosu': 'Ïó¨Ïàò',
                'Suncheon-si': 'ÏàúÏ≤ú', 'Suncheon': 'ÏàúÏ≤ú',
                'Mokpo-si': 'Î™©Ìè¨', 'Mokpo': 'Î™©Ìè¨',
                'Gwangyang-si': 'Í¥ëÏñë', 'Gwangyang': 'Í¥ëÏñë',
                'Naju-si': 'ÎÇòÏ£º', 'Naju': 'ÎÇòÏ£º',
                
                // Í∞ïÏõêÎèÑ ÎèÑÏãú
                'Chuncheon-si': 'Ï∂òÏ≤ú', 'Chuncheon': 'Ï∂òÏ≤ú',
                'Wonju-si': 'ÏõêÏ£º', 'Wonju': 'ÏõêÏ£º',
                'Gangneung-si': 'Í∞ïÎ¶â', 'Gangneung': 'Í∞ïÎ¶â',
                'Donghae-si': 'ÎèôÌï¥', 'Donghae': 'ÎèôÌï¥',
                'Sokcho-si': 'ÏÜçÏ¥à', 'Sokcho': 'ÏÜçÏ¥à',
                'Samcheok-si': 'ÏÇºÏ≤ô', 'Samcheok': 'ÏÇºÏ≤ô',
                'Taebaek-si': 'ÌÉúÎ∞±', 'Taebaek': 'ÌÉúÎ∞±',
                
                // Ï†úÏ£ºÎèÑ ÎèÑÏãú
                'Jeju City': 'Ï†úÏ£ºÏãú', 'Jeju-si': 'Ï†úÏ£ºÏãú',
                'Seogwipo-si': 'ÏÑúÍ∑ÄÌè¨', 'Seogwipo': 'ÏÑúÍ∑ÄÌè¨',
                
                // ÏÑúÏö∏ Íµ¨
                'Gangnam-gu': 'Í∞ïÎÇ®Íµ¨', 'Gangnam': 'Í∞ïÎÇ®',
                'Seocho-gu': 'ÏÑúÏ¥àÍµ¨', 'Seocho': 'ÏÑúÏ¥à',
                'Songpa-gu': 'ÏÜ°ÌååÍµ¨', 'Songpa': 'ÏÜ°Ìåå',
                'Gangdong-gu': 'Í∞ïÎèôÍµ¨', 'Gangdong': 'Í∞ïÎèô',
                'Gwanak-gu': 'Í¥ÄÏïÖÍµ¨', 'Gwanak': 'Í¥ÄÏïÖ',
                'Dongjak-gu': 'ÎèôÏûëÍµ¨', 'Dongjak': 'ÎèôÏûë',
                'Yeongdeungpo-gu': 'ÏòÅÎì±Ìè¨Íµ¨', 'Yeongdeungpo': 'ÏòÅÎì±Ìè¨',
                'Guro-gu': 'Íµ¨Î°úÍµ¨', 'Guro': 'Íµ¨Î°ú',
                'Geumcheon-gu': 'Í∏àÏ≤úÍµ¨', 'Geumcheon': 'Í∏àÏ≤ú',
                'Yangcheon-gu': 'ÏñëÏ≤úÍµ¨', 'Yangcheon': 'ÏñëÏ≤ú',
                'Gangseo-gu': 'Í∞ïÏÑúÍµ¨', 'Gangseo': 'Í∞ïÏÑú',
                'Mapo-gu': 'ÎßàÌè¨Íµ¨', 'Mapo': 'ÎßàÌè¨',
                'Seodaemun-gu': 'ÏÑúÎåÄÎ¨∏Íµ¨', 'Seodaemun': 'ÏÑúÎåÄÎ¨∏',
                'Eunpyeong-gu': 'ÏùÄÌèâÍµ¨', 'Eunpyeong': 'ÏùÄÌèâ',
                'Jongno-gu': 'Ï¢ÖÎ°úÍµ¨', 'Jongno': 'Ï¢ÖÎ°ú',
                'Jung-gu': 'Ï§ëÍµ¨', 'Jung': 'Ï§ë',
                'Yongsan-gu': 'Ïö©ÏÇ∞Íµ¨', 'Yongsan': 'Ïö©ÏÇ∞',
                'Seongbuk-gu': 'ÏÑ±Î∂ÅÍµ¨', 'Seongbuk': 'ÏÑ±Î∂Å',
                'Gangbuk-gu': 'Í∞ïÎ∂ÅÍµ¨', 'Gangbuk': 'Í∞ïÎ∂Å',
                'Dobong-gu': 'ÎèÑÎ¥âÍµ¨', 'Dobong': 'ÎèÑÎ¥â',
                'Nowon-gu': 'ÎÖ∏ÏõêÍµ¨', 'Nowon': 'ÎÖ∏Ïõê',
                'Jungnang-gu': 'Ï§ëÎûëÍµ¨', 'Jungnang': 'Ï§ëÎûë',
                'Dongdaemun-gu': 'ÎèôÎåÄÎ¨∏Íµ¨', 'Dongdaemun': 'ÎèôÎåÄÎ¨∏',
                'Seongdong-gu': 'ÏÑ±ÎèôÍµ¨', 'Seongdong': 'ÏÑ±Îèô',
                'Gwangjin-gu': 'Í¥ëÏßÑÍµ¨', 'Gwangjin': 'Í¥ëÏßÑ',
                
                // Î∂ÄÏÇ∞ Íµ¨
                'Dongnae-gu': 'ÎèôÎûòÍµ¨', 'Dongnae': 'ÎèôÎûò',
                'Haeundae-gu': 'Ìï¥Ïö¥ÎåÄÍµ¨', 'Haeundae': 'Ìï¥Ïö¥ÎåÄ',
                'Suyeong-gu': 'ÏàòÏòÅÍµ¨', 'Suyeong': 'ÏàòÏòÅ',
                'Nam-gu': 'ÎÇ®Íµ¨',
                'Busanjin-gu': 'Î∂ÄÏÇ∞ÏßÑÍµ¨', 'Busanjin': 'Î∂ÄÏÇ∞ÏßÑ',
                'Saha-gu': 'ÏÇ¨ÌïòÍµ¨', 'Saha': 'ÏÇ¨Ìïò',
                'Sasang-gu': 'ÏÇ¨ÏÉÅÍµ¨', 'Sasang': 'ÏÇ¨ÏÉÅ',
                'Buk-gu': 'Î∂ÅÍµ¨',
                'Geumjeong-gu': 'Í∏àÏ†ïÍµ¨', 'Geumjeong': 'Í∏àÏ†ï',
                'Yeonje-gu': 'Ïó∞Ï†úÍµ¨', 'Yeonje': 'Ïó∞Ï†ú',
                'Seo-gu': 'ÏÑúÍµ¨',
                'Dong-gu': 'ÎèôÍµ¨',
                'Yeongdo-gu': 'ÏòÅÎèÑÍµ¨', 'Yeongdo': 'ÏòÅÎèÑ',
                'Gijang-gun': 'Í∏∞Ïû•Íµ∞', 'Gijang': 'Í∏∞Ïû•',
                
                // Ïù∏Ï≤ú Íµ¨
                'Namdong-gu': 'ÎÇ®ÎèôÍµ¨', 'Namdong': 'ÎÇ®Îèô',
                'Bupyeong-gu': 'Î∂ÄÌèâÍµ¨', 'Bupyeong': 'Î∂ÄÌèâ',
                'Gyeyang-gu': 'Í≥ÑÏñëÍµ¨', 'Gyeyang': 'Í≥ÑÏñë',
                'Yeonsu-gu': 'Ïó∞ÏàòÍµ¨', 'Yeonsu': 'Ïó∞Ïàò',
                'Michuhol-gu': 'ÎØ∏Ï∂îÌôÄÍµ¨', 'Michuhol': 'ÎØ∏Ï∂îÌôÄ',
                
                // ÎåÄÍµ¨ Íµ¨
                'Suseong-gu': 'ÏàòÏÑ±Íµ¨', 'Suseong': 'ÏàòÏÑ±',
                'Dalseo-gu': 'Îã¨ÏÑúÍµ¨', 'Dalseo': 'Îã¨ÏÑú',
                'Dalseong-gun': 'Îã¨ÏÑ±Íµ∞', 'Dalseong': 'Îã¨ÏÑ±'
            };
            
            let result = loc;
            
            // Í∏¥ Î¨∏ÏûêÏó¥Î∂ÄÌÑ∞ Î≥ÄÌôò (Ï†ïÌôïÌïú Îß§Ïπ≠ÏùÑ ÏúÑÌï¥)
            const sortedKeys = Object.keys(translateMap).sort((a, b) => b.length - a.length);
            
            for (const eng of sortedKeys) {
                if (result.includes(eng)) {
                    result = result.replace(new RegExp(eng, 'g'), translateMap[eng]);
                }
            }
            
            // ÎÇ®ÏùÄ ÏòÅÏñ¥Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞ÌïòÍ≥† Ï†ïÎ¶¨
            result = result.trim();
            
            // Í≥µÎ∞± Ï†ïÎ¶¨ (Ïó∞ÏÜç Í≥µÎ∞± Ï†úÍ±∞)
            result = result.replace(/\s+/g, ' ');
            
            return result || '-';
        }
        
        // ÏúÑÏπò Ï†ïÎ≥¥ Ï°∞Ìöå Ìï®Ïàò (Ï∫êÏãú ÏÇ¨Ïö©)
        let cachedLocation = null;
        let cachedIp = null;
        async function getIpAndLocation() {
            try {
                const ip = await getIp();
                
                // Í∞ôÏùÄ IPÎ©¥ Ï∫êÏãúÎêú ÏúÑÏπò ÏÇ¨Ïö©
                if (cachedIp === ip && cachedLocation) {
                    return { ip, location: cachedLocation };
                }
                
                cachedIp = ip;
                
                // ipapi.co Î¨¥Î£å API ÏÇ¨Ïö© (HTTPS ÏßÄÏõê)
                const res = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await res.json();
                
                if (data && !data.error) {
                    const country = data.country_name || '';
                    const region = data.region || '';
                    const city = data.city || '';
                    
                    // Íµ≠Í∞ÄÎ≥Ñ Ìè¨Îß∑
                    if (country === 'South Korea' || country === 'Korea') {
                        // ÌïúÍµ≠: "ÎåÄÌïúÎØºÍµ≠ ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨" ÌòïÏãù
                        const parts = [];
                        parts.push('ÎåÄÌïúÎØºÍµ≠');
                        if (region) parts.push(region);
                        if (city && city !== region) parts.push(city);
                        cachedLocation = parts.join(' ');
                    } else if (country) {
                        // Ìï¥Ïô∏: "ÎØ∏Íµ≠ ÏÉåÌîÑÎûÄÏãúÏä§ÏΩî" ÌòïÏãù
                        const parts = [country];
                        if (city) {
                            parts.push(city);
                        } else if (region) {
                            parts.push(region);
                        }
                        cachedLocation = parts.join(' ');
                    } else {
                        cachedLocation = '';
                    }
                } else {
                    cachedLocation = '';
                }
                
                return { ip, location: cachedLocation };
            } catch (e) {
                return { ip: await getIp(), location: '' };
            }
        }
        
        // Î°úÍ∑∏ Ï†ïÎ≥¥ Ìó¨Ìçº (IP, ÏúÑÏπò, Í∏∞Í∏∞ Ï†ïÎ≥¥)
        async function getLogInfo() {
            const { ip, location } = await getIpAndLocation();
            return {
                ip: ip,
                location: location,
                device: parseUserAgent(navigator.userAgent)
            };
        }

        async function fetchGuildList() {
            const docRef = doc(db, "config", "guilds");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { guildList = docSnap.data().names || []; } 
            else { guildList = ['ÏÇ¨Ïã†', 'Ï∂ïÎ≥µ', 'ÎÜÄÏûê', 'Î£®ÎπÑ']; await setDoc(docRef, { names: guildList }); }
        }

       
        let guildDataMap = {};
        let currentGuild = null;

        async function loadData() {
            await fetchGuildList();
            
            const querySnapshot = await getDocs(collection(db, "users"));
            guildDataMap = {}; 
            guildList.forEach(g => guildDataMap[g] = []); 
            allGuildData = [];

            if (querySnapshot.empty) { await initializeDatabase(); return; }

            querySnapshot.forEach((docSnap) => {
                const user = docSnap.data();
                user.shape_legend = typeof user.shape_legend === 'number' ? user.shape_legend : (user.shape_legend ? 1 : 0);
                user.shape_myth = typeof user.shape_myth === 'number' ? user.shape_myth : (user.shape_myth ? 1 : 0);
                user.mount_legend = typeof user.mount_legend === 'number' ? user.mount_legend : (user.mount_legend ? 1 : 0);
                user.mount_myth = typeof user.mount_myth === 'number' ? user.mount_myth : (user.mount_myth ? 1 : 0);

                if (guildDataMap[user.guild] !== undefined) guildDataMap[user.guild].push(user);
                else if (guildList.includes(user.guild)) guildDataMap[user.guild] = [user];
            });

           
            Object.keys(guildDataMap).forEach(guildName => {
                guildDataMap[guildName].sort((a, b) => b.power - a.power);
                allGuildData.push(...guildDataMap[guildName]);
            });

           
            renderGuildButtons();
            
           
            if (currentGuild && guildList.includes(currentGuild)) {
                showGuildDetail(currentGuild);
            } else {
                showGuildSelect();
            }
        }

        function renderGuildButtons() {
            const container = document.getElementById('guildButtons');
            container.innerHTML = '';
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            
            guildList.forEach((guildName, index) => {
                const count = guildDataMap[guildName]?.length || 0;
                const btn = document.createElement('div');
                btn.className = 'guild-btn';
                btn.innerHTML = `
                    <div class="guild-btn-badge" style="background: ${colors[index % 4]}"></div>
                    <div class="guild-btn-info">
                        <div class="guild-btn-name">${guildName}</div>
                        <div class="guild-btn-count">${count}Î™ÖÏùò Í∏∏ÎìúÏõê</div>
                    </div>
                    <div class="guild-btn-arrow">‚Üí</div>
                `;
                btn.onclick = () => showGuildDetail(guildName);
                container.appendChild(btn);
            });
        }

        window.showGuildSelect = function() {
            currentGuild = null;
            document.getElementById('guildSelectContainer').style.display = 'block';
            document.getElementById('guildDetailContainer').classList.remove('active');
        }

        window.showGuildDetail = function(guildName) {
            currentGuild = guildName;
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            const colorIndex = guildList.indexOf(guildName);
            
            document.getElementById('guildSelectContainer').style.display = 'none';
            document.getElementById('guildDetailContainer').classList.add('active');
            
            document.getElementById('detailBadge').style.background = colors[colorIndex % 4];
            document.getElementById('detailTitle').textContent = guildName;
            
            const users = guildDataMap[guildName] || [];
            document.getElementById('detailCount').textContent = `${users.length}Î™Ö`;
            
            const tbody = document.getElementById('detailList');
            tbody.innerHTML = '';
            
            users.forEach((user, index) => {
                const tr = document.createElement('tr');
                let icons = "";
                if(user.shape_legend > 0) icons += "üõ°Ô∏è";
                if(user.shape_myth > 0) icons += "üëë";
                if(user.mount_legend > 0) icons += "üê¥";
                if(user.mount_myth > 0) icons += "ü¶Ñ";
                
                const shouldBlur = powerMaskingEnabled && !isAdmin && (loggedInUser !== user.name);
                const blurClass = shouldBlur ? ' blurred' : '';
                const powerDisplay = shouldBlur ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : user.power.toLocaleString();
                
                tr.innerHTML = `<td><div class="player-cell"><span class="rank-number">${index + 1}</span><span class="player-name" title="${user.name}">${user.name}</span><span class="spec-icons">${icons}</span></div></td>
                    <td><span class="power-value${blurClass}">${powerDisplay}</span></td>`;
                
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('power-value')) {
                        showUserInfo(user.name);
                    }
                });
                
                const powerValueSpan = tr.querySelector('.power-value');
                powerValueSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePowerClick(user.name);
                });
                
                tbody.appendChild(tr);
            });
        }

       
        async function showUserInfo(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();

            const showCount = (count) => {
                if (count > 0) {
                    return `<span class="spec-count">${count}Í∞ú</span>`;
                } else {
                    return `<span class="spec-count zero">ÏóÜÏùå</span>`;
                }
            };

            const shouldBlurPower = powerMaskingEnabled && !isAdmin && (loggedInUser !== name);
            const powerDisplayVal = shouldBlurPower ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : u.power.toLocaleString();
            const powerClass = shouldBlurPower ? 'power-value blurred' : '';

                       let updatedInfo = '';
            if (isAdmin && u.updatedAt) {
                const updatedDate = formatDateTime(u.updatedAt);
                const isAdminUpdate = u.updatedBy === 'admin';
                updatedInfo = `<p style="font-size:12px; color:#6b7280; margin-top:8px;">Í∞±Ïã†Ïùº: ${updatedDate}${isAdminUpdate ? ' (Í¥ÄÎ¶¨Ïûê)' : ''}</p>`;
            }

                       const renameButton = isAdmin ? `<button class="btn btn-rename" onclick="window.openRenameModal('${name}')" style="flex:1">üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</button>` : '';
            
            // ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÏö© Î°úÍ∑∏ Î≥¥Í∏∞ Î≤ÑÌäº
            const logButton = isSuperAdmin ? `<button class="btn" onclick="window.showUserLogs('${name}')" style="flex:1; background:#6366f1; color:white;">üìã Î°úÍ∑∏ Î≥¥Í∏∞</button>` : '';

            const content = `
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Í∏∏Îìú</span><span class="info-val">${u.guild}</span></div>
                    <div class="info-item">
                        <span class="info-label">Ï†ÑÌà¨Î†•</span>
                        <span class="info-val ${powerClass}" ${shouldBlurPower ? 'title="Î°úÍ∑∏Ïù∏ ÌõÑ ÌôïÏù∏ Í∞ÄÎä•"' : ''}>${powerDisplayVal}</span>
                    </div>
                </div>
                ${updatedInfo}
                <div class="info-grid" style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd;">
                    <div class="info-item"><span class="info-label">üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</span>${showCount(u.shape_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">üëë ÌòïÏÉÅ Ïã†Ìôî</span>${showCount(u.shape_myth || 0)}</div>
                    <div class="info-item"><span class="info-label">üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</span>${showCount(u.mount_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</span>${showCount(u.mount_myth || 0)}</div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; text-align:center;">‚Äª Ïä§Ìéô Í∞úÏàòÎäî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÑ§Ï†ïÌï©ÎãàÎã§</p>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="window.editUserFromInfo('${name}')" style="flex:1">‚úèÔ∏è Ï†ïÎ≥¥ ÏàòÏ†ï</button>
                    ${renameButton}
                </div>
                ${isAdmin ? `<div style="display: flex; gap: 8px; margin-top: 8px;">${logButton}</div>` : ''}
            `;
            
            openSmallModal('ÏÉÅÏÑ∏ Ï†ïÎ≥¥', u.name, content);
            document.getElementById('modalFooter').style.display = 'none';
        }

        // ÌäπÏ†ï Ïú†Ï†ÄÏùò Î°úÍ∑∏ Î≥¥Í∏∞
        window.showUserLogs = async function(userName) {
            // ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑º Í∞ÄÎä•
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }
            
            openLargeModal('üìã Ïú†Ï†Ä Î°úÍ∑∏', `${userName}Ïùò ÌôúÎèô Í∏∞Î°ù`);
            setModalBody('<p style="text-align:center; padding:40px;">Î°úÎî© Ï§ë...</p>');
            
            try {
                const logsSnap = await getDocs(query(collection(db, "logs"), orderBy("createdAt", "desc")));
                
                const userLogs = [];
                logsSnap.forEach(d => {
                    const l = d.data();
                    // who ÌïÑÎìúÏóêÏÑú Ïú†Ï†Ä Ïù¥Î¶Ñ Í≤ÄÏÉâ (ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÏùò Í≤ΩÏö∞ old‚Üínew ÌòïÌÉúÎèÑ Ï≤¥ÌÅ¨)
                    const who = l.who || '';
                    if (who.includes(userName) || who === userName) {
                        // Í∏∞Í∏∞ Ï†ïÎ≥¥ ÌååÏã±
                        let deviceDisplay = l.device || '-';
                        if (deviceDisplay.length > 30 || deviceDisplay.includes('Mozilla')) {
                            deviceDisplay = parseUserAgent(deviceDisplay);
                        }
                        
                        // ÏúÑÏπò ÌïúÍ∏Ä Î≥ÄÌôò
                        let locationDisplay = translateLocation(l.location || '-');
                        
                        userLogs.push({
                            time: formatDateTime(l.createdAt),
                            type: l.type,
                            oldValue: l.old_value || '-',
                            newValue: l.new_value || '-',
                            changes: l.changes || '',
                            editedBy: l.editedBy || '-',
                            ip: l.ip || '-',
                            location: locationDisplay,
                            device: deviceDisplay
                        });
                    }
                });
                
                // Ï†ÑÏó≠ Ï†ÄÏû• (ÏÉÅÏÑ∏Î≥¥Í∏∞Ïö©)
                window.currentUserLogs = userLogs;
                
                const typeMap = {
                    'power': '‚úèÔ∏è Ï†ÑÌà¨Î†•',
                    'info_edit': 'üìù Ï†ïÎ≥¥',
                    'guild_change': 'üè† Í∏∏Îìú',
                    'spec_edit': '‚≠ê Ïä§Ìéô',
                    'nickname_change': 'üîÑ ÎãâÎ≥Ä',
                    'user_approved': '‚úÖ ÏäπÏù∏',
                    'user_deleted': 'üóëÔ∏è ÏÇ≠Ï†ú',
                    'user_request': 'üìù ÏöîÏ≤≠',
                    'guild_move': 'üöÄ Ïù¥Îèô'
                };
                
                let logsHtml = '';
                if (userLogs.length === 0) {
                    logsHtml = '<p style="text-align:center; color:#9ca3af; padding:20px;">Î°úÍ∑∏ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>';
                } else {
                    logsHtml = `
                        <div class="table-scroll-container" style="max-height:400px;">
                            <table class="common-table" style="font-size:12px;">
                                <thead>
                                    <tr>
                                        <th style="width:14%;">ÏãúÍ∞Ñ</th>
                                        <th style="width:8%;">ÏûëÏóÖ</th>
                                        <th style="width:20%;">ÎÇ¥Ïö©</th>
                                        <th style="width:8%;">ÏûëÏóÖÏûê</th>
                                        <th style="width:12%;">IP</th>
                                        <th style="width:20%;">ÏúÑÏπò</th>
                                        <th style="width:18%;">Í∏∞Í∏∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    userLogs.slice(0, 100).forEach((l, idx) => {
                        const typeDisplay = typeMap[l.type] || l.type;
                        let contentDisplay = l.changes || '';
                        
                        // ÌÉÄÏûÖÎ≥Ñ ÎÇ¥Ïö© ÌëúÏãú
                        if (l.type === 'power' || l.type === 'info_edit' || l.type === 'guild_change' || l.type === 'spec_edit') {
                            contentDisplay = l.changes || 'Ï†ïÎ≥¥ ÏàòÏ†ï';
                        } else if (l.type === 'nickname_change') {
                            contentDisplay = `${l.oldValue} ‚Üí ${l.newValue}`;
                        } else if (l.type === 'user_approved') {
                            contentDisplay = 'ÏäπÏù∏ ÏôÑÎ£å';
                        } else if (l.type === 'guild_move') {
                            contentDisplay = l.newValue || 'Í∏∏Îìú Ïù¥Îèô';
                        }
                        
                        const workerDisplay = l.editedBy === 'self' ? 'Î≥∏Ïù∏' : (l.editedBy === 'admin' || l.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' ? 'Í¥ÄÎ¶¨Ïûê' : l.editedBy);
                        
                        logsHtml += `<tr style="cursor:pointer;" onclick="showUserLogDetail(${idx})">
                            <td style="font-size:11px;">${l.time}</td>
                            <td>${typeDisplay}</td>
                            <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis;" title="${contentDisplay}">${contentDisplay || '-'}</td>
                            <td style="color:#8b5cf6;">${workerDisplay}</td>
                            <td style="font-size:11px; color:#6b7280;">${l.ip}</td>
                            <td style="font-size:11px;">${l.location}</td>
                            <td style="font-size:11px;">${l.device}</td>
                        </tr>`;
                    });
                    
                    logsHtml += '</tbody></table></div>';
                    if (userLogs.length > 100) {
                        logsHtml += `<p style="font-size:11px; color:#9ca3af; margin-top:8px; text-align:center;">ÏµúÍ∑º 100Í±¥Îßå ÌëúÏãúÎê©ÎãàÎã§ (Ï¥ù ${userLogs.length}Í±¥)</p>`;
                    }
                }
                
                setModalBody(`
                    <p style="font-size:13px; color:#374151; margin-bottom:12px;">Ï¥ù <strong>${userLogs.length}Í±¥</strong>Ïùò Î°úÍ∑∏ (Ìñâ ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏Î≥¥Í∏∞)</p>
                    ${logsHtml}
                `);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
                `;
            } catch(e) {
                console.error(e);
                setModalBody('<p style="color:#ef4444; text-align:center; padding:40px;">Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
        };
        
        // Ïú†Ï†Ä Î°úÍ∑∏ ÏÉÅÏÑ∏Î≥¥Í∏∞
        window.showUserLogDetail = function(index) {
            const l = window.currentUserLogs[index];
            if (!l) return;
            
            const typeMap = {
                'power': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                'info_edit': 'üìù Ï†ïÎ≥¥ ÏàòÏ†ï',
                'guild_change': 'üè† Í∏∏Îìú Î≥ÄÍ≤Ω',
                'spec_edit': '‚≠ê Ïä§Ìéô ÏàòÏ†ï',
                'nickname_change': 'üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω',
                'user_approved': '‚úÖ ÏäπÏù∏',
                'user_deleted': 'üóëÔ∏è ÏÇ≠Ï†ú',
                'user_request': 'üìù Îì±Î°ù ÏöîÏ≤≠',
                'guild_move': 'üöÄ Í∏∏Îìú Ïù¥Îèô'
            };
            
            const typeDisplay = typeMap[l.type] || l.type;
            const workerDisplay = l.editedBy === 'self' ? 'üë§ Î≥∏Ïù∏' : (l.editedBy === 'admin' || l.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' ? 'üëë Í¥ÄÎ¶¨Ïûê' : `üëë ${l.editedBy}`);
            
            const html = `
                <div style="padding: 10px 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; width: 80px;">ÏãúÍ∞Ñ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${l.time}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏûëÏóÖ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${typeDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÎÇ¥Ïö©</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${l.changes || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏûëÏóÖÏûê</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #8b5cf6;">${workerDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">IP</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-family: monospace;">${l.ip}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏúÑÏπò</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${l.location}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">Í∏∞Í∏∞</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${l.device}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            openSmallModal('üìã Î°úÍ∑∏ ÏÉÅÏÑ∏', l.time.split(' ')[0], html);
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };

               window.openRenameModal = async function(oldName) {
            if (!isAdmin) {
                showAlert('‚ùå ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÏùÄ Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§', 'error');
                return;
            }

            openSmallModal('ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)', `ÌòÑÏû¨: ${oldName}`, `
                <div class="form-group">
                    <label class="form-label">ÏÉà ÎãâÎÑ§ÏûÑ</label>
                    <input type="text" id="newNickname" class="form-input" placeholder="ÏÉàÎ°úÏö¥ ÎãâÎÑ§ÏûÑ ÏûÖÎ†•" autocomplete="off">
                </div>
                <p style="font-size:12px; color:#ef4444; margin-top:8px;">‚ö†Ô∏è ÎãâÎÑ§ÏûÑÏùÑ Î≥ÄÍ≤ΩÌïòÎ©¥ Ïù¥Ï†Ñ ÎãâÎÑ§ÏûÑÏúºÎ°úÎäî Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>
            `);

            setTimeout(() => document.getElementById('newNickname').focus(), 100);

            document.getElementById('modalSubmit').onclick = async () => {
                const newName = document.getElementById('newNickname').value.trim();
                
                if (!newName) {
                    showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                    return;
                }

                if (newName === oldName) {
                    showAlert('ÎèôÏùºÌïú ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error');
                    return;
                }

                               const checkDoc = await getDoc(doc(db, "users", newName));
                if (checkDoc.exists()) {
                    showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error');
                    return;
                }

                try {
                                       const oldDocRef = doc(db, "users", oldName);
                    const oldDocSnap = await getDoc(oldDocRef);
                    const userData = oldDocSnap.data();

                                       userData.name = newName;
                    await setDoc(doc(db, "users", newName), userData);

                                       await deleteDoc(oldDocRef);

                                       await setDoc(doc(collection(db, "logs")), {
                        who: `${oldName} ‚Üí ${newName}`,
                        type: 'nickname_change',
                        old_value: oldName,
                        new_value: newName,
                        editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                        createdAt: Date.now(),
                        ip: await getIp(),
                        location: (await getIpAndLocation()).location,
                        device: parseUserAgent(navigator.userAgent),
                        admin: true
                    });

                    showAlert(`ÎãâÎÑ§ÏûÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§: ${oldName} ‚Üí ${newName}`, 'success');
                    closeModal();
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(userData.guild);
                    }, 500);
                } catch (e) {
                    console.error(e);
                    showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                }
            };
        };

       
        document.getElementById('addUserBtn').addEventListener('click', () => {
            if (isSystemLocked() && !isSuperAdmin) { 
                const lockMsg = `Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.\n\nÍ∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            openSmallModal('ÏÇ¨Ïö©Ïûê Îì±Î°ù', 'Ïã†Í∑ú Ïú†Ï†Ä Îì±Î°ù (Í¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌïÑÏöî)', `
                <div class="form-group"><label class="form-label">Í∏∏Îìú ÏÑ†ÌÉù</label><select id="newUserGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">ÎãâÎÑ§ÏûÑ</label><input type="text" id="newUserName" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ" autocomplete="off"></div>
                <div class="form-group"><label class="form-label">Ï†ÑÌà¨Î†• (Ïà´ÏûêÎßå)</label><input type="text" id="newUserPower" class="form-input" placeholder="Ïòà: 1200000" inputmode="numeric"></div>
                <div class="form-group"><label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏ (4ÏûêÎ¶¨)</label><input type="password" id="newUserPw" class="form-input" maxlength="4" inputmode="numeric" placeholder="Î≥∏Ïù∏Ïù∏Ï¶ùÏö©"></div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">‚Äª Îì±Î°ù ÌõÑ Í¥ÄÎ¶¨Ïûê ÏäπÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§</p>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const guild = document.getElementById('newUserGuild').value;
                const name = document.getElementById('newUserName').value.trim();
                const powerStr = document.getElementById('newUserPower').value.replace(/,/g, "").trim();
                const pw = document.getElementById('newUserPw').value;

                               if (!name) {
                    showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (!powerStr) {
                    showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                if (!/^\d+$/.test(powerStr)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
               
                if (!/^\d{4}$/.test(pw)) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨ Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }

                               const userDocRef = doc(db, "users", name);
                const pendingDocRef = doc(db, "pendingUsers", name);
                const [userSnap, pendingSnap] = await Promise.all([
                    getDoc(userDocRef),
                    getDoc(pendingDocRef)
                ]);

                if (userSnap.exists() || pendingSnap.exists()) { 
                    showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÍ±∞ÎÇò ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error'); 
                    return; 
                }

                try {
                    const power = Number(powerStr);
                                       await setDoc(pendingDocRef, { 
                        guild, 
                        name, 
                        power, 
                        password: pw,
                        shape_legend: 0, 
                        shape_myth: 0,
                        mount_legend: 0, 
                        mount_myth: 0,
                        requestedAt: Date.now(),
                        ip: await getIp()
                    });
                    
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'user_request', 
                        old_value: '-', 
                        new_value: `Îì±Î°ùÏöîÏ≤≠(${guild})`, 
                        createdAt: Date.now(), 
                        ip: await getIp(),
                        location: (await getIpAndLocation()).location,
                        device: parseUserAgent(navigator.userAgent) 
                    });
                    
                    showAlert(`${name}Îãò Îì±Î°ùÏù¥ ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§!\nÍ¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'success'); 
                    closeModal();
                } catch(e) { 
                    console.error(e); 
                    showAlert('Ïò§Î•ò Î∞úÏÉù', 'error'); 
                }
            };
        });

               document.getElementById('approveBtn').addEventListener('click', async () => {
            if (!isAdmin) return;

            openLargeModal('ÏäπÏù∏ Í¥ÄÎ¶¨', 'Îì±Î°ù ÏöîÏ≤≠ Î™©Î°ù');
            
            const q = query(collection(db, "pendingUsers"), orderBy("requestedAt", "desc"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                setModalBody('<div style="text-align:center; padding:40px; color:#9ca3af;">ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>');
                return;
            }

            let html = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th>ÏöîÏ≤≠ÏãúÍ∞Ñ</th><th>ÎãâÎÑ§ÏûÑ</th><th>Í∏∏Îìú</th><th>Ï†ÑÌà¨Î†•</th><th>Í¥ÄÎ¶¨</th></tr></thead><tbody>';
            
            snapshot.forEach(docSnap => {
                const u = docSnap.data();
                html += `<tr>
                    <td>${formatDateTime(u.requestedAt)}</td>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td>${u.power.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-success" onclick="window.approveUser('${u.name}')" style="padding:6px 12px; font-size:12px; margin-right:4px;">ÏäπÏù∏</button>
                        <button class="btn btn-danger" onclick="window.rejectUser('${u.name}')" style="padding:6px 12px; font-size:12px;">Í±∞Î∂Ä</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
        });

               window.approveUser = async function(name) {
            if (!await showConfirm('ÏÇ¨Ïö©Ïûê ÏäπÏù∏', `[${name}]ÎãòÏùò Îì±Î°ùÏùÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                const pendingSnap = await getDoc(pendingRef);
                
                if (!pendingSnap.exists()) {
                    showAlert('Ìï¥Îãπ ÏöîÏ≤≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }

                const userData = pendingSnap.data();
                
                               await setDoc(doc(db, "users", name), userData);
                
                               await deleteDoc(pendingRef);
                
                               await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_approved',
                    old_value: 'ÏäπÏù∏ÎåÄÍ∏∞',
                    new_value: 'ÏäπÏù∏ÏôÑÎ£å',
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    location: (await getIpAndLocation()).location,
                    device: parseUserAgent(navigator.userAgent)
                });

                showAlert(`${name}ÎãòÏù¥ ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                await checkPendingUsers();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(userData.guild);
                }, 500);
            } catch (e) {
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        };

               window.rejectUser = async function(name) {
            if (!await showConfirm('Îì±Î°ù Í±∞Î∂Ä', `[${name}]ÎãòÏùò Îì±Î°ùÏùÑ Í±∞Î∂ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br><span style="color:#ef4444;">Ïù¥ ÏûëÏóÖÏùÄ Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.</span>`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                await deleteDoc(pendingRef);
                
                await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_rejected',
                    old_value: 'ÏäπÏù∏ÎåÄÍ∏∞',
                    new_value: 'Í±∞Î∂ÄÎê®',
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    location: (await getIpAndLocation()).location,
                    device: parseUserAgent(navigator.userAgent)
                });

                showAlert(`${name}ÎãòÏùò Îì±Î°ùÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                await checkPendingUsers();
            } catch (e) {
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        };

       
        function openUserEditModal(u) {
            const guildOptions = guildList.map(g => `<option value="${g}" ${g===u.guild?'selected':''}>${g}</option>`).join('');
            
            let specSection = '';
            if (isAdmin) {
                specSection = `
                    <div class="form-group"><label class="form-label">Î≥¥Ïú† Ïä§Ìéô (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© - Í∞úÏàò ÏûÖÎ†•)</label>
                        <div class="spec-grid">
                            <div class="spec-input-group">
                                <label>üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</label>
                                <input type="number" class="form-input small" id="eSL" value="${u.shape_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>üëë ÌòïÏÉÅ Ïã†Ìôî</label>
                                <input type="number" class="form-input small" id="eSM" value="${u.shape_myth || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</label>
                                <input type="number" class="form-input small" id="eML" value="${u.mount_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</label>
                                <input type="number" class="form-input small" id="eMM" value="${u.mount_myth || 0}" min="0" max="99">
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const showCount = (count) => count > 0 ? `<span class="spec-count">${count}Í∞ú</span>` : `<span class="spec-count zero">ÏóÜÏùå</span>`;
                specSection = `
                    <div class="form-group"><label class="form-label">Î≥¥Ïú† Ïä§Ìéô (Ï°∞Ìöå Ï†ÑÏö©)</label>
                        <div class="info-grid" style="margin-top:10px;">
                            <div class="info-item"><span class="info-label">üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</span>${showCount(u.shape_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">üëë ÌòïÏÉÅ Ïã†Ìôî</span>${showCount(u.shape_myth || 0)}</div>
                            <div class="info-item"><span class="info-label">üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</span>${showCount(u.mount_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</span>${showCount(u.mount_myth || 0)}</div>
                        </div>
                        <p style="font-size:12px; color:#6b7280; margin-top:8px;">‚Äª Ïä§Ìéô Í∞úÏàòÎäî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÑ§Ï†ïÌï©ÎãàÎã§</p>
                    </div>
                `;
            }
            
           
            const deleteBtn = isAdmin ? `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <button type="button" id="deleteUserBtn" class="btn" style="width:100%; background:#ef4444; color:white;">üóëÔ∏è Ïù¥ ÏÇ¨Ïö©Ïûê Îì±Î°ù Ìï¥Ï†ú</button>
                </div>
            ` : '';
            
            const html = `
                <div class="form-group"><label class="form-label">Í∏∏Îìú</label><select id="editGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">Ï†ÑÌà¨Î†•</label><input type="text" id="editPower" class="form-input" value="${u.power}" inputmode="numeric"><p style="font-size:12px; color:#6b7280; margin-top:4px;">‚Äª Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§</p></div>
                ${specSection}
                ${deleteBtn}
            `;
            openSmallModal('Ï†ïÎ≥¥ ÏàòÏ†ï', u.name, html);

                       if (isAdmin) {
                setTimeout(() => {
                    const deleteBtnEl = document.getElementById('deleteUserBtn');
                    if (deleteBtnEl) {
                        deleteBtnEl.onclick = () => {
                            closeModal();
                            setTimeout(() => deleteUser(u.name), 300);
                        };
                    }
                }, 100);
            }

            document.getElementById('modalSubmit').innerText = "ÏàòÏ†ï ÏôÑÎ£å";
            document.getElementById('modalSubmit').onclick = async () => {
                // ÎçîÎ∏îÌÅ¥Î¶≠ Î∞©ÏßÄ
                const submitBtn = document.getElementById('modalSubmit');
                if (submitBtn.disabled) return;
                submitBtn.disabled = true;
                submitBtn.innerText = 'Ï≤òÎ¶¨ Ï§ë...';
                
                try {
                    const nGuild = document.getElementById('editGuild').value;
                    const powerInput = document.getElementById('editPower').value.replace(/,/g,"").trim();
                    
                                   if (!powerInput) {
                        showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'ÏàòÏ†ï ÏôÑÎ£å';
                        return;
                    }
                    
                    if (!/^\d+$/.test(powerInput)) {
                        showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'ÏàòÏ†ï ÏôÑÎ£å';
                        return;
                    }
                    
                    const nPower = Number(powerInput);
                    
                    if (isNaN(nPower) || nPower < 0) {
                        showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïò¨Î∞îÎ•∏ Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'ÏàòÏ†ï ÏôÑÎ£å';
                        return;
                    }
                
                let newData = {
                    guild: nGuild,
                    power: nPower,
                    updatedAt: Date.now(),
                    updatedBy: isAdmin ? 'admin' : 'user'
                };
                
                let newSL = u.shape_legend || 0;
                let newSM = u.shape_myth || 0;
                let newML = u.mount_legend || 0;
                let newMM = u.mount_myth || 0;
                
                if (isAdmin) {
                    newSL = Number(document.getElementById('eSL').value) || 0;
                    newSM = Number(document.getElementById('eSM').value) || 0;
                    newML = Number(document.getElementById('eML').value) || 0;
                    newMM = Number(document.getElementById('eMM').value) || 0;
                    newData.shape_legend = newSL;
                    newData.shape_myth = newSM;
                    newData.mount_legend = newML;
                    newData.mount_myth = newMM;
                }
                
                const changes = [];
                if (u.power !== nPower) {
                    changes.push(`Ï†ÑÌà¨Î†•: ${u.power.toLocaleString()} ‚Üí ${nPower.toLocaleString()}`);
                }
                if (u.guild !== nGuild) {
                    changes.push(`Í∏∏Îìú: ${u.guild} ‚Üí ${nGuild}`);
                }
                if (isAdmin) {
                    if ((u.shape_legend || 0) !== newSL) {
                        changes.push(`ÌòïÏÉÅÏ†ÑÏÑ§: ${u.shape_legend || 0} ‚Üí ${newSL}`);
                    }
                    if ((u.shape_myth || 0) !== newSM) {
                        changes.push(`ÌòïÏÉÅÏã†Ìôî: ${u.shape_myth || 0} ‚Üí ${newSM}`);
                    }
                    if ((u.mount_legend || 0) !== newML) {
                        changes.push(`ÌÉàÍ≤ÉÏ†ÑÏÑ§: ${u.mount_legend || 0} ‚Üí ${newML}`);
                    }
                    if ((u.mount_myth || 0) !== newMM) {
                        changes.push(`ÌÉàÍ≤ÉÏã†Ìôî: ${u.mount_myth || 0} ‚Üí ${newMM}`);
                    }
                }
                
                const oldValues = {
                    power: u.power,
                    guild: u.guild,
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                };
                
                const newValues = {
                    power: nPower,
                    guild: nGuild,
                    shape_legend: newSL,
                    shape_myth: newSM,
                    mount_legend: newML,
                    mount_myth: newMM
                };

                await updateDoc(doc(db, "users", u.name), newData);
                
                // Î≥ÄÍ≤Ω ÎÇ¥Ïö©Ïóê Îî∞Îùº Î°úÍ∑∏ ÌÉÄÏûÖ Í≤∞Ï†ï
                let logType = 'info_edit';
                const powerChanged = u.power !== nPower;
                const guildChanged = u.guild !== nGuild;
                const specChanged = isAdmin && (
                    (u.shape_legend || 0) !== newSL ||
                    (u.shape_myth || 0) !== newSM ||
                    (u.mount_legend || 0) !== newML ||
                    (u.mount_myth || 0) !== newMM
                );
                
                // Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ ÎïåÎßå Î°úÍ∑∏ Ï†ÄÏû•
                const hasAnyChange = powerChanged || guildChanged || specChanged;
                
                if (hasAnyChange) {
                    if (guildChanged && !powerChanged && !specChanged) {
                        logType = 'guild_change';  // Í∏∏ÎìúÎßå Î≥ÄÍ≤Ω
                    } else if (powerChanged && !guildChanged && !specChanged) {
                        logType = 'power';  // Ï†ÑÌà¨Î†•Îßå Î≥ÄÍ≤Ω
                    } else if (specChanged && !powerChanged && !guildChanged) {
                        logType = 'spec_edit';  // Ïä§ÌéôÎßå Î≥ÄÍ≤Ω
                    }
                    // Ïó¨Îü¨ Ìï≠Î™© Î≥ÄÍ≤Ω Ïãú info_edit Ïú†ÏßÄ
                    
                    await setDoc(doc(collection(db, "logs")), { 
                        who: u.name, 
                        type: logType, 
                        old_value: JSON.stringify(oldValues), 
                        new_value: JSON.stringify(newValues),
                        changes: changes.join(', '),
                        editedBy: isAdmin ? (loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') : 'self',
                        createdAt: Date.now(), 
                        ip: await getIp(),
                        location: (await getIpAndLocation()).location,
                        device: parseUserAgent(navigator.userAgent)
                    });
                }
                
                showAlert('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§', 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(nGuild);
                }, 500);
                } catch (e) {
                    console.error('ÏàòÏ†ï Ïò§Î•ò:', e);
                    showAlert('ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                    const submitBtn = document.getElementById('modalSubmit');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'ÏàòÏ†ï ÏôÑÎ£å';
                    }
                }
            };
        }

               document.getElementById('bulkAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            
            const html = `
                <div class="form-group"><label class="form-label">1. Ïù¥ÎèôÏãúÌÇ¨ Í∏∏Îìú ÏÑ†ÌÉù</label><select id="bulkGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">2. Î∂ÄÏó¨Ìï† Ïä§Ìéô Í∞úÏàò</label>
                    <div class="spec-grid">
                        <div class="spec-input-group">
                            <label>üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</label>
                            <input type="number" class="form-input small" id="bSL" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>üëë ÌòïÏÉÅ Ïã†Ìôî</label>
                            <input type="number" class="form-input small" id="bSM" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</label>
                            <input type="number" class="form-input small" id="bML" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</label>
                            <input type="number" class="form-input small" id="bMM" value="0" min="0" max="99">
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">3. ÎãâÎÑ§ÏûÑ ÏûÖÎ†• (ÏÑ∏Î°úÎ°ú ÏóîÌÑ∞Ï≥êÏÑú ÏûÖÎ†•)</label>
                    <textarea id="bulkNames" class="form-input" rows="8" placeholder="ÌôçÍ∏∏Îèô&#10;ÏûÑÍ∫ΩÏ†ï&#10;ÏïÑÎ¨¥Í∞ú"></textarea>
                </div>
                <p style="font-size:12px; color:#666;">‚Äª Í∏∞Ï°¥ Ïú†Ï†ÄÎäî Í∏∏ÎìúÏôÄ Ïä§ÌéôÏù¥ Î≥ÄÍ≤ΩÎêòÍ≥† <b>Ï†ÑÌà¨Î†•ÏùÄ Ïú†ÏßÄ</b>Îê©ÎãàÎã§.<br>‚Äª Ïã†Í∑ú Ïú†Ï†ÄÎäî Ï†ÑÌà¨Î†• 0ÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§.</p>
            `;
            openLargeModal('ÏùºÍ¥Ñ Îì±Î°ù', 'Ïó¨Îü¨ Ïú†Ï†ÄÎ•º Ìïú Î≤àÏóê Îì±Î°ùÌï©ÎãàÎã§.');
            setModalBody(html);

            const footerBtn = document.createElement('button');
            footerBtn.className = "btn btn-primary";
            footerBtn.innerText = "ÏùºÍ¥Ñ Ï†ÅÏö© Ïã§Ìñâ";
            footerBtn.onclick = executeBulkUpdate;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Îã´Í∏∞";
            closeBtn.onclick = closeModal;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.textAlign = "right";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";
            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(footerBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        });

        async function executeBulkUpdate() {
            const targetGuild = document.getElementById('bulkGuild').value;
            const namesText = document.getElementById('bulkNames').value;
            const specs = {
                shape_legend: Number(document.getElementById('bSL').value) || 0,
                shape_myth: Number(document.getElementById('bSM').value) || 0,
                mount_legend: Number(document.getElementById('bML').value) || 0,
                mount_myth: Number(document.getElementById('bMM').value) || 0
            };

            if(!namesText.trim()) { showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); return; }

            const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
            let updateCount = 0;
            let newCount = 0;

            const btn = event.target;
            btn.innerText = "Ï≤òÎ¶¨ Ï§ë...";
            btn.disabled = true;
            
            // ÏßÑÌñâÎ•† Î™®Îã¨ ÌëúÏãú
            const progress = showProgress('üìù ÏùºÍ¥Ñ Îì±Î°ù Ï§ë', `${names.length}Î™Ö Ï≤òÎ¶¨ Ï§ë...`);

            try {
                for(let i = 0; i < names.length; i++) {
                    const name = names[i];
                    const docRef = doc(db, "users", name);
                    const docSnap = await getDoc(docRef);

                    if(docSnap.exists()) {
                        await updateDoc(docRef, {
                            guild: targetGuild,
                            ...specs
                        });
                        updateCount++;
                    } else {
                        await setDoc(docRef, {
                            name: name,
                            guild: targetGuild,
                            power: 0,
                            password: null,
                            ...specs
                        });
                        newCount++;
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    progress.update(((i + 1) / names.length) * 100, `${i + 1}/${names.length} Ï≤òÎ¶¨ Ï§ë... (${name})`);
                }
                
                progress.close();
                
                await setDoc(doc(collection(db, "logs")), { 
                    who: 'Admin', 
                    type: 'bulk_update', 
                    old_value: '-', 
                    new_value: `${names.length}Î™Ö Ï≤òÎ¶¨`, 
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    location: (await getIpAndLocation()).location,
                    device: parseUserAgent(navigator.userAgent)
                });

                showAlert(`ÏôÑÎ£å! (ÏàòÏ†ï:${updateCount}, Ïã†Í∑ú:${newCount})`, 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(targetGuild);
                }, 500);

            } catch(e) {
                progress.close();
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
                btn.innerText = "ÏùºÍ¥Ñ Ï†ÅÏö© Ïã§Ìñâ";
                btn.disabled = false;
            }
        }

               document.getElementById('guildMoveBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            
            const html = `
                <div style="background:#f0f9ff; border:2px solid #0ea5e9; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <p style="color:#0369a1; font-weight:600; margin-bottom:8px;">üöÄ Í∏∏Îìú Ïù¥Îèô ÏïàÎÇ¥</p>
                    <ul style="color:#075985; font-size:13px; margin:0; padding-left:20px;">
                        <li>ÏûÖÎ†•Îêú ÎãâÎÑ§ÏûÑÏùÑ ÏÑ†ÌÉùÌïú Í∏∏ÎìúÎ°ú ÏùºÍ¥Ñ Ïù¥ÎèôÌï©ÎãàÎã§.</li>
                        <li>Ïù¥ÎØ∏ Ìï¥Îãπ Í∏∏ÎìúÏóê ÏûàÎäî Ïú†Ï†ÄÎäî ÏûêÎèôÏúºÎ°ú Í±¥ÎÑàÎúÅÎãàÎã§.</li>
                        <li>Ï†ÑÌà¨Î†•Í≥º Ïä§Ìéô Ï†ïÎ≥¥Îäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.</li>
                        <li>Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ ÎãâÎÑ§ÏûÑÏùÄ Î¨¥ÏãúÎê©ÎãàÎã§.</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥ÎèôÌï† Í∏∏Îìú ÏÑ†ÌÉù</label>
                    <select id="moveTargetGuild" class="form-input">${guildOptions}</select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥ÎèôÌï† ÎãâÎÑ§ÏûÑ ÏûÖÎ†• (Ìïú Ï§ÑÏóê ÌïòÎÇòÏî©)</label>
                    <textarea id="moveNames" class="form-input" rows="10" placeholder="ÌôçÍ∏∏Îèô&#10;ÏûÑÍ∫ΩÏ†ï&#10;ÏïÑÎ¨¥Í∞ú&#10;..."></textarea>
                </div>
            `;
            openLargeModal('üöÄ Í∏∏Îìú Ïù¥Îèô', 'Ïó¨Îü¨ Ïú†Ï†ÄÎ•º Ìïú Î≤àÏóê Îã§Î•∏ Í∏∏ÎìúÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
            setModalBody(html);

            const footerBtn = document.createElement('button');
            footerBtn.className = "btn btn-primary";
            footerBtn.style.background = "#0ea5e9";
            footerBtn.innerText = "Í∏∏Îìú Ïù¥Îèô Ïã§Ìñâ";
            footerBtn.onclick = executeGuildMove;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Ï∑®ÏÜå";
            closeBtn.onclick = closeModal;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.textAlign = "right";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";
            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(footerBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        });

        async function executeGuildMove() {
            const targetGuild = document.getElementById('moveTargetGuild').value;
            const namesText = document.getElementById('moveNames').value;

            if(!namesText.trim()) { 
                showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); 
                return; 
            }

            const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
            
            if(names.length === 0) {
                showAlert('Ïú†Ìö®Ìïú ÎãâÎÑ§ÏûÑÏù¥ ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            const btn = event.target;
            btn.innerText = "Ï≤òÎ¶¨ Ï§ë...";
            btn.disabled = true;
            
            // ÏßÑÌñâÎ•† Î™®Îã¨ ÌëúÏãú
            const progress = showProgress('üöÄ Í∏∏Îìú Ïù¥Îèô Ï§ë', `${names.length}Î™Ö Ï≤òÎ¶¨ Ï§ë...`);

            let movedCount = 0;                 let skippedCount = 0;               let notFoundCount = 0;              const movedUsers = [];
            const skippedUsers = [];
            const notFoundUsers = [];

            try {
                for(let i = 0; i < names.length; i++) {
                    const name = names[i];
                    const docRef = doc(db, "users", name);
                    const docSnap = await getDoc(docRef);

                    if(docSnap.exists()) {
                        const userData = docSnap.data();
                        
                        if(userData.guild === targetGuild) {
                                                       skippedCount++;
                            skippedUsers.push(name);
                        } else {
                                                       const oldGuild = userData.guild;
                            await updateDoc(docRef, {
                                guild: targetGuild,
                                updatedAt: Date.now(),
                                updatedBy: 'admin'
                            });
                            movedCount++;
                            movedUsers.push({ name, from: oldGuild, to: targetGuild });
                        }
                    } else {
                                               notFoundCount++;
                        notFoundUsers.push(name);
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    progress.update(((i + 1) / names.length) * 100, `${i + 1}/${names.length} Ï≤òÎ¶¨ Ï§ë... (${name})`);
                }
                
                progress.close();
                
                // Ïù¥ÎèôÎêú Ïú†Ï†Ä Ïù¥Î¶Ñ Î™©Î°ù
                const movedNames = movedUsers.map(u => u.name).join(', ');
                
                               await setDoc(doc(collection(db, "logs")), { 
                    who: movedNames || 'Admin', 
                    type: 'guild_move', 
                    old_value: '-', 
                    new_value: `${targetGuild}ÏúºÎ°ú ${movedCount}Î™Ö Ïù¥Îèô`, 
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    location: (await getIpAndLocation()).location,
                    device: parseUserAgent(navigator.userAgent)
                });

                               showGuildMoveResult(targetGuild, movedUsers, skippedUsers, notFoundUsers);
                
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(targetGuild);
                }, 500);

            } catch(e) {
                progress.close();
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
                btn.innerText = "Í∏∏Îìú Ïù¥Îèô Ïã§Ìñâ";
                btn.disabled = false;
            }
        }

        function showGuildMoveResult(targetGuild, movedUsers, skippedUsers, notFoundUsers) {
            openLargeModal('üöÄ Í∏∏Îìú Ïù¥Îèô ÏôÑÎ£å', `${targetGuild} Í∏∏ÎìúÎ°ú Ïù¥Îèô Í≤∞Í≥º`);
            
            let html = `
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:20px;">
                    <div style="background:#dcfce7; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#16a34a;">${movedUsers.length}</div>
                        <div style="font-size:13px; color:#166534;">‚úÖ Ïù¥Îèô ÏÑ±Í≥µ</div>
                    </div>
                    <div style="background:#fef3c7; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#d97706;">${skippedUsers.length}</div>
                        <div style="font-size:13px; color:#92400e;">‚è≠Ô∏è Í±¥ÎÑàÎúÄ</div>
                    </div>
                    <div style="background:#fee2e2; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#dc2626;">${notFoundUsers.length}</div>
                        <div style="font-size:13px; color:#991b1b;">‚ùå ÎØ∏Îì±Î°ù</div>
                    </div>
                </div>`;
            
                       if(movedUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;" open>
                        <summary style="cursor:pointer; font-weight:600; color:#16a34a; margin-bottom:8px;">‚úÖ Ïù¥Îèô ÏÑ±Í≥µ (${movedUsers.length}Î™Ö)</summary>
                        <div style="background:#f0fdf4; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${movedUsers.map(u => `<span style="display:inline-block; background:#dcfce7; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u.name} <span style="color:#6b7280;">(${u.from}‚Üí${u.to})</span></span>`).join('')}
                        </div>
                    </details>`;
            }
            
                       if(skippedUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;">
                        <summary style="cursor:pointer; font-weight:600; color:#d97706; margin-bottom:8px;">‚è≠Ô∏è Í±¥ÎÑàÎúÄ - Ïù¥ÎØ∏ ${targetGuild} ÏÜåÏÜç (${skippedUsers.length}Î™Ö)</summary>
                        <div style="background:#fffbeb; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${skippedUsers.map(u => `<span style="display:inline-block; background:#fef3c7; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u}</span>`).join('')}
                        </div>
                    </details>`;
            }
            
                       if(notFoundUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;">
                        <summary style="cursor:pointer; font-weight:600; color:#dc2626; margin-bottom:8px;">‚ùå ÎØ∏Îì±Î°ù Ïú†Ï†Ä (${notFoundUsers.length}Î™Ö)</summary>
                        <div style="background:#fef2f2; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${notFoundUsers.map(u => `<span style="display:inline-block; background:#fee2e2; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u}</span>`).join('')}
                        </div>
                    </details>`;
            }
            
            html += `<div style="text-align:right; margin-top:20px;">
                <button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>
            </div>`;
            
            setModalBody(html);
            document.getElementById('modalFooter').style.display = 'none';
        }

       
               async function checkLockStatusRealtime() {
            try {
                const docRef = doc(db, "config", "system");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const startTime = data.lockStartTime || 0;
                    const endTime = data.lockEndTime || 0;
                    const now = Date.now();
                    return (startTime > 0 && endTime > 0 && now >= startTime && now <= endTime);
                }
                return false;
            } catch (e) {
                console.log("Lock check error", e);
                return false;
            }
        }

        async function openPowerEditModal(name, u) {
           
            if (!isAdmin) {
                const isLocked = await checkLockStatusRealtime();
                if (isLocked) {
                    showAlert('ÌòÑÏû¨ ÏàòÏ†ï Í∏àÏßÄ ÏãúÍ∞ÑÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    await checkLockStatus();
                    return;
                }
            }
            
            openSmallModal('Ï†ÑÌà¨Î†• ÏàòÏ†ï', `ÌòÑÏû¨: ${u.power.toLocaleString()}`, `
                <div class="form-group">
                    <input type="text" class="form-input" id="editInput" value="${u.power}" inputmode="numeric">
                    <p style="font-size:12px; color:#6b7280; margin-top:8px;">‚Äª Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§</p>
                </div>
            `);
            setTimeout(() => { const i=document.getElementById('editInput'); i.focus(); i.select(); }, 100);
            
            document.getElementById('modalSubmit').onclick = async () => {
                               if (!isAdmin) {
                    const isLocked = await checkLockStatusRealtime();
                    if (isLocked) {
                        showAlert('ÌòÑÏû¨ ÏàòÏ†ï Í∏àÏßÄ ÏãúÍ∞ÑÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        closeModal();
                        await checkLockStatus();
                        return;
                    }
                }
                
                const inputVal = document.getElementById('editInput').value.replace(/,/g, "").trim();
                
                               if (!inputVal) {
                    showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (!/^\d+$/.test(inputVal)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const val = Number(inputVal);
                
                               if (isNaN(val)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïò¨Î∞îÎ•∏ Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (val < 0) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ 0 Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                    return;
                }
                
                try {
                    await updateDoc(doc(db, "users", name), { 
                        power: val,
                        updatedAt: Date.now(),
                        updatedBy: isAdmin ? 'admin' : 'user'
                    });
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'power', 
                        old_value: u.power, 
                        new_value: val, 
                        editedBy: isAdmin ? (loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') : 'self',                        createdAt: Date.now(), 
                        ip: await getIp(),
                        location: (await getIpAndLocation()).location,
                        device: parseUserAgent(navigator.userAgent) 
                    });
                    closeModal(); 
                    showAlert('ÏàòÏ†ï ÏôÑÎ£å', 'success'); 
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(u.guild);
                    }, 500);
                } catch (e) { 
                    showAlert('Ïò§Î•ò Î∞úÏÉù', 'error'); 
                }
            };
        }

               document.getElementById('adminLoginBtn').addEventListener('click', () => {
            if(isAdmin) { 
                openSmallModal('Î°úÍ∑∏ÏïÑÏõÉ', 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏùÑ Ìï¥Ï†úÌï©ÎãàÎã§', `<div style="text-align:center; padding:10px 0; color:#374151;">Ï†ïÎßê Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>`);
                const btn = document.getElementById('modalSubmit');
                btn.innerText = "Î°úÍ∑∏ÏïÑÏõÉ"; 
                btn.style.backgroundColor = "#ef4444";
                btn.onclick = async () => { 
                    closeModal();
                   
                    localStorage.removeItem('adminAutoLogin');
                    await adminLogout(false);
                };
                return; 
            }
            openSmallModal('Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏', '', `
                <div class="form-group"><input type="text" class="form-input" id="aid" placeholder="ID" autocomplete="off"></div>
                <div class="form-group"><input type="password" class="form-input" id="apw" placeholder="PW" autocomplete="off"></div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="autoLoginCheck" style="width:18px; height:18px; cursor:pointer;">
                    <label for="autoLoginCheck" style="font-size:14px; color:#374151; cursor:pointer;">ÏûêÎèô Î°úÍ∑∏Ïù∏</label>
                </div>
            `);
            const btn = document.getElementById('modalSubmit'); 
            btn.innerText = "ÌôïÏù∏"; 
            btn.style.backgroundColor = "";
            btn.onclick = async () => {
                const inputId = document.getElementById('aid').value;
                const inputPw = document.getElementById('apw').value;
                const autoLogin = document.getElementById('autoLoginCheck').checked;
                
                               if (btoa(inputId) === _0x.a && btoa(inputPw) === _0x.b) {
                    isAdmin = true;
                    isSuperAdmin = true;
                    loggedInAdminId = inputId;
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('isSuperAdmin', 'true');
                    sessionStorage.setItem('loggedInAdminId', inputId);
                   
                    if (autoLogin) {
                        localStorage.setItem('adminAutoLogin', btoa(JSON.stringify({id: inputId, pw: inputPw, type: 'super'})));
                    }
                    
                    // Ï†ëÏÜç Î°úÍ∑∏ Í∏∞Î°ù
                    try {
                        const { ip, location } = await getIpAndLocation();
                        await setDoc(doc(collection(db, "adminLogs")), {
                            adminId: inputId,
                            loginAt: Date.now(),
                            ip: ip,
                            location: location,
                            device: parseUserAgent(navigator.userAgent),
                            loginType: 'ÏàòÎèô'
                        });
                    } catch(e) { console.error('Admin log error:', e); }
                    
                    resetAdminSessionTimer();
                    updateAdminUI(); 
                    closeModal(); 
                    showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎ°ú Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                    await checkPendingUsers();
                   
                    await loadData();
                    return;
                }
                
                               try {
                    const adminDoc = await getDoc(doc(db, "admins", inputId));
                    if (adminDoc.exists() && adminDoc.data().password === inputPw) {
                        isAdmin = true;
                        isSuperAdmin = false;
                        loggedInAdminId = inputId;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.removeItem('isSuperAdmin');
                        sessionStorage.setItem('loggedInAdminId', inputId);
                       
                        if (autoLogin) {
                            localStorage.setItem('adminAutoLogin', btoa(JSON.stringify({id: inputId, pw: inputPw, type: 'normal'})));
                        }
                        
                        // Ï†ëÏÜç Î°úÍ∑∏ Í∏∞Î°ù
                        try {
                            const { ip, location } = await getIpAndLocation();
                            await setDoc(doc(collection(db, "adminLogs")), {
                                adminId: inputId,
                                loginAt: Date.now(),
                                ip: ip,
                                location: location,
                                device: parseUserAgent(navigator.userAgent),
                                loginType: 'ÏàòÎèô'
                            });
                        } catch(e) { console.error('Admin log error:', e); }
                        
                        resetAdminSessionTimer();
                        updateAdminUI();
                        closeModal();
                        showAlert('Í¥ÄÎ¶¨ÏûêÎ°ú Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                        await checkPendingUsers();
                       
                        await loadData();
                        return;
                    }
                } catch (e) {
                    console.error('Admin check error:', e);
                }
                
                showAlert('Ï†ïÎ≥¥ Î∂àÏùºÏπò', 'error');
            };
        });
        

        async function tryAutoLogin() {
            const saved = localStorage.getItem('adminAutoLogin');
            if (!saved) return false;
            
            try {
                const {id, pw, type} = JSON.parse(atob(saved));
                
                if (type === 'super') {
                    if (btoa(id) === _0x.a && btoa(pw) === _0x.b) {
                        isAdmin = true;
                        isSuperAdmin = true;
                        loggedInAdminId = id;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.setItem('isSuperAdmin', 'true');
                        sessionStorage.setItem('loggedInAdminId', id);
                        resetAdminSessionTimer();
                        updateAdminUI();
                        await checkPendingUsers();
                        
                        // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ï†ëÏÜç Î°úÍ∑∏ Í∏∞Î°ù
                        try {
                            const { ip, location } = await getIpAndLocation();
                            await setDoc(doc(collection(db, "adminLogs")), {
                                adminId: id,
                                loginAt: Date.now(),
                                ip: ip,
                                location: location,
                                device: parseUserAgent(navigator.userAgent),
                                loginType: 'ÏûêÎèô'
                            });
                        } catch(e) { console.error('Admin log error:', e); }
                        
                        return true;
                    }
                } else {
                    const adminDoc = await getDoc(doc(db, "admins", id));
                    if (adminDoc.exists() && adminDoc.data().password === pw) {
                        isAdmin = true;
                        isSuperAdmin = false;
                        loggedInAdminId = id;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.removeItem('isSuperAdmin');
                        sessionStorage.setItem('loggedInAdminId', id);
                        resetAdminSessionTimer();
                        updateAdminUI();
                        await checkPendingUsers();
                        
                        // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ï†ëÏÜç Î°úÍ∑∏ Í∏∞Î°ù
                        try {
                            const { ip, location } = await getIpAndLocation();
                            await setDoc(doc(collection(db, "adminLogs")), {
                                adminId: id,
                                loginAt: Date.now(),
                                ip: ip,
                                location: location,
                                device: parseUserAgent(navigator.userAgent),
                                loginType: 'ÏûêÎèô'
                            });
                        } catch(e) { console.error('Admin log error:', e); }
                        
                        return true;
                    }
                }
               
                localStorage.removeItem('adminAutoLogin');
            } catch (e) {
                console.error('Auto login error:', e);
                localStorage.removeItem('adminAutoLogin');
            }
            return false;
        }

               document.getElementById('guildAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            openSmallModal('Í∏∏Îìú Ï∂îÍ∞Ä', '', `<div class="form-group"><input type="text" class="form-input" id="newGuildInput" autocomplete="off"></div>`);
            setTimeout(() => document.getElementById('newGuildInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('newGuildInput').value.trim();
                if(!name || guildList.includes(name)) { showAlert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå', 'error'); return; }
                await updateDoc(doc(db, "config", "guilds"), { names: [...guildList, name] });
                showAlert('Ï∂îÍ∞ÄÎê®', 'success'); closeModal(); setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('guildDeleteBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            
            const guildOptions = guildList.map(g => {
                const memberCount = guildDataMap[g] ? guildDataMap[g].length : 0;
                return `<option value="${g}">${g} (${memberCount}Î™Ö)</option>`;
            }).join('');
            
            openLargeModal('üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú', 'ÏÇ≠Ï†úÌï† Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
            
            const html = `
                <div style="background:#fef2f2; border:2px solid #dc2626; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <p style="color:#dc2626; font-weight:600; margin-bottom:8px;">‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠</p>
                    <ul style="color:#991b1b; font-size:13px; margin:0; padding-left:20px;">
                        <li>Í∏∏ÎìúÏóê ÏÜåÏÜçÎêú Ïú†Ï†ÄÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.</li>
                        <li>Î®ºÏ†Ä 'Í∏∏Îìú Ïù¥Îèô' Í∏∞Îä•ÏúºÎ°ú Ïú†Ï†ÄÎ•º Îã§Î•∏ Í∏∏ÎìúÎ°ú Ïù¥ÎèôÏãúÏºúÏ£ºÏÑ∏Ïöî.</li>
                        <li>ÏÇ≠Ï†úÎêú Í∏∏ÎìúÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÇ≠Ï†úÌï† Í∏∏Îìú ÏÑ†ÌÉù</label>
                    <select id="deleteGuildSelect" class="form-input">${guildOptions}</select>
                </div>
                <div id="guildDeleteInfo" style="margin-top:16px; padding:16px; background:#f9fafb; border-radius:8px;">
                    <p style="color:#6b7280; text-align:center;">Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.</p>
                </div>
            `;
            
            setModalBody(html);
            
            const updateGuildInfo = () => {
                const selectedGuild = document.getElementById('deleteGuildSelect').value;
                const members = guildDataMap[selectedGuild] || [];
                const infoDiv = document.getElementById('guildDeleteInfo');
                
                if (members.length > 0) {
                    infoDiv.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:48px; margin-bottom:8px;">üö´</div>
                            <p style="color:#dc2626; font-weight:600; font-size:16px;">ÏÇ≠Ï†ú Î∂àÍ∞Ä</p>
                            <p style="color:#991b1b; margin-top:8px;">${selectedGuild} Í∏∏ÎìúÏóê <strong>${members.length}Î™Ö</strong>Ïùò Ïú†Ï†ÄÍ∞Ä ÏûàÏäµÎãàÎã§.</p>
                            <p style="color:#6b7280; font-size:13px; margin-top:12px;">Í∏∏Îìú Ïù¥Îèô Í∏∞Îä•ÏúºÎ°ú Ïú†Ï†ÄÎ•º Î®ºÏ†Ä Ïù¥ÎèôÏãúÏºúÏ£ºÏÑ∏Ïöî.</p>
                            <div style="margin-top:16px; max-height:150px; overflow-y:auto; text-align:left; background:#fee2e2; padding:12px; border-radius:8px;">
                                <p style="font-size:12px; color:#991b1b; margin-bottom:8px;">ÏÜåÏÜç Ïú†Ï†Ä Î™©Î°ù:</p>
                                ${members.map(m => `<span style="display:inline-block; background:#fecaca; padding:2px 8px; margin:2px; border-radius:4px; font-size:11px;">${m.name}</span>`).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:48px; margin-bottom:8px;">‚úÖ</div>
                            <p style="color:#16a34a; font-weight:600; font-size:16px;">ÏÇ≠Ï†ú Í∞ÄÎä•</p>
                            <p style="color:#166534; margin-top:8px;">${selectedGuild} Í∏∏ÎìúÏóê ÏÜåÏÜçÎêú Ïú†Ï†ÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <button id="confirmDeleteGuildBtn" class="btn btn-primary" style="margin-top:16px; background:#dc2626;">üóëÔ∏è ${selectedGuild} Í∏∏Îìú ÏÇ≠Ï†ú</button>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        const deleteBtn = document.getElementById('confirmDeleteGuildBtn');
                        if (deleteBtn) {
                            deleteBtn.onclick = async () => {
                                if (!await showConfirm('Í∏∏Îìú ÏÇ≠Ï†ú ÌôïÏù∏', `Ï†ïÎßêÎ°ú <strong>${selectedGuild}</strong> Í∏∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br><br><span style="color:#dc2626;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.</span>`)) return;
                                
                                try {
                                    const newGuildList = guildList.filter(g => g !== selectedGuild);
                                    await updateDoc(doc(db, "config", "guilds"), { names: newGuildList });
                                    
                                    await setDoc(doc(collection(db, "logs")), {
                                        who: 'Admin',
                                        type: 'guild_delete',
                                        old_value: selectedGuild,
                                        new_value: 'Í∏∏Îìú ÏÇ≠Ï†úÎê®',
                                        editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                                        createdAt: Date.now(),
                                        ip: await getIp()
                                    });
                                    
                                    showAlert(`${selectedGuild} Í∏∏ÎìúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
                                    closeModal();
                                    setTimeout(() => location.reload(), 1000);
                                } catch (e) {
                                    console.error(e);
                                    showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                                }
                            };
                        }
                    }, 100);
                }
            };
            
            document.getElementById('deleteGuildSelect').addEventListener('change', updateGuildInfo);
            updateGuildInfo();
            
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
        });

        document.getElementById('excelBtn').addEventListener('click', () => {
            if(!isAdmin || allGuildData.length === 0) return;
            
            // Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Î™®Îã¨
            openSmallModal('üîó Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±', 'ÌòÑÏû¨ Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ Í≥µÏú†Ìï©ÎãàÎã§', `
                <div class="form-group">
                    <label class="form-label">ÌéòÏù¥ÏßÄ Ï†úÎ™©</label>
                    <input type="text" id="shareTitle" class="form-input" value="üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê" placeholder="Ïπ¥Ïπ¥Ïò§ÌÜ°Ïóê ÌëúÏãúÎê† Ï†úÎ™©">
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÑ§Î™Ö (ÏÑ†ÌÉù)</label>
                    <input type="text" id="shareDesc" class="form-input" placeholder="Ï∂îÍ∞Ä ÏÑ§Î™Ö ÏûÖÎ†•">
                </div>
                <div class="form-group">
                    <label class="form-label">Ï†ïÎ†¨ Í∏∞Ï§Ä</label>
                    <select id="shareSortType" class="form-input">
                        <option value="power">Ï†ÑÌà¨Î†•Ïàú (ÎÜíÏùÄÏàú)</option>
                        <option value="guild">Í∏∏ÎìúÎ≥Ñ (Ï†ÑÌà¨Î†•Ïàú)</option>
                        <option value="name">Ïù¥Î¶ÑÏàú (Í∞ÄÎÇòÎã§)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ìè¨Ìï®Ìï† Í∏∏Îìú</label>
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
                        ${guildList.map(g => `
                            <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                                <input type="checkbox" class="share-guild-check" value="${g}" checked>
                                <span style="font-size:13px;">${g}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `);
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn" onclick="closeModal()" style="background:#6b7280; color:white;">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" onclick="generateShareLinkCurrent()">üîó ÎßÅÌÅ¨ ÏÉùÏÑ±</button>
            `;
        });
        
        // ÌòÑÏû¨ Ï†ÑÌà¨Î†• Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±
        window.generateShareLinkCurrent = async function() {
            const pageTitle = document.getElementById('shareTitle').value.trim() || 'üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê';
            const description = document.getElementById('shareDesc').value.trim() || '';
            const sortType = document.getElementById('shareSortType').value;
            const selectedGuilds = Array.from(document.querySelectorAll('.share-guild-check:checked')).map(c => c.value);
            
            if (selectedGuilds.length === 0) {
                showAlert('ÏµúÏÜå 1Í∞ú Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }
            
            // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ Î∞è Ï†ïÎ†¨
            let data = allGuildData.filter(u => selectedGuilds.includes(u.guild));
            
            if (sortType === 'power') {
                data.sort((a, b) => b.power - a.power);
            } else if (sortType === 'guild') {
                data.sort((a, b) => {
                    if (a.guild !== b.guild) return guildList.indexOf(a.guild) - guildList.indexOf(b.guild);
                    return b.power - a.power;
                });
            } else if (sortType === 'name') {
                data.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            }
            
            // Í∏∏ÎìúÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            const guildStats = {};
            selectedGuilds.forEach(guild => {
                const guildUsers = data.filter(u => u.guild === guild);
                const totalPower = guildUsers.reduce((sum, u) => sum + u.power, 0);
                guildStats[guild] = {
                    count: guildUsers.length,
                    totalPower: totalPower,
                    totalDiff: 0
                };
            });
            
            const totalPower = data.reduce((sum, u) => sum + u.power, 0);
            
            try {
                // Í≥µÏú† Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                const shareId = `share_${Date.now()}`;
                await setDoc(doc(db, "sharedBackups", shareId), {
                    type: 'current',
                    pageTitle: pageTitle,
                    headerName: pageTitle,
                    description: description,
                    sortType: sortType,
                    createdAt: Date.now(),
                    createdBy: 'ÏóêÎπÑÏ∏Ñ',
                    backupData: {
                        users: data.map(u => ({
                            name: u.name,
                            guild: u.guild,
                            power: u.power,
                            diff: 0,
                            shape_legend: u.shape_legend || 0,
                            shape_myth: u.shape_myth || 0,
                            mount_legend: u.mount_legend || 0,
                            mount_myth: u.mount_myth || 0
                        })),
                        totalUsers: data.length,
                        totalPower: totalPower,
                        totalDiff: 0,
                        guildStats: guildStats,
                        createdAt: Date.now()
                    }
                });
                
                // Í≥µÏú† URL ÏÉùÏÑ±
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                
                const html = `
                    <div style="padding: 10px 0; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 20px;">Í≥µÏú† ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</p>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; word-break: break-all;">
                            <input type="text" id="shareUrlInput" value="${shareUrl}" readonly 
                                   style="width: 100%; border: none; background: transparent; text-align: center; font-size: 13px; color: #374151;">
                        </div>
                        <button onclick="copyShareUrl()" class="btn btn-primary" style="width: 100%;">üìã ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 12px;">üí° Ïπ¥Ïπ¥Ïò§ÌÜ°Ïóê Î∞îÎ°ú Î∂ôÏó¨ÎÑ£Í∏∞ ÌïòÏÑ∏Ïöî!</p>
                    </div>
                `;
                
                openSmallModal('üîó Í≥µÏú† ÎßÅÌÅ¨', '', html);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
                `;
                
            } catch(e) {
                console.error(e);
                showAlert('ÎßÅÌÅ¨ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };

               document.getElementById('spreadsheetBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openSpreadsheetSettingsModal();
        });

        // Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨ Î≤ÑÌäº
        document.getElementById('syncExcludeBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openSyncExcludeModal();
        });

        async function openSyncExcludeModal() {
            openLargeModal('üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨', 'Î∂ÑÎ∞∞Í∏à Í≥ÑÏÇ∞ÏóêÏÑú Ï†úÏô∏Ìï† Ïú†Ï†ÄÎ•º ÏÑ†ÌÉùÌï©ÎãàÎã§');
            
            // Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ UI
            let html = `
                <div style="margin-bottom:16px;">
                    <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                        <p style="color:#92400e; font-size:13px; margin:0;">
                            ‚ö†Ô∏è Ï≤¥ÌÅ¨Îêú Ïú†Ï†ÄÎäî Î∂ÑÎ∞∞Í∏à Í≥ÑÏÇ∞ÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.<br>
                            ÌòÑÏû¨ <b>${syncExcludeList.length}Î™Ö</b>Ïù¥ Ï†úÏô∏ Î™©Î°ùÏóê ÏûàÏäµÎãàÎã§.
                        </p>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                        <div style="flex:2; min-width:200px;">
                            <input type="text" id="excludeSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <select id="excludeGuildFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                                ${guildList.map(g => `<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <select id="excludeStatusFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                                <option value="excluded">Ï†úÏô∏Îêú Ïú†Ï†ÄÎßå</option>
                                <option value="included">Ìè¨Ìï®Îêú Ïú†Ï†ÄÎßå</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="max-height:400px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px;">
                    <table class="common-table" style="margin:0;">
                        <thead style="position:sticky; top:0; background:white; z-index:1;">
                            <tr>
                                <th style="width:50px;">Ï†úÏô∏</th>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>Í∏∏Îìú</th>
                                <th>Ï†ÑÌà¨Î†•</th>
                            </tr>
                        </thead>
                        <tbody id="excludeUserList">
            `;
            
            // Ïú†Ï†Ä Î™©Î°ù ÏÉùÏÑ±
            const sortedUsers = [...allGuildData].sort((a, b) => a.name.localeCompare(b.name));
            sortedUsers.forEach(user => {
                const isExcluded = syncExcludeList.includes(user.name);
                html += `
                    <tr class="exclude-row" data-name="${user.name}" data-guild="${user.guild}" data-excluded="${isExcluded}" style="cursor:pointer;">
                        <td style="text-align:center;">
                            <input type="checkbox" class="exclude-checkbox" data-name="${user.name}" ${isExcluded ? 'checked' : ''}>
                        </td>
                        <td style="font-weight:600;">${user.name}</td>
                        <td>${user.guild}</td>
                        <td>${user.power.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span id="excludeCount" style="color:#6b7280; font-size:13px;">Ï¥ù ${sortedUsers.length}Î™Ö</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn" onclick="selectAllExclude(true)" style="padding:6px 12px; font-size:12px; background:#ef4444; color:white;">Ï†ÑÏ≤¥ Ï†úÏô∏</button>
                        <button class="btn" onclick="selectAllExclude(false)" style="padding:6px 12px; font-size:12px; background:#10b981; color:white;">Ï†ÑÏ≤¥ Ìè¨Ìï®</button>
                    </div>
                </div>
            `;
            
            setModalBody(html);
            
            // Í≤ÄÏÉâ/ÌïÑÌÑ∞ Ïù¥Î≤§Ìä∏
            document.getElementById('excludeSearchInput').addEventListener('input', filterExcludeList);
            document.getElementById('excludeGuildFilter').addEventListener('change', filterExcludeList);
            document.getElementById('excludeStatusFilter').addEventListener('change', filterExcludeList);
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.exclude-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const name = this.dataset.name;
                    const row = this.closest('tr');
                    if (this.checked) {
                        if (!syncExcludeList.includes(name)) {
                            syncExcludeList.push(name);
                        }
                        row.dataset.excluded = 'true';
                    } else {
                        syncExcludeList = syncExcludeList.filter(n => n !== name);
                        row.dataset.excluded = 'false';
                    }
                    updateExcludeCount();
                });
            });
            
            // Ìñâ ÌÅ¥Î¶≠ Ïãú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
            document.querySelectorAll('.exclude-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏßÅÏ†ë ÌÅ¥Î¶≠ÏùÄ Ï†úÏô∏ (Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê®)
                    if (e.target.type === 'checkbox') return;
                    
                    const checkbox = this.querySelector('.exclude-checkbox');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            });
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="saveExcludeList()">üíæ Ï†ÄÏû•</button>
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
            `;
        }

        function filterExcludeList() {
            const search = document.getElementById('excludeSearchInput').value.toLowerCase();
            const guild = document.getElementById('excludeGuildFilter').value;
            const status = document.getElementById('excludeStatusFilter').value;
            
            let visibleCount = 0;
            document.querySelectorAll('.exclude-row').forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const rowGuild = row.dataset.guild;
                const isExcluded = row.dataset.excluded === 'true';
                
                let show = true;
                if (search && !name.includes(search)) show = false;
                if (guild && rowGuild !== guild) show = false;
                if (status === 'excluded' && !isExcluded) show = false;
                if (status === 'included' && isExcluded) show = false;
                
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            document.getElementById('excludeCount').textContent = `ÌëúÏãú: ${visibleCount}Î™Ö / Ï†ÑÏ≤¥: ${allGuildData.length}Î™Ö`;
        }

        function updateExcludeCount() {
            const infoBox = document.querySelector('.openSyncExcludeModal-info');
            // Ìó§ÎçîÏùò Ï†úÏô∏ Ïù∏Ïõê ÏóÖÎç∞Ïù¥Ìä∏Îäî Ï†ÄÏû• ÌõÑÏóê Î∞òÏòÅ
        }

        window.selectAllExclude = function(exclude) {
            const visibleRows = document.querySelectorAll('.exclude-row:not([style*="display: none"])');
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.exclude-checkbox');
                const name = checkbox.dataset.name;
                checkbox.checked = exclude;
                row.dataset.excluded = exclude ? 'true' : 'false';
                
                if (exclude) {
                    if (!syncExcludeList.includes(name)) {
                        syncExcludeList.push(name);
                    }
                } else {
                    syncExcludeList = syncExcludeList.filter(n => n !== name);
                }
            });
        };

        window.saveExcludeList = async function() {
            try {
                const config = spreadsheetConfig || {};
                const prevList = config.excludeList || [];
                config.excludeList = syncExcludeList;
                
                await setDoc(doc(db, "config", "spreadsheet"), config);
                spreadsheetConfig = config;
                
                // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Í≥ÑÏÇ∞
                const added = syncExcludeList.filter(n => !prevList.includes(n));
                const removed = prevList.filter(n => !syncExcludeList.includes(n));
                
                // Î°úÍ∑∏ Í∏∞Î°ù
                let logDetail = '';
                if (added.length > 0) logDetail += `Ï†úÏô∏ Ï∂îÍ∞Ä: ${added.join(', ')}`;
                if (removed.length > 0) logDetail += (logDetail ? ' / ' : '') + `Ï†úÏô∏ Ìï¥Ï†ú: ${removed.join(', ')}`;
                if (!logDetail) logDetail = 'Î≥ÄÍ≤Ω ÏóÜÏùå';
                
                await setDoc(doc(collection(db, "logs")), {
                    who: 'Admin',
                    type: 'exclude_update',
                    old_value: `${prevList.length}Î™Ö Ï†úÏô∏`,
                    new_value: `${syncExcludeList.length}Î™Ö Ï†úÏô∏ (${logDetail})`,
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    location: (await getIpAndLocation()).location,
                    device: parseUserAgent(navigator.userAgent)
                });
                
                showAlert(`Î∂ÑÎ∞∞ Ï†úÏô∏ Î™©Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§ (${syncExcludeList.length}Î™Ö Ï†úÏô∏)`, 'success');
                closeModal();
            } catch(e) {
                console.error(e);
                showAlert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };

        async function openSpreadsheetSettingsModal() {
            const currentConfig = spreadsheetConfig || {};
            const sheetId = currentConfig.sheetId || '1ySgXwqwDGSW3c9gh8LVYPDBmdkh27q9JmVKId8gQ6uI';
            const webAppUrl = currentConfig.webAppUrl || '';
            const autoSync = currentConfig.autoSync !== false;
            const maskingEnabled = currentConfig.powerMaskingEnabled || false;
            
                       let sheetMappingHtml = '<div class="form-group"><label class="form-label">ÏãúÌä∏ ÌÉ≠ Îß§Ìïë (Í∏∏ÎìúÎ™Ö: ÏãúÌä∏ÌÉ≠Î™Ö)</label>';
            guildList.forEach(guild => {
                               let defaultSheet = '';
                if (guild === 'ÏÇ¨Ïã†') {
                    defaultSheet = 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(ÏÇ¨Ïã†)';
                }
                const mappedSheet = (currentConfig.sheetMappings && currentConfig.sheetMappings[guild]) || defaultSheet;
                sheetMappingHtml += `
                    <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                        <input type="text" class="form-input" value="${guild}" readonly style="flex:1; background:#f3f4f6;">
                        <span style="color:#6b7280;">‚Üí</span>
                        <input type="text" class="form-input sheet-mapping" data-guild="${guild}" value="${mappedSheet}" placeholder="${guild === 'ÏÇ¨Ïã†' ? 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(ÏÇ¨Ïã†)' : '(Ï†ÑÏ≤¥ ÏãúÌä∏ÏóêÎßå Ìè¨Ìï®)'}" style="flex:2;" ${!isSuperAdmin ? 'readonly' : ''}>
                    </div>
                `;
            });
            
            
            const allSheetName = (currentConfig.sheetMappings && currentConfig.sheetMappings['Ï†ÑÏ≤¥']) || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
            sheetMappingHtml += `
                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                    <input type="text" class="form-input" value="Ï†ÑÏ≤¥" readonly style="flex:1; background:#f3f4f6;">
                    <span style="color:#6b7280;">‚Üí</span>
                    <input type="text" class="form-input sheet-mapping" data-guild="Ï†ÑÏ≤¥" value="${allSheetName}" placeholder="Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)" style="flex:2;" ${!isSuperAdmin ? 'readonly' : ''}>
                </div>
            `;
            sheetMappingHtml += '</div>';
            
            // ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö© ÏàòÏ†ï ÏïàÎÇ¥
            const notSuperAdminNotice = !isSuperAdmin ? `
                <div style="margin-bottom:16px; padding:12px; background:#fef3c7; border-radius:8px; border-left:4px solid #f59e0b;">
                    <p style="font-size:12px; color:#92400e; margin:0;">‚ö†Ô∏è ÏÑ§Ï†ï ÏàòÏ†ïÏùÄ ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§ (Ï°∞ÌöåÎßå Í∞ÄÎä•)</p>
                </div>
            ` : '';

            const html = `
                ${notSuperAdminNotice}
                
                <!-- Ï†ÑÌà¨Î†• ÎßàÏä§ÌÇπ ÏÑ§Ï†ï -->
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <h4 style="font-size:14px; font-weight:600; color:#1e293b; margin:0 0 12px;">üîí Ï†ÑÌà¨Î†• Í≥µÍ∞ú ÏÑ§Ï†ï</h4>
                    <label class="checkbox-label" style="background:none; padding:0; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="powerMasking" ${maskingEnabled ? 'checked' : ''} ${!isSuperAdmin ? 'disabled' : ''}>
                        <span style="font-size:13px; color:#374151;">ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌÉÄÏù∏Ïùò Ï†ÑÌà¨Î†• Ïà®Í∏∞Í∏∞</span>
                    </label>
                    <p style="font-size:11px; color:#6b7280; margin:8px 0 0 24px;">ÌôúÏÑ±Ìôî Ïãú ÎπÑÎ°úÍ∑∏Ïù∏ ÎòêÎäî ÏûêÏã†Ïù¥ ÏïÑÎãå Îã§Î•∏ ÏÇ¨ÎûåÏùò Ï†ÑÌà¨Î†•Ïù¥ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢Î°ú ÌëúÏãúÎê©ÎãàÎã§</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ID</label>
                    <input type="text" id="sheetId" class="form-input" value="${sheetId}" placeholder="Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ URLÏùò /d/ Îí§ ID" ${!isSuperAdmin ? 'readonly style="background:#f3f4f6;"' : ''}>
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">Ïòà: docs.google.com/spreadsheets/d/<b>Ïó¨Í∏∞IDÎ∂ÄÎ∂Ñ</b>/edit</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Google Apps Script ÏõπÏï± URL</label>
                    <input type="text" id="webAppUrl" class="form-input" value="${webAppUrl}" placeholder="https://script.google.com/macros/s/.../exec" ${!isSuperAdmin ? 'readonly style="background:#f3f4f6;"' : ''}>
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">Apps Script Î∞∞Ìè¨ ÌõÑ Î∞õÏùÄ ÏõπÏï± URL</p>
                </div>
                ${sheetMappingHtml}
                <div class="form-group">
                    <label class="checkbox-label" style="background:none; padding:0;">
                        <input type="checkbox" id="autoSync" ${autoSync ? 'checked' : ''} ${!isSuperAdmin ? 'disabled' : ''}>
                        Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú ÏûêÎèôÏúºÎ°ú Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî
                    </label>
                </div>
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="window.testSpreadsheetSync()" style="flex:1;">üß™ Ïó∞Îèô ÌÖåÏä§Ìä∏</button>
                    <button class="btn btn-success" onclick="window.syncAllToSpreadsheet()" style="flex:1;">üîÑ Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; padding:10px; background:#f9fafb; border-radius:6px;">
                    <b>ÏÑ§Ï†ï Î∞©Î≤ï:</b><br>
                    1. Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ÏóêÏÑú "ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®" > "Apps Script" ÏÑ†ÌÉù<br>
                    2. Ï†úÍ≥µÎêú GoogleAppsScript.gs ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞<br>
                    3. "Î∞∞Ìè¨" > "ÏÉà Î∞∞Ìè¨" > "Ïõπ Ïï±" ÏÑ†ÌÉù<br>
                    4. "Ïï°ÏÑ∏Ïä§ Í∂åÌïú" > "Î™®Îì† ÏÇ¨Ïö©Ïûê" ÏÑ†ÌÉù<br>
                    5. Î∞∞Ìè¨ ÌõÑ Î∞õÏùÄ URLÏùÑ ÏúÑÏóê ÏûÖÎ†•
                </p>
            `;

            openLargeModal('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïó∞Îèô ÏÑ§Ï†ï', 'Íµ¨Í∏Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏûêÎèô ÎèôÍ∏∞Ìôî');
            // setModalBody ÎåÄÏã† ÏßÅÏ†ë ÏÑ§Ï†ï (Îã´Í∏∞ Î≤ÑÌäº Ï§ëÎ≥µ Î∞©ÏßÄ)
            document.getElementById('modalBody').innerHTML = html;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";

            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Îã´Í∏∞";
            closeBtn.onclick = closeModal;

            if (isSuperAdmin) {
                const saveBtn = document.createElement('button');
                saveBtn.className = "btn btn-primary";
                saveBtn.innerText = "üíæ ÏÑ§Ï†ï Ï†ÄÏû•";
                saveBtn.onclick = saveSpreadsheetSettings;
                
                footerDiv.appendChild(closeBtn);
                footerDiv.appendChild(saveBtn);
            } else {
                footerDiv.appendChild(closeBtn);
            }
            
            document.getElementById('modalBody').appendChild(footerDiv);
        }

        async function saveSpreadsheetSettings() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const autoSync = document.getElementById('autoSync').checked;
            const powerMaskingEnabledVal = document.getElementById('powerMasking').checked;

            if (!sheetId || !webAppUrl) {
                showAlert('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ IDÏôÄ ÏõπÏï± URLÏùÑ Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

                       const sheetMappings = {};
            document.querySelectorAll('.sheet-mapping').forEach(input => {
                const guild = input.dataset.guild;
                const sheetName = input.value.trim();
                if (sheetName) {
                    sheetMappings[guild] = sheetName;
                }
            });

            const config = {
                sheetId,
                webAppUrl,
                autoSync,
                sheetMappings,
                powerMaskingEnabled: powerMaskingEnabledVal
            };

            try {
                await setDoc(doc(db, "config", "spreadsheet"), config);
                spreadsheetConfig = config;
                powerMaskingEnabled = powerMaskingEnabledVal;
                showAlert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                closeModal();
                // ÎßàÏä§ÌÇπ ÏÑ§Ï†ï Î≥ÄÍ≤Ω Ïãú ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
                loadData();
            } catch (e) {
                console.error(e);
                showAlert('ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        }

        window.testSpreadsheetSync = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('Î®ºÏ†Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

                       const testGuild = guildList[0];
            const testUsers = allGuildData.filter(u => u.guild === testGuild).slice(0, 5);

            if (testUsers.length === 0) {
                showAlert('ÌÖåÏä§Ìä∏Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            const sheetName = spreadsheetConfig.sheetMappings[testGuild] || `Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(${testGuild})`;

            try {
                showAlert('ÌÖåÏä§Ìä∏ Ï§ë...', 'success');
                const result = await syncToSpreadsheet(testUsers, sheetName);
                if (result.success) {
                    showAlert(`ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ! ${result.message}`, 'success');
                } else {
                    showAlert(`ÌÖåÏä§Ìä∏ Ïã§Ìå®: ${result.error}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('ÌÖåÏä§Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + e.message, 'error');
            }
        };

        window.syncAllToSpreadsheet = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('Î®ºÏ†Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

            if (!await showConfirm('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî', 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê ÎèôÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

                       openSmallModal('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî', 'ÎèôÍ∏∞Ìôî ÏßÑÌñâ Ï§ë...', `
                <div style="text-align:center; padding:20px;">
                    <div id="syncIcon" style="font-size:48px; margin-bottom:15px;">üìä</div>
                    <p id="syncStatus" style="font-size:16px; color:#374151; margin-bottom:8px; font-weight:600;">Ï§ÄÎπÑ Ï§ë...</p>
                    <p id="syncDetail" style="font-size:13px; color:#6b7280; margin-bottom:20px;"></p>
                    <div style="background:#e5e7eb; border-radius:12px; height:20px; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="syncProgress" style="background:linear-gradient(90deg, #10b981, #34d399); height:100%; width:0%; transition:width 0.4s ease; border-radius:12px;"></div>
                    </div>
                    <p id="syncPercent" style="font-size:14px; color:#374151; margin-top:10px; font-weight:600;">0%</p>
                </div>
            `);
            document.getElementById('modalFooter').style.display = 'none';

            try {
                let successCount = 0;
                let failCount = 0;
                
                               const sheetsToSync = [];
                guildList.forEach(guild => {
                    const sheetName = spreadsheetConfig.sheetMappings && spreadsheetConfig.sheetMappings[guild];
                    if (sheetName) {
                        sheetsToSync.push({ guild, sheetName, isAll: false });
                    }
                });
                               const allSheetName = (spreadsheetConfig.sheetMappings && spreadsheetConfig.sheetMappings['Ï†ÑÏ≤¥']) || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
                sheetsToSync.push({ guild: 'Ï†ÑÏ≤¥', sheetName: allSheetName, isAll: true });
                
                const totalSheets = sheetsToSync.length;
                let currentSheet = 0;

                for (const sheet of sheetsToSync) {
                    currentSheet++;
                    const progress = Math.round((currentSheet / totalSheets) * 100);
                    
                   
                    document.getElementById('syncStatus').textContent = `${sheet.guild} ÎèôÍ∏∞Ìôî Ï§ë...`;
                    document.getElementById('syncDetail').textContent = `ÏãúÌä∏: ${sheet.sheetName} (${currentSheet}/${totalSheets})`;
                    document.getElementById('syncProgress').style.width = `${progress - 10}%`;
                    document.getElementById('syncPercent').textContent = `${progress - 10}%`;
                    
                    const users = sheet.isAll ? allGuildData : allGuildData.filter(u => u.guild === sheet.guild);
                    
                    try {
                        const result = await syncToSpreadsheet(users, sheet.sheetName);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error(`Failed to sync ${sheet.guild}:`, result.error);
                        }
                    } catch (e) {
                        failCount++;
                        console.error(`Error syncing ${sheet.guild}:`, e);
                    }
                    
                                       document.getElementById('syncProgress').style.width = `${progress}%`;
                    document.getElementById('syncPercent').textContent = `${progress}%`;
                    
                                       await new Promise(resolve => setTimeout(resolve, 500));
                }

                               if (failCount === 0) {
                    document.getElementById('syncIcon').textContent = '‚úÖ';
                    document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å!';
                    document.getElementById('syncDetail').textContent = `${successCount}Í∞ú ÏãúÌä∏ ÎèôÍ∏∞Ìôî ÏÑ±Í≥µ`;
                    document.getElementById('syncProgress').style.width = '100%';
                    document.getElementById('syncProgress').style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                    document.getElementById('syncPercent').textContent = '100%';
                } else {
                    document.getElementById('syncIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å (ÏùºÎ∂Ä Ïã§Ìå®)';
                    document.getElementById('syncDetail').textContent = `ÏÑ±Í≥µ: ${successCount}Í∞ú, Ïã§Ìå®: ${failCount}Í∞ú`;
                    document.getElementById('syncProgress').style.width = '100%';
                    document.getElementById('syncProgress').style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    document.getElementById('syncPercent').textContent = 'ÏôÑÎ£å';
                }

                               document.getElementById('modalFooter').style.display = 'flex';
                document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>';

                await setDoc(doc(collection(db, "logs")), {
                    who: 'Admin',
                    type: 'spreadsheet_sync',
                    old_value: '-',
                    new_value: `Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî (ÏÑ±Í≥µ:${successCount}, Ïã§Ìå®:${failCount})`,
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp()
                });

            } catch (e) {
                console.error(e);
                document.getElementById('syncIcon').textContent = '‚ùå';
                document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî Ïã§Ìå®';
                document.getElementById('syncDetail').textContent = e.message || 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§';
                document.getElementById('syncProgress').style.background = '#ef4444';
                document.getElementById('modalFooter').style.display = 'flex';
                document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
            }
        };

        async function syncToSpreadsheet(users, sheetName) {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                return { success: false, error: 'Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏù¥ ÏóÜÏäµÎãàÎã§' };
            }

            // Ï†úÏô∏ Î™©Î°ù ÌïÑÌÑ∞ÎßÅ
            const filteredUsers = users.filter(u => !syncExcludeList.includes(u.name));

            const payload = {
                sheetId: spreadsheetConfig.sheetId,
                sheetName: sheetName,
                users: filteredUsers.map(u => ({
                    guild: u.guild,
                    name: u.name,
                    power: u.power,
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                }))
            };

            try {
                const response = await fetch(spreadsheetConfig.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                               return { success: true, message: `${filteredUsers.length}Í∞ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° (${users.length - filteredUsers.length}Î™Ö Ï†úÏô∏)` };

            } catch (e) {
                console.error('Sync error:', e);
                return { success: false, error: e.message };
            }
        }

               async function autoSyncIfEnabled(guild = null) {
            if (!spreadsheetConfig || !spreadsheetConfig.autoSync) {
                return;
            }

            try {
                if (guild) {
                                       const guildUsers = allGuildData.filter(u => u.guild === guild);
                    const sheetName = spreadsheetConfig.sheetMappings[guild] || `Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(${guild})`;
                    await syncToSpreadsheet(guildUsers, sheetName);
                }
                
                               const allSheetName = spreadsheetConfig.sheetMappings['Ï†ÑÏ≤¥'] || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
                await syncToSpreadsheet(allGuildData, allSheetName);
                
            } catch (e) {
                console.error('Auto sync error:', e);
            }
        }

       
        document.getElementById('lockManageBtn').addEventListener('click', () => {
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ïû†Í∏à ÏÑ§Ï†ïÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§', 'error');
                return;
            }
            
            let statusMsg = '';
            let biweeklyStatusMsg = '';
            
            if (lockStartTime > 0 && lockEndTime > 0) {
                statusMsg = `ÌòÑÏû¨ Ïû†Í∏à: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
            } else {
                statusMsg = 'ÌòÑÏû¨ Ïû†Í∏à ÏÑ§Ï†ï ÏóÜÏùå';
            }
            
            if (biweeklyBaseTime > 0) {
                biweeklyStatusMsg = `<div style="background:#d1fae5; border:1px solid #10b981; border-radius:8px; padding:10px; margin-bottom:12px;">
                    <p style="color:#065f46; font-weight:600; margin:0; font-size:13px;">‚úÖ 2Ï£º Î∞òÎ≥µ ÌôúÏÑ±ÌôîÎê®</p>
                    <p style="color:#047857; font-size:12px; margin:4px 0 0;">Ïû†Í∏à Ï¢ÖÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú 2Ï£º Îí§Î°ú Í∞±Ïã†Îê©ÎãàÎã§</p>
                </div>`;
            }

            const startValue = lockStartTime > 0 ? toDatetimeLocalValue(lockStartTime) : '';
            const endValue = lockEndTime > 0 ? toDatetimeLocalValue(lockEndTime) : '';
            
            // 2Ï£º Î∞òÎ≥µ Í∏∞Î≥∏Í∞í Í≥ÑÏÇ∞ (Îã§Ïùå ÌÜ†ÏöîÏùº~ÏõîÏöîÏùº)
            const nowKst = toKST(Date.now());
            const dayOfWeek = nowKst.getUTCDay();
            let daysUntilSat = dayOfWeek === 6 ? 7 : (dayOfWeek === 0 ? 6 : 6 - dayOfWeek);
            const defSatKst = new Date(Date.UTC(nowKst.getUTCFullYear(), nowKst.getUTCMonth(), nowKst.getUTCDate() + daysUntilSat, 0, 0, 0));
            const defMonKst = new Date(defSatKst.getTime() + 2 * 24 * 60 * 60 * 1000);
            const defStart = toDatetimeLocalValue(defSatKst.getTime() - 9 * 60 * 60 * 1000);
            const defEnd = toDatetimeLocalValue(defMonKst.getTime() - 9 * 60 * 60 * 1000);

            openSmallModal('Ïû†Í∏à ÏÑ§Ï†ï (KST Í∏∞Ï§Ä)', '', `
                <div style="margin-bottom:15px; color:#374151; font-size:13px; padding:10px; background:#f9fafb; border-radius:8px;">${statusMsg}</div>
                ${biweeklyStatusMsg}
                
                <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                    <p style="color:#92400e; font-weight:600; margin:0 0 8px; font-size:13px;">‚è∞ 2Ï£º Î∞òÎ≥µ Ïû†Í∏à (Í∏∏ÎìúÏ†ÑÏö©)</p>
                    <p style="color:#a16207; font-size:12px; margin:0 0 10px;">ÏµúÏ¥à Í∏∞Í∞ÑÏùÑ ÏßÄÏ†ïÌïòÎ©¥ 2Ï£ºÎßàÎã§ ÏûêÎèô Î∞òÎ≥µÎê©ÎãàÎã§</p>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <label style="font-size:11px; color:#92400e;">ÏãúÏûë (KST)</label>
                            <input type="datetime-local" id="biweeklyStartInput" class="form-input" value="${defStart}" style="font-size:12px;">
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:11px; color:#92400e;">Ï¢ÖÎ£å (KST)</label>
                            <input type="datetime-local" id="biweeklyEndInput" class="form-input" value="${defEnd}" style="font-size:12px;">
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button id="biweeklyLockBtn" class="btn btn-primary" style="flex:1; background:#f59e0b;">üîÑ 2Ï£º Î∞òÎ≥µ ÏãúÏûë</button>
                        ${biweeklyBaseTime > 0 ? '<button id="biweeklyStopBtn" class="btn btn-cancel" style="flex:1;">‚èπÔ∏è Î∞òÎ≥µ Ï§ëÏßÄ</button>' : ''}
                    </div>
                </div>
                
                <hr style="border:none; border-top:1px solid #e5e7eb; margin:16px 0;">
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">ÎòêÎäî ÏàòÎèôÏúºÎ°ú ÏßÅÏ†ë ÏÑ§Ï†ï (1ÌöåÏÑ±):</p>
                
                <div class="form-group">
                    <label class="form-label">Ïû†Í∏à ÏãúÏûë ÏãúÍ∞Ñ (KST)</label>
                    <input type="datetime-local" id="lockStartInput" class="form-input" value="${startValue}">
                </div>
                <div class="form-group">
                    <label class="form-label">Ïû†Í∏à Ï¢ÖÎ£å ÏãúÍ∞Ñ (KST)</label>
                    <input type="datetime-local" id="lockEndInput" class="form-input" value="${endValue}">
                </div>
                <div class="form-group">
                    <button id="unlockBtn" class="btn btn-cancel" style="width:100%">üîì Ïû†Í∏à Ìï¥Ï†ú (Î∞òÎ≥µÎèÑ Ï§ëÏßÄ)</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">‚Äª ÌïúÍµ≠ ÌëúÏ§ÄÏãú(KST) Í∏∞Ï§ÄÏúºÎ°ú ÏÑ§Ï†ïÎê©ÎãàÎã§</p>
            `);

            // 2Ï£º Î∞òÎ≥µ Ï§ëÏßÄ Î≤ÑÌäº
            if (biweeklyBaseTime > 0) {
                document.getElementById('biweeklyStopBtn').onclick = async () => {
                    if (!await showConfirm('2Ï£º Î∞òÎ≥µ Ï§ëÏßÄ', '2Ï£º Î∞òÎ≥µÏùÑ Ï§ëÏßÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\\nÌòÑÏû¨ Ïû†Í∏àÏùÄ Ïú†ÏßÄÎêòÍ≥† Î∞òÎ≥µÎßå Ï§ëÏßÄÎê©ÎãàÎã§.')) return;
                    
                    await setDoc(doc(db, "config", "system"), { 
                        lockStartTime: lockStartTime,
                        lockEndTime: lockEndTime,
                        biweeklyBaseTime: 0,
                        lockType: 'manual'
                    });
                    
                    showAlert('2Ï£º Î∞òÎ≥µÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§', 'success'); 
                    closeModal(); 
                    setTimeout(() => location.reload(), 1000);
                };
            }

            // 2Ï£º Î∞òÎ≥µ Ïû†Í∏à Î≤ÑÌäº Ìï∏Îì§Îü¨
            document.getElementById('biweeklyLockBtn').onclick = async () => {
                // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÏãúÏûë/Ï¢ÖÎ£å ÏãúÍ∞Ñ ÏÇ¨Ïö©
                const startVal = document.getElementById('biweeklyStartInput').value;
                const endVal = document.getElementById('biweeklyEndInput').value;
                
                if (!startVal || !endVal) {
                    showAlert('ÏãúÏûë ÏãúÍ∞ÑÍ≥º Ï¢ÖÎ£å ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 'error');
                    return;
                }
                
                const startTime = fromKST(startVal);
                const endTime = fromKST(endVal);
                
                if (endTime <= startTime) {
                    showAlert('Ï¢ÖÎ£å ÏãúÍ∞ÑÏù¥ ÏãúÏûë ÏãúÍ∞ÑÎ≥¥Îã§ Îπ†Î¶ÖÎãàÎã§', 'error');
                    return;
                }
                
                const startStr = formatKSTDateTime(startTime);
                const endStr = formatKSTDateTime(endTime);
                
                const confirmMsg = `Ï≤´ Ïû†Í∏à Í∏∞Í∞Ñ:\n${startStr} ~ ${endStr}\n\nÏù¥ÌõÑ 2Ï£ºÎßàÎã§ ÏûêÎèô Î∞òÎ≥µÎê©ÎãàÎã§.\nÏÑ§Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
                
                if (!await showConfirm('2Ï£º Î∞òÎ≥µ Ïû†Í∏à ÏÑ§Ï†ï', confirmMsg)) return;
                
                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: startTime,
                    lockEndTime: endTime,
                    biweeklyBaseTime: startTime, // Í∏∞Ï§Ä ÏãúÍ∞Ñ Ï†ÄÏû•
                    lockType: 'biweekly'
                });
                
                showAlert('2Ï£º Î∞òÎ≥µ Ïû†Í∏àÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000);
            };

            document.getElementById('unlockBtn').onclick = async () => { 
                if(!await showConfirm('Ïû†Í∏à Ìï¥Ï†ú', 'Ïû†Í∏àÏùÑ Ìï¥Ï†úÌïòÍ≥† 2Ï£º Î∞òÎ≥µÎèÑ Ï§ëÏßÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return; 
                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: 0, 
                    lockEndTime: 0,
                    biweeklyBaseTime: 0, // Î∞òÎ≥µÎèÑ Ìï¥Ï†ú
                    lockType: null
                }); 
                showAlert('Ïû†Í∏àÏù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000); 
            };

            document.getElementById('modalSubmit').onclick = async () => {
                const startVal = document.getElementById('lockStartInput').value;
                const endVal = document.getElementById('lockEndInput').value;
                
                if (!startVal || !endVal) { 
                    showAlert('ÏãúÏûë ÏãúÍ∞ÑÍ≥º Ï¢ÖÎ£å ÏãúÍ∞ÑÏùÑ Î™®Îëê ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 'error'); 
                    return; 
                }

                const startTime = fromKST(startVal);
                const endTime = fromKST(endVal);

                if (endTime <= startTime) {
                    showAlert('Ï¢ÖÎ£å ÏãúÍ∞ÑÏù¥ ÏãúÏûë ÏãúÍ∞ÑÎ≥¥Îã§ Îπ†Î¶ÖÎãàÎã§', 'error');
                    return;
                }

                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: startTime,
                    lockEndTime: endTime,
                    biweeklyBaseTime: 0, // ÏàòÎèô ÏÑ§Ï†ïÏùÄ Î∞òÎ≥µ ÏóÜÏùå
                    lockType: 'manual'
                });
                
                showAlert('Ïû†Í∏àÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§ (1ÌöåÏÑ±)', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('userManageBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('Ïú†Ï†Ä Í¥ÄÎ¶¨', 'ÎπÑÎ∞ÄÎ≤àÌò∏ Í¥ÄÎ¶¨ Î∞è ÌïÑÌÑ∞');
            const snap = await getDocs(collection(db, "users")); 
            let users = []; 
            snap.forEach(d => users.push(d.data())); 
            
                       users.sort((a,b)=>a.name.localeCompare(b.name));
            
            let html = `
                <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                    <div class="form-group" style="flex:2; margin-bottom:0;">
                        <input type="text" id="modalSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="guildFilter" class="form-input">
                            <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                            ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="pwFilter" class="form-input">
                            <option value="">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÑÏ≤¥</option>
                            <option value="set">ÏÑ§Ï†ïÎê®</option>
                            <option value="unset">ÎØ∏ÏÑ§Ï†ï</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="sortOrder" class="form-input">
                            <option value="name">Í∞ÄÎÇòÎã§Ïàú</option>
                            <option value="updated">ÏµúÍ∑º Í∞±Ïã†Ïàú</option>
                        </select>
                    </div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">Ï¥ù <span id="userCount">${users.length}</span>Î™Ö</p>
                <div class="table-scroll-container">
                    <table class="common-table" id="userManageTable">
                        <thead>
                            <tr>
                                <th style="width:25%;">ÎãâÎÑ§ÏûÑ</th>
                                <th style="width:15%;">Í∏∏Îìú</th>
                                <th style="width:15%;">ÎπÑÎ∞ÄÎ≤àÌò∏</th>
                                <th style="width:25%;">ÎπÑÎ∞ÄÎ≤àÌò∏ Í¥ÄÎ¶¨</th>
                                <th style="width:20%;">Îì±Î°ù Ìï¥Ï†ú</th>
                            </tr>
                        </thead>
                        <tbody id="userManageTableBody"></tbody>
                    </table>
                </div>
            `;
            
            setModalBody(html);
            
                       function renderUserTable(filteredUsers) {
                const tbody = document.getElementById('userManageTableBody');
                tbody.innerHTML = '';
                
                filteredUsers.forEach(u => {
                    const pwStatus = u.password 
                        ? '<span style="color:#10b981; font-weight:600;">‚úì ÏÑ§Ï†ïÎê®</span>' 
                        : '<span style="color:#ef4444; font-weight:600;">‚úó ÎØ∏ÏÑ§Ï†ï</span>';
                    
                    const resetBtn = u.password 
                        ? `<button class="btn-reset-pw" onclick="window.resetUserPw('${u.name}')">Ï¥àÍ∏∞Ìôî</button>` 
                        : '-';
                    
                    const deleteBtn = `<button class="btn-delete" onclick="window.deleteUser('${u.name}')" style="background:#ef4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s;">üóëÔ∏è Îì±Î°ù Ìï¥Ï†ú</button>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td>${pwStatus}</td>
                        <td>${resetBtn}</td>
                        <td>${deleteBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('userCount').textContent = filteredUsers.length;
            }
            
                       function applyFiltersAndSort() {
                const searchText = document.getElementById('modalSearchInput').value.toLowerCase();
                const guildFilter = document.getElementById('guildFilter').value;
                const pwFilter = document.getElementById('pwFilter').value;
                const sortOrder = document.getElementById('sortOrder').value;
                
                let filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    const matchPw = !pwFilter || 
                        (pwFilter === 'set' && u.password) || 
                        (pwFilter === 'unset' && !u.password);
                    
                    return matchSearch && matchGuild && matchPw;
                });
                
                               if (sortOrder === 'name') {
                    filtered.sort((a,b) => a.name.localeCompare(b.name));
                } else if (sortOrder === 'updated') {
                    filtered.sort((a,b) => {
                        const aTime = (a.updatedAt && a.updatedBy !== 'admin') ? a.updatedAt : 0;
                        const bTime = (b.updatedAt && b.updatedBy !== 'admin') ? b.updatedAt : 0;
                        return bTime - aTime;                     });
                }
                
                renderUserTable(filtered);
            }
            
                       renderUserTable(users);
            
                       document.getElementById('modalSearchInput').addEventListener('input', applyFiltersAndSort);
            document.getElementById('guildFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('pwFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndSort);
        });

        window.resetUserPw = async function(n) { 
            if(!await showConfirm('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî', `[${n}]ÎãòÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return; 
            await updateDoc(doc(db, "users", n), { password: null }); 
            showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'success'); 
            closeModal(); 
            setTimeout(() => location.reload(), 1000); 
        };

               window.deleteUser = async function(name) {
                       if(!await showConfirm('ÏÇ¨Ïö©Ïûê Îì±Î°ù Ìï¥Ï†ú', `<span style="color:#ef4444; font-weight:600;">[${name}]ÎãòÏùÑ Îì±Î°ù Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</span><br><br>‚Ä¢ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§<br>‚Ä¢ ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ùÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•<br>‚Ä¢ Î≥µÍµ¨Îäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§`)) return;
            
                       setTimeout(() => {
                openSmallModal('Îì±Î°ù Ìï¥Ï†ú ÏÇ¨Ïú†', 'ÏÑ†ÌÉùÏÇ¨Ìï≠ - ÎÇòÏ§ëÏóê Ï∞∏Í≥†Ïö©', `
                    <div class="form-group">
                        <label class="form-label">ÏÇ¨Ïú† (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <select id="deleteReason" class="form-input">
                            <option value="ÏûêÏßÑ ÌÉàÌá¥">ÏûêÏßÑ ÌÉàÌá¥</option>
                            <option value="Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç">Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç</option>
                            <option value="Í∏∏Îìú Ïù¥Îèô">Í∏∏Îìú Ïù¥Îèô</option>
                            <option value="Í∑úÏ†ï ÏúÑÎ∞ò">Í∑úÏ†ï ÏúÑÎ∞ò</option>
                            <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÏÉÅÏÑ∏ Î©îÎ™® (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="deleteMemo" class="form-input" rows="3" placeholder="Ï∂îÍ∞Ä Î©îÎ™®..."></textarea>
                    </div>
                `);
                
                setTimeout(() => {
                    document.getElementById('modalSubmit').onclick = async () => {
                        const reason = document.getElementById('deleteReason').value;
                        const memo = document.getElementById('deleteMemo').value.trim();
                        
                        try {
                                                       const userDoc = await getDoc(doc(db, "users", name));
                            if (!userDoc.exists()) {
                                showAlert('ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                                return;
                            }
                            
                            const userData = userDoc.data();
                            
                                                       await setDoc(doc(collection(db, "deletedUsers")), {
                                ...userData,                                 deletedAt: Date.now(),
                                deletedBy: 'admin',
                                deleteReason: reason,
                                deleteMemo: memo || '',
                                originalName: name,
                                deletedIp: await getIp(),
                                deletedDevice: navigator.userAgent
                            });
                            
                                                       await deleteDoc(doc(db, "users", name));
                            
                                                       await setDoc(doc(collection(db, "logs")), {
                                who: name,
                                type: 'user_deleted',
                                old_value: 'ÏÇ¨Ïö©Ïûê Ï°¥Ïû¨',
                                new_value: `Îì±Î°ù Ìï¥Ï†ú (ÏÇ¨Ïú†: ${reason})`,
                                editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                                createdAt: Date.now(),
                                ip: await getIp(),
                                location: (await getIpAndLocation()).location,
                                device: parseUserAgent(navigator.userAgent)
                            });
                            
                            showAlert('Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å (Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê®)', 'success');
                            closeModal();
                            setTimeout(() => location.reload(), 1000);
                        } catch (e) {
                            console.error('Delete error:', e);
                            showAlert('Îì±Î°ù Ìï¥Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                        }
                    };
                }, 100);
            }, 300);
        };


        document.getElementById('logViewBtn').addEventListener('click', async () => {
            if(!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }
            openLargeModal('Î°úÍ∑∏', 'Ï†ÑÏ≤¥ Î°úÍ∑∏ (Í≤ÄÏÉâ Í∞ÄÎä•)');
            setModalBody('<p style="text-align:center; padding:40px;">üìã Î°úÍ∑∏ Î°úÎî© Ï§ë...</p>');
            
            try {
                // Í¥ÄÎ¶¨Ïûê Î™©Î°ù Î®ºÏ†Ä Í∞ÄÏ†∏Ïò§Í∏∞
                const adminsSnap = await getDocs(collection(db, "admins"));
                const allAdmins = [];
                adminsSnap.forEach(d => {
                    allAdmins.push(d.id);
                });
                allAdmins.sort();
                
                // ÏµúÍ∑º 1000Í±¥Îßå Î°úÎìú (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
                const snap = await getDocs(query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(1000)));
                
                const logs = [];
                snap.forEach(d => { 
                    const l = d.data(); 
                    // Í∏∞Í∏∞ Ï†ïÎ≥¥: Í∏¥ User AgentÎ©¥ Î≥ÄÌôò, Ïù¥ÎØ∏ ÏßßÏúºÎ©¥ Í∑∏ÎåÄÎ°ú
                    let deviceDisplay = l.device || '-';
                    if (deviceDisplay.length > 30 || deviceDisplay.includes('Mozilla')) {
                        deviceDisplay = parseUserAgent(deviceDisplay);
                    }
                    
                    // ÏúÑÏπò Ï†ïÎ≥¥: ÏòÅÏñ¥Î©¥ ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò
                    let locationDisplay = translateLocation(l.location || '');
                    
                    logs.push({
                        time: formatDateTime(l.createdAt),
                        who: l.who || '-',
                        type: l.type || '-',
                        oldValue: l.old_value || '-',
                        newValue: l.new_value || '-',
                        changes: l.changes || '',
                        editedBy: l.editedBy || '-',
                        ip: l.ip || '-',
                        device: deviceDisplay,
                        location: locationDisplay
                    });
                });
            
            // Ï†ÑÏó≠ Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏÉÅÏÑ∏Î≥¥Í∏∞Ïö©)
            window.currentLogs = logs;
            
            // Í¥ÄÎ¶¨Ïûê Î™©Î°ù: DBÏóêÏÑú Í∞ÄÏ†∏Ïò® Î™©Î°ù + Î°úÍ∑∏Ïóê ÏûàÎäî Í¥ÄÎ¶¨Ïûê
            const adminSet = new Set(allAdmins);
            logs.forEach(l => {
                if (l.editedBy && l.editedBy !== 'self' && l.editedBy !== 'admin' && l.editedBy !== 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' && l.editedBy !== '-') {
                    adminSet.add(l.editedBy);
                }
            });
            const adminList = Array.from(adminSet).sort();
            
            // ÎåÄÏÉÅÏù¥ Ïó¨Îü¨ Î™ÖÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† ÌëúÏãúÏö© ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
            function formatWho(who) {
                if (!who || who === '-') return '-';
                // ÏâºÌëúÎÇò Í≥µÎ∞±ÏúºÎ°ú Ïó¨Îü¨ Î™Ö Íµ¨Î∂Ñ
                const names = who.split(/[,\s]+/).filter(n => n.trim());
                if (names.length > 2) {
                    return `${names[0]} Ïô∏ ${names.length - 1}Î™Ö`;
                }
                return who;
            }
            
                       function formatLogType(type) {
                const typeMap = {
                    'power': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                    'info_edit': 'üìù Ï†ïÎ≥¥ ÏàòÏ†ï',
                    'guild_change': 'üè† Í∏∏Îìú Î≥ÄÍ≤Ω',
                    'spec_edit': '‚≠ê Ïä§Ìéô ÏàòÏ†ï',
                    'nickname_change': 'üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω',
                    'user_approved': '‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏',
                    'user_rejected': '‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä',
                    'user_deleted': 'üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú',
                    'user_request': 'üìù Îì±Î°ù ÏöîÏ≤≠',
                    'bulk_update': 'üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨',
                    'guild_move': 'üöÄ Í∏∏Îìú Ïù¥Îèô',
                    'guild_delete': 'üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú',
                    'exclude_update': 'üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Î≥ÄÍ≤Ω',
                    'spreadsheet_sync': 'üìä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî',
                    'google_sheet_sync': 'üìä Íµ¨Í∏ÄÏãúÌä∏ ÎèôÍ∏∞Ìôî'
                };
                return typeMap[type] || type;
            }
            
                       function formatLogContent(log) {
                const type = log.type;
                const oldVal = log.oldValue;
                const newVal = log.newValue;
                const changes = log.changes;
                
                switch(type) {
                    case 'power':
                        // JSONÏù∏ÏßÄ ÌôïÏù∏
                        if (oldVal && oldVal.startsWith('{')) {
                            try {
                                const oldData = JSON.parse(oldVal);
                                const newData = JSON.parse(newVal);
                                return `Ï†ÑÌà¨Î†•: ${Number(oldData.power).toLocaleString()} ‚Üí ${Number(newData.power).toLocaleString()}`;
                            } catch(e) {}
                        }
                        const oldPower = Number(oldVal).toLocaleString();
                        const newPower = Number(newVal).toLocaleString();
                        return `Ï†ÑÌà¨Î†•: ${oldPower} ‚Üí ${newPower}`;
                    
                    case 'guild_change':
                        // JSONÏù∏ÏßÄ ÌôïÏù∏
                        if (oldVal && oldVal.startsWith('{')) {
                            try {
                                const oldData = JSON.parse(oldVal);
                                const newData = JSON.parse(newVal);
                                return `Í∏∏Îìú: ${oldData.guild} ‚Üí ${newData.guild}`;
                            } catch(e) {}
                        }
                        return changes || 'Í∏∏Îìú Î≥ÄÍ≤Ω';
                    
                    case 'spec_edit':
                        return changes || 'Ïä§Ìéô ÏàòÏ†ï';
                    
                    case 'nickname_change':
                        return `${oldVal} ‚Üí ${newVal}`;
                    
                    case 'info_edit':
                        return changes || 'Ï†ïÎ≥¥ ÏàòÏ†ï';
                    
                    case 'user_approved':
                        return 'ÏäπÏù∏ ÏôÑÎ£å';
                    
                    case 'user_rejected':
                        return 'Îì±Î°ù Í±∞Î∂Ä';
                    
                    case 'user_deleted':
                        return newVal;
                    
                    case 'user_request':
                        return newVal;
                    
                    case 'bulk_update':
                        return newVal;
                    
                    case 'spreadsheet_sync':
                    case 'google_sheet_sync':
                        return newVal;
                    
                    default:
                        return changes || newVal;
                }
            }
            
            // Í¥ÄÎ¶¨Ïûê ÏòµÏÖò HTML ÏÉùÏÑ±
            let adminOptionsHtml = adminList.map(admin => 
                `<option value="admin:${admin}">üëë ${admin}</option>`
            ).join('');
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                        <input type="text" id="logSearchInput" class="form-input" placeholder="ÎåÄÏÉÅ Í≤ÄÏÉâ..." autocomplete="off" style="flex:1; min-width:120px;">
                        <input type="text" id="logIpSearch" class="form-input" placeholder="IP Í≤ÄÏÉâ..." autocomplete="off" style="flex:1; min-width:120px;">
                        <select id="logTypeFilter" class="form-input" style="flex:1; min-width:130px;">
                            <option value="">Ï†ÑÏ≤¥ ÏûëÏóÖ</option>
                            <option value="power">‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï</option>
                            <option value="guild_change">üè† Í∏∏Îìú Î≥ÄÍ≤Ω</option>
                            <option value="spec_edit">‚≠ê Ïä§Ìéô ÏàòÏ†ï</option>
                            <option value="info_edit">üìù Ï†ïÎ≥¥ ÏàòÏ†ï (Î≥µÌï©)</option>
                            <option value="nickname_change">üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</option>
                            <option value="user_approved">‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏</option>
                            <option value="user_rejected">‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä</option>
                            <option value="user_deleted">üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú</option>
                            <option value="user_request">üìù Îì±Î°ù ÏöîÏ≤≠</option>
                            <option value="bulk_update">üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨</option>
                            <option value="guild_move">üöÄ Í∏∏Îìú Ïù¥Îèô (ÏùºÍ¥Ñ)</option>
                            <option value="exclude_update">üö´ Î∂ÑÎ∞∞ Ï†úÏô∏</option>
                            <option value="spreadsheet_sync,google_sheet_sync">üìä ÎèôÍ∏∞Ìôî</option>
                        </select>
                        <select id="logWorkerFilter" class="form-input" style="flex:1; min-width:130px;">
                            <option value="">Ï†ÑÏ≤¥ ÏûëÏóÖÏûê</option>
                            <option value="self">üë§ Î≥∏Ïù∏ Î≥ÄÍ≤Ω</option>
                            <option value="admin">üëë Í¥ÄÎ¶¨Ïûê Ï†ÑÏ≤¥</option>
                            ${adminOptionsHtml}
                        </select>
                    </div>
                    <p style="font-size: 12px; color: #6b7280;">Ï¥ù <span id="logCount">${logs.length}</span>Í∞ú Î°úÍ∑∏</p>
                </div>
                <div style="max-height: 450px; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; -webkit-overflow-scrolling: touch;">
                    <table class="common-table" id="logTable" style="width: 100%; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 15%;">ÏãúÍ∞Ñ</th>
                                <th style="width: 12%;">ÎåÄÏÉÅ</th>
                                <th style="width: 13%;">ÏûëÏóÖ</th>
                                <th style="width: 12%;">ÏàòÏ†ïÏ†Ñ</th>
                                <th style="width: 12%;">ÏàòÏ†ïÌõÑ</th>
                                <th style="width: 26%;">ÎÇ¥Ïö©</th>
                                <th style="width: 10%;">ÏûëÏóÖÏûê</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            logs.forEach(l => {
                const logType = formatLogType(l.type);
                
                               let oldDisplay = '-';
                let newDisplay = '-';
                let contentDisplay = '-';
                
                switch(l.type) {
                    case 'power':
                        try {
                            if (l.oldValue && l.oldValue.startsWith('{')) {
                                const oldData = JSON.parse(l.oldValue);
                                const newData = JSON.parse(l.newValue);
                                oldDisplay = oldData.power ? oldData.power.toLocaleString() : '-';
                                newDisplay = newData.power ? newData.power.toLocaleString() : '-';
                            } else {
                                oldDisplay = Number(l.oldValue).toLocaleString();
                                newDisplay = Number(l.newValue).toLocaleString();
                            }
                        } catch(e) {
                            oldDisplay = Number(l.oldValue).toLocaleString();
                            newDisplay = Number(l.newValue).toLocaleString();
                        }
                        contentDisplay = `Ï†ÑÌà¨Î†•: ${oldDisplay} ‚Üí ${newDisplay}`;
                        break;
                    
                    case 'guild_change':
                        try {
                            const oldData = JSON.parse(l.oldValue);
                            const newData = JSON.parse(l.newValue);
                            oldDisplay = oldData.guild || '-';
                            newDisplay = newData.guild || '-';
                            contentDisplay = `Í∏∏Îìú: ${oldDisplay} ‚Üí ${newDisplay}`;
                        } catch(e) {
                            oldDisplay = '-';
                            newDisplay = '-';
                            contentDisplay = l.changes || 'Í∏∏Îìú Î≥ÄÍ≤Ω';
                        }
                        break;
                    
                    case 'spec_edit':
                        try {
                            const oldData = JSON.parse(l.oldValue);
                            const newData = JSON.parse(l.newValue);
                            oldDisplay = '-';
                            newDisplay = '-';
                            contentDisplay = l.changes || 'Ïä§Ìéô ÏàòÏ†ï';
                        } catch(e) {
                            oldDisplay = '-';
                            newDisplay = '-';
                            contentDisplay = l.changes || 'Ïä§Ìéô ÏàòÏ†ï';
                        }
                        break;
                    
                    case 'nickname_change':
                        oldDisplay = l.oldValue;
                        newDisplay = l.newValue;
                        contentDisplay = `ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω`;
                        break;
                    
                    case 'info_edit':
                        try {
                            const oldData = JSON.parse(l.oldValue);
                            const newData = JSON.parse(l.newValue);
                            oldDisplay = oldData.power ? oldData.power.toLocaleString() : '-';
                            newDisplay = newData.power ? newData.power.toLocaleString() : '-';
                            contentDisplay = l.changes || 'Ï†ïÎ≥¥ ÏàòÏ†ï';
                        } catch(e) {
                            oldDisplay = '-';
                            newDisplay = '-';
                            contentDisplay = l.changes || 'Ï†ïÎ≥¥ ÏàòÏ†ï';
                        }
                        break;
                    
                    case 'user_approved':
                        oldDisplay = 'ÎåÄÍ∏∞';
                        newDisplay = 'ÏäπÏù∏Îê®';
                        contentDisplay = 'ÏÇ¨Ïö©Ïûê ÏäπÏù∏ ÏôÑÎ£å';
                        break;
                    
                    case 'user_rejected':
                        oldDisplay = 'ÎåÄÍ∏∞';
                        newDisplay = 'Í±∞Î∂ÄÎê®';
                        contentDisplay = 'Îì±Î°ù Í±∞Î∂ÄÎê®';
                        break;
                    
                    case 'user_deleted':
                        oldDisplay = 'Îì±Î°ùÎê®';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = l.newValue || 'Îì±Î°ù Ìï¥Ï†ú';
                        break;
                    
                    case 'user_request':
                        oldDisplay = '-';
                        newDisplay = 'ÏöîÏ≤≠Îê®';
                        contentDisplay = l.newValue || 'Îì±Î°ù ÏöîÏ≤≠';
                        break;
                    
                    case 'bulk_update':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'ÏùºÍ¥Ñ Ï≤òÎ¶¨';
                        break;
                    
                    case 'guild_move':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'Í∏∏Îìú Ïù¥Îèô';
                        break;
                    
                    case 'guild_delete':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = `${l.oldValue} Í∏∏Îìú ÏÇ≠Ï†ú`;
                        break;
                    
                    case 'spreadsheet_sync':
                    case 'google_sheet_sync':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å';
                        break;
                    
                    case 'admin_add':
                        oldDisplay = '-';
                        newDisplay = l.newValue || '-';
                        contentDisplay = 'Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä';
                        break;
                    
                    case 'admin_delete':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = 'Í¥ÄÎ¶¨Ïûê ÏÇ≠Ï†ú';
                        break;
                    
                    case 'admin_pw_reset':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = '-';
                        contentDisplay = 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî';
                        break;
                    
                    default:
                        oldDisplay = l.oldValue || '-';
                        newDisplay = l.newValue || '-';
                        contentDisplay = '-';
                }
                
                let workerDisplay = '-';
                let workerTitle = l.editedBy || '-';
                let workerType = 'unknown';
                
                if (l.editedBy === 'self') {
                    workerDisplay = '<span style="color:#6b7280;">Î≥∏Ïù∏</span>';
                    workerType = 'self';
                } else if (l.editedBy === 'admin' || l.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') {
                    workerDisplay = '<span style="color:#8b5cf6; font-weight:600;">üëë Í¥ÄÎ¶¨Ïûê</span>';
                    workerType = 'admin';
                } else if (l.editedBy && l.editedBy !== '-') {
                    workerDisplay = `<span style="color:#8b5cf6; font-weight:600;">üëë ${l.editedBy}</span>`;
                    workerType = 'admin';
                } else {
                    workerDisplay = '<span style="color:#9ca3af;">-</span>';
                }
                
                const whoDisplay = formatWho(l.who);
                const logIndex = logs.indexOf(l);
                
                html += `<tr data-type="${l.type}" data-worker="${workerType}" data-admin-id="${l.editedBy}" data-ip="${l.ip || ''}" data-who="${l.who}" data-index="${logIndex}" style="cursor:pointer;" onclick="showLogDetail(${logIndex})">
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${l.time}">${l.time}</td>
                    <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100px;" title="${l.who}"><strong>${whoDisplay}</strong></td>
                    <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${logType}</td>
                    <td style="color:#ef4444; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${oldDisplay}">${oldDisplay}</td>
                    <td style="color:#10b981; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${newDisplay}">${newDisplay}</td>
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${contentDisplay}">${contentDisplay}</td>
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${workerTitle}">${workerDisplay}</td>
                </tr>`; 
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
                       // ÌïÑÌÑ∞ Ìï®Ïàò
            function applyLogFilters() {
                const searchText = document.getElementById('logSearchInput').value.toLowerCase();
                const ipSearch = document.getElementById('logIpSearch').value.toLowerCase();
                const typeFilter = document.getElementById('logTypeFilter').value;
                const workerFilter = document.getElementById('logWorkerFilter').value;
                const types = typeFilter ? typeFilter.split(',') : [];
                
                let visibleCount = 0;
                document.querySelectorAll('#logTable tbody tr').forEach(row => {
                    const who = (row.dataset.who || '').toLowerCase();
                    const rowType = row.dataset.type;
                    const rowWorker = row.dataset.worker;
                    const rowAdminId = row.dataset.adminId;
                    const rowIp = row.dataset.ip || '';
                    
                    const matchSearch = !searchText || who.includes(searchText);
                    const matchIp = !ipSearch || rowIp.includes(ipSearch);
                    const matchType = types.length === 0 || types.includes(rowType);
                    
                    // ÏûëÏóÖÏûê ÌïÑÌÑ∞ Î°úÏßÅ
                    let matchWorker = true;
                    if (workerFilter) {
                        if (workerFilter === 'self') {
                            matchWorker = rowWorker === 'self';
                        } else if (workerFilter === 'admin') {
                            matchWorker = rowWorker === 'admin';
                        } else if (workerFilter.startsWith('admin:')) {
                            // ÌäπÏ†ï Í¥ÄÎ¶¨Ïûê ÏÑ†ÌÉù
                            const selectedAdmin = workerFilter.replace('admin:', '');
                            matchWorker = rowAdminId === selectedAdmin;
                        }
                    }
                    
                    if (matchSearch && matchIp && matchType && matchWorker) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                document.getElementById('logCount').textContent = visibleCount;
            }
            
            document.getElementById('logSearchInput').addEventListener('input', applyLogFilters);
            document.getElementById('logIpSearch').addEventListener('input', applyLogFilters);
            document.getElementById('logTypeFilter').addEventListener('change', applyLogFilters);
            document.getElementById('logWorkerFilter').addEventListener('change', applyLogFilters);
            
            } catch(e) {
                console.error('Î°úÍ∑∏ Î°úÎî© Ïã§Ìå®:', e);
                setModalBody('<p style="color:#ef4444; text-align:center; padding:40px;">Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
        });
        
        // Î°úÍ∑∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ìï®Ïàò
        window.showLogDetail = function(index) {
            const log = window.currentLogs[index];
            if (!log) return;
            
            const typeMap = {
                'power': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                'info_edit': 'üìù Ï†ïÎ≥¥ ÏàòÏ†ï',
                'guild_change': 'üè† Í∏∏Îìú Î≥ÄÍ≤Ω',
                'spec_edit': '‚≠ê Ïä§Ìéô ÏàòÏ†ï',
                'nickname_change': 'üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω',
                'user_approved': '‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏',
                'user_rejected': '‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä',
                'user_deleted': 'üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú',
                'user_request': 'üìù Îì±Î°ù ÏöîÏ≤≠',
                'bulk_update': 'üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨',
                'guild_move': 'üöÄ Í∏∏Îìú Ïù¥Îèô',
                'guild_delete': 'üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú',
                'exclude_update': 'üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Î≥ÄÍ≤Ω',
                'spreadsheet_sync': 'üìä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî',
                'google_sheet_sync': 'üìä Íµ¨Í∏ÄÏãúÌä∏ ÎèôÍ∏∞Ìôî'
            };
            
            const logType = typeMap[log.type] || log.type;
            
            // ÏûëÏóÖÏûê ÌëúÏãú
            let workerDisplay = '-';
            if (log.editedBy === 'self') {
                workerDisplay = 'üë§ Î≥∏Ïù∏';
            } else if (log.editedBy === 'admin' || log.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') {
                workerDisplay = 'üëë Í¥ÄÎ¶¨Ïûê';
            } else if (log.editedBy && log.editedBy !== '-') {
                workerDisplay = `üëë ${log.editedBy}`;
            }
            
            // ÎåÄÏÉÅ Î™©Î°ù (Ïó¨Îü¨ Î™ÖÏù∏ Í≤ΩÏö∞ Ï§ÑÎ∞îÍøàÏúºÎ°ú ÌëúÏãú)
            let whoDisplay = log.who;
            if (log.who && log.who.includes(',')) {
                const names = log.who.split(',').map(n => n.trim()).filter(n => n);
                whoDisplay = names.map(n => `<span style="display:inline-block; background:#f3f4f6; padding:2px 8px; margin:2px; border-radius:4px;">${n}</span>`).join(' ');
            }
            
            // ÏàòÏ†ïÏ†Ñ/ÏàòÏ†ïÌõÑ Í∞í ÌååÏã±
            let oldDisplay = log.oldValue || '-';
            let newDisplay = log.newValue || '-';
            let contentDisplay = log.changes || '-';
            
            // JSON ÌòïÌÉúÏù∏ Í≤ΩÏö∞ ÌååÏã± (info_edit, guild_change, spec_edit, power)
            if (log.type === 'info_edit' || log.type === 'power' || log.type === 'guild_change' || log.type === 'spec_edit') {
                try {
                    if (log.oldValue && log.oldValue.startsWith('{')) {
                        const oldData = JSON.parse(log.oldValue);
                        oldDisplay = oldData.power ? Number(oldData.power).toLocaleString() : '-';
                    } else if (log.oldValue && !isNaN(log.oldValue)) {
                        oldDisplay = Number(log.oldValue).toLocaleString();
                    }
                } catch(e) { }
                
                try {
                    if (log.newValue && log.newValue.startsWith('{')) {
                        const newData = JSON.parse(log.newValue);
                        newDisplay = newData.power ? Number(newData.power).toLocaleString() : '-';
                    } else if (log.newValue && !isNaN(log.newValue)) {
                        newDisplay = Number(log.newValue).toLocaleString();
                    }
                } catch(e) { }
                
                if (oldDisplay !== '-' && newDisplay !== '-') {
                    contentDisplay = `Ï†ÑÌà¨Î†•: ${oldDisplay} ‚Üí ${newDisplay}`;
                }
            }
            
            // Í∏∏Îìú Ïù¥ÎèôÏù∏ Í≤ΩÏö∞
            if (log.type === 'guild_move') {
                oldDisplay = '-';
                // newValueÏóêÏÑú Í∏∏ÎìúÎ™Ö Ï∂îÏ∂ú (Ïòà: "ÏÇ¨Ïã†ÏúºÎ°ú 1Î™Ö Ïù¥Îèô")
                const match = log.newValue ? log.newValue.match(/(.+?)ÏúºÎ°ú/) : null;
                const targetGuild = match ? match[1] : '-';
                
                // who ÌïÑÎìúÏóê Ïù¥ÎèôÎêú Ïú†Ï†Ä Ïù¥Î¶ÑÎì§Ïù¥ ÏûàÏùå
                if (log.who && log.who !== 'Admin' && log.who !== '-') {
                    const names = log.who.split(',').map(n => n.trim()).filter(n => n);
                    newDisplay = `${targetGuild} Í∏∏ÎìúÎ°ú Ïù¥Îèô`;
                    contentDisplay = `Ïù¥Îèô Ïù∏Ïõê: ${names.length}Î™Ö<br><br>${names.map(n => `<span style="display:inline-block; background:#dbeafe; padding:2px 8px; margin:2px; border-radius:4px;">${n}</span>`).join(' ')}`;
                } else {
                    newDisplay = log.newValue || '-';
                }
            }
            
            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÏù∏ Í≤ΩÏö∞
            if (log.type === 'nickname_change') {
                contentDisplay = `${log.oldValue} ‚Üí ${log.newValue}`;
            }
            
            // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†úÏù∏ Í≤ΩÏö∞
            if (log.type === 'user_deleted') {
                oldDisplay = 'Îì±Î°ùÎê®';
                newDisplay = 'ÏÇ≠Ï†úÎê®';
                contentDisplay = log.newValue || 'Îì±Î°ù Ìï¥Ï†ú';
            }
            
            const html = `
                <div style="padding: 10px 0; max-height: 60vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; width: 80px; white-space: nowrap;">ÏãúÍ∞Ñ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${log.time}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÎåÄÏÉÅ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-weight: 600;">${whoDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏûëÏóÖ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${logType}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏàòÏ†ï Ï†Ñ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #ef4444; font-weight: 500;">${oldDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏàòÏ†ï ÌõÑ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #10b981; font-weight: 500;">${newDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÎÇ¥Ïö©</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${contentDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏûëÏóÖÏûê</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #8b5cf6; font-weight: 600;">${workerDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">IP</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${log.ip || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏúÑÏπò</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${log.location || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">Í∏∞Í∏∞</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${log.device || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            // Î™®Îã¨ Ïó¥Í∏∞ (ÌÅ∞ ÏÇ¨Ïù¥Ï¶à)
            openSmallModal('üìã Î°úÍ∑∏ ÏÉÅÏÑ∏', log.who.length > 20 ? log.who.substring(0, 20) + '...' : log.who, html);
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };

               document.getElementById('deletedUsersBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê', 'Îì±Î°ù Ìï¥Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ù (ÏòÅÍµ¨ Î≥¥Í¥Ä)');
            
            const snap = await getDocs(query(collection(db, "deletedUsers"), orderBy("deletedAt", "desc")));
            
            const deletedUsers = [];
            snap.forEach(d => {
                const u = d.data();
                deletedUsers.push({
                    id: d.id,
                    name: u.originalName || u.name,
                    guild: u.guild || '-',
                    power: u.power || 0,
                    deletedAt: formatDateTime(u.deletedAt),
                    deletedAtRaw: u.deletedAt,
                    reason: u.deleteReason || '-',
                    memo: u.deleteMemo || '',
                    deletedBy: u.deletedBy || 'admin',
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                });
            });
            
            // Ï†ÑÏó≠ Ï†ÄÏû• (ÏÉÅÏÑ∏Î≥¥Í∏∞Ïö©)
            window.deletedUsersList = deletedUsers;
            
            // ÏÇ¨Ïú† Î™©Î°ù Ï∂îÏ∂ú
            const reasonSet = new Set(deletedUsers.map(u => u.reason));
            const reasonOptions = Array.from(reasonSet).sort().map(r => `<option value="${r}">${r}</option>`).join('');
            
            // Í∏∏Îìú Î™©Î°ù Ï∂îÏ∂ú
            const guildSet = new Set(deletedUsers.map(u => u.guild));
            const guildOptions = Array.from(guildSet).sort().map(g => `<option value="${g}">${g}</option>`).join('');
            
            // ÏÇ≠Ï†úÏûê Î™©Î°ù Ï∂îÏ∂ú
            const deletedBySet = new Set(deletedUsers.map(u => u.deletedBy));
            const deletedByOptions = Array.from(deletedBySet).sort().map(d => `<option value="${d}">${d}</option>`).join('');
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                        <input type="text" id="deletedSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off" style="flex:1; min-width:120px;">
                        <select id="deletedGuildFilter" class="form-input" style="flex:1; min-width:100px;">
                            <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                            ${guildOptions}
                        </select>
                        <select id="deletedReasonFilter" class="form-input" style="flex:1; min-width:100px;">
                            <option value="">Ï†ÑÏ≤¥ ÏÇ¨Ïú†</option>
                            ${reasonOptions}
                        </select>
                        <select id="deletedByFilter" class="form-input" style="flex:1; min-width:100px;">
                            <option value="">Ï†ÑÏ≤¥ ÏÇ≠Ï†úÏûê</option>
                            ${deletedByOptions}
                        </select>
                    </div>
                    <p style="font-size: 12px; color: #6b7280;">Ï¥ù <span id="deletedCount">${deletedUsers.length}</span>Î™Ö</p>
                </div>
                <div class="table-scroll-container" style="max-height: 400px;">
                    <table class="common-table" id="deletedUsersTable" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 18%;">ÎãâÎÑ§ÏûÑ</th>
                                <th style="width: 12%;">Í∏∏Îìú</th>
                                <th style="width: 15%;">Ï†ÑÌà¨Î†•</th>
                                <th style="width: 20%;">ÏÇ≠Ï†úÏùºÏãú</th>
                                <th style="width: 15%;">ÏÇ¨Ïú†</th>
                                <th style="width: 20%;">ÏÇ≠Ï†úÏûê</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            deletedUsers.forEach((u, idx) => {
                const deletedByDisplay = u.deletedBy === 'admin' || u.deletedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' ? 'Í¥ÄÎ¶¨Ïûê' : u.deletedBy;
                html += `<tr data-index="${idx}" data-guild="${u.guild}" data-reason="${u.reason}" data-deletedby="${u.deletedBy}" style="cursor:pointer;" onclick="showDeletedUserDetail(${idx})">
                    <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${u.name}"><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td style="color:#3b82f6; font-weight:600;">${u.power.toLocaleString()}</td>
                    <td style="font-size:12px;">${u.deletedAt}</td>
                    <td><span style="padding:2px 6px; background:#fef2f2; color:#991b1b; border-radius:4px; font-size:11px;">${u.reason}</span></td>
                    <td style="font-size:12px;"><span style="color:#8b5cf6;">üëë ${deletedByDisplay}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
            // ÌïÑÌÑ∞ Ìï®Ïàò
            function applyDeletedFilters() {
                const searchText = document.getElementById('deletedSearchInput').value.toLowerCase();
                const guildFilter = document.getElementById('deletedGuildFilter').value;
                const reasonFilter = document.getElementById('deletedReasonFilter').value;
                const deletedByFilter = document.getElementById('deletedByFilter').value;
                
                let visibleCount = 0;
                document.querySelectorAll('#deletedUsersTable tbody tr').forEach(row => {
                    const name = row.cells[0].textContent.toLowerCase();
                    const guild = row.dataset.guild;
                    const reason = row.dataset.reason;
                    const deletedBy = row.dataset.deletedby;
                    
                    const matchSearch = !searchText || name.includes(searchText);
                    const matchGuild = !guildFilter || guild === guildFilter;
                    const matchReason = !reasonFilter || reason === reasonFilter;
                    const matchDeletedBy = !deletedByFilter || deletedBy === deletedByFilter;
                    
                    if (matchSearch && matchGuild && matchReason && matchDeletedBy) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                document.getElementById('deletedCount').textContent = visibleCount;
            }
            
            document.getElementById('deletedSearchInput').addEventListener('input', applyDeletedFilters);
            document.getElementById('deletedGuildFilter').addEventListener('change', applyDeletedFilters);
            document.getElementById('deletedReasonFilter').addEventListener('change', applyDeletedFilters);
            document.getElementById('deletedByFilter').addEventListener('change', applyDeletedFilters);
        });
        
        // ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏Î≥¥Í∏∞
        window.showDeletedUserDetail = function(index) {
            const u = window.deletedUsersList[index];
            if (!u) return;
            
            const html = `
                <div style="padding: 10px 0; max-height: 60vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; width: 100px;">ÎãâÎÑ§ÏûÑ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-weight: 600;">${u.name}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">Í∏∏Îìú</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${u.guild}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">Ï†ÑÌà¨Î†•</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #3b82f6; font-weight: 600;">${u.power.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">Ïä§Ìéô</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 13px;">
                                ÌòïÏÉÅ Ï†ÑÏÑ§: ${u.shape_legend}Í∞ú / Ïã†Ìôî: ${u.shape_myth}Í∞ú<br>
                                ÌÉàÍ≤É Ï†ÑÏÑ§: ${u.mount_legend}Í∞ú / Ïã†Ìôî: ${u.mount_myth}Í∞ú
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏÇ≠Ï†úÏùºÏãú</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${u.deletedAt}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏÇ¨Ïú†</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">
                                <span style="padding: 4px 10px; background: #fef2f2; color: #991b1b; border-radius: 4px;">${u.reason}</span>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">ÏÇ≠Ï†úÏûê</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #8b5cf6; font-weight: 600;">
                                üëë ${u.deletedBy === 'admin' || u.deletedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' ? 'Í¥ÄÎ¶¨Ïûê' : u.deletedBy}
                            </td>
                        </tr>
                        ${u.memo ? `<tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600;">Î©îÎ™®</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">${u.memo}</td>
                        </tr>` : ''}
                    </table>
                </div>
            `;
            
            openSmallModal('üìã ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê ÏÉÅÏÑ∏', u.name, html);
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };

               document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú', 'Ïó¨Îü¨ ÏÇ¨Ïö©ÏûêÎ•º Ìïú Î≤àÏóê Îì±Î°ù Ìï¥Ï†ú');
            
            const snap = await getDocs(collection(db, "users"));
            let users = [];
            snap.forEach(d => users.push(d.data()));
            
                       users.sort((a,b) => a.name.localeCompare(b.name));
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <input type="text" id="bulkDeleteSearch" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <select id="bulkDeleteGuildFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                                ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <button id="selectAllBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                            ‚úÖ Ï†ÑÏ≤¥ ÏÑ†ÌÉù
                        </button>
                        <button id="deselectAllBtn" class="btn btn-cancel" style="padding: 8px 16px; font-size: 13px;">
                            ‚ùå Ï†ÑÏ≤¥ Ìï¥Ï†ú
                        </button>
                        <span id="selectedCount" style="margin-left: auto; font-size: 14px; color: #6b7280;">
                            ÏÑ†ÌÉù: <strong style="color: #ef4444;">0</strong>Î™Ö
                        </span>
                    </div>
                </div>
                
                <div class="table-scroll-container" style="max-height: 350px;">
                    <table class="common-table" id="bulkDeleteTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ÏÑ†ÌÉù</th>
                                <th style="min-width: 120px;">ÎãâÎÑ§ÏûÑ</th>
                                <th style="min-width: 80px;">Í∏∏Îìú</th>
                                <th style="min-width: 100px;">Ï†ÑÌà¨Î†•</th>
                            </tr>
                        </thead>
                        <tbody id="bulkDeleteTableBody"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Îì±Î°ù Ìï¥Ï†ú ÏÇ¨Ïú† (Í≥µÌÜµ)</label>
                        <select id="bulkDeleteReason" class="form-input">
                            <option value="ÏûêÏßÑ ÌÉàÌá¥">ÏûêÏßÑ ÌÉàÌá¥</option>
                            <option value="Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç">Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç</option>
                            <option value="Í∏∏Îìú Ïù¥Îèô">Í∏∏Îìú Ïù¥Îèô</option>
                            <option value="Í∑úÏ†ï ÏúÑÎ∞ò">Í∑úÏ†ï ÏúÑÎ∞ò</option>
                            <option value="ÏùºÍ¥Ñ Ï†ïÎ¶¨">ÏùºÍ¥Ñ Ï†ïÎ¶¨</option>
                            <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">ÏÉÅÏÑ∏ Î©îÎ™® (Í≥µÌÜµ, ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="bulkDeleteMemo" class="form-input" rows="2" placeholder="Ï∂îÍ∞Ä Î©îÎ™®..."></textarea>
                    </div>
                    <button id="executeBulkDelete" class="btn btn-danger" style="width: 100%;">
                        üóëÔ∏è ÏÑ†ÌÉùÌïú ÏÇ¨Ïö©Ïûê ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú
                    </button>
                </div>
            `;
            
            setModalBody(html);
            
            // ÏÑ†ÌÉùÎêú Ïú†Ï†Ä Î™©Î°ù (Í≤ÄÏÉâÌï¥ÎèÑ Ïú†ÏßÄ)
            const selectedUsers = new Set();
            
                       function renderTable() {
                const tbody = document.getElementById('bulkDeleteTableBody');
                const searchText = document.getElementById('bulkDeleteSearch').value.toLowerCase();
                const guildFilter = document.getElementById('bulkDeleteGuildFilter').value;
                
                const filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    return matchSearch && matchGuild;
                });
                
                tbody.innerHTML = '';
                filtered.forEach(u => {
                    const isChecked = selectedUsers.has(u.name);
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="user-checkbox" data-username="${u.name}" 
                                   ${isChecked ? 'checked' : ''}
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td style="color: #3b82f6; font-weight: 600;">${u.power.toLocaleString()}</td>
                    `;
                    
                    // Ìñâ ÌÅ¥Î¶≠ Ïãú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
                    row.addEventListener('click', function(e) {
                        if (e.target.type === 'checkbox') return;
                        const checkbox = this.querySelector('.user-checkbox');
                        checkbox.checked = !checkbox.checked;
                        toggleSelection(checkbox.dataset.username, checkbox.checked);
                    });
                    
                    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏßÅÏ†ë ÌÅ¥Î¶≠
                    row.querySelector('.user-checkbox').addEventListener('change', function() {
                        toggleSelection(this.dataset.username, this.checked);
                    });
                    
                    tbody.appendChild(row);
                });
                
                updateSelectedCount();
            }
            
            function toggleSelection(name, isSelected) {
                if (isSelected) {
                    selectedUsers.add(name);
                } else {
                    selectedUsers.delete(name);
                }
                updateSelectedCount();
            }
            
                       function updateSelectedCount() {
                document.getElementById('selectedCount').innerHTML = 
                    `ÏÑ†ÌÉù: <strong style="color: #ef4444;">${selectedUsers.size}</strong>Î™Ö`;
            }
            
            renderTable();
            
                       document.getElementById('bulkDeleteSearch').addEventListener('input', renderTable);
            document.getElementById('bulkDeleteGuildFilter').addEventListener('change', renderTable);
            
                       document.getElementById('selectAllBtn').addEventListener('click', () => {
                // ÌòÑÏû¨ Î≥¥Ïù¥Îäî Ìï≠Î™©Îßå ÏÑ†ÌÉù
                document.querySelectorAll('.user-checkbox').forEach(cb => {
                    cb.checked = true;
                    selectedUsers.add(cb.dataset.username);
                });
                updateSelectedCount();
            });
            
                       document.getElementById('deselectAllBtn').addEventListener('click', () => {
                // ÌòÑÏû¨ Î≥¥Ïù¥Îäî Ìï≠Î™©Îßå Ìï¥Ï†ú
                document.querySelectorAll('.user-checkbox').forEach(cb => {
                    cb.checked = false;
                    selectedUsers.delete(cb.dataset.username);
                });
                updateSelectedCount();
            });
            
                       document.getElementById('executeBulkDelete').addEventListener('click', async (e) => {
                               const btn = e.target;
                if (btn.disabled) return;
                
                try {
                    const selected = Array.from(selectedUsers);
                    
                    if (selected.length === 0) {
                        showAlert('ÏÇ≠Ï†úÌï† ÏÇ¨Ïö©ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                        return;
                    }
                    
                    const reason = document.getElementById('bulkDeleteReason').value;
                    const memo = document.getElementById('bulkDeleteMemo').value.trim();
                    
                                       const confirmed = await showConfirm(
                        'ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú ÌôïÏù∏',
                        `<span style="color:#ef4444; font-weight:600;">${selected.length}Î™ÖÏùò ÏÇ¨Ïö©ÏûêÎ•º Îì±Î°ù Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</span><br><br>
                        ‚Ä¢ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§<br>
                        ‚Ä¢ ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ùÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•<br>
                        ‚Ä¢ Î≥µÍµ¨Îäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§<br><br>
                        <strong>ÏÑ†ÌÉùÎêú ÏÇ¨Ïö©Ïûê:</strong><br>
                        ${selected.slice(0, 10).join(', ')}${selected.length > 10 ? '...' : ''}`,
                        true                     );
                    
                    if (!confirmed) return;
                    
                                       document.getElementById('modalTitle').textContent = 'ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú ÏßÑÌñâ Ï§ë';
                    document.getElementById('modalSubtitle').textContent = 'Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...';
                    
                                       document.getElementById('modalBody').innerHTML = `
                        <div style="padding: 20px 16px;">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <strong style="font-size: 16px; color: #111827;">Ï≤òÎ¶¨ Ï§ë...</strong>
                                <p style="margin-top: 6px; color: #6b7280; font-size: 13px;">
                                    Ï∞ΩÏùÑ Îã´ÏßÄ ÎßàÏãúÍ≥† Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="background: #e5e7eb; height: 28px; border-radius: 14px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);">
                                        <span id="progressPercent" style="color: white; font-weight: 700; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ÏßÑÌñâ</div>
                                        <div id="progressText" style="font-size: 16px; font-weight: 700; color: #111827;">0 / ${selected.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ÏÑ±Í≥µ</div>
                                        <div id="successCount" style="font-size: 16px; font-weight: 700; color: #10b981;">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">Ïã§Ìå®</div>
                                        <div id="failCount" style="font-size: 16px; font-weight: 700; color: #ef4444;">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="currentUser" style="margin-top: 12px; text-align: center; font-size: 12px; color: #6b7280; min-height: 18px;">
                                Ï§ÄÎπÑ Ï§ë...
                            </div>
                        </div>
                    `;
                
                
                btn.disabled = true;
                
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < selected.length; i++) {
                    const name = selected[i];
                    
                                       document.getElementById('currentUser').textContent = `Ï≤òÎ¶¨ Ï§ë: ${name}`;
                    
                    try {
                                               const userDoc = await getDoc(doc(db, "users", name));
                        if (!userDoc.exists()) {
                            failCount++;
                            document.getElementById('failCount').textContent = failCount;
                            continue;
                        }
                        
                        const userData = userDoc.data();
                        
                                               await setDoc(doc(collection(db, "deletedUsers")), {
                            ...userData,
                            deletedAt: Date.now(),
                            deletedBy: 'admin',
                            deleteReason: reason,
                            deleteMemo: memo || '',
                            originalName: name,
                            deletedIp: await getIp(),
                            deletedDevice: navigator.userAgent
                        });
                        
                                               await deleteDoc(doc(db, "users", name));
                        
                                               await setDoc(doc(collection(db, "logs")), {
                            who: name,
                            type: 'user_deleted',
                            old_value: 'ÏÇ¨Ïö©Ïûê Ï°¥Ïû¨',
                            new_value: `ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú (ÏÇ¨Ïú†: ${reason})`,
                            editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                            createdAt: Date.now(),
                            ip: await getIp(),
                            location: (await getIpAndLocation()).location,
                            device: parseUserAgent(navigator.userAgent)
                        });
                        
                        successCount++;
                        document.getElementById('successCount').textContent = successCount;
                    } catch (e) {
                        console.error(`Failed to delete ${name}:`, e);
                        failCount++;
                        document.getElementById('failCount').textContent = failCount;
                    }
                    
                                       const current = i + 1;
                    const percent = Math.round((current / selected.length) * 100);
                    document.getElementById('progressText').textContent = `${current} / ${selected.length}`;
                    document.getElementById('progressBar').style.width = `${percent}%`;
                    document.getElementById('progressPercent').textContent = `${percent}%`;
                    
                   
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                               document.getElementById('modalTitle').textContent = 'Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å';
                document.getElementById('modalSubtitle').textContent = '';
                document.getElementById('currentUser').innerHTML = `
                    <div style="text-align: center; padding: 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${failCount === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 8px;">
                            Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            ÏÑ±Í≥µ: <strong style="color: #10b981;">${successCount}Î™Ö</strong> / 
                            Ïã§Ìå®: <strong style="color: #ef4444;">${failCount}Î™Ö</strong>
                        </div>
                        <div style="margin-top: 12px; font-size: 12px; color: #9ca3af;">
                            Ïû†Ïãú ÌõÑ ÌéòÏù¥ÏßÄÍ∞Ä ÏÉàÎ°úÍ≥†Ïπ®Îê©ÎãàÎã§...
                        </div>
                    </div>
                `;
                
                               setTimeout(() => {
                    closeModal();
                    showAlert(
                        `Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å: ÏÑ±Í≥µ ${successCount}Î™Ö, Ïã§Ìå® ${failCount}Î™Ö`,
                        failCount === 0 ? 'success' : 'error'
                    );
                    setTimeout(() => location.reload(), 1000);
                }, 2000);
                } catch (error) {
                    console.error('ÏùºÍ¥Ñ ÏÇ≠Ï†ú ÏóêÎü¨:', error);
                    closeModal();
                    btn.disabled = false;
                    showAlert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                }
            });
        });

               async function authenticateAndRun(name, callback) {
            if (isSystemLocked() && !isSuperAdmin) { 
                const lockMsg = `Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.\n\nÍ∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            const u = (await getDoc(doc(db, "users", name))).data();
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalFooter').style.display = 'flex';
            if (!u.password) openPasswordSetupModal(name, u, callback); 
            else openPasswordVerifyModal(name, u, callback);
        }
        
        function handlePowerClick(name) { 
           
            if (isAdmin) {
                getDoc(doc(db, "users", name)).then(snap => {
                    if (snap.exists()) {
                        openPowerEditModal(name, snap.data());
                    }
                });
            } else {
                authenticateAndRun(name, (u) => openPowerEditModal(name, u));
            }
        }

        window.editUserFromInfo = async function(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();
            
            closeModal();            setTimeout(() => {
               
                if (isAdmin) {
                    openUserEditModal(u);
                } else {
                    authenticateAndRun(name, (userData) => openUserEditModal(userData));
                }
            }, 300);
        };
        
        function openPasswordSetupModal(name, u, cb) {
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï', '4ÏûêÎ¶¨ Ïà´Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî', `<div class="form-group"><input type="password" class="form-input" id="passwordInput" maxlength="4" placeholder="4ÏûêÎ¶¨ Ïà´Ïûê" inputmode="numeric"></div>`);
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => { 
                const pw = document.getElementById('passwordInput').value; 
                if(!/^\d{4}$/.test(pw)) { 
                    showAlert('4ÏûêÎ¶¨ Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); 
                    return; 
                }
                await updateDoc(doc(db, "users", name), { password: pw }); 
                closeModal(); 
                setTimeout(() => cb(u), 500); 
            };
        }

        function openPasswordVerifyModal(name, u, cb) {
            let failCount = 0;
            const maxAttempts = 5;
            
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏', 'Î≥∏Ïù∏ ÌôïÏù∏ÏùÑ ÏúÑÌï¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', `
                <div class="form-group">
                    <input type="password" class="form-input" id="passwordInput" maxlength="4" inputmode="numeric">
                    <p id="attemptInfo" style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">ÎÇ®ÏùÄ ÏãúÎèÑ ÌöüÏàò: ${maxAttempts}Ìöå</p>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
                        <input type="checkbox" id="rememberPassword" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÄÏû• (ÏûêÎèô Î°úÍ∑∏Ïù∏)</span>
                    </label>
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 4px; margin-left: 26px;">‚Äª Î∏åÎùºÏö∞Ï†Ä Î≥ÄÍ≤Ω Ïãú ÏûêÎèô Î°úÍ∑∏Ïù∏Ïù¥ Ìï¥Ï†úÎê©ÎãàÎã§</p>
                </div>
            `);
            
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            
            document.getElementById('modalSubmit').onclick = () => { 
                if (document.getElementById('passwordInput').value === u.password || isAdmin) {
                    const rememberChecked = document.getElementById('rememberPassword').checked;
                    
                                       loggedInUser = name;
                    
                   
                    if (rememberChecked && !isAdmin) {
                        localStorage.setItem('autoLogin', JSON.stringify({
                            username: name,
                            password: u.password,
                            timestamp: Date.now()
                        }));
                    }
                    
                    closeModal(); 
                    setTimeout(() => {
                        loadData();
                        cb(u);
                    }, 200); 
                } else {
                    failCount++;
                    const remaining = maxAttempts - failCount;
                    
                    if (failCount >= maxAttempts) {
                        closeModal();
                        setTimeout(() => {
                            openSmallModal(
                                'ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Ï†úÌïú', 
                                '5Ìöå Ïù¥ÏÉÅ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌãÄÎ†∏ÏäµÎãàÎã§', 
                                `
                                <div style="text-align: center; padding: 20px;">
                                    <p style="font-size: 16px; color: #374151; margin-bottom: 20px;">
                                        ÎπÑÎ∞ÄÎ≤àÌò∏Î•º 5Ìöå Ïù¥ÏÉÅ ÌãÄÎ†∏ÏäµÎãàÎã§.<br>
                                        Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.
                                    </p>
                                    <a href="https://open.kakao.com/o/s3LUVM4h" target="_blank" 
                                       style="display: inline-block; padding: 12px 24px; background: #FEE500; color: #000000; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;">
                                        üì± Ïπ¥Ïπ¥Ïò§ÌÜ° Ïò§ÌîàÏ±ÑÌåÖ Î∞îÎ°úÍ∞ÄÍ∏∞
                                    </a>
                                </div>
                                `
                            );
                            document.getElementById('modalFooter').style.display = 'none';
                        }, 300);
                        return;
                    }
                    
                    document.getElementById('attemptInfo').textContent = `ÎÇ®ÏùÄ ÏãúÎèÑ ÌöüÏàò: ${remaining}Ìöå`;
                    document.getElementById('attemptInfo').style.color = remaining <= 2 ? '#ef4444' : '#6b7280';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                    showAlert(`ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§ (${remaining}Ìöå ÎÇ®Ïùå)`, 'error'); 
                }
            };
        }

               // Î™®Îã¨ Ïä§ÌÉù (Ï§ëÏ≤© Î™®Îã¨ ÏßÄÏõê)
        let modalStack = [];
        
        // Î≤ÑÌäº ÏÉÅÌÉú Î¶¨ÏÖã Ìï®Ïàò (Ï†ïÍ∑úÌëúÌòÑÏãùÏúºÎ°ú Ï≤òÎ¶¨)
        function resetButtonStates(htmlContent) {
            if (!htmlContent) return htmlContent;
            
            // disabled ÏÜçÏÑ± Ï†úÍ±∞
            let result = htmlContent.replace(/\s+disabled(=["'][^"']*["'])?/gi, '');
            
            // "Ï≤òÎ¶¨ Ï§ë...", "Ï†ÄÏû• Ï§ë...", "ÏßÑÌñâ Ï§ë..." ÌÖçÏä§Ìä∏ Î≥µÏõê
            result = result.replace(/>Ï≤òÎ¶¨ Ï§ë\.\.\.</g, '>Í∏∏Îìú Ïù¥Îèô Ïã§Ìñâ<');
            result = result.replace(/>Ï†ÄÏû• Ï§ë\.\.\.</g, '>Ï†ÄÏû•<');
            result = result.replace(/>ÏßÑÌñâ Ï§ë\.\.\.</g, '>ÌôïÏù∏<');
            
            return result;
        }
        
        function openLargeModal(t, s) {
            // ÌòÑÏû¨ Î™®Îã¨ ÏÉÅÌÉú Ï†ÄÏû•
            let currentContent = document.getElementById('modalBody').innerHTML;
            const currentTitle = document.getElementById('modalTitle').textContent;
            const currentSubtitle = document.getElementById('modalSubtitle').textContent;
            let currentFooter = document.getElementById('modalFooter').innerHTML;
            const currentFooterDisplay = document.getElementById('modalFooter').style.display;
            const isLarge = document.getElementById('modalContent').classList.contains('modal-lg');
            const isActive = document.getElementById('modalOverlay').classList.contains('active');
            
            if (isActive) {
                // Ï†ÄÏû• Ï†Ñ Î≤ÑÌäº ÏÉÅÌÉú Î¶¨ÏÖã
                currentContent = resetButtonStates(currentContent);
                currentFooter = resetButtonStates(currentFooter);
                modalStack.push({ title: currentTitle, subtitle: currentSubtitle, body: currentContent, footer: currentFooter, footerDisplay: currentFooterDisplay, isLarge });
            }
            
            document.getElementById('modalContent').classList.add('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalFooter').style.display = 'none'; 
            document.getElementById('modalBody').innerHTML = 'Î°úÎî©Ï§ë...'; 
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openSmallModal(t, s, b) {
            // ÌòÑÏû¨ Î™®Îã¨ ÏÉÅÌÉú Ï†ÄÏû•
            let currentContent = document.getElementById('modalBody').innerHTML;
            const currentTitle = document.getElementById('modalTitle').textContent;
            const currentSubtitle = document.getElementById('modalSubtitle').textContent;
            let currentFooter = document.getElementById('modalFooter').innerHTML;
            const currentFooterDisplay = document.getElementById('modalFooter').style.display;
            const isLarge = document.getElementById('modalContent').classList.contains('modal-lg');
            const isActive = document.getElementById('modalOverlay').classList.contains('active');
            
            if (isActive) {
                // Ï†ÄÏû• Ï†Ñ Î≤ÑÌäº ÏÉÅÌÉú Î¶¨ÏÖã
                currentContent = resetButtonStates(currentContent);
                currentFooter = resetButtonStates(currentFooter);
                modalStack.push({ title: currentTitle, subtitle: currentSubtitle, body: currentContent, footer: currentFooter, footerDisplay: currentFooterDisplay, isLarge });
            }
            
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalBody').innerHTML = b; 
                       document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" id="modalSubmit">ÌôïÏù∏</button>
            `;
            document.getElementById('modalFooter').style.display = 'flex'; 
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function setModalBody(h) { 
            document.getElementById('modalBody').innerHTML = h + `<div style="text-align:right;margin-top:10px"><button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button></div>`; 
        }

        window.closeModal = () => {
            if (modalStack.length > 0) {
                // Ïù¥Ï†Ñ Î™®Îã¨Î°ú Î≥µÏõê
                const prev = modalStack.pop();
                document.getElementById('modalTitle').textContent = prev.title;
                document.getElementById('modalSubtitle').textContent = prev.subtitle;
                document.getElementById('modalBody').innerHTML = prev.body;
                document.getElementById('modalFooter').innerHTML = prev.footer;
                document.getElementById('modalFooter').style.display = prev.footerDisplay;
                document.getElementById('modalContent').style.maxWidth = ''; // Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Î¶¨ÏÖã
                if (prev.isLarge) {
                    document.getElementById('modalContent').classList.add('modal-lg');
                } else {
                    document.getElementById('modalContent').classList.remove('modal-lg');
                }
                
                // Î≥µÏõê ÌõÑ Î≤ÑÌäº ÌôúÏÑ±Ìôî (ÏïàÏ†ÑÏû•Ïπò)
                setTimeout(() => {
                    document.querySelectorAll('#modalBody button, #modalFooter button').forEach(btn => {
                        btn.disabled = false;
                    });
                }, 10);
            } else {
                // Î™®Îã¨ Îã´Í∏∞
                document.getElementById('modalOverlay').classList.remove('active');
                document.getElementById('modalContent').style.maxWidth = ''; // Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Î¶¨ÏÖã
                document.body.style.overflow = '';
            }
        };
        
        // Î™®Îã¨ ÏôÑÏ†ÑÌûà Îã´Í∏∞ (Ïä§ÌÉù Î¨¥Ïãú)
        window.closeAllModals = () => {
            modalStack = [];
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('modalContent').style.maxWidth = ''; // Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº Î¶¨ÏÖã
            document.body.style.overflow = '';
        };
        
        // Î™®Îã¨ Ïä§ÌÉù Ï¥àÍ∏∞Ìôî (ÏûëÏóÖ ÏôÑÎ£å ÌõÑ Ìò∏Ï∂ú)
        window.clearModalStack = () => {
            modalStack = [];
        };
        
       
               window.showConfirm = (title, message, keepOpen = false) => {
            return new Promise((resolve) => {
                openSmallModal(title, '', `<p style="text-align:center; padding:20px 0; font-size:15px; line-height:1.6; color:#374151;">${message}</p>`);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="window.confirmResolve(false)">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="window.confirmResolve(true)">ÌôïÏù∏</button>
                `;
                window.confirmResolve = (result) => {
                    if (!keepOpen || !result) {
                        closeModal();
                    }
                    resolve(result);
                    delete window.confirmResolve;
                };
            });
        };

        // Ïª§Ïä§ÌÖÄ ÌîÑÎ°¨ÌîÑÌä∏ (ÏûÖÎ†•Ï∞Ω)
        window.showPrompt = (title, message, defaultValue = '') => {
            return new Promise((resolve) => {
                openSmallModal(title, '', `
                    <p style="text-align:center; padding:10px 0 20px; font-size:14px; color:#374151;">${message}</p>
                    <input type="text" id="promptInput" class="form-input" value="${defaultValue}" style="text-align:center; font-size:15px;" autofocus>
                `);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="window.promptResolve(null)">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="window.promptResolve(document.getElementById('promptInput').value)">ÌôïÏù∏</button>
                `;
                
                // Ìè¨Ïª§Ïä§ Î∞è ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    if (input) {
                        input.focus();
                        input.select();
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                window.promptResolve(input.value);
                            }
                        });
                    }
                }, 100);
                
                window.promptResolve = (result) => {
                    closeModal();
                    resolve(result);
                    delete window.promptResolve;
                };
            });
        };

        // ÏßÑÌñâÎ•† ÌëúÏãú Î™®Îã¨
        window.showProgress = (title, message = '') => {
            // Í∏∞Ï°¥ ÏßÑÌñâÎ•† Î™®Îã¨ Ï†úÍ±∞
            const existing = document.getElementById('progressModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'progressModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 8px; color: #374151; font-size: 18px;">${title}</h3>
                    <p id="progressMessage" style="margin: 0 0 20px; color: #6b7280; font-size: 14px;">${message}</p>
                    <div style="background: #e5e7eb; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 12px;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <p id="progressPercent" style="margin: 0; color: #374151; font-weight: 600; font-size: 16px;">0%</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            return {
                update: (percent, msg = null) => {
                    const bar = document.getElementById('progressBar');
                    const pct = document.getElementById('progressPercent');
                    const msgEl = document.getElementById('progressMessage');
                    if (bar) bar.style.width = percent + '%';
                    if (pct) pct.textContent = Math.round(percent) + '%';
                    if (msg && msgEl) msgEl.textContent = msg;
                },
                close: () => {
                    const m = document.getElementById('progressModal');
                    if (m) m.remove();
                }
            };
        };

               function performSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchText) {
                showAlert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }
            
                       let foundUser = null;
            for (let i = 0; i < allGuildData.length; i++) {
                if (allGuildData[i].name.toLowerCase().includes(searchText)) {
                    foundUser = allGuildData[i];
                    break;
                }
            }
            
            if (foundUser) {
                               showGuildDetail(foundUser.guild);
                
                               setTimeout(() => {
                    const rows = document.querySelectorAll('#detailList tr');
                    rows.forEach(r => {
                        const playerName = r.querySelector('.player-name');
                        if (playerName && playerName.textContent.toLowerCase().includes(searchText)) {
                            r.style.background = '#fef3c7';
                            r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                                                       setTimeout(() => {
                                r.style.background = '';
                            }, 3000);
                        }
                    });
                }, 200);
            } else {
                showAlert('Ìï¥Îãπ ÎãâÎÑ§ÏûÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
            }
        }

        document.getElementById('searchInput').addEventListener('input', (e) => { 
            const searchText = e.target.value.toLowerCase().trim();
            
                       if (currentGuild) {
                document.querySelectorAll('#detailList tr').forEach(r => {
                    const playerName = r.querySelector('.player-name');
                    if (playerName) {
                        r.style.display = playerName.textContent.toLowerCase().includes(searchText) ? '' : 'none';
                    }
                });
            }
        });
        
               document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
               document.getElementById('searchBtn').addEventListener('click', () => {
            performSearch();
        });

        function showAlert(m, t='success') { 
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) existingAlert.remove();
            
            const a = document.createElement('div'); 
            a.className = `alert alert-${t}`; 
            a.innerHTML = `<button class="alert-close" onclick="this.parentElement.remove()">√ó</button><div class="alert-title">${t==='success'?'ÏÑ±Í≥µ':'ÏïåÎ¶º'}</div><p class="alert-message" style="white-space: pre-line;">${m}</p>`; 
            document.body.appendChild(a); 
            setTimeout(() => { if(a.parentElement) a.remove(); }, 5000); 
        }

        async function initializeDatabase() { 
            const uList = [
                { guild: 'ÏÇ¨Ïã†', name: 'Í∞ìÎ™ÖÌíà', power: 1347941 }, 
                { guild: 'ÏÇ¨Ïã†', name: 'ÏπºÎ¶¨', power: 1292531 }
            ]; 
            for (const u of uList) await setDoc(doc(db, "users", u.name), { 
                ...u, 
                password: null, 
                shape_legend: 0, 
                shape_myth: 0, 
                mount_legend: 0, 
                mount_myth: 0 
            }); 
            showAlert("Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å", "success"); 
            setTimeout(() => location.reload(), 1500); 
        }

               document.getElementById('backupManageBtn').addEventListener('click', async () => {
            if (!isAdmin) return;
            
            openLargeModal('üì¶ Ï£ºÍ∞Ñ Î∞±ÏóÖ Í¥ÄÎ¶¨', 'Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ Î∞±ÏóÖÌïòÍ≥† Í≥ºÍ±∞ Í∏∞Î°ùÏùÑ Ï°∞ÌöåÌï©ÎãàÎã§');
            
            let lastBackupTime = null;
            let backupsList = [];
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(50)));
                backupsSnap.forEach(doc => {
                    const data = doc.data();
                    backupsList.push({ id: doc.id, ...data });
                });
                if (backupsList.length > 0) {
                    lastBackupTime = backupsList[0].createdAt;
                }
            } catch(e) { console.error(e); }
            
            const lastBackupStr = lastBackupTime ? formatDateTime(lastBackupTime) : 'ÏóÜÏùå';
            
            // ÎπÑÍµê Î∞±ÏóÖ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
            let compareOptions = '<option value="">ÏµúÍ∑º Î∞±ÏóÖÍ≥º ÎπÑÍµê (Í∏∞Î≥∏)</option>';
            backupsList.forEach(b => {
                const name = b.backupName || formatDateTime(b.createdAt);
                compareOptions += `<option value="${b.id}">${name}</option>`;
            });
            
            // ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÍ∞Ä ÏïÑÎãàÎ©¥ Î∞±ÏóÖ ÏÉùÏÑ± UI Ïà®ÍπÄ
            const backupCreateSection = isSuperAdmin ? `
                <div style="background:#f9fafb; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label class="form-label" style="font-size:13px;">üìù Î∞±ÏóÖ Ïù¥Î¶Ñ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <input type="text" id="backupNameInput" class="form-input" placeholder="Ïòà: 1Ïõî 2Ï£ºÏ∞®, Í∏∏ÎìúÏ†Ñ Ï†ÑÎÇ† Îì±" maxlength="50">
                    </div>
                    <div class="form-group" style="margin-bottom:12px;">
                        <label class="form-label" style="font-size:13px;">üë§ ÏÉùÏÑ±Ïûê Ïù¥Î¶Ñ</label>
                        <input type="text" id="backupCreatorInput" class="form-input" placeholder="Ïòà: ÏóêÎπÑÏ∏Ñ" maxlength="20" value="${isSuperAdmin ? 'ÏóêÎπÑÏ∏Ñ' : (loggedInAdminId || '')}">
                        <p style="font-size:11px; color:#6b7280; margin-top:4px;">Î∞±ÏóÖ Í∏∞Î°ùÍ≥º ÏóëÏÖÄÏóê ÌëúÏãúÎê† Ïù¥Î¶ÑÏûÖÎãàÎã§</p>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label" style="font-size:13px;">üìä ÎπÑÍµê Í∏∞Ï§Ä Î∞±ÏóÖ</label>
                        <select id="compareBackupSelect" class="form-input">${compareOptions}</select>
                        <p style="font-size:11px; color:#6b7280; margin-top:4px;">Ï†ÑÌà¨Î†• Ï¶ùÍ∞êÏùÑ Ïñ¥Îäê Î∞±ÏóÖÍ≥º ÎπÑÍµêÌï†ÏßÄ ÏÑ†ÌÉùÌï©ÎãàÎã§</p>
                    </div>
                </div>
                
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="runManualBackup()" style="background:#0891b2;">üì¶ ÏßÄÍ∏à Î∞±ÏóÖÌïòÍ∏∞</button>
                    <button class="btn" onclick="viewBackupHistory()" style="background:#6366f1; color:white;">üìã Î∞±ÏóÖ Í∏∞Î°ù Î≥¥Í∏∞</button>
                </div>
            ` : `
                <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                    <p style="color:#92400e; font-size:12px; margin:0;">‚ö†Ô∏è Î∞±ÏóÖ ÏÉùÏÑ±ÏùÄ ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§</p>
                </div>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button class="btn" onclick="viewBackupHistory()" style="background:#6366f1; color:white;">üìã Î∞±ÏóÖ Í∏∞Î°ù Î≥¥Í∏∞</button>
                </div>
            `;
            
            const html = `
                <div style="margin-bottom:24px;">
                    <div style="background:#f0f9ff; border:1px solid #0891b2; border-radius:12px; padding:16px; margin-bottom:20px;">
                        <p style="color:#0891b2; font-weight:600; margin-bottom:8px;">üìå Î∞±ÏóÖ ÏïàÎÇ¥</p>
                        <ul style="color:#0e7490; font-size:13px; margin:0; padding-left:20px;">
                            <li>Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Îäî FirebaseÏóê ÏòÅÍµ¨ Ï†ÄÏû•Îê©ÎãàÎã§</li>
                            <li>Î™á Îã¨, Î™á ÎÖÑ Îí§ÏóêÎèÑ Ï°∞Ìöå Í∞ÄÎä•Ìï©ÎãàÎã§</li>
                            <li>Îß§Ï£º ÌÜ†ÏöîÏùº Ïò§ÌõÑ 9Ïãú(KST)Ïóê ÏûêÎèô Î∞±ÏóÖÎê©ÎãàÎã§</li>
                            <li>Î∞±ÏóÖ ÎÇ¥Ïö©: ÎãâÎÑ§ÏûÑ, Í∏∏Îìú, Ï†ÑÌà¨Î†•, Ï£ºÍ∞Ñ Ï¶ùÍ∞ÄÎüâ</li>
                        </ul>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
                        <div style="background:#fef3c7; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#92400e; font-size:13px; margin:0;">ÎßàÏßÄÎßâ Î∞±ÏóÖ</p>
                            <p style="color:#b45309; font-size:16px; font-weight:600; margin:8px 0 0;">${lastBackupStr}</p>
                        </div>
                        <div style="background:#d1fae5; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#065f46; font-size:13px; margin:0;">ÌòÑÏû¨ Ïú†Ï†Ä Ïàò</p>
                            <p style="color:#047857; font-size:16px; font-weight:600; margin:8px 0 0;">${allGuildData.length}Î™Ö</p>
                        </div>
                        <div style="background:#e0e7ff; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#3730a3; font-size:13px; margin:0;">Ï¥ù Ï†ÑÌà¨Î†•</p>
                            <p style="color:#4338ca; font-size:16px; font-weight:600; margin:8px 0 0;">${allGuildData.reduce((sum, u) => sum + u.power, 0).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    ${backupCreateSection}
                </div>
            `;
            
            setModalBody(html);
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
        });
        
        window.runManualBackup = async function() {
            if (!isSuperAdmin) {
                showAlert('Î∞±ÏóÖ ÏÉùÏÑ±ÏùÄ ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§', 'error');
                return;
            }
            
            const backupName = document.getElementById('backupNameInput')?.value.trim() || '';
            const backupCreator = document.getElementById('backupCreatorInput')?.value.trim() || loggedInAdminId || 'admin';
            const compareBackupId = document.getElementById('compareBackupSelect')?.value || '';
            
            const confirmMsg = backupName 
                ? `"${backupName}" Ïù¥Î¶ÑÏúºÎ°ú Î∞±ÏóÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?` 
                : 'ÌòÑÏû¨ Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ Î∞±ÏóÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            
            if (!await showConfirm('Î∞±ÏóÖ ÌôïÏù∏', confirmMsg)) return;
            
            showAlert('Î∞±ÏóÖ Ï§ë...', 'success');
            
            const now = Date.now();
            
            let lastBackupData = {};
            let compareBackupName = 'ÏµúÍ∑º Î∞±ÏóÖ';
            try {
                // ÎπÑÍµêÌï† Î∞±ÏóÖ ÏÑ†ÌÉù
                if (compareBackupId) {
                    const compareDoc = await getDoc(doc(db, "backups", compareBackupId));
                    if (compareDoc.exists()) {
                        const compareBackup = compareDoc.data();
                        compareBackupName = compareBackup.backupName || formatDateTime(compareBackup.createdAt);
                        if (compareBackup.users) {
                            compareBackup.users.forEach(u => {
                                lastBackupData[u.name] = u.power;
                            });
                        }
                    }
                } else {
                    // Í∏∞Î≥∏: ÏµúÍ∑º Î∞±ÏóÖÍ≥º ÎπÑÍµê
                    const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                    if (!backupsSnap.empty) {
                        const lastBackup = backupsSnap.docs[0].data();
                        compareBackupName = lastBackup.backupName || formatDateTime(lastBackup.createdAt);
                        if (lastBackup.users) {
                            lastBackup.users.forEach(u => {
                                lastBackupData[u.name] = u.power;
                            });
                        }
                    }
                }
            } catch(e) { console.error(e); }
            
            const backupUsers = allGuildData.map(u => ({
                name: u.name,
                guild: u.guild,
                power: u.power,
                prevPower: lastBackupData[u.name] || u.power,
                diff: u.power - (lastBackupData[u.name] || u.power),
                shape_legend: u.shape_legend || 0,
                shape_myth: u.shape_myth || 0,
                mount_legend: u.mount_legend || 0,
                mount_myth: u.mount_myth || 0
            })).sort((a, b) => b.power - a.power);
            
            const guildStats = {};
            backupUsers.forEach(u => {
                if (!guildStats[u.guild]) {
                    guildStats[u.guild] = { count: 0, totalPower: 0, totalDiff: 0, activeCount: 0 };
                }
                guildStats[u.guild].count++;
                if (u.power > 0) {
                    guildStats[u.guild].activeCount++;
                    guildStats[u.guild].totalPower += u.power;
                }
                guildStats[u.guild].totalDiff += u.diff;
            });
            
            const backupId = `backup_${now}`;
            try {
                await setDoc(doc(db, "backups", backupId), {
                    users: backupUsers,
                    guildStats: guildStats,
                    totalUsers: backupUsers.length,
                    totalPower: backupUsers.reduce((sum, u) => sum + u.power, 0),
                    totalDiff: backupUsers.reduce((sum, u) => sum + u.diff, 0),
                    createdAt: now,
                    createdBy: backupCreator,
                    type: 'manual',
                    backupName: backupName || null,
                    compareBackupId: compareBackupId || null,
                    compareBackupName: compareBackupName
                });
                
                showAlert('Î∞±ÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                setTimeout(() => document.getElementById('backupManageBtn').click(), 1000);
            } catch(e) {
                console.error(e);
                showAlert('Î∞±ÏóÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        window.viewBackupHistory = async function() {
            openLargeModal('üìã Î∞±ÏóÖ Í∏∞Î°ù', 'Í≥ºÍ±∞ Î∞±ÏóÖ ÎÇ¥Ïó≠ÏùÑ Ï°∞ÌöåÌïòÍ≥† ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï©ÎãàÎã§');
            setModalBody('<p style="text-align:center; padding:40px;">Î°úÎî© Ï§ë...</p>');
            
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(50)));
                
                if (backupsSnap.empty) {
                    setModalBody('<p style="text-align:center; color:#9ca3af; padding:40px;">Î∞±ÏóÖ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>');
                    document.getElementById('modalFooter').innerHTML = `
                        <button class="btn" onclick="document.getElementById('backupManageBtn').click()" style="background:#0891b2; color:white;">‚Üê Î∞±ÏóÖ Í¥ÄÎ¶¨</button>
                        <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
                    `;
                    return;
                }
                
                let html = `<div style="overflow-x:auto;"><table class="common-table table-wide"><thead><tr>
                    <th>Î∞±ÏóÖ Ïù¥Î¶Ñ</th>
                    <th>ÏùºÏãú</th>
                    <th>Ïú†Ï†Ä Ïàò</th>
                    <th>Ï¥ù Ï†ÑÌà¨Î†•</th>
                    <th>Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</th>
                    <th>Ïú†Ìòï</th>
                    <th>Í¥ÄÎ¶¨</th>
                </tr></thead><tbody>`;
                
                backupsSnap.forEach(docSnap => {
                    const backup = docSnap.data();
                    const backupId = docSnap.id;
                    const time = formatDateTime(backup.createdAt);
                    const backupName = backup.backupName || '-';
                    const backupNameEscaped = (backup.backupName || '').replace(/'/g, "\\'");
                    const totalPower = backup.totalPower ? backup.totalPower.toLocaleString() : '-';
                    const totalDiff = backup.totalDiff || 0;
                    const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                    const diffSign = totalDiff >= 0 ? '+' : '';
                    const type = backup.type === 'manual' ? '<span style="color:#f59e0b;">ÏàòÎèô</span>' : '<span style="color:#10b981;">ÏûêÎèô</span>';
                    
                    html += `<tr id="backup-row-${backupId}">
                        <td style="font-weight:600; color:#374151;">
                            <span id="backup-name-${backupId}">${backupName}</span>
                            <button onclick="editBackupName('${backupId}', '${backupNameEscaped}')" style="background:none; border:none; cursor:pointer; padding:2px 4px; font-size:12px;" title="Ïù¥Î¶Ñ Î≥ÄÍ≤Ω">‚úèÔ∏è</button>
                        </td>
                        <td style="font-size:12px;">${time}</td>
                        <td>${backup.totalUsers || 0}Î™Ö</td>
                        <td style="font-weight:600;">${totalPower}</td>
                        <td style="color:${diffColor}; font-weight:600;">${diffSign}${totalDiff.toLocaleString()}</td>
                        <td>${type}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn" onclick="viewBackupDetail('${backupId}')" style="padding:4px 8px; font-size:12px; background:#6366f1; color:white;">ÏÉÅÏÑ∏</button>
                            <button class="btn" onclick="openShareBackupModal('${backupId}')" style="padding:4px 8px; font-size:12px; background:#8b5cf6; color:white;">Í≥µÏú†</button>
                            <button class="btn" onclick="deleteBackup('${backupId}')" style="padding:4px 8px; font-size:12px; background:#ef4444; color:white;">ÏÇ≠Ï†ú</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                setModalBody(html);
            } catch(e) {
                console.error(e);
                setModalBody('<p style="text-align:center; color:#ef4444; padding:40px;">Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn" onclick="document.getElementById('backupManageBtn').click()" style="background:#0891b2; color:white;">‚Üê Î∞±ÏóÖ Í¥ÄÎ¶¨</button>
                <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };
        
        // Î∞±ÏóÖ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
        window.editBackupName = async function(backupId, currentName) {
            const newName = await showPrompt('Î∞±ÏóÖ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω', 'ÏÉà Î∞±ÏóÖ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', currentName || '');
            if (newName === null) return; // Ï∑®ÏÜå
            
            try {
                await updateDoc(doc(db, "backups", backupId), {
                    backupName: newName.trim() || null
                });
                
                // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                const nameSpan = document.getElementById(`backup-name-${backupId}`);
                if (nameSpan) {
                    nameSpan.textContent = newName.trim() || '-';
                }
                
                showAlert('Î∞±ÏóÖ Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch(e) {
                console.error(e);
                showAlert('Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        // Î∞±ÏóÖ ÏÇ≠Ï†ú
        window.deleteBackup = async function(backupId) {
            if (!await showConfirm('Î∞±ÏóÖ ÏÇ≠Ï†ú', 'Ïù¥ Î∞±ÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\\nÏÇ≠Ï†úÎêú Î∞±ÏóÖÏùÄ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')) return;
            
            try {
                await deleteDoc(doc(db, "backups", backupId));
                
                // UIÏóêÏÑú Ìñâ Ï†úÍ±∞
                const row = document.getElementById(`backup-row-${backupId}`);
                if (row) {
                    row.remove();
                }
                
                showAlert('Î∞±ÏóÖÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch(e) {
                console.error(e);
                showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        window.viewBackupDetail = async function(backupId) {
            openLargeModal('üìä Î∞±ÏóÖ ÏÉÅÏÑ∏', 'Ìï¥Îãπ ÏãúÏ†êÏùò Ï†ÑÌà¨Î†• ÌòÑÌô©');
            setModalBody('<p style="text-align:center; padding:40px;">Î°úÎî© Ï§ë...</p>');
            
            try {
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) {
                    setModalBody('<p style="text-align:center; color:#ef4444;">Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</p>');
                    return;
                }
                
                const backup = backupDoc.data();
                const time = formatDateTime(backup.createdAt);
                const users = backup.users || [];
                const guildStats = backup.guildStats || {};
                
                // Ï†ÑÏó≠ Ï†ÄÏû• (ÌïÑÌÑ∞Ïö©)
                window.backupDetailUsers = users;
                window.backupDetailGuilds = [...new Set(users.map(u => u.guild))].sort();
                
                let guildStatsHtml = '';
                Object.keys(guildStats).sort().forEach(guild => {
                    const stats = guildStats[guild];
                    // Ìï¥Îãπ Í∏∏ÎìúÏùò Ï†ÑÌà¨Î†• > 0Ïù∏ Ïú†Ï†ÄÎßå Ïπ¥Ïö¥Ìä∏
                    const guildActiveUsers = users.filter(u => u.guild === guild && u.power > 0);
                    const activeCount = guildActiveUsers.length;
                    const avgPower = activeCount > 0 ? Math.round(stats.totalPower / activeCount).toLocaleString() : '0';
                    const diffSign = stats.totalDiff >= 0 ? '+' : '';
                    const diffColor = stats.totalDiff >= 0 ? '#10b981' : '#ef4444';
                    guildStatsHtml += `<tr>
                        <td style="font-weight:600;">${guild}</td>
                        <td style="text-align:center;">${stats.count}Î™Ö</td>
                        <td style="text-align:right;">${avgPower}</td>
                        <td style="text-align:right; color:${diffColor};">${diffSign}${stats.totalDiff.toLocaleString()}</td>
                    </tr>`;
                });
                
                const totalDiff = backup.totalDiff || 0;
                const diffSign = totalDiff >= 0 ? '+' : '';
                const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                
                // Í∏∏Îìú ÏòµÏÖò ÏÉùÏÑ±
                const guildOptions = window.backupDetailGuilds.map(g => `<option value="${g}">${g}</option>`).join('');
                
                const html = `
                    <div style="margin-bottom:20px;">
                        <p style="color:#6b7280; margin:0;">Î∞±ÏóÖ ÏùºÏãú: <strong>${time}</strong> | Ïú†Ìòï: ${backup.type === 'manual' ? 'ÏàòÎèô' : 'ÏûêÎèô'}</p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:24px;">
                        <div style="background:#fef3c7; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#92400e; font-size:12px; margin:0;">Ï¥ù Ïù∏Ïõê</p>
                            <p style="color:#b45309; font-size:20px; font-weight:700; margin:4px 0 0;">${backup.totalUsers}Î™Ö</p>
                        </div>
                        <div style="background:#d1fae5; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#065f46; font-size:12px; margin:0;">Ï¥ù Ï†ÑÌà¨Î†•</p>
                            <p style="color:#047857; font-size:20px; font-weight:700; margin:4px 0 0;">${backup.totalPower.toLocaleString()}</p>
                        </div>
                        <div style="background:#e0e7ff; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#3730a3; font-size:12px; margin:0;">Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</p>
                            <p style="color:${diffColor}; font-size:20px; font-weight:700; margin:4px 0 0;">${diffSign}${totalDiff.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <h4 style="margin:0 0 12px; color:#374151;">üìä Í∏∏ÎìúÎ≥Ñ ÌòÑÌô©</h4>
                    <div style="overflow-x:auto; margin-bottom:24px;">
                        <table class="common-table">
                            <thead><tr><th>Í∏∏Îìú</th><th>Ïù∏Ïõê</th><th>ÌèâÍ∑† Ï†ÑÌà¨Î†•</th><th>Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</th></tr></thead>
                            <tbody>${guildStatsHtml}</tbody>
                        </table>
                    </div>
                    
                    <h4 style="margin:0 0 12px; color:#374151;">üë• Ï†ÑÏ≤¥ Î™ÖÎã® (<span id="backupUserCount">${users.length}</span>Î™Ö)</h4>
                    
                    <!-- ÌïÑÌÑ∞ UI -->
                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:8px;">
                        <input type="text" id="backupSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." style="flex:1; min-width:120px; padding:8px 12px; font-size:13px;">
                        <select id="backupGuildFilter" class="form-input" style="min-width:100px; padding:8px 12px; font-size:13px;">
                            <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                            ${guildOptions}
                        </select>
                        <select id="backupDiffFilter" class="form-input" style="min-width:100px; padding:8px 12px; font-size:13px;">
                            <option value="">Ï†ÑÏ≤¥ Ï¶ùÍ∞ê</option>
                            <option value="plus">üìà Ï¶ùÍ∞Ä (+)</option>
                            <option value="zero">‚û°Ô∏è Î≥ÄÎèôÏóÜÏùå (0)</option>
                            <option value="minus">üìâ Í∞êÏÜå (-)</option>
                        </select>
                        <select id="backupPowerFilter" class="form-input" style="min-width:120px; padding:8px 12px; font-size:13px;">
                            <option value="">Ï†ÑÏ≤¥ Ï†ÑÌà¨Î†•</option>
                            <option value="1500000">150Îßå Ïù¥ÏÉÅ</option>
                            <option value="1400000">140Îßå Ïù¥ÏÉÅ</option>
                            <option value="1300000">130Îßå Ïù¥ÏÉÅ</option>
                            <option value="1200000">120Îßå Ïù¥ÏÉÅ</option>
                            <option value="1100000">110Îßå Ïù¥ÏÉÅ</option>
                            <option value="1000000">100Îßå Ïù¥ÏÉÅ</option>
                            <option value="900000">90Îßå Ïù¥ÏÉÅ</option>
                            <option value="800000">80Îßå Ïù¥ÏÉÅ</option>
                            <option value="700000">70Îßå Ïù¥ÏÉÅ</option>
                            <option value="600000">60Îßå Ïù¥ÏÉÅ</option>
                            <option value="500000">50Îßå Ïù¥ÏÉÅ</option>
                            <option value="custom">‚öôÔ∏è ÏßÅÏ†ë ÏÑ§Ï†ï...</option>
                        </select>
                        <select id="backupSortFilter" class="form-input" style="min-width:120px; padding:8px 12px; font-size:13px;">
                            <option value="power_desc">Ï†ÑÌà¨Î†• ÎÜíÏùÄÏàú</option>
                            <option value="power_asc">Ï†ÑÌà¨Î†• ÎÇÆÏùÄÏàú</option>
                            <option value="diff_desc">Ï¶ùÍ∞ê ÎÜíÏùÄÏàú</option>
                            <option value="diff_asc">Ï¶ùÍ∞ê ÎÇÆÏùÄÏàú</option>
                            <option value="name_asc">Ïù¥Î¶ÑÏàú („Ñ±-„Öé)</option>
                            <option value="name_desc">Ïù¥Î¶ÑÏàú („Öé-„Ñ±)</option>
                            <option value="guild_asc">Í∏∏ÎìúÏàú</option>
                        </select>
                    </div>
                    
                    <!-- Ïª§Ïä§ÌÖÄ ÌïÑÌÑ∞ Ìå®ÎÑê (Ïà®ÍπÄ) -->
                    <div id="customPowerFilterPanel" style="display:none; padding:12px; background:#fef3c7; border-radius:8px; margin-bottom:12px;">
                        <p style="font-size:13px; color:#92400e; margin:0 0 8px; font-weight:600;">‚öôÔ∏è Ï†ÑÌà¨Î†• Î≤îÏúÑ ÏßÅÏ†ë ÏÑ§Ï†ï</p>
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <input type="number" id="customPowerMin" class="form-input" placeholder="ÏµúÏÜå (Ïòà: 1000000)" style="width:140px; padding:8px; font-size:13px;">
                            <span style="color:#6b7280;">~</span>
                            <input type="number" id="customPowerMax" class="form-input" placeholder="ÏµúÎåÄ (ÎπÑÏõåÎëêÎ©¥ Î¨¥Ï†úÌïú)" style="width:140px; padding:8px; font-size:13px;">
                            <button onclick="applyCustomPowerFilter()" class="btn btn-primary" style="padding:8px 16px; font-size:13px;">Ï†ÅÏö©</button>
                            <button onclick="resetPowerFilter()" class="btn btn-cancel" style="padding:8px 12px; font-size:13px;">Ï¥àÍ∏∞Ìôî</button>
                        </div>
                    </div>
                    
                    <div id="backupUserListContainer" style="max-height:400px; overflow-y:auto; overflow-x:auto;">
                        <table class="common-table" id="backupUserTable">
                            <thead><tr><th>ÏàúÏúÑ</th><th>ÎãâÎÑ§ÏûÑ</th><th>Í∏∏Îìú</th><th>Ï†ÑÌà¨Î†•</th><th>Ï¶ùÍ∞ê</th></tr></thead>
                            <tbody id="backupUserTableBody"></tbody>
                        </table>
                    </div>
                `;
                
                setModalBody(html);
                
                // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
                renderBackupUserList();
                
                // ÌïÑÌÑ∞ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                document.getElementById('backupSearchInput').addEventListener('input', renderBackupUserList);
                document.getElementById('backupGuildFilter').addEventListener('change', renderBackupUserList);
                document.getElementById('backupDiffFilter').addEventListener('change', renderBackupUserList);
                document.getElementById('backupPowerFilter').addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('customPowerFilterPanel').style.display = 'block';
                    } else {
                        document.getElementById('customPowerFilterPanel').style.display = 'none';
                        window.customPowerMin = null;
                        window.customPowerMax = null;
                        renderBackupUserList();
                    }
                });
                document.getElementById('backupSortFilter').addEventListener('change', renderBackupUserList);
                
            } catch(e) {
                console.error(e);
                setModalBody('<p style="text-align:center; color:#ef4444;">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn" onclick="openShareBackupModal('${backupId}')" style="background:#8b5cf6; color:white;">üîó Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±</button>
                <button class="btn" onclick="viewBackupHistory()" style="background:#6366f1; color:white;">‚Üê Î∞±ÏóÖ Í∏∞Î°ù</button>
                <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };
        
        // Ïª§Ïä§ÌÖÄ Ï†ÑÌà¨Î†• ÌïÑÌÑ∞ Ï†ÅÏö©
        window.applyCustomPowerFilter = function() {
            const min = document.getElementById('customPowerMin').value;
            const max = document.getElementById('customPowerMax').value;
            window.customPowerMin = min ? parseInt(min) : null;
            window.customPowerMax = max ? parseInt(max) : null;
            renderBackupUserList();
        };
        
        // Ï†ÑÌà¨Î†• ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
        window.resetPowerFilter = function() {
            document.getElementById('backupPowerFilter').value = '';
            document.getElementById('customPowerFilterPanel').style.display = 'none';
            document.getElementById('customPowerMin').value = '';
            document.getElementById('customPowerMax').value = '';
            window.customPowerMin = null;
            window.customPowerMax = null;
            renderBackupUserList();
        };
        
        // Î∞±ÏóÖ ÏÉÅÏÑ∏ Ïú†Ï†Ä Î™©Î°ù Î†åÎçîÎßÅ Ìï®Ïàò
        function renderBackupUserList() {
            const users = window.backupDetailUsers || [];
            const tbody = document.getElementById('backupUserTableBody');
            if (!tbody) return;
            
            const search = document.getElementById('backupSearchInput')?.value.toLowerCase() || '';
            const guildFilter = document.getElementById('backupGuildFilter')?.value || '';
            const diffFilter = document.getElementById('backupDiffFilter')?.value || '';
            const powerFilter = document.getElementById('backupPowerFilter')?.value || '';
            const sortFilter = document.getElementById('backupSortFilter')?.value || 'power_desc';
            
            // ÌïÑÌÑ∞ÎßÅ
            let filtered = users.filter(u => {
                if (search && !u.name.toLowerCase().includes(search)) return false;
                if (guildFilter && u.guild !== guildFilter) return false;
                if (diffFilter === 'plus' && u.diff <= 0) return false;
                if (diffFilter === 'zero' && u.diff !== 0) return false;
                if (diffFilter === 'minus' && u.diff >= 0) return false;
                
                // Ï†ÑÌà¨Î†• ÌïÑÌÑ∞ (ÏùºÎ∞ò ÎòêÎäî Ïª§Ïä§ÌÖÄ)
                if (powerFilter === 'custom') {
                    if (window.customPowerMin && u.power < window.customPowerMin) return false;
                    if (window.customPowerMax && u.power > window.customPowerMax) return false;
                } else if (powerFilter && u.power < parseInt(powerFilter)) {
                    return false;
                }
                return true;
            });
            
            // Ï†ïÎ†¨
            filtered.sort((a, b) => {
                switch(sortFilter) {
                    case 'power_desc': return b.power - a.power;
                    case 'power_asc': return a.power - b.power;
                    case 'diff_desc': return b.diff - a.diff;
                    case 'diff_asc': return a.diff - b.diff;
                    case 'name_asc': return a.name.localeCompare(b.name, 'ko');
                    case 'name_desc': return b.name.localeCompare(a.name, 'ko');
                    case 'guild_asc': return a.guild.localeCompare(b.guild, 'ko') || b.power - a.power;
                    default: return b.power - a.power;
                }
            });
            
            // Î†åÎçîÎßÅ
            tbody.innerHTML = '';
            filtered.forEach((u, idx) => {
                const diffSign = u.diff >= 0 ? '+' : '';
                const diffColor = u.diff > 0 ? '#10b981' : u.diff < 0 ? '#ef4444' : '#6b7280';
                const rank = sortFilter === 'power_desc' ? (idx + 1) : '-';
                const medal = sortFilter === 'power_desc' && idx === 0 ? 'ü•á' : 
                              sortFilter === 'power_desc' && idx === 1 ? 'ü•à' : 
                              sortFilter === 'power_desc' && idx === 2 ? 'ü•â' : rank;
                
                tbody.innerHTML += `<tr>
                    <td style="text-align:center;">${medal}</td>
                    <td>${u.name}</td>
                    <td style="text-align:center;">${u.guild}</td>
                    <td style="text-align:right; font-weight:600;">${u.power.toLocaleString()}</td>
                    <td style="text-align:right; color:${diffColor}; font-weight:500;">${diffSign}${u.diff.toLocaleString()}</td>
                </tr>`;
            });
            
            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const countEl = document.getElementById('backupUserCount');
            if (countEl) countEl.textContent = filtered.length;
        }
        
        // Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ± Î™®Îã¨
        window.openShareBackupModal = async function(backupId) {
            try {
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) {
                    showAlert('Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const backup = backupDoc.data();
                const backupTime = formatDateTime(backup.createdAt);
                const defaultTitle = backup.backupName || `Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô© (${backupTime})`;
                
                // Í∏∏Îìú Î™©Î°ù Ï∂îÏ∂ú
                const guilds = [...new Set((backup.users || []).map(u => u.guild))].sort();
                
                // Í∏∏ÎìúÎ≥Ñ Ï∞®Í∞ê ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
                const guildDeductInputs = guilds.map(guild => `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <span style="min-width:60px; font-weight:500; font-size:13px;">${guild}</span>
                        <input type="number" class="form-input guild-deduct-input" data-guild="${guild}" 
                               placeholder="0" style="width:100px; padding:6px 10px;" min="0">
                        <span style="font-size:12px; color:#6b7280;">Ï∞®Í∞ê</span>
                    </div>
                `).join('');
                
                const html = `
                    <div style="padding: 10px 0;">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">üìå ÌéòÏù¥ÏßÄ Ï†úÎ™©</label>
                            <input type="text" id="sharePageTitle" class="form-input" value="${defaultTitle}" placeholder="Ïòà: Ïò§Ïä§Ïπ¥2 1Ïõî 2Ï£ºÏ∞® Ï†ÑÌà¨Î†•">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">üè∑Ô∏è Ìó§Îçî Ïù¥Î¶Ñ</label>
                            <input type="text" id="shareHeaderName" class="form-input" value="üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê" placeholder="ÌéòÏù¥ÏßÄ ÏÉÅÎã®Ïóê ÌëúÏãúÎê† Ïù¥Î¶Ñ">
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">üìù Ï∂îÍ∞Ä ÏÑ§Î™Ö (ÏÑ†ÌÉù)</label>
                            <textarea id="shareDescription" class="form-input" rows="2" placeholder="Í≥µÏú† ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÌï† Ï∂îÍ∞Ä ÏÑ§Î™Ö"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">‚öîÔ∏è Í∏∏ÎìúÎ≥Ñ ÌÅ¥Îûú Î¨òÏã§ Ï∞®Í∞ê</label>
                            <p style="font-size:11px; color:#6b7280; margin:4px 0 12px;">Í∞Å Í∏∏ÎìúÏùò ÌÅ¥Îûú Î¨òÏã§ ÏàòÏπòÎ•º Ï∞®Í∞êÌïòÏó¨ ÌëúÏãúÌï©ÎãàÎã§ (Ïòà: 4400)</p>
                            <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
                                ${guildDeductInputs}
                            </div>
                        </div>
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            <p style="font-size: 12px; color: #0369a1; margin: 0;">
                                üí° ÏÉùÏÑ±Îêú ÎßÅÌÅ¨Îäî ÎàÑÍµ¨ÎÇò Î≥º Ïàò ÏûàÏúºÎ©∞, ÎßÅÌÅ¨Îßå ÏûàÏúºÎ©¥ Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                            </p>
                        </div>
                    </div>
                `;
                
                openSmallModal('üîó Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±', backupTime, html);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="generateShareLink('${backupId}')">üîó ÎßÅÌÅ¨ ÏÉùÏÑ±</button>
                `;
            } catch(e) {
                console.error(e);
                showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        // Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±
        window.generateShareLink = async function(backupId) {
            const pageTitle = document.getElementById('sharePageTitle').value.trim() || 'Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©';
            const headerName = document.getElementById('shareHeaderName').value.trim() || 'üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê';
            const description = document.getElementById('shareDescription').value.trim() || '';
            
            // Í∏∏ÎìúÎ≥Ñ Ï∞®Í∞ê Ï†ïÎ≥¥ ÏàòÏßë
            const guildDeductions = {};
            document.querySelectorAll('.guild-deduct-input').forEach(input => {
                const guild = input.dataset.guild;
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    guildDeductions[guild] = value;
                }
            });
            
            try {
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) {
                    showAlert('Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const backup = backupDoc.data();
                
                // Ï∞®Í∞ê Ï†ÅÏö©Îêú Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                const modifiedUsers = (backup.users || []).map(u => {
                    const deduction = guildDeductions[u.guild] || 0;
                    return {
                        ...u,
                        power: Math.max(0, u.power - deduction),
                        originalPower: u.power,
                        deduction: deduction
                    };
                });
                
                // Ï∞®Í∞ê Ï†ÅÏö©Îêú Í∏∏Îìú ÌÜµÍ≥Ñ Ïû¨Í≥ÑÏÇ∞
                const modifiedGuildStats = {};
                modifiedUsers.forEach(u => {
                    if (!modifiedGuildStats[u.guild]) {
                        modifiedGuildStats[u.guild] = { count: 0, totalPower: 0, totalDiff: 0, activeCount: 0 };
                    }
                    modifiedGuildStats[u.guild].count++;
                    if (u.power > 0) {
                        modifiedGuildStats[u.guild].activeCount++;
                        modifiedGuildStats[u.guild].totalPower += u.power;
                    }
                    modifiedGuildStats[u.guild].totalDiff += u.diff;
                });
                
                // ÏàòÏ†ïÎêú Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞
                const modifiedBackup = {
                    ...backup,
                    users: modifiedUsers,
                    guildStats: modifiedGuildStats,
                    totalPower: modifiedUsers.reduce((sum, u) => sum + u.power, 0)
                };
                
                // Í≥µÏú† Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                const shareId = `share_${Date.now()}`;
                await setDoc(doc(db, "sharedBackups", shareId), {
                    backupId: backupId,
                    pageTitle: pageTitle,
                    headerName: headerName,
                    description: description,
                    createdAt: Date.now(),
                    createdBy: 'ÏóêÎπÑÏ∏Ñ',
                    guildDeductions: guildDeductions,
                    backupData: modifiedBackup
                });
                
                // Í≥µÏú† URL ÏÉùÏÑ± (ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∏∞Ï§Ä)
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                
                const html = `
                    <div style="padding: 10px 0; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="font-size: 16px; font-weight: 600; color: #10b981; margin-bottom: 20px;">Í≥µÏú† ÎßÅÌÅ¨Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</p>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; word-break: break-all;">
                            <input type="text" id="shareUrlInput" value="${shareUrl}" readonly 
                                   style="width: 100%; border: none; background: transparent; text-align: center; font-size: 13px; color: #374151;">
                        </div>
                        <button onclick="copyShareUrl()" class="btn btn-primary" style="width: 100%;">üìã ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
                    </div>
                `;
                
                openSmallModal('üîó Í≥µÏú† ÎßÅÌÅ¨', '', html);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
                `;
                
            } catch(e) {
                console.error(e);
                showAlert('ÎßÅÌÅ¨ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        // Í≥µÏú† URL Î≥µÏÇ¨
        window.copyShareUrl = function() {
            const input = document.getElementById('shareUrlInput');
            input.select();
            document.execCommand('copy');
            showAlert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
        };
        
        async function checkAutoBackup() {
            if (!isAdmin) return;
            
            const now = new Date();
            const kstNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const dayOfWeek = kstNow.getDay();
            const hour = kstNow.getHours();
            
            if (dayOfWeek === 6 && hour >= 21) {
                const todayStart = new Date(kstNow);
                todayStart.setHours(21, 0, 0, 0);
                const todayStartTimestamp = todayStart.getTime();
                
                try {
                    const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                    
                    let needBackup = true;
                    if (!backupsSnap.empty) {
                        const lastBackup = backupsSnap.docs[0].data();
                        if (lastBackup.createdAt >= todayStartTimestamp) {
                            needBackup = false;
                        }
                    }
                    
                    if (needBackup) {
                        console.log('ÏûêÎèô Î∞±ÏóÖ Ïã§Ìñâ...');
                        await performAutoBackup();
                    }
                } catch(e) {
                    console.error('ÏûêÎèô Î∞±ÏóÖ Ï≤¥ÌÅ¨ Ïò§Î•ò:', e);
                }
            }
        }
        
        async function performAutoBackup() {
            const now = Date.now();
            
            let lastBackupData = {};
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                if (!backupsSnap.empty) {
                    const lastBackup = backupsSnap.docs[0].data();
                    if (lastBackup.users) {
                        lastBackup.users.forEach(u => {
                            lastBackupData[u.name] = u.power;
                        });
                    }
                }
            } catch(e) { console.error(e); }
            
            const backupUsers = allGuildData.map(u => ({
                name: u.name,
                guild: u.guild,
                power: u.power,
                prevPower: lastBackupData[u.name] || u.power,
                diff: u.power - (lastBackupData[u.name] || u.power),
                shape_legend: u.shape_legend || 0,
                shape_myth: u.shape_myth || 0,
                mount_legend: u.mount_legend || 0,
                mount_myth: u.mount_myth || 0
            })).sort((a, b) => b.power - a.power);
            
            const guildStats = {};
            backupUsers.forEach(u => {
                if (!guildStats[u.guild]) {
                    guildStats[u.guild] = { count: 0, totalPower: 0, totalDiff: 0, activeCount: 0 };
                }
                guildStats[u.guild].count++;
                if (u.power > 0) {
                    guildStats[u.guild].activeCount++;
                    guildStats[u.guild].totalPower += u.power;
                }
                guildStats[u.guild].totalDiff += u.diff;
            });
            
            const totalPower = backupUsers.reduce((sum, u) => sum + u.power, 0);
            const totalDiff = backupUsers.reduce((sum, u) => sum + u.diff, 0);
            
            const backupId = `backup_${now}`;
            try {
                await setDoc(doc(db, "backups", backupId), {
                    users: backupUsers,
                    guildStats: guildStats,
                    totalUsers: backupUsers.length,
                    totalPower: totalPower,
                    totalDiff: totalDiff,
                    createdAt: now,
                    createdBy: 'auto',
                    type: 'auto'
                });
                console.log('ÏûêÎèô Î∞±ÏóÖ ÏôÑÎ£å!');
                
                // Í≤åÏãúÌåêÏóê ÏûêÎèô Îì±Î°ù
                await createBackupPost(backupId, now, backupUsers.length, totalPower, totalDiff);
                
            } catch(e) {
                console.error('ÏûêÎèô Î∞±ÏóÖ Ïã§Ìå®:', e);
            }
        }
        
        // Î∞±ÏóÖ Í≤åÏãúÍ∏Ä ÏûêÎèô ÏÉùÏÑ±
        async function createBackupPost(backupId, createdAt, totalUsers, totalPower, totalDiff) {
            try {
                const date = new Date(createdAt);
                const dateStr = `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
                const weekNum = Math.ceil(date.getDate() / 7);
                const monthName = `${date.getMonth() + 1}Ïõî ${weekNum}Ï£ºÏ∞®`;
                
                const diffSign = totalDiff >= 0 ? '+' : '';
                const diffColor = totalDiff >= 0 ? 'ÏÉÅÏäπ' : 'ÌïòÎùΩ';
                
                // Í≥µÏú† ÎßÅÌÅ¨ ÏÉùÏÑ±
                const shareId = `share_${Date.now()}`;
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (backupDoc.exists()) {
                    await setDoc(doc(db, "sharedBackups", shareId), {
                        backupId: backupId,
                        pageTitle: `üèÜ Ïò§Ïä§Ïπ¥2 ${monthName} Ï†ÑÌà¨Î†• ÌòÑÌô©`,
                        headerName: 'üèÜ Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê',
                        description: `${dateStr} Ï£ºÍ∞Ñ Î∞±ÏóÖ`,
                        createdAt: Date.now(),
                        createdBy: 'ÏóêÎπÑÏ∏Ñ',
                        guildDeductions: {},
                        backupData: backupDoc.data()
                    });
                }
                
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
                
                const postId = `post_backup_${createdAt}`;
                await setDoc(doc(db, "posts", postId), {
                    category: 'backup',
                    title: `üìä ${monthName} Ï£ºÍ∞Ñ Ï†ÑÌà¨Î†• ÌòÑÌô©`,
                    content: `${dateStr} Í∏∞Ï§Ä Ï£ºÍ∞Ñ Ï†ÑÌà¨Î†• ÌòÑÌô©ÏûÖÎãàÎã§.\n\nüìå Ï¥ù Ïù∏Ïõê: ${totalUsers}Î™Ö\nüí™ Ï¥ù Ï†ÑÌà¨Î†•: ${totalPower.toLocaleString()}\nüìà Ï£ºÍ∞Ñ Ï¶ùÍ∞ê: ${diffSign}${totalDiff.toLocaleString()} (${diffColor})\n\nÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨ ÏÉÅÏÑ∏ ÌòÑÌô©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî!`,
                    author: 'ÏóêÎπÑÏ∏Ñ',
                    views: 0,
                    createdAt: createdAt,
                    link: shareUrl,
                    linkText: 'üìä Ï†ÑÌà¨Î†• ÌòÑÌô© Î≥¥Í∏∞'
                });
                
                console.log('Î∞±ÏóÖ Í≤åÏãúÍ∏Ä ÏûêÎèô ÏÉùÏÑ± ÏôÑÎ£å!');
            } catch(e) {
                console.error('Î∞±ÏóÖ Í≤åÏãúÍ∏Ä ÏÉùÏÑ± Ïò§Î•ò:', e);
            }
        }
        
        setTimeout(checkAutoBackup, 3000);

        // Ï†ëÏÜç ÌÜµÍ≥Ñ Í∏∞Îä•
        document.getElementById('statsViewBtn').addEventListener('click', async () => {
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }
            
            openLargeModal('üìä Ï†ëÏÜç ÌÜµÍ≥Ñ', 'ÎãâÎÑ§ÏûÑÎ≥Ñ ÏúÑÏπò, Í∏∞Í∏∞, Î∏åÎùºÏö∞Ï†Ä ÌÜµÍ≥Ñ');
            setModalBody('<p style="text-align:center; padding:40px;">üìä ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...</p>');
            
            try {
                // Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const logsSnap = await getDocs(query(collection(db, "logs"), orderBy("createdAt", "desc")));
                
                // Ïú†Ï†ÄÎ≥Ñ ÌÜµÍ≥Ñ ÏàòÏßë
                const userStats = {};
                
                logsSnap.forEach(d => {
                    const l = d.data();
                    const who = l.who;
                    if (!who || who === '-' || who === 'Admin') return;
                    
                    // Ïó¨Îü¨ Î™ÖÏù¥ Ìè¨Ìï®Îêú Í≤ΩÏö∞ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ) - Ïä§ÌÇµ
                    if (who.includes(',') || who.includes('Ïô∏')) return;
                    
                    // Í∏∞Í∏∞ Ï†ïÎ≥¥ ÌååÏã±
                    let deviceRaw = l.device || '';
                    if (deviceRaw.length > 30 || deviceRaw.includes('Mozilla')) {
                        deviceRaw = parseUserAgent(deviceRaw);
                    }
                    
                    // ÏúÑÏπò Ï†ïÎ≥¥ ÌïúÍ∏Ä Î≥ÄÌôò
                    let locationRaw = translateLocation(l.location || '');
                    
                    if (!userStats[who]) {
                        userStats[who] = {
                            locations: new Set(),
                            devices: new Set(),
                            browsers: new Set(),
                            manufacturers: new Set(),
                            lastAccess: l.createdAt,
                            accessCount: 0
                        };
                    }
                    
                    // ÏúÑÏπò Ï∂îÍ∞Ä
                    if (locationRaw && locationRaw !== '-') {
                        userStats[who].locations.add(locationRaw);
                    }
                    
                    // Í∏∞Í∏∞ Î∞è Î∏åÎùºÏö∞Ï†Ä ÌååÏã±
                    if (deviceRaw && deviceRaw !== '-' && deviceRaw !== 'Ïïå Ïàò ÏóÜÏùå') {
                        const parts = deviceRaw.split('-');
                        const device = parts[0] || '';
                        const browser = parts[1] || '';
                        
                        if (device) {
                            userStats[who].devices.add(device);
                            
                            // Ï†úÏ°∞ÏÇ¨ Î∂ÑÎ•ò
                            if (device.includes('ÏïÑÏù¥Ìè∞') || device.includes('ÏïÑÏù¥Ìå®Îìú') || device.includes('Îß•')) {
                                userStats[who].manufacturers.add('Ïï†Ìîå');
                            } else if (device.includes('Í∞§Îü≠Ïãú') || device.includes('ÏÇºÏÑ±')) {
                                userStats[who].manufacturers.add('ÏÇºÏÑ±');
                            } else if (device === 'PC') {
                                userStats[who].manufacturers.add('PC');
                            } else if (device.includes('ÏïàÎìúÎ°úÏù¥Îìú')) {
                                userStats[who].manufacturers.add('Í∏∞ÌÉÄÏïàÎìúÎ°úÏù¥Îìú');
                            }
                        }
                        
                        if (browser) {
                            userStats[who].browsers.add(browser);
                        }
                    }
                    
                    userStats[who].accessCount++;
                    if (l.createdAt > userStats[who].lastAccess) {
                        userStats[who].lastAccess = l.createdAt;
                    }
                });
                
                // Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                const statsArray = Object.entries(userStats).map(([name, stats]) => ({
                    name,
                    locations: Array.from(stats.locations),
                    devices: Array.from(stats.devices),
                    browsers: Array.from(stats.browsers),
                    manufacturers: Array.from(stats.manufacturers),
                    lastAccess: formatDateTime(stats.lastAccess),
                    accessCount: stats.accessCount
                }));
                
                // Ï†ÑÏó≠ Ï†ÄÏû•
                window.allUserStats = statsArray;
                
                // ÌÜµÍ≥Ñ ÏöîÏïΩ
                const totalUsers = statsArray.length;
                const samsungUsers = statsArray.filter(s => s.manufacturers.includes('ÏÇºÏÑ±')).length;
                const appleUsers = statsArray.filter(s => s.manufacturers.includes('Ïï†Ìîå')).length;
                const pcUsers = statsArray.filter(s => s.manufacturers.includes('PC')).length;
                
                // Î∏åÎùºÏö∞Ï†ÄÎ≥Ñ ÏÇ¨Ïö©Ïûê Ïàò
                const browserCounts = {};
                statsArray.forEach(s => {
                    s.browsers.forEach(b => {
                        browserCounts[b] = (browserCounts[b] || 0) + 1;
                    });
                });
                
                // ÏßÄÏó≠Î≥Ñ ÏÇ¨Ïö©Ïûê Ïàò
                const locationCounts = {};
                statsArray.forEach(s => {
                    s.locations.forEach(loc => {
                        // Ïãú/ÎèÑ Îã®ÏúÑÎ°ú Ï∂îÏ∂ú
                        const parts = loc.split(' ');
                        let region = parts.length >= 2 ? parts[1] : parts[0];
                        if (region) {
                            locationCounts[region] = (locationCounts[region] || 0) + 1;
                        }
                    });
                });
                
                // Í∏∞Í∏∞Î≥Ñ ÏÇ¨Ïö©Ïûê Ïàò
                const deviceCounts = {};
                statsArray.forEach(s => {
                    s.devices.forEach(dev => {
                        deviceCounts[dev] = (deviceCounts[dev] || 0) + 1;
                    });
                });
                
                // Ï†ïÎ†¨Îêú ÌÜµÍ≥Ñ
                const sortedBrowsers = Object.entries(browserCounts).sort((a,b) => b[1] - a[1]);
                const sortedLocations = Object.entries(locationCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                const sortedDevices = Object.entries(deviceCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                
                const html = `
                    <div style="margin-bottom:20px;">
                        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:12px; margin-bottom:20px;">
                            <div style="background:#f0f9ff; padding:16px; border-radius:12px; text-align:center;">
                                <p style="color:#0891b2; font-size:24px; font-weight:700; margin:0;">${totalUsers}</p>
                                <p style="color:#0e7490; font-size:12px; margin:4px 0 0;">Ï†ÑÏ≤¥ Ïú†Ï†Ä</p>
                            </div>
                            <div style="background:#fef3c7; padding:16px; border-radius:12px; text-align:center;">
                                <p style="color:#d97706; font-size:24px; font-weight:700; margin:0;">${samsungUsers}</p>
                                <p style="color:#92400e; font-size:12px; margin:4px 0 0;">üì± ÏÇºÏÑ±</p>
                            </div>
                            <div style="background:#f3e8ff; padding:16px; border-radius:12px; text-align:center;">
                                <p style="color:#7c3aed; font-size:24px; font-weight:700; margin:0;">${appleUsers}</p>
                                <p style="color:#5b21b6; font-size:12px; margin:4px 0 0;">üçé Ïï†Ìîå</p>
                            </div>
                            <div style="background:#ecfdf5; padding:16px; border-radius:12px; text-align:center;">
                                <p style="color:#059669; font-size:24px; font-weight:700; margin:0;">${pcUsers}</p>
                                <p style="color:#047857; font-size:12px; margin:4px 0 0;">üíª PC</p>
                            </div>
                        </div>
                        
                        <!-- ÌÜµÍ≥Ñ Í∑∏Î¶¨Îìú -->
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px;">
                            <div style="background:#f9fafb; padding:12px; border-radius:8px;">
                                <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üåê Î∏åÎùºÏö∞Ï†Ä ÌÜµÍ≥Ñ</p>
                                ${sortedBrowsers.map(([b, c]) => `<div style="display:flex; justify-content:space-between; font-size:12px; padding:4px 0;"><span>${b}</span><span style="color:#6b7280;">${c}Î™Ö</span></div>`).join('')}
                            </div>
                            <div style="background:#f9fafb; padding:12px; border-radius:8px;">
                                <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üìç ÏßÄÏó≠ ÌÜµÍ≥Ñ (Top 10)</p>
                                ${sortedLocations.map(([l, c]) => `<div style="display:flex; justify-content:space-between; font-size:12px; padding:4px 0;"><span>${l}</span><span style="color:#6b7280;">${c}Î™Ö</span></div>`).join('')}
                            </div>
                            <div style="background:#f9fafb; padding:12px; border-radius:8px;">
                                <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üì± Í∏∞Í∏∞ ÌÜµÍ≥Ñ (Top 10)</p>
                                ${sortedDevices.map(([d, c]) => `<div style="display:flex; justify-content:space-between; font-size:12px; padding:4px 0;"><span>${d}</span><span style="color:#6b7280;">${c}Î™Ö</span></div>`).join('')}
                            </div>
                        </div>
                        
                        <!-- Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ -->
                        <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                            <p style="font-weight:600; font-size:14px; margin:0 0 12px; color:#374151;">üîç Ïú†Ï†ÄÎ≥Ñ ÏÉÅÏÑ∏ Í≤ÄÏÉâ</p>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                                <input type="text" id="statsSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ, ÏßÄÏó≠, Í∏∞Í∏∞ Í≤ÄÏÉâ..." style="flex:2; min-width:150px;">
                                <select id="statsManufFilter" class="form-input" style="flex:1; min-width:100px;">
                                    <option value="">Ï†ÑÏ≤¥ Ï†úÏ°∞ÏÇ¨</option>
                                    <option value="ÏÇºÏÑ±">üì± ÏÇºÏÑ±</option>
                                    <option value="Ïï†Ìîå">üçé Ïï†Ìîå</option>
                                    <option value="PC">üíª PC</option>
                                </select>
                                <select id="statsBrowserFilter" class="form-input" style="flex:1; min-width:100px;">
                                    <option value="">Ï†ÑÏ≤¥ Î∏åÎùºÏö∞Ï†Ä</option>
                                    ${sortedBrowsers.map(([b]) => `<option value="${b}">${b}</option>`).join('')}
                                </select>
                            </div>
                            <p style="font-size:12px; color:#6b7280; margin-bottom:8px;">Í≤ÄÏÉâ Í≤∞Í≥º: <span id="statsResultCount">${statsArray.length}</span>Î™Ö</p>
                            <div class="table-scroll-container" style="max-height:300px;">
                                <table class="common-table" id="statsTable" style="font-size:12px;">
                                    <thead>
                                        <tr>
                                            <th style="width:15%;">ÎãâÎÑ§ÏûÑ</th>
                                            <th style="width:25%;">ÏúÑÏπò</th>
                                            <th style="width:12%;">Ï†úÏ°∞ÏÇ¨</th>
                                            <th style="width:20%;">Í∏∞Í∏∞</th>
                                            <th style="width:15%;">Î∏åÎùºÏö∞Ï†Ä</th>
                                            <th style="width:13%;">Ï†ëÏÜçÏàò</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                setModalBody(html);
                document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>';
                
                // ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ Î†åÎçîÎßÅ Ìï®Ïàò
                function renderStatsTable(data) {
                    const tbody = document.getElementById('statsTableBody');
                    tbody.innerHTML = data.map(s => {
                        const locDisplay = s.locations.slice(0, 2).join(', ') + (s.locations.length > 2 ? ` Ïô∏ ${s.locations.length - 2}` : '');
                        const devDisplay = s.devices.slice(0, 2).join(', ') + (s.devices.length > 2 ? ` Ïô∏ ${s.devices.length - 2}` : '');
                        const browDisplay = s.browsers.join(', ');
                        const manufDisplay = s.manufacturers.join('/');
                        
                        return `<tr style="cursor:pointer;" onclick="showUserStatsDetail('${s.name}')">
                            <td><strong>${s.name}</strong></td>
                            <td style="font-size:11px;" title="${s.locations.join(', ')}">${locDisplay || '-'}</td>
                            <td>${manufDisplay || '-'}</td>
                            <td style="font-size:11px;" title="${s.devices.join(', ')}">${devDisplay || '-'}</td>
                            <td>${browDisplay || '-'}</td>
                            <td style="text-align:center;">${s.accessCount}</td>
                        </tr>`;
                    }).join('');
                    
                    document.getElementById('statsResultCount').textContent = data.length;
                }
                
                // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
                renderStatsTable(statsArray);
                
                // ÌïÑÌÑ∞ Ìï®Ïàò
                function applyStatsFilters() {
                    const searchText = document.getElementById('statsSearchInput').value.toLowerCase();
                    const manufFilter = document.getElementById('statsManufFilter').value;
                    const browserFilter = document.getElementById('statsBrowserFilter').value;
                    
                    const filtered = window.allUserStats.filter(s => {
                        // Í≤ÄÏÉâÏñ¥ Ï≤¥ÌÅ¨ (ÎãâÎÑ§ÏûÑ, ÏúÑÏπò, Í∏∞Í∏∞)
                        const matchSearch = !searchText || 
                            s.name.toLowerCase().includes(searchText) ||
                            s.locations.some(l => l.toLowerCase().includes(searchText)) ||
                            s.devices.some(d => d.toLowerCase().includes(searchText));
                        
                        // Ï†úÏ°∞ÏÇ¨ Ï≤¥ÌÅ¨
                        const matchManuf = !manufFilter || s.manufacturers.includes(manufFilter);
                        
                        // Î∏åÎùºÏö∞Ï†Ä Ï≤¥ÌÅ¨
                        const matchBrowser = !browserFilter || s.browsers.includes(browserFilter);
                        
                        return matchSearch && matchManuf && matchBrowser;
                    });
                    
                    renderStatsTable(filtered);
                }
                
                document.getElementById('statsSearchInput').addEventListener('input', applyStatsFilters);
                document.getElementById('statsManufFilter').addEventListener('change', applyStatsFilters);
                document.getElementById('statsBrowserFilter').addEventListener('change', applyStatsFilters);
                
            } catch(e) {
                console.error('ÌÜµÍ≥Ñ Î°úÎìú Ïã§Ìå®:', e);
                setModalBody('<p style="color:#ef4444; text-align:center; padding:40px;">ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
        });
        
        // Ïú†Ï†Ä ÌÜµÍ≥Ñ ÏÉÅÏÑ∏Î≥¥Í∏∞
        window.showUserStatsDetail = function(userName) {
            const stats = window.allUserStats.find(s => s.name === userName);
            if (!stats) return;
            
            const html = `
                <div style="padding:10px 0;">
                    <div style="margin-bottom:16px; padding:12px; background:#f9fafb; border-radius:8px;">
                        <p style="margin:0 0 4px; font-size:13px;"><strong>ÎãâÎÑ§ÏûÑ:</strong> ${stats.name}</p>
                        <p style="margin:0 0 4px; font-size:13px;"><strong>Ï¥ù Ï†ëÏÜç:</strong> ${stats.accessCount}Ìöå</p>
                        <p style="margin:0; font-size:13px;"><strong>ÎßàÏßÄÎßâ Ï†ëÏÜç:</strong> ${stats.lastAccess}</p>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üìç Ï†ëÏÜç ÏúÑÏπò</p>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            ${stats.locations.length > 0 ? stats.locations.map(l => 
                                `<span style="padding:4px 10px; background:#e0f2fe; color:#0369a1; border-radius:16px; font-size:12px;">${l}</span>`
                            ).join('') : '<span style="color:#9ca3af;">Í∏∞Î°ù ÏóÜÏùå</span>'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üì± ÏÇ¨Ïö© Í∏∞Í∏∞</p>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            ${stats.devices.length > 0 ? stats.devices.map(d => 
                                `<span style="padding:4px 10px; background:#fef3c7; color:#92400e; border-radius:16px; font-size:12px;">${d}</span>`
                            ).join('') : '<span style="color:#9ca3af;">Í∏∞Î°ù ÏóÜÏùå</span>'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üåê ÏÇ¨Ïö© Î∏åÎùºÏö∞Ï†Ä</p>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            ${stats.browsers.length > 0 ? stats.browsers.map(b => 
                                `<span style="padding:4px 10px; background:#f3e8ff; color:#7c3aed; border-radius:16px; font-size:12px;">${b}</span>`
                            ).join('') : '<span style="color:#9ca3af;">Í∏∞Î°ù ÏóÜÏùå</span>'}
                        </div>
                    </div>
                    
                    <div>
                        <p style="font-weight:600; font-size:13px; margin:0 0 8px; color:#374151;">üè≠ Ï†úÏ°∞ÏÇ¨</p>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            ${stats.manufacturers.length > 0 ? stats.manufacturers.map(m => {
                                let bg = '#f3f4f6', color = '#374151';
                                if (m === 'ÏÇºÏÑ±') { bg = '#fef3c7'; color = '#92400e'; }
                                else if (m === 'Ïï†Ìîå') { bg = '#f3e8ff'; color = '#7c3aed'; }
                                else if (m === 'PC') { bg = '#ecfdf5'; color = '#047857'; }
                                return `<span style="padding:4px 10px; background:${bg}; color:${color}; border-radius:16px; font-size:12px;">${m}</span>`;
                            }).join('') : '<span style="color:#9ca3af;">Í∏∞Î°ù ÏóÜÏùå</span>'}
                        </div>
                    </div>
                </div>
            `;
            
            openSmallModal('üìä Ïú†Ï†Ä ÌÜµÍ≥Ñ ÏÉÅÏÑ∏', stats.name, html);
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>';
        };

               document.getElementById('adminManageBtn').addEventListener('click', async () => {
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }

            openLargeModal('Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨', 'ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏùÑ Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò ÏÇ≠Ï†úÌï©ÎãàÎã§');
            
            // Í¥ÄÎ¶¨Ïûê Î™©Î°ù Î°úÎìú
            const adminSnapshot = await getDocs(collection(db, "admins"));
            
            // Ï†ÑÏó≠ Ï†ÄÏû•
            window.adminsList = [];
            adminSnapshot.forEach(docSnap => {
                window.adminsList.push({
                    id: docSnap.id,
                    ...docSnap.data()
                });
            });
            
            let adminListHtml = '';
            if (adminSnapshot.empty) {
                adminListHtml = '<p style="text-align:center; color:#9ca3af; padding:20px;">Îì±Î°ùÎêú ÏùºÎ∞ò Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
            } else {
                adminListHtml = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th style="width:30%;">ÏïÑÏù¥Îîî</th><th style="width:35%;">ÏÉùÏÑ±Ïùº</th><th style="width:35%;">Í¥ÄÎ¶¨</th></tr></thead><tbody>';
                adminSnapshot.forEach(docSnap => {
                    const admin = docSnap.data();
                    const createdAt = admin.createdAt ? formatDateTime(admin.createdAt) : '-';
                    adminListHtml += `<tr>
                        <td style="cursor:pointer;" onclick="showAdminDetail('${docSnap.id}')"><strong style="color:#3b82f6; text-decoration:underline;">${docSnap.id}</strong></td>
                        <td style="font-size:12px;">${createdAt}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn btn-primary" onclick="window.resetAdminPw('${docSnap.id}')" style="padding:6px 10px; font-size:12px; margin-right:4px;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî</button>
                            <button class="btn btn-danger" onclick="window.deleteAdmin('${docSnap.id}')" style="padding:6px 10px; font-size:12px;">ÏÇ≠Ï†ú</button>
                        </td>
                    </tr>`;
                });
                adminListHtml += '</tbody></table></div>';
            }

            const html = `
                <div style="margin-bottom:20px; padding:15px; background:#f0fdf4; border-radius:8px; border-left:4px solid #22c55e;">
                    <p style="font-size:13px; color:#166534;"><strong>üëë ÏµúÏ¢Ö Í¥ÄÎ¶¨Ïûê:</strong> tjdals9328 (Î≥ÄÍ≤Ω Î∂àÍ∞Ä)</p>
                </div>
                
                <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">üìã ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê Î™©Î°ù</h4>
                <p style="font-size:11px; color:#6b7280; margin-bottom:8px;">ÏïÑÏù¥ÎîîÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ Ï†ëÏÜç Î°úÍ∑∏Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§</p>
                ${adminListHtml}
                
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                    <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">‚ûï ÏÉà Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <input type="text" id="newAdminId" class="form-input" placeholder="ÏïÑÏù¥Îîî" style="flex:1 1 150px; min-width:120px; max-width:250px;">
                        <input type="password" id="newAdminPw" class="form-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" style="flex:1 1 150px; min-width:120px; max-width:250px;">
                        <button class="btn btn-primary" onclick="window.addNewAdmin()" style="white-space:nowrap;">Ï∂îÍ∞Ä</button>
                    </div>
                    <p style="font-size:11px; color:#9ca3af; margin-top:8px;">‚Äª ÏùºÎ∞ò Í¥ÄÎ¶¨ÏûêÎäî Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§</p>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html + `<div style="text-align:right;margin-top:20px"><button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button></div>`;
        });
        
        // Í¥ÄÎ¶¨Ïûê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ + Ï†ëÏÜç Î°úÍ∑∏
        window.showAdminDetail = async function(adminId) {
            openSmallModal('üëë Í¥ÄÎ¶¨Ïûê ÏÉÅÏÑ∏', adminId, '<p style="text-align:center; padding:20px;">Î°úÎî© Ï§ë...</p>');
            
            // Í¥ÄÎ¶¨Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const adminDoc = await getDoc(doc(db, "admins", adminId));
            const adminData = adminDoc.exists() ? adminDoc.data() : {};
            const createdAt = adminData.createdAt ? formatDateTime(adminData.createdAt) : '-';
            
            // Ï†ëÏÜç Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞
            const logsSnap = await getDocs(query(
                collection(db, "adminLogs"),
                orderBy("loginAt", "desc")
            ));
            
            const logs = [];
            logsSnap.forEach(d => {
                const l = d.data();
                if (l.adminId === adminId) {
                    // Í∏∞Í∏∞ Ï†ïÎ≥¥: Í∏¥ User AgentÎ©¥ Î≥ÄÌôò
                    let deviceDisplay = l.device || '-';
                    if (deviceDisplay.length > 30 || deviceDisplay.includes('Mozilla')) {
                        deviceDisplay = parseUserAgent(deviceDisplay);
                    }
                    
                    // ÏúÑÏπò Ï†ïÎ≥¥: ÏòÅÏñ¥Î©¥ ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò
                    let locationDisplay = translateLocation(l.location || '-');
                    
                    logs.push({
                        time: formatDateTime(l.loginAt),
                        ip: l.ip || '-',
                        device: deviceDisplay,
                        location: locationDisplay,
                        type: l.loginType || 'ÏàòÎèô'
                    });
                }
            });
            
            let logsHtml = '';
            if (logs.length === 0) {
                logsHtml = '<p style="text-align:center; color:#9ca3af; padding:15px;">Ï†ëÏÜç Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>';
            } else {
                logsHtml = `
                    <div style="max-height:200px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px;">
                        <table style="width:100%; border-collapse:collapse; font-size:12px;">
                            <thead>
                                <tr style="background:#f9fafb;">
                                    <th style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;">ÏãúÍ∞Ñ</th>
                                    <th style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;">IP</th>
                                    <th style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;">Í∏∞Í∏∞</th>
                                    <th style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;">ÏúÑÏπò</th>
                                    <th style="padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;">Ïú†Ìòï</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                logs.slice(0, 50).forEach(l => {  // ÏµúÍ∑º 50Í±¥Îßå
                    const typeColor = l.type === 'ÏûêÎèô' ? '#10b981' : '#3b82f6';
                    logsHtml += `<tr>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6;">${l.time}</td>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6;">${l.ip}</td>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6;">${l.device}</td>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6;">${l.location}</td>
                        <td style="padding:8px; border-bottom:1px solid #f3f4f6;"><span style="color:${typeColor};">${l.type}</span></td>
                    </tr>`;
                });
                logsHtml += '</tbody></table></div>';
            }
            
            const html = `
                <div style="padding: 10px 0;">
                    <div style="margin-bottom:16px; padding:12px; background:#f9fafb; border-radius:8px;">
                        <p style="margin:0 0 8px;"><strong>ÏïÑÏù¥Îîî:</strong> ${adminId}</p>
                        <p style="margin:0; font-size:13px; color:#6b7280;"><strong>ÏÉùÏÑ±Ïùº:</strong> ${createdAt}</p>
                    </div>
                    
                    <h4 style="font-size:13px; font-weight:600; margin-bottom:8px; color:#374151;">üìä Ï†ëÏÜç Î°úÍ∑∏ (ÏµúÍ∑º 50Í±¥)</h4>
                    ${logsHtml}
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };

               window.addNewAdmin = async function() {
            const adminId = document.getElementById('newAdminId').value.trim();
            const adminPw = document.getElementById('newAdminPw').value;

            if (!adminId || !adminPw) {
                showAlert('ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

            if (adminPw.length < 4) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                return;
            }

                       const existingAdmin = await getDoc(doc(db, "admins", adminId));
            if (existingAdmin.exists()) {
                showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏïÑÏù¥ÎîîÏûÖÎãàÎã§', 'error');
                return;
            }

            try {
                await setDoc(doc(db, "admins", adminId), {
                    password: adminPw,
                    createdAt: Date.now(),
                    createdBy: 'superadmin'
                });

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_add',
                    old_value: '-',
                    new_value: `Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä: ${adminId}`,
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`Í¥ÄÎ¶¨Ïûê [${adminId}]Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                               setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };


        window.deleteAdmin = async function(adminId) {
            if (!await showConfirm('Í¥ÄÎ¶¨Ïûê ÏÇ≠Ï†ú', `[${adminId}] Í¥ÄÎ¶¨ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            try {
                await deleteDoc(doc(db, "admins", adminId));

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_delete',
                    old_value: adminId,
                    new_value: 'ÏÇ≠Ï†úÎê®',
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`Í¥ÄÎ¶¨Ïûê [${adminId}]Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };


        window.resetAdminPw = async function(adminId) {
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî', `[${adminId}] Í¥ÄÎ¶¨Ïûê`, `
                <div class="form-group">
                    <label class="form-label">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="resetPwInput" class="form-input" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•">
                </div>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const newPw = document.getElementById('resetPwInput').value;
                
                if (!newPw || newPw.length < 4) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                    return;
                }

                try {
                    await updateDoc(doc(db, "admins", adminId), {
                        password: newPw,
                        updatedAt: Date.now()
                    });

                    await setDoc(doc(collection(db, "logs")), {
                        who: 'SuperAdmin',
                        type: 'admin_pw_reset',
                        old_value: adminId,
                        new_value: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî',
                        createdAt: Date.now(),
                        ip: await getIp()
                    });

                    showAlert(`[${adminId}] ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§`, 'success');
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                }
            };
        };

        // Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Î™®Îã¨ (ÏµúÏ¢ÖÍ¥ÄÎ¶¨Ïûê Ï†ÑÏö©)
        document.getElementById('versionInfoBtn').addEventListener('click', () => {
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }
            
            let changelogHtml = '';
            APP_CHANGELOG.forEach(release => {
                changelogHtml += `
                    <div style="margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 700; font-size: 16px; color: #1f2937;">v${release.version}</span>
                            <span style="font-size: 12px; color: #6b7280; background: #e5e7eb; padding: 4px 8px; border-radius: 4px;">${release.date}</span>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.8;">
                            ${release.changes.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            const html = `
                <div style="text-align: center; padding: 20px 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üèÜ</div>
                    <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">Ïò§Ïä§Ïπ¥2 Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê</h2>
                    <div style="display: flex; justify-content: center; gap: 16px; margin-top: 12px;">
                        <span style="background: #dbeafe; color: #1d4ed8; padding: 6px 12px; border-radius: 6px; font-weight: 600;">v${APP_VERSION}</span>
                        <span style="background: #f3f4f6; color: #6b7280; padding: 6px 12px; border-radius: 6px;">ÎπåÎìú: ${APP_BUILD_DATE}</span>
                    </div>
                </div>
                
                <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 16px;">üìã Î≥ÄÍ≤Ω ÎÇ¥Ïó≠</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${changelogHtml}
                </div>
                
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb; text-align: center;">
                    <p style="font-size: 12px; color: #9ca3af;">Made with ‚ù§Ô∏è by ÏóêÎπÑÏ∏Ñ</p>
                </div>
            `;
            
            openSmallModal('‚ÑπÔ∏è Î≤ÑÏ†Ñ Ï†ïÎ≥¥', '', html);
            document.getElementById('modalContent').style.maxWidth = '480px';
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>
            `;
        });

        init();
    </script>
</body>
</html>
