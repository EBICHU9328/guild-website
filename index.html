<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸¸ë“œ ì „íˆ¬ë ¥ í˜„í™©íŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; background: #ffffff; color: #1a1a1a; line-height: 1.6; }
        .lock-banner { background: #ef4444; color: white; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; display: none; animation: slideDown 0.3s ease; }
        .lock-banner.active { display: block; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .top-bar { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid #e5e7eb; padding: 16px 24px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .top-bar h1 { font-size: 20px; font-weight: 600; color: #111827; letter-spacing: -0.5px; }
        .top-actions { display: flex; gap: 12px; align-items: center; }
        .search-input { padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; width: 180px; transition: all 0.2s; background: #f9fafb; }
        .search-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn-common { padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .btn-user-add { background: #3b82f6; color: white; font-weight: 600; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .btn-user-add:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-user-add.disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .btn-excel { background: #10b981; color: white; }
        .btn-admin { background: #1f2937; color: white; position: relative; }
        .btn-admin.logged-in { background: #4b5563; cursor: default; }
        .btn-log { background: #f59e0b; color: white; }
        .btn-manage { background: #6366f1; color: white; }
        .btn-guild-add { background: #8b5cf6; color: white; }
        .btn-lock { background: #ef4444; color: white; }
        .btn-bulk { background: #db2777; color: white; }
        .btn-bulk:hover { background: #be185d; }
        .btn-approve { background: #059669; color: white; }
        .btn-approve:hover { background: #047857; }
        .btn-rename { background: #8b5cf6; color: white; }
        .btn-rename:hover { background: #7c3aed; }
        .btn-reset-pw { padding: 4px 8px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-reset-pw:hover { background: #dc2626; }
        
        /* ìŠ¹ì¸ ëŒ€ê¸° ë±ƒì§€ */
        .pending-badge { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; }

        /* ê¸¸ë“œ ì„ íƒ í™”ë©´ */
        .guild-select-container { max-width: 1200px; margin: 0 auto; padding: 60px 24px; }
        .guild-select-title { text-align: center; font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 40px; }
        .guild-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .guild-btn { background: #ffffff; border: 2px solid #e5e7eb; border-radius: 16px; padding: 30px 24px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 16px; }
        .guild-btn:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15); }
        .guild-btn:active { transform: translateY(-2px); }
        .guild-btn-badge { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
        .guild-btn:nth-child(4n+1) .guild-btn-badge { background: #3b82f6; }
        .guild-btn:nth-child(4n+2) .guild-btn-badge { background: #10b981; }
        .guild-btn:nth-child(4n+3) .guild-btn-badge { background: #f59e0b; }
        .guild-btn:nth-child(4n+4) .guild-btn-badge { background: #ef4444; }
        .guild-btn-info { flex: 1; }
        .guild-btn-name { font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .guild-btn-count { font-size: 14px; color: #6b7280; }
        .guild-btn-arrow { font-size: 24px; color: #9ca3af; transition: transform 0.3s; }
        .guild-btn:hover .guild-btn-arrow { transform: translateX(4px); color: #3b82f6; }

        /* ê¸¸ë“œ ìƒì„¸ í™”ë©´ */
        .guild-detail-container { max-width: 900px; margin: 0 auto; padding: 40px 24px; display: none; }
        .guild-detail-container.active { display: block; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .back-btn:hover { background: #e5e7eb; }
        .guild-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .guild-detail-badge { width: 12px; height: 12px; border-radius: 50%; }
        .guild-detail-title { font-size: 24px; font-weight: 700; color: #111827; }
        .guild-detail-count { font-size: 14px; color: #6b7280; margin-left: auto; }

        .container { max-width: 1600px; margin: 0 auto; padding: 40px 24px; display: none; grid-template-columns: repeat(auto-fit, minmax(min(100%, 360px), 1fr)); gap: 24px; }
        .card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { border-color: #d1d5db; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; }
        .guild-badge { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: #9ca3af; }
        .card:nth-child(4n+1) .guild-badge { background: #3b82f6; }
        .card:nth-child(4n+2) .guild-badge { background: #10b981; }
        .card:nth-child(4n+3) .guild-badge { background: #f59e0b; }
        .card:nth-child(4n+4) .guild-badge { background: #ef4444; }
        .card-header h2 { font-size: 16px; font-weight: 600; color: #111827; letter-spacing: -0.3px; }
        .card-body { padding: 0; }
        .card-body table { width: 100%; border-collapse: collapse; }
        .card-body thead { background: #f9fafb; border-bottom: 1px solid #f3f4f6; }
        .card-body th { padding: 12px 16px; font-weight: 500; color: #6b7280; font-size: 13px; text-align: left; letter-spacing: 0.3px; }
        .card-body th:first-child { width: 60%; }
        .card-body th:last-child { width: 40%; text-align: right; padding-right: 20px; }
        .card-body td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; height: 60px; }
        .card-body td:first-child { overflow: visible; }
        .card-body td:last-child { text-align: right; width: 40%; padding-right: 20px; }
        .player-cell { display: flex; align-items: center; gap: 4px; flex-wrap: nowrap; }
        .card-body tbody tr { height: 60px; cursor: pointer; -webkit-tap-highlight-color: rgba(59, 130, 246, 0.1); }
        .card-body tbody tr:hover { background: #f0f9ff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-body tbody tr:active { background: #dbeafe; }
        .card-body tbody tr:last-child td { border-bottom: none; }
        .card-body tbody tr { border-bottom: 2px solid #e5e7eb; }
        .rank-number { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; font-size: 14px; font-weight: 700; margin-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .rank-number:hover { transform: scale(1.05); }
        tbody tr:nth-child(1) .rank-number { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #92400e; box-shadow: 0 4px 6px rgba(255,215,0,0.4); }
        tbody tr:nth-child(2) .rank-number { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #57534e; box-shadow: 0 4px 6px rgba(192,192,192,0.4); }
        tbody tr:nth-child(3) .rank-number { background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); color: #78350f; box-shadow: 0 4px 6px rgba(205,127,50,0.4); }
        tbody tr:nth-child(n+4) .rank-number { background: #f3f4f6; color: #374151; font-weight: 600; }
        .player-name { 
            font-weight: 500; 
            color: #111827; 
            cursor: pointer; 
            padding: 6px 10px; 
            border-radius: 6px; 
            transition: all 0.2s; 
            display: inline-block; 
            vertical-align: middle;
            user-select: none;
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.1);
        }
        .player-name:hover { 
            background: #e0e7ff; 
            color: #2563eb; 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-name:active {
            transform: translateY(0);
            background: #c7d2fe;
        }
        .power-value { font-weight: 600; color: #3b82f6; cursor: pointer; transition: all 0.15s ease; padding: 6px 12px; border-radius: 6px; display: inline-block; }
        .power-value:hover { background: #eff6ff; color: #2563eb; }
        
        /* ì „íˆ¬ë ¥ ë¸”ëŸ¬ ì²˜ë¦¬ */
        .power-value.blurred { 
            filter: blur(8px); 
            user-select: none; 
            pointer-events: none;
            color: #9ca3af;
        }
        .power-value.blurred:hover {
            background: transparent;
        }
        
        /* ìŠ¤í™ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .spec-icons { font-size: 11px; margin-left: 2px; color: #666; display: inline-block; cursor: pointer; vertical-align: middle; flex-shrink: 0; white-space: nowrap; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; animation: fadeIn 0.2s ease; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal { background: #ffffff; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; max-height: calc(100vh - 40px); display: flex; flex-direction: column; animation: slideUp 0.3s ease; position: relative; margin: 20px auto; }
        .modal.modal-lg { max-width: 900px; }
        .modal-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border: none; background: #f3f4f6; border-radius: 50%; color: #6b7280; font-size: 24px; line-height: 1; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .modal-close-btn:hover { background: #e5e7eb; color: #374151; transform: rotate(90deg); }
        .modal-header { padding: 24px 24px 16px; border-bottom: 1px solid #f3f4f6; flex-shrink: 0; }
        .modal-header h3 { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .modal-header p { font-size: 14px; color: #6b7280; margin: 0; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; min-height: 0; }
        .table-scroll-container { max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
        .common-table { width: 100%; font-size: 13px; table-layout: auto; border-collapse: collapse; }
        .common-table th { position: sticky; top: 0; background: #f3f4f6; text-align: center; padding: 12px 10px; font-weight: 600; white-space: nowrap; border-bottom: 2px solid #e5e7eb; }
        .common-table td { text-align: center; padding: 10px 12px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; white-space: nowrap; }
        .common-table tbody tr:hover { background: #f9fafb; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; color: #111827; transition: all 0.15s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0; background: #ffffff; border-radius: 0 0 16px 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; }
        .btn-cancel { background: #f3f4f6; color: #6b7280; }
        .btn-cancel:hover { background: #e5e7eb; color: #374151; }
        .btn-primary { background: #3b82f6; color: #ffffff; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: #ffffff; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: #ffffff; }
        .btn-danger:hover { background: #dc2626; }
        .alert { position: fixed; top: 24px; right: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 2000; animation: slideInRight 0.3s ease; max-width: 400px; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .alert-success { border-left: 4px solid #10b981; }
        .alert-error { border-left: 4px solid #ef4444; }
        .alert-title { font-weight: 600; color: #111827; margin-bottom: 4px; }
        .alert-message { font-size: 14px; color: #6b7280; margin: 0; }
        
        /* ì¼ê´„ ë“±ë¡ìš© ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .checkbox-label { display: flex; align-items: center; font-size: 14px; cursor: pointer; background: #f3f4f6; padding: 8px 12px; border-radius: 6px; }
        .checkbox-label input { margin-right: 8px; }
        
        /* ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { background: #f9fafb; padding: 10px; border-radius: 8px; font-size: 14px; }
        .info-label { color: #6b7280; font-size: 12px; display: block; margin-bottom: 4px; }
        .info-val { font-weight: 600; color: #111827; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
        .badge-on { background: #dbeafe; color: #1e40af; }
        .badge-off { background: #f3f4f6; color: #9ca3af; }
        .spec-count { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 4px; background: #dbeafe; color: #1e40af; }
        .spec-count.zero { background: #f3f4f6; color: #9ca3af; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
        .spec-input-group { display: flex; flex-direction: column; }
        .spec-input-group label { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
        .form-input.small { padding: 8px 12px; font-size: 14px; }
        
        /* ì‹œê°„ ì…ë ¥ ê·¸ë£¹ */
        .time-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        @media (max-width: 768px) {
            .top-bar { padding: 14px 16px; flex-direction: column; align-items: flex-start; }
            .top-actions { width: 100%; flex-wrap: wrap; }
            .search-input { flex-grow: 1; width: auto; }
            .container { padding: 24px 16px; gap: 20px; }
            
            /* ëª¨ë°”ì¼ ëª¨ë‹¬ ìµœì í™” */
            .modal-overlay { padding: 10px; align-items: flex-start; }
            .modal { 
                width: 95%; 
                max-height: calc(100vh - 20px);
                margin: 10px auto;
                border-radius: 12px;
            }
            .modal.modal-lg { 
                max-width: 95%; 
            }
            .modal-header { 
                padding: 20px 16px 12px; 
            }
            .modal-header h3 { 
                font-size: 16px; 
                padding-right: 30px; /* X ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            }
            .modal-body { 
                padding: 16px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            }
            .modal-footer { 
                padding: 12px 16px;
                flex-shrink: 0;
            }
            .modal-close-btn {
                top: 12px;
                right: 12px;
                width: 28px;
                height: 28px;
                font-size: 20px;
            }
            .table-scroll-container {
                max-height: 300px; /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” ë†’ì´ ì¤„ì´ê¸° */
            }
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            .form-group {
                margin-bottom: 16px; /* ëª¨ë°”ì¼ì—ì„œ ê°„ê²© ì¤„ì´ê¸° */
            }
            .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            /* ëª¨ë°”ì¼ í…Œì´ë¸” ìµœì í™” */
            td { 
                padding: 10px 12px; /* ì¢Œìš° íŒ¨ë”© ì¶•ì†Œ */
            }
            .player-name { 
                font-size: 13px;
            }
            .rank-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
                margin-right: 8px;
            }
            .spec-icons {
                font-size: 11px;
            }
            .power-value {
                font-size: 13px;
                padding: 4px 8px;
            }
            
            /* ê¸¸ë“œ ì„ íƒ í™”ë©´ ëª¨ë°”ì¼ */
            .guild-select-container { padding: 30px 16px; }
            .guild-select-title { font-size: 22px; margin-bottom: 24px; }
            .guild-buttons { gap: 12px; }
            .guild-btn { padding: 20px 16px; }
            .guild-btn-name { font-size: 16px; }
            .guild-btn-count { font-size: 12px; }
            
            /* ê¸¸ë“œ ìƒì„¸ í™”ë©´ ëª¨ë°”ì¼ */
            .guild-detail-container { padding: 20px 16px; }
            .guild-detail-title { font-size: 20px; }
            .back-btn { padding: 8px 14px; font-size: 13px; }
            
            /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ ë†’ì´ ì¡°ì • */
            .table-scroll-container { 
                max-height: 300px; 
            }
            
            /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .btn { 
                padding: 10px 16px; 
                font-size: 13px; 
            }
            
            /* í¼ ì…ë ¥ í¬ê¸° ì¡°ì • */
            .form-input { 
                padding: 10px 12px; 
                font-size: 14px; 
            }
            
            /* ê·¸ë¦¬ë“œ 1ì—´ë¡œ ë³€ê²½ */
            .spec-grid, .time-input-group { 
                grid-template-columns: 1fr; 
            }
        }
        @media (min-width: 1024px) { .container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1440px) { .container { grid-template-columns: repeat(4, 1fr); max-width: 1440px; } }
    </style>
</head>
<body>
    <div id="lockBanner" class="lock-banner">â›” í˜„ì¬ ì •ë³´ ìˆ˜ì •ì´ ì ê²¨ìˆìŠµë‹ˆë‹¤</div>

    <div class="top-bar">
        <h1>ê¸¸ë“œ ì „íˆ¬ë ¥ í˜„í™©íŒ</h1>
        <div class="top-actions">
            <button id="addUserBtn" class="btn-common btn-user-add">â• ì‚¬ìš©ì ë“±ë¡</button>
            <div style="display: flex; gap: 4px;">
                <input type="text" id="searchInput" class="search-input" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰...">
                <button id="searchBtn" class="btn-common" style="padding: 8px 12px; background: #3b82f6; color: white;">ğŸ”</button>
            </div>
            
            <button id="approveBtn" class="btn-common btn-approve admin-only">âœ… ìŠ¹ì¸ ê´€ë¦¬ <span id="pendingBadge" class="pending-badge" style="display:none;">0</span></button>
            <button id="bulkAddBtn" class="btn-common btn-bulk admin-only">ğŸ“ ì¼ê´„ ë“±ë¡/ì´ë™</button>
            <button id="spreadsheetBtn" class="btn-common admin-only" style="background:#0f9d58; color:white;">ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™</button>
            <button id="excelBtn" class="btn-common btn-excel admin-only"><span>ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span></button>
            <button id="sheetSyncBtn" class="btn-common btn-excel admin-only"><span>ğŸ“¤ êµ¬ê¸€ì‹œíŠ¸ ë™ê¸°í™”</span></button>
            <button id="guildAddBtn" class="btn-common btn-guild-add admin-only"><span>ğŸ° ê¸¸ë“œ ì¶”ê°€</span></button>
            <button id="userManageBtn" class="btn-common btn-manage admin-only">ğŸ‘¥ ìœ ì € ê´€ë¦¬</button>
            <button id="bulkDeleteBtn" class="btn-common admin-only" style="background:#dc2626; color:white;">ğŸ—‘ï¸ ì¼ê´„ ë“±ë¡ í•´ì œ</button>
            <button id="lockManageBtn" class="btn-common btn-lock admin-only">ğŸ”’ ì ê¸ˆ ì„¤ì •</button>
            <button id="logViewBtn" class="btn-common btn-log admin-only">ğŸ“ ë¡œê·¸ í™•ì¸</button>
            <button id="deletedUsersBtn" class="btn-common admin-only" style="background:#dc2626; color:white;">ğŸ—‘ï¸ ì‚­ì œëœ ì‚¬ìš©ì</button>
            <button id="adminManageBtn" class="btn-common super-admin-only" style="background:#7c3aed; color:white; display:none;">ğŸ‘‘ ê´€ë¦¬ì ê´€ë¦¬</button>
            <button id="adminLoginBtn" class="btn-common btn-admin">ê´€ë¦¬ì</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent">
            <button class="modal-close-btn" onclick="closeModal()" title="ë‹«ê¸°">Ã—</button>
            <div class="modal-header">
                <h3 id="modalTitle">ì œëª©</h3>
                <p id="modalSubtitle">ë¶€ì œëª©</p>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="modalSubmit">í™•ì¸</button>
            </div>
        </div>
    </div>
    
    <div class="container" id="mainContainer"></div>
    
    <!-- ê¸¸ë“œ ì„ íƒ í™”ë©´ -->
    <div class="guild-select-container" id="guildSelectContainer">
        <h1 class="guild-select-title">âš”ï¸ ê¸¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
        <div class="guild-buttons" id="guildButtons"></div>
    </div>
    
    <!-- ê¸¸ë“œ ìƒì„¸ í™”ë©´ -->
    <div class="guild-detail-container" id="guildDetailContainer">
        <button class="back-btn" onclick="showGuildSelect()">â† ê¸¸ë“œ ëª©ë¡ìœ¼ë¡œ</button>
        <div class="guild-detail-header">
            <div class="guild-detail-badge" id="detailBadge"></div>
            <h2 class="guild-detail-title" id="detailTitle"></h2>
            <span class="guild-detail-count" id="detailCount"></span>
        </div>
        <div class="card">
            <div class="card-body">
                <table>
                    <thead><tr><th>í”Œë ˆì´ì–´</th><th>ì „íˆ¬ë ¥</th></tr></thead>
                    <tbody id="detailList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, getDoc, query, orderBy, limit, deleteDoc, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrW07jxkT-I5k7LXT_IKVdw3o4s45ZRE0",
            authDomain: "guild-power-rank.firebaseapp.com",
            projectId: "guild-power-rank",
            storageBucket: "guild-power-rank.firebasestorage.app",
            messagingSenderId: "312765940928",
            appId: "1:312765940928:web:bdf388e3cdd4f32e699925",
            measurementId: "G-QPVZKMLS70"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let allGuildData = [];
        let guildList = []; 
        let isAdmin = false;
        let isSuperAdmin = false; // ìµœì¢… ê´€ë¦¬ì ì—¬ë¶€
        let loggedInUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë‹‰ë„¤ì„
        let lockStartTime = 0;
        let lockEndTime = 0;
        let spreadsheetConfig = null; // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •
        const SUPER_ADMIN_HASH = { id: "dGpkYWxzOTMyOA==", pw: "dG5hbHM5MzI4QEA=" }; // ìµœì¢… ê´€ë¦¬ì

        // --- KST ë³€í™˜ í•¨ìˆ˜ ---
        function toKST(timestamp) {
            // UTCë¥¼ KST(UTC+9)ë¡œ ë³€í™˜
            return new Date(timestamp + (9 * 60 * 60 * 1000));
        }

        function fromKST(dateString) {
            // KST datetime-local ì…ë ¥ê°’ì„ UTC timestampë¡œ ë³€í™˜
            const kstDate = new Date(dateString);
            return kstDate.getTime() - (9 * 60 * 60 * 1000);
        }

        function formatKSTDateTime(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function toDatetimeLocalValue(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // --- ì´ˆê¸°í™” ---
        async function init() {
            if (sessionStorage.getItem('isAdmin') === 'true') { 
                isAdmin = true;
                if (sessionStorage.getItem('isSuperAdmin') === 'true') {
                    isSuperAdmin = true;
                }
                updateAdminUI(); 
                await checkPendingUsers(); // ìŠ¹ì¸ ëŒ€ê¸° ìœ ì € í™•ì¸
            }
            
            // ìë™ ë¡œê·¸ì¸ ì²´í¬
            await checkAutoLogin();
            
            await checkLockStatus();
            await loadSpreadsheetConfig(); // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì • ë¡œë“œ
            await loadData();
        }
        
        // ìë™ ë¡œê·¸ì¸ ì²´í¬
        async function checkAutoLogin() {
            const autoLogin = localStorage.getItem('autoLogin');
            if (autoLogin) {
                try {
                    const data = JSON.parse(autoLogin);
                    const userDoc = await getDoc(doc(db, "users", data.username));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        // ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ë©´ ìë™ ë¡œê·¸ì¸
                        if (userData.password === data.password) {
                            loggedInUser = data.username;
                            console.log('ìë™ ë¡œê·¸ì¸:', loggedInUser);
                        } else {
                            // ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ìë™ ë¡œê·¸ì¸ í•´ì œ
                            localStorage.removeItem('autoLogin');
                        }
                    } else {
                        // ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìœ¼ë©´ ìë™ ë¡œê·¸ì¸ í•´ì œ
                        localStorage.removeItem('autoLogin');
                    }
                } catch (e) {
                    console.error('ìë™ ë¡œê·¸ì¸ ì—ëŸ¬:', e);
                    localStorage.removeItem('autoLogin');
                }
            }
        }

        async function loadSpreadsheetConfig() {
            try {
                const docRef = doc(db, "config", "spreadsheet");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    spreadsheetConfig = docSnap.data();
                }
            } catch (e) {
                console.log("Spreadsheet config error", e);
            }
        }

        async function checkLockStatus() {
            try {
                const docRef = doc(db, "config", "system");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lockStartTime = data.lockStartTime || 0;
                    lockEndTime = data.lockEndTime || 0;
                }
                updateLockUI();
            } catch (e) { console.log("Config error", e); }
        }

        function isSystemLocked() { 
            const now = Date.now();
            return (lockStartTime > 0 && lockEndTime > 0 && now >= lockStartTime && now <= lockEndTime); 
        }

        function updateLockUI() {
            const banner = document.getElementById('lockBanner');
            const addUserBtn = document.getElementById('addUserBtn');
            if (isSystemLocked() && !isAdmin) {
                banner.classList.add('active');
                addUserBtn.classList.add('disabled');
                const remainMs = lockEndTime - Date.now();
                const remainHours = Math.ceil(remainMs / (1000 * 60 * 60));
                banner.innerText = `â›” ê´€ë¦¬ìê°€ ìˆ˜ì • ì ê¸ˆì„ í•˜ì—¬ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤ | ê¸°ê°„: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (ì•½ ${remainHours}ì‹œê°„ ë‚¨ìŒ)`;
            } else {
                banner.classList.remove('active');
                addUserBtn.classList.remove('disabled');
            }
        }

        async function checkPendingUsers() {
            if (!isAdmin) return;
            const q = query(collection(db, "pendingUsers"));
            const snapshot = await getDocs(q);
            const count = snapshot.size;
            
            const badge = document.getElementById('pendingBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
                showAlert(`ìŠ¹ì¸ ìš”ì²­ì´ ${count}ê°œ ë„ì°©í•˜ì˜€ìŠµë‹ˆë‹¤`, 'success');
            } else {
                badge.style.display = 'none';
            }
        }

        function updateAdminUI() {
            if(isAdmin) {
                const btn = document.getElementById('adminLoginBtn');
                btn.textContent = isSuperAdmin ? 'ìµœì¢…ê´€ë¦¬ìë‹˜' : 'ê´€ë¦¬ìë‹˜'; 
                btn.classList.add('logged-in');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
                // ìŠˆí¼ ê´€ë¦¬ì ì „ìš© UI
                if(isSuperAdmin) {
                    document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'inline-flex');
                }
                updateLockUI();
            }
        }

        const formatDateTime = (d) => {
            const date = toKST(d);
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${String(date.getUTCDate()).padStart(2,'0')} ` +
                   `${String(date.getUTCHours()).padStart(2,'0')}:${String(date.getUTCMinutes()).padStart(2,'0')}:${String(date.getUTCSeconds()).padStart(2,'0')}`;
        };

        async function getIp() { try { const res = await fetch('https://api.ipify.org?format=json'); return (await res.json()).ip; } catch (e) { return 'unknown'; } }

        async function fetchGuildList() {
            const docRef = doc(db, "config", "guilds");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { guildList = docSnap.data().names || []; } 
            else { guildList = ['ì‚¬ì‹ ', 'ì¶•ë³µ', 'ë†€ì', 'ë£¨ë¹„']; await setDoc(docRef, { names: guildList }); }
        }

        // ê¸¸ë“œë³„ ë°ì´í„° ì €ì¥ìš©
        let guildDataMap = {};
        let currentGuild = null;

        async function loadData() {
            await fetchGuildList();
            
            const querySnapshot = await getDocs(collection(db, "users"));
            guildDataMap = {}; 
            guildList.forEach(g => guildDataMap[g] = []); 
            allGuildData = [];

            if (querySnapshot.empty) { await initializeDatabase(); return; }

            querySnapshot.forEach((docSnap) => {
                const user = docSnap.data();
                user.shape_legend = typeof user.shape_legend === 'number' ? user.shape_legend : (user.shape_legend ? 1 : 0);
                user.shape_myth = typeof user.shape_myth === 'number' ? user.shape_myth : (user.shape_myth ? 1 : 0);
                user.mount_legend = typeof user.mount_legend === 'number' ? user.mount_legend : (user.mount_legend ? 1 : 0);
                user.mount_myth = typeof user.mount_myth === 'number' ? user.mount_myth : (user.mount_myth ? 1 : 0);

                if (guildDataMap[user.guild] !== undefined) guildDataMap[user.guild].push(user);
                else if (guildList.includes(user.guild)) guildDataMap[user.guild] = [user];
            });

            // ê° ê¸¸ë“œ ì •ë ¬
            Object.keys(guildDataMap).forEach(guildName => {
                guildDataMap[guildName].sort((a, b) => b.power - a.power);
                allGuildData.push(...guildDataMap[guildName]);
            });

            // ê¸¸ë“œ ì„ íƒ ë²„íŠ¼ ë Œë”ë§
            renderGuildButtons();
            
            // í˜„ì¬ ë³´ê³  ìˆë˜ ê¸¸ë“œê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í‘œì‹œ
            if (currentGuild && guildList.includes(currentGuild)) {
                showGuildDetail(currentGuild);
            } else {
                showGuildSelect();
            }
        }

        function renderGuildButtons() {
            const container = document.getElementById('guildButtons');
            container.innerHTML = '';
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            
            guildList.forEach((guildName, index) => {
                const count = guildDataMap[guildName]?.length || 0;
                const btn = document.createElement('div');
                btn.className = 'guild-btn';
                btn.innerHTML = `
                    <div class="guild-btn-badge" style="background: ${colors[index % 4]}"></div>
                    <div class="guild-btn-info">
                        <div class="guild-btn-name">${guildName}</div>
                        <div class="guild-btn-count">${count}ëª…ì˜ ê¸¸ë“œì›</div>
                    </div>
                    <div class="guild-btn-arrow">â†’</div>
                `;
                btn.onclick = () => showGuildDetail(guildName);
                container.appendChild(btn);
            });
        }

        window.showGuildSelect = function() {
            currentGuild = null;
            document.getElementById('guildSelectContainer').style.display = 'block';
            document.getElementById('guildDetailContainer').classList.remove('active');
        }

        window.showGuildDetail = function(guildName) {
            currentGuild = guildName;
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            const colorIndex = guildList.indexOf(guildName);
            
            document.getElementById('guildSelectContainer').style.display = 'none';
            document.getElementById('guildDetailContainer').classList.add('active');
            
            document.getElementById('detailBadge').style.background = colors[colorIndex % 4];
            document.getElementById('detailTitle').textContent = guildName;
            
            const users = guildDataMap[guildName] || [];
            document.getElementById('detailCount').textContent = `${users.length}ëª…`;
            
            const tbody = document.getElementById('detailList');
            tbody.innerHTML = '';
            
            users.forEach((user, index) => {
                const tr = document.createElement('tr');
                let icons = "";
                if(user.shape_legend > 0) icons += "ğŸ›¡ï¸";
                if(user.shape_myth > 0) icons += "ğŸ‘‘";
                if(user.mount_legend > 0) icons += "ğŸ´";
                if(user.mount_myth > 0) icons += "ğŸ¦„";
                
                const shouldBlur = !isAdmin && (loggedInUser !== user.name);
                const blurClass = shouldBlur ? ' blurred' : '';
                
                tr.innerHTML = `<td><div class="player-cell"><span class="rank-number">${index + 1}</span><span class="player-name" title="${user.name}">${user.name}</span><span class="spec-icons">${icons}</span></div></td>
                    <td><span class="power-value${blurClass}">${user.power.toLocaleString()}</span></td>`;
                
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('power-value')) {
                        showUserInfo(user.name);
                    }
                });
                
                const powerValueSpan = tr.querySelector('.power-value');
                powerValueSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePowerClick(user.name);
                });
                
                tbody.appendChild(tr);
            });
        }

        // --- ê¸°ëŠ¥: ì‚¬ìš©ì ì¡°íšŒ ë° ìƒì„¸ ë³´ê¸° ---
        async function showUserInfo(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();

            // ë¸”ëŸ¬ ì²˜ë¦¬ ì—¬ë¶€ ê²°ì •
            const isBlurred = !isAdmin && (loggedInUser !== name);

            const showCount = (count) => {
                if (count > 0) {
                    return `<span class="spec-count">${count}ê°œ</span>`;
                } else {
                    return `<span class="spec-count zero">ì—†ìŒ</span>`;
                }
            };

            // ê°±ì‹ ì¼ í¬ë§·íŒ… (ê´€ë¦¬ìë§Œ í‘œì‹œ)
            let updatedInfo = '';
            if (isAdmin && u.updatedAt) {
                const updatedDate = formatDateTime(u.updatedAt);
                const isAdminUpdate = u.updatedBy === 'admin';
                updatedInfo = `<p style="font-size:12px; color:#6b7280; margin-top:8px;">ê°±ì‹ ì¼: ${updatedDate}${isAdminUpdate ? ' (ê´€ë¦¬ì)' : ''}</p>`;
            }

            // ë‹‰ë„¤ì„ ë³€ê²½ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
            const renameButton = isAdmin ? `<button class="btn btn-rename" onclick="window.openRenameModal('${name}')" style="flex:1">ğŸ”„ ë‹‰ë„¤ì„ ë³€ê²½</button>` : '';

            const content = `
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">ê¸¸ë“œ</span><span class="info-val">${u.guild}</span></div>
                    <div class="info-item">
                        <span class="info-label">ì „íˆ¬ë ¥</span>
                        <span class="info-val ${isBlurred ? 'power-value blurred' : ''}" ${isBlurred ? 'title="ë¡œê·¸ì¸ í›„ í™•ì¸ ê°€ëŠ¥"' : ''}>
                            ${isBlurred ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : u.power.toLocaleString()}
                        </span>
                    </div>
                </div>
                ${updatedInfo}
                <div class="info-grid" style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd;">
                    <div class="info-item"><span class="info-label">ğŸ›¡ï¸ í˜•ìƒ ì „ì„¤</span>${showCount(u.shape_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">ğŸ‘‘ í˜•ìƒ ì‹ í™”</span>${showCount(u.shape_myth || 0)}</div>
                    <div class="info-item"><span class="info-label">ğŸ´ íƒˆê²ƒ ì „ì„¤</span>${showCount(u.mount_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">ğŸ¦„ íƒˆê²ƒ ì‹ í™”</span>${showCount(u.mount_myth || 0)}</div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; text-align:center;">â€» ìŠ¤í™ ê°œìˆ˜ëŠ” ê´€ë¦¬ìê°€ ì„¤ì •í•©ë‹ˆë‹¤</p>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="window.editUserFromInfo('${name}')" style="flex:1">âœï¸ ì •ë³´ ìˆ˜ì •</button>
                    ${renameButton}
                </div>
            `;
            
            openSmallModal('ìƒì„¸ ì •ë³´', u.name, content);
            document.getElementById('modalFooter').style.display = 'none';
        }

        // --- ë‹‰ë„¤ì„ ë³€ê²½ ê¸°ëŠ¥ (ê´€ë¦¬ì ì „ìš©) ---
        window.openRenameModal = async function(oldName) {
            if (!isAdmin) {
                showAlert('âŒ ë‹‰ë„¤ì„ ë³€ê²½ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                return;
            }

            openSmallModal('ë‹‰ë„¤ì„ ë³€ê²½ (ê´€ë¦¬ì ì „ìš©)', `í˜„ì¬: ${oldName}`, `
                <div class="form-group">
                    <label class="form-label">ìƒˆ ë‹‰ë„¤ì„</label>
                    <input type="text" id="newNickname" class="form-input" placeholder="ìƒˆë¡œìš´ ë‹‰ë„¤ì„ ì…ë ¥">
                </div>
                <p style="font-size:12px; color:#ef4444; margin-top:8px;">âš ï¸ ë‹‰ë„¤ì„ì„ ë³€ê²½í•˜ë©´ ì´ì „ ë‹‰ë„¤ì„ìœ¼ë¡œëŠ” ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            `);

            setTimeout(() => document.getElementById('newNickname').focus(), 100);

            document.getElementById('modalSubmit').onclick = async () => {
                const newName = document.getElementById('newNickname').value.trim();
                
                if (!newName) {
                    showAlert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                if (newName === oldName) {
                    showAlert('ë™ì¼í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤', 'error');
                    return;
                }

                // ì¤‘ë³µ ì²´í¬
                const checkDoc = await getDoc(doc(db, "users", newName));
                if (checkDoc.exists()) {
                    showAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤', 'error');
                    return;
                }

                try {
                    // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const oldDocRef = doc(db, "users", oldName);
                    const oldDocSnap = await getDoc(oldDocRef);
                    const userData = oldDocSnap.data();

                    // ìƒˆ ë‹‰ë„¤ì„ìœ¼ë¡œ ë¬¸ì„œ ìƒì„±
                    userData.name = newName;
                    await setDoc(doc(db, "users", newName), userData);

                    // ê¸°ì¡´ ë¬¸ì„œ ì‚­ì œ
                    await deleteDoc(oldDocRef);

                    // ë¡œê·¸ ê¸°ë¡
                    await setDoc(doc(collection(db, "logs")), {
                        who: `${oldName} â†’ ${newName}`,
                        type: 'nickname_change',
                        old_value: oldName,
                        new_value: newName,
                        createdAt: Date.now(),
                        ip: await getIp(),
                        device: navigator.userAgent,
                        admin: true
                    });

                    showAlert(`ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤: ${oldName} â†’ ${newName}`, 'success');
                    closeModal();
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(userData.guild);
                    }, 500);
                } catch (e) {
                    console.error(e);
                    showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            };
        };

        // --- ê¸°ëŠ¥: ì‚¬ìš©ì ë“±ë¡ (ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœë¡œ) ---
        document.getElementById('addUserBtn').addEventListener('click', () => {
            if (isSystemLocked() && !isAdmin) { 
                const lockMsg = `ê´€ë¦¬ìê°€ ìˆ˜ì • ì ê¸ˆì„ í•˜ì—¬ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nê¸°ê°„: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            openSmallModal('ì‚¬ìš©ì ë“±ë¡', 'ì‹ ê·œ ìœ ì € ë“±ë¡ (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)', `
                <div class="form-group"><label class="form-label">ê¸¸ë“œ ì„ íƒ</label><select id="newUserGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">ë‹‰ë„¤ì„</label><input type="text" id="newUserName" class="form-input" placeholder="ë‹‰ë„¤ì„"></div>
                <div class="form-group"><label class="form-label">ì „íˆ¬ë ¥ (ìˆ«ìë§Œ)</label><input type="text" id="newUserPower" class="form-input" placeholder="ì˜ˆ: 1200000" inputmode="numeric"></div>
                <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label><input type="password" id="newUserPw" class="form-input" maxlength="4" inputmode="numeric" placeholder="ë³¸ì¸ì¸ì¦ìš©"></div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">â€» ë“±ë¡ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const guild = document.getElementById('newUserGuild').value;
                const name = document.getElementById('newUserName').value.trim();
                const powerStr = document.getElementById('newUserPower').value.replace(/,/g, "").trim();
                const pw = document.getElementById('newUserPw').value;

                // ë‹‰ë„¤ì„ ì²´í¬
                if (!name) {
                    showAlert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                // ì „íˆ¬ë ¥ ì²´í¬
                if (!powerStr) {
                    showAlert('ì „íˆ¬ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                if (!/^\d+$/.test(powerStr)) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ì „íˆ¬ë ¥ì€ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
                if (!/^\d{4}$/.test(pw)) {
                    showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }

                // ì¤‘ë³µ ì²´í¬ (users + pendingUsers ëª¨ë‘)
                const userDocRef = doc(db, "users", name);
                const pendingDocRef = doc(db, "pendingUsers", name);
                const [userSnap, pendingSnap] = await Promise.all([
                    getDoc(userDocRef),
                    getDoc(pendingDocRef)
                ]);

                if (userSnap.exists() || pendingSnap.exists()) { 
                    showAlert('ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤', 'error'); 
                    return; 
                }

                try {
                    const power = Number(powerStr);
                    // ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœë¡œ ì €ì¥
                    await setDoc(pendingDocRef, { 
                        guild, 
                        name, 
                        power, 
                        password: pw,
                        shape_legend: 0, 
                        shape_myth: 0,
                        mount_legend: 0, 
                        mount_myth: 0,
                        requestedAt: Date.now(),
                        ip: await getIp()
                    });
                    
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'user_request', 
                        old_value: '-', 
                        new_value: `ë“±ë¡ìš”ì²­(${guild})`, 
                        createdAt: Date.now(), 
                        ip: await getIp(), 
                        device: navigator.userAgent 
                    });
                    
                    showAlert(`${name}ë‹˜ ë“±ë¡ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'success'); 
                    closeModal();
                } catch(e) { 
                    console.error(e); 
                    showAlert('ì˜¤ë¥˜ ë°œìƒ', 'error'); 
                }
            };
        });

        // --- ìŠ¹ì¸ ê´€ë¦¬ ê¸°ëŠ¥ ---
        document.getElementById('approveBtn').addEventListener('click', async () => {
            if (!isAdmin) return;

            openLargeModal('ìŠ¹ì¸ ê´€ë¦¬', 'ë“±ë¡ ìš”ì²­ ëª©ë¡');
            
            const q = query(collection(db, "pendingUsers"), orderBy("requestedAt", "desc"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                setModalBody('<div style="text-align:center; padding:40px; color:#9ca3af;">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</div>');
                return;
            }

            let html = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th>ìš”ì²­ì‹œê°„</th><th>ë‹‰ë„¤ì„</th><th>ê¸¸ë“œ</th><th>ì „íˆ¬ë ¥</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
            
            snapshot.forEach(docSnap => {
                const u = docSnap.data();
                html += `<tr>
                    <td>${formatDateTime(u.requestedAt)}</td>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td>${u.power.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-success" onclick="window.approveUser('${u.name}')" style="padding:6px 12px; font-size:12px; margin-right:4px;">ìŠ¹ì¸</button>
                        <button class="btn btn-danger" onclick="window.rejectUser('${u.name}')" style="padding:6px 12px; font-size:12px;">ê±°ë¶€</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
        });

        // ìŠ¹ì¸ ì²˜ë¦¬
        window.approveUser = async function(name) {
            if (!await showConfirm('ì‚¬ìš©ì ìŠ¹ì¸', `[${name}]ë‹˜ì˜ ë“±ë¡ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                const pendingSnap = await getDoc(pendingRef);
                
                if (!pendingSnap.exists()) {
                    showAlert('í•´ë‹¹ ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }

                const userData = pendingSnap.data();
                
                // users ì»¬ë ‰ì…˜ì— ì¶”ê°€
                await setDoc(doc(db, "users", name), userData);
                
                // pendingUsersì—ì„œ ì‚­ì œ
                await deleteDoc(pendingRef);
                
                // ë¡œê·¸ ê¸°ë¡
                await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_approved',
                    old_value: 'ìŠ¹ì¸ëŒ€ê¸°',
                    new_value: 'ìŠ¹ì¸ì™„ë£Œ',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`${name}ë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                closeModal();
                await checkPendingUsers();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(userData.guild);
                }, 500);
            } catch (e) {
                console.error(e);
                showAlert('ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        };

        // ê±°ë¶€ ì²˜ë¦¬
        window.rejectUser = async function(name) {
            if (!await showConfirm('ë“±ë¡ ê±°ë¶€', `[${name}]ë‹˜ì˜ ë“±ë¡ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style="color:#ef4444;">ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                await deleteDoc(pendingRef);
                
                await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_rejected',
                    old_value: 'ìŠ¹ì¸ëŒ€ê¸°',
                    new_value: 'ê±°ë¶€ë¨',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`${name}ë‹˜ì˜ ë“±ë¡ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                closeModal();
                await checkPendingUsers();
            } catch (e) {
                console.error(e);
                showAlert('ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        };

        // --- ê¸°ëŠ¥: ìœ ì € ì „ì²´ ì •ë³´ ìˆ˜ì • (ìŠ¤í™ í¬í•¨) ---
        function openUserEditModal(u) {
            const guildOptions = guildList.map(g => `<option value="${g}" ${g===u.guild?'selected':''}>${g}</option>`).join('');
            
            let specSection = '';
            if (isAdmin) {
                specSection = `
                    <div class="form-group"><label class="form-label">ë³´ìœ  ìŠ¤í™ (ê´€ë¦¬ì ì „ìš© - ê°œìˆ˜ ì…ë ¥)</label>
                        <div class="spec-grid">
                            <div class="spec-input-group">
                                <label>ğŸ›¡ï¸ í˜•ìƒ ì „ì„¤</label>
                                <input type="number" class="form-input small" id="eSL" value="${u.shape_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>ğŸ‘‘ í˜•ìƒ ì‹ í™”</label>
                                <input type="number" class="form-input small" id="eSM" value="${u.shape_myth || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>ğŸ´ íƒˆê²ƒ ì „ì„¤</label>
                                <input type="number" class="form-input small" id="eML" value="${u.mount_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>ğŸ¦„ íƒˆê²ƒ ì‹ í™”</label>
                                <input type="number" class="form-input small" id="eMM" value="${u.mount_myth || 0}" min="0" max="99">
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const showCount = (count) => count > 0 ? `<span class="spec-count">${count}ê°œ</span>` : `<span class="spec-count zero">ì—†ìŒ</span>`;
                specSection = `
                    <div class="form-group"><label class="form-label">ë³´ìœ  ìŠ¤í™ (ì¡°íšŒ ì „ìš©)</label>
                        <div class="info-grid" style="margin-top:10px;">
                            <div class="info-item"><span class="info-label">ğŸ›¡ï¸ í˜•ìƒ ì „ì„¤</span>${showCount(u.shape_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">ğŸ‘‘ í˜•ìƒ ì‹ í™”</span>${showCount(u.shape_myth || 0)}</div>
                            <div class="info-item"><span class="info-label">ğŸ´ íƒˆê²ƒ ì „ì„¤</span>${showCount(u.mount_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">ğŸ¦„ íƒˆê²ƒ ì‹ í™”</span>${showCount(u.mount_myth || 0)}</div>
                        </div>
                        <p style="font-size:12px; color:#6b7280; margin-top:8px;">â€» ìŠ¤í™ ê°œìˆ˜ëŠ” ê´€ë¦¬ìê°€ ì„¤ì •í•©ë‹ˆë‹¤</p>
                    </div>
                `;
            }
            
            const html = `
                <div class="form-group"><label class="form-label">ê¸¸ë“œ</label><select id="editGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">ì „íˆ¬ë ¥</label><input type="text" id="editPower" class="form-input" value="${u.power}" inputmode="numeric"><p style="font-size:12px; color:#6b7280; margin-top:4px;">â€» ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</p></div>
                ${specSection}
            `;
            openSmallModal('ì •ë³´ ìˆ˜ì •', u.name, html);

            document.getElementById('modalSubmit').innerText = "ìˆ˜ì • ì™„ë£Œ";
            document.getElementById('modalSubmit').onclick = async () => {
                const nGuild = document.getElementById('editGuild').value;
                const powerInput = document.getElementById('editPower').value.replace(/,/g,"").trim();
                
                // ì „íˆ¬ë ¥ ìœ íš¨ì„± ê²€ì‚¬
                if (!powerInput) {
                    showAlert('ì „íˆ¬ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                if (!/^\d+$/.test(powerInput)) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ì „íˆ¬ë ¥ì€ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const nPower = Number(powerInput);
                
                if (isNaN(nPower) || nPower < 0) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ì˜¬ë°”ë¥¸ ì „íˆ¬ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                let newData = {
                    guild: nGuild,
                    power: nPower,
                    updatedAt: Date.now(),
                    updatedBy: isAdmin ? 'admin' : 'user'
                };
                
                if (isAdmin) {
                    newData.shape_legend = Number(document.getElementById('eSL').value) || 0;
                    newData.shape_myth = Number(document.getElementById('eSM').value) || 0;
                    newData.mount_legend = Number(document.getElementById('eML').value) || 0;
                    newData.mount_myth = Number(document.getElementById('eMM').value) || 0;
                }

                await updateDoc(doc(db, "users", u.name), newData);
                await setDoc(doc(collection(db, "logs")), { 
                    who: u.name, 
                    type: 'info_edit', 
                    old_value: 'ìˆ˜ì •ë¨', 
                    new_value: isAdmin ? 'ê´€ë¦¬ììˆ˜ì •' : 'ì¼ë°˜ìˆ˜ì •', 
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    device: navigator.userAgent
                });
                
                showAlert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(nGuild);
                }, 500);
            };
        }

        // --- ê´€ë¦¬ì: ì¼ê´„ ë“±ë¡ ê¸°ëŠ¥ ---
        document.getElementById('bulkAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            
            const html = `
                <div class="form-group"><label class="form-label">1. ì´ë™ì‹œí‚¬ ê¸¸ë“œ ì„ íƒ</label><select id="bulkGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">2. ë¶€ì—¬í•  ìŠ¤í™ ê°œìˆ˜</label>
                    <div class="spec-grid">
                        <div class="spec-input-group">
                            <label>ğŸ›¡ï¸ í˜•ìƒ ì „ì„¤</label>
                            <input type="number" class="form-input small" id="bSL" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>ğŸ‘‘ í˜•ìƒ ì‹ í™”</label>
                            <input type="number" class="form-input small" id="bSM" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>ğŸ´ íƒˆê²ƒ ì „ì„¤</label>
                            <input type="number" class="form-input small" id="bML" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>ğŸ¦„ íƒˆê²ƒ ì‹ í™”</label>
                            <input type="number" class="form-input small" id="bMM" value="0" min="0" max="99">
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">3. ë‹‰ë„¤ì„ ì…ë ¥ (ì„¸ë¡œë¡œ ì—”í„°ì³ì„œ ì…ë ¥)</label>
                    <textarea id="bulkNames" class="form-input" rows="8" placeholder="í™ê¸¸ë™&#10;ì„êº½ì •&#10;ì•„ë¬´ê°œ"></textarea>
                </div>
                <p style="font-size:12px; color:#666;">â€» ê¸°ì¡´ ìœ ì €ëŠ” ê¸¸ë“œì™€ ìŠ¤í™ì´ ë³€ê²½ë˜ê³  <b>ì „íˆ¬ë ¥ì€ ìœ ì§€</b>ë©ë‹ˆë‹¤.<br>â€» ì‹ ê·œ ìœ ì €ëŠ” ì „íˆ¬ë ¥ 0ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
            `;
            openLargeModal('ì¼ê´„ ë“±ë¡ ë° ì´ë™', 'ì—¬ëŸ¬ ìœ ì €ë¥¼ í•œ ë²ˆì— ì²˜ë¦¬í•©ë‹ˆë‹¤.');
            setModalBody(html);

            const footerBtn = document.createElement('button');
            footerBtn.className = "btn btn-primary";
            footerBtn.innerText = "ì¼ê´„ ì ìš© ì‹¤í–‰";
            footerBtn.onclick = executeBulkUpdate;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "ë‹«ê¸°";
            closeBtn.onclick = closeModal;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.textAlign = "right";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";
            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(footerBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        });

        async function executeBulkUpdate() {
            const targetGuild = document.getElementById('bulkGuild').value;
            const namesText = document.getElementById('bulkNames').value;
            const specs = {
                shape_legend: Number(document.getElementById('bSL').value) || 0,
                shape_myth: Number(document.getElementById('bSM').value) || 0,
                mount_legend: Number(document.getElementById('bML').value) || 0,
                mount_myth: Number(document.getElementById('bMM').value) || 0
            };

            if(!namesText.trim()) { showAlert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

            const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
            let updateCount = 0;
            let newCount = 0;

            const btn = event.target;
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            btn.disabled = true;

            try {
                for(const name of names) {
                    const docRef = doc(db, "users", name);
                    const docSnap = await getDoc(docRef);

                    if(docSnap.exists()) {
                        await updateDoc(docRef, {
                            guild: targetGuild,
                            ...specs
                        });
                        updateCount++;
                    } else {
                        await setDoc(docRef, {
                            name: name,
                            guild: targetGuild,
                            power: 0,
                            password: null,
                            ...specs
                        });
                        newCount++;
                    }
                }
                
                await setDoc(doc(collection(db, "logs")), { 
                    who: 'Admin', 
                    type: 'bulk_update', 
                    old_value: '-', 
                    new_value: `${names.length}ëª… ì²˜ë¦¬`, 
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`ì™„ë£Œ! (ìˆ˜ì •:${updateCount}, ì‹ ê·œ:${newCount})`, 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(targetGuild);
                }, 500);

            } catch(e) {
                console.error(e);
                showAlert('ì˜¤ë¥˜ ë°œìƒ', 'error');
                btn.innerText = "ì¼ê´„ ì ìš© ì‹¤í–‰";
                btn.disabled = false;
            }
        }

        // --- ê¸°ëŠ¥: ì „íˆ¬ë ¥ ìˆ˜ì • (ë‹¨ì¶•) ---
        function openPowerEditModal(name, u) {
            openSmallModal('ì „íˆ¬ë ¥ ìˆ˜ì •', `í˜„ì¬: ${u.power.toLocaleString()}`, `
                <div class="form-group">
                    <input type="text" class="form-input" id="editInput" value="${u.power}" inputmode="numeric">
                    <p style="font-size:12px; color:#6b7280; margin-top:8px;">â€» ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </div>
            `);
            setTimeout(() => { const i=document.getElementById('editInput'); i.focus(); i.select(); }, 100);
            
            document.getElementById('modalSubmit').onclick = async () => {
                const inputVal = document.getElementById('editInput').value.replace(/,/g, "").trim();
                
                // ë¹ˆ ê°’ ì²´í¬
                if (!inputVal) {
                    showAlert('ì „íˆ¬ë ¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì í¬í•¨ ì—¬ë¶€ ì²´í¬
                if (!/^\d+$/.test(inputVal)) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const val = Number(inputVal);
                
                // NaN ì²´í¬ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
                if (isNaN(val)) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                // ìŒìˆ˜ ì²´í¬
                if (val < 0) {
                    showAlert('ìˆ˜ì • ë¶ˆê°€ëŠ¥: ì „íˆ¬ë ¥ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                    return;
                }
                
                try {
                    await updateDoc(doc(db, "users", name), { 
                        power: val,
                        updatedAt: Date.now(),
                        updatedBy: isAdmin ? 'admin' : 'user'
                    });
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'power', 
                        old_value: u.power, 
                        new_value: val, 
                        createdAt: Date.now(), 
                        ip: await getIp(), 
                        device: navigator.userAgent 
                    });
                    closeModal(); 
                    showAlert('ìˆ˜ì • ì™„ë£Œ', 'success'); 
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(u.guild);
                    }, 500);
                } catch (e) { 
                    showAlert('ì˜¤ë¥˜ ë°œìƒ', 'error'); 
                }
            };
        }

        // --- ê´€ë¦¬ì ë¡œê·¸ì¸ ë° ë¡œê·¸ì•„ì›ƒ ---
        document.getElementById('adminLoginBtn').addEventListener('click', () => {
            if(isAdmin) { 
                openSmallModal('ë¡œê·¸ì•„ì›ƒ', 'ê´€ë¦¬ì ê¶Œí•œì„ í•´ì œí•©ë‹ˆë‹¤', `<div style="text-align:center; padding:10px 0; color:#374151;">ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>`);
                const btn = document.getElementById('modalSubmit');
                btn.innerText = "ë¡œê·¸ì•„ì›ƒ"; 
                btn.style.backgroundColor = "#ef4444";
                btn.onclick = () => { 
                    sessionStorage.removeItem('isAdmin');
                    sessionStorage.removeItem('isSuperAdmin');
                    showAlert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); 
                    closeModal(); 
                    setTimeout(() => location.reload(), 500); 
                };
                return; 
            }
            openSmallModal('ê´€ë¦¬ì ë¡œê·¸ì¸', '', `<div class="form-group"><input type="text" class="form-input" id="aid" placeholder="ID"></div><div class="form-group"><input type="password" class="form-input" id="apw" placeholder="PW"></div>`);
            const btn = document.getElementById('modalSubmit'); 
            btn.innerText = "í™•ì¸"; 
            btn.style.backgroundColor = "";
            btn.onclick = async () => {
                const inputId = document.getElementById('aid').value;
                const inputPw = document.getElementById('apw').value;
                
                // 1. ìµœì¢… ê´€ë¦¬ì(ìŠˆí¼ ê´€ë¦¬ì) ì²´í¬
                if (btoa(inputId) === SUPER_ADMIN_HASH.id && btoa(inputPw) === SUPER_ADMIN_HASH.pw) {
                    isAdmin = true;
                    isSuperAdmin = true;
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('isSuperAdmin', 'true');
                    updateAdminUI(); 
                    closeModal(); 
                    showAlert('ìµœì¢… ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    await checkPendingUsers();
                    return;
                }
                
                // 2. ì¼ë°˜ ê´€ë¦¬ì ì²´í¬ (Firebase admins ì»¬ë ‰ì…˜)
                try {
                    const adminDoc = await getDoc(doc(db, "admins", inputId));
                    if (adminDoc.exists() && adminDoc.data().password === inputPw) {
                        isAdmin = true;
                        isSuperAdmin = false;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.removeItem('isSuperAdmin');
                        updateAdminUI();
                        closeModal();
                        showAlert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        await checkPendingUsers();
                        return;
                    }
                } catch (e) {
                    console.error('Admin check error:', e);
                }
                
                showAlert('ì •ë³´ ë¶ˆì¼ì¹˜', 'error');
            };
        });

        // --- ê¸°íƒ€ ê¸°ëŠ¥ (ê¸¸ë“œì¶”ê°€, ì—‘ì…€, ì ê¸ˆ ë“±) ---
        document.getElementById('guildAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            openSmallModal('ê¸¸ë“œ ì¶”ê°€', '', `<div class="form-group"><input type="text" class="form-input" id="newGuildInput"></div>`);
            setTimeout(() => document.getElementById('newGuildInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('newGuildInput').value.trim();
                if(!name || guildList.includes(name)) { showAlert('ìœ íš¨í•˜ì§€ ì•ŠìŒ', 'error'); return; }
                await updateDoc(doc(db, "config", "guilds"), { names: [...guildList, name] });
                showAlert('ì¶”ê°€ë¨', 'success'); closeModal(); setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('excelBtn').addEventListener('click', () => {
            if(!isAdmin || allGuildData.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(allGuildData.map(u => ({ 
                'ê¸¸ë“œ': u.guild, 
                'ë‹‰ë„¤ì„': u.name, 
                'ì „íˆ¬ë ¥': u.power, 
                'í˜•ìƒì „ì„¤': u.shape_legend || 0, 
                'í˜•ìƒì‹ í™”': u.shape_myth || 0, 
                'íƒˆê²ƒì „ì„¤': u.mount_legend || 0, 
                'íƒˆê²ƒì‹ í™”': u.mount_myth || 0 
            })));
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "ê¸¸ë“œí˜„í™©"); 
            XLSX.writeFile(wb, "ê¸¸ë“œ_ì „íˆ¬ë ¥_í˜„í™©.xlsx");
        });

        // --- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ê¸°ëŠ¥ ---
        document.getElementById('spreadsheetBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openSpreadsheetSettingsModal();
        });

        async function openSpreadsheetSettingsModal() {
            const currentConfig = spreadsheetConfig || {};
            const sheetId = currentConfig.sheetId || '1ySgXwqwDGSW3c9gh8LVYPDBmdkh27q9JmVKId8gQ6uI';
            const webAppUrl = currentConfig.webAppUrl || '';
            const autoSync = currentConfig.autoSync !== false; // ê¸°ë³¸ê°’ true
            
            // ê¸¸ë“œë³„ ì‹œíŠ¸ ë§¤í•‘ ì…ë ¥ í•„ë“œ ìƒì„±
            let sheetMappingHtml = '<div class="form-group"><label class="form-label">ì‹œíŠ¸ íƒ­ ë§¤í•‘ (ê¸¸ë“œëª…: ì‹œíŠ¸íƒ­ëª…)</label>';
            guildList.forEach(guild => {
                // ì‚¬ì‹ ë§Œ ê°œë³„ ì‹œíŠ¸, ë‚˜ë¨¸ì§€ëŠ” ë¹„ì›Œë‘  (ì „ì²´ ì‹œíŠ¸ì—ë§Œ í¬í•¨)
                let defaultSheet = '';
                if (guild === 'ì‚¬ì‹ ') {
                    defaultSheet = 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì‚¬ì‹ )';
                }
                const mappedSheet = (currentConfig.sheetMappings && currentConfig.sheetMappings[guild]) || defaultSheet;
                sheetMappingHtml += `
                    <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                        <input type="text" class="form-input" value="${guild}" readonly style="flex:1; background:#f3f4f6;">
                        <span style="color:#6b7280;">â†’</span>
                        <input type="text" class="form-input sheet-mapping" data-guild="${guild}" value="${mappedSheet}" placeholder="${guild === 'ì‚¬ì‹ ' ? 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì‚¬ì‹ )' : '(ì „ì²´ ì‹œíŠ¸ì—ë§Œ í¬í•¨)'}" style="flex:2;">
                    </div>
                `;
            });
            
            // "ì „ì²´" íƒ­ ì¶”ê°€
            const allSheetName = (currentConfig.sheetMappings && currentConfig.sheetMappings['ì „ì²´']) || 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì „ì²´)';
            sheetMappingHtml += `
                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                    <input type="text" class="form-input" value="ì „ì²´" readonly style="flex:1; background:#f3f4f6;">
                    <span style="color:#6b7280;">â†’</span>
                    <input type="text" class="form-input sheet-mapping" data-guild="ì „ì²´" value="${allSheetName}" placeholder="ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì „ì²´)" style="flex:2;">
                </div>
            `;
            sheetMappingHtml += '</div>';

            const html = `
                <div class="form-group">
                    <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
                    <input type="text" id="sheetId" class="form-input" value="${sheetId}" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì˜ /d/ ë’¤ ID">
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">ì˜ˆ: docs.google.com/spreadsheets/d/<b>ì—¬ê¸°IDë¶€ë¶„</b>/edit</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Google Apps Script ì›¹ì•± URL</label>
                    <input type="text" id="webAppUrl" class="form-input" value="${webAppUrl}" placeholder="https://script.google.com/macros/s/.../exec">
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">Apps Script ë°°í¬ í›„ ë°›ì€ ì›¹ì•± URL</p>
                </div>
                ${sheetMappingHtml}
                <div class="form-group">
                    <label class="checkbox-label" style="background:none; padding:0;">
                        <input type="checkbox" id="autoSync" ${autoSync ? 'checked' : ''}>
                        ë°ì´í„° ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë™ê¸°í™”
                    </label>
                </div>
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="window.testSpreadsheetSync()" style="flex:1;">ğŸ§ª ì—°ë™ í…ŒìŠ¤íŠ¸</button>
                    <button class="btn btn-success" onclick="window.syncAllToSpreadsheet()" style="flex:1;">ğŸ”„ ì „ì²´ ë™ê¸°í™”</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; padding:10px; background:#f9fafb; border-radius:6px;">
                    <b>ì„¤ì • ë°©ë²•:</b><br>
                    1. ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ "í™•ì¥ í”„ë¡œê·¸ë¨" > "Apps Script" ì„ íƒ<br>
                    2. ì œê³µëœ GoogleAppsScript.gs ì½”ë“œ ë¶™ì—¬ë„£ê¸°<br>
                    3. "ë°°í¬" > "ìƒˆ ë°°í¬" > "ì›¹ ì•±" ì„ íƒ<br>
                    4. "ì•¡ì„¸ìŠ¤ ê¶Œí•œ" > "ëª¨ë“  ì‚¬ìš©ì" ì„ íƒ<br>
                    5. ë°°í¬ í›„ ë°›ì€ URLì„ ìœ„ì— ì…ë ¥
                </p>
            `;

            openLargeModal('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì •', 'êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìë™ ë™ê¸°í™”');
            setModalBody(html);

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";

            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "ë‹«ê¸°";
            closeBtn.onclick = closeModal;

            const saveBtn = document.createElement('button');
            saveBtn.className = "btn btn-primary";
            saveBtn.innerText = "ğŸ’¾ ì„¤ì • ì €ì¥";
            saveBtn.onclick = saveSpreadsheetSettings;

            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(saveBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        }

        async function saveSpreadsheetSettings() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const autoSync = document.getElementById('autoSync').checked;

            if (!sheetId || !webAppUrl) {
                showAlert('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDì™€ ì›¹ì•± URLì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // ì‹œíŠ¸ ë§¤í•‘ ìˆ˜ì§‘
            const sheetMappings = {};
            document.querySelectorAll('.sheet-mapping').forEach(input => {
                const guild = input.dataset.guild;
                const sheetName = input.value.trim();
                if (sheetName) {
                    sheetMappings[guild] = sheetName;
                }
            });

            const config = {
                sheetId,
                webAppUrl,
                autoSync,
                sheetMappings
            };

            try {
                await setDoc(doc(db, "config", "spreadsheet"), config);
                spreadsheetConfig = config;
                showAlert('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                closeModal();
            } catch (e) {
                console.error(e);
                showAlert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        window.testSpreadsheetSync = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('ë¨¼ì € ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •ì„ ì €ì¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // ì²« ë²ˆì§¸ ê¸¸ë“œë¡œ í…ŒìŠ¤íŠ¸
            const testGuild = guildList[0];
            const testUsers = allGuildData.filter(u => u.guild === testGuild).slice(0, 5);

            if (testUsers.length === 0) {
                showAlert('í…ŒìŠ¤íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const sheetName = spreadsheetConfig.sheetMappings[testGuild] || `ì „íˆ¬ë ¥ ì ìˆ˜ì œ(${testGuild})`;

            try {
                showAlert('í…ŒìŠ¤íŠ¸ ì¤‘...', 'success');
                const result = await syncToSpreadsheet(testUsers, sheetName);
                if (result.success) {
                    showAlert(`í…ŒìŠ¤íŠ¸ ì„±ê³µ! ${result.message}`, 'success');
                } else {
                    showAlert(`í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message, 'error');
            }
        };

        window.syncAllToSpreadsheet = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('ë¨¼ì € ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •ì„ ì €ì¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (!await showConfirm('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë™ê¸°í™”', 'ëª¨ë“  ë°ì´í„°ë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                showAlert('ë™ê¸°í™” ì¤‘...', 'success');
                let successCount = 0;
                let failCount = 0;

                // ê° ê¸¸ë“œë³„ë¡œ ë™ê¸°í™”
                for (const guild of guildList) {
                    const guildUsers = allGuildData.filter(u => u.guild === guild);
                    const sheetName = spreadsheetConfig.sheetMappings[guild] || `ì „íˆ¬ë ¥ ì ìˆ˜ì œ(${guild})`;
                    
                    try {
                        const result = await syncToSpreadsheet(guildUsers, sheetName);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error(`Failed to sync ${guild}:`, result.error);
                        }
                    } catch (e) {
                        failCount++;
                        console.error(`Error syncing ${guild}:`, e);
                    }
                    
                    // API ìš”ì²­ ê°„ê²© (ê³¼ë¶€í•˜ ë°©ì§€)
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // ì „ì²´ íƒ­ ë™ê¸°í™”
                const allSheetName = spreadsheetConfig.sheetMappings['ì „ì²´'] || 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì „ì²´)';
                try {
                    const result = await syncToSpreadsheet(allGuildData, allSheetName);
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (e) {
                    failCount++;
                    console.error('Error syncing all:', e);
                }

                if (failCount === 0) {
                    showAlert(`âœ… ì „ì²´ ë™ê¸°í™” ì™„ë£Œ! (${successCount}ê°œ ì‹œíŠ¸)`, 'success');
                } else {
                    showAlert(`âš ï¸ ë™ê¸°í™” ì™„ë£Œ (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount})`, 'error');
                }

                await setDoc(doc(collection(db, "logs")), {
                    who: 'Admin',
                    type: 'spreadsheet_sync',
                    old_value: '-',
                    new_value: `ì „ì²´ ë™ê¸°í™” (ì„±ê³µ:${successCount}, ì‹¤íŒ¨:${failCount})`,
                    createdAt: Date.now(),
                    ip: await getIp()
                });

            } catch (e) {
                console.error(e);
                showAlert('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        };

        async function syncToSpreadsheet(users, sheetName) {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                return { success: false, error: 'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤' };
            }

            const payload = {
                sheetId: spreadsheetConfig.sheetId,
                sheetName: sheetName,
                users: users.map(u => ({
                    guild: u.guild,
                    name: u.name,
                    power: u.power,
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                }))
            };

            try {
                const response = await fetch(spreadsheetConfig.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', // CORS ìš°íšŒ
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
                return { success: true, message: `${users.length}ê°œ ë°ì´í„° ì „ì†¡` };

            } catch (e) {
                console.error('Sync error:', e);
                return { success: false, error: e.message };
            }
        }

        // ìë™ ë™ê¸°í™” í•¨ìˆ˜ (ë°ì´í„° ë³€ê²½ ì‹œ í˜¸ì¶œ)
        async function autoSyncIfEnabled(guild = null) {
            if (!spreadsheetConfig || !spreadsheetConfig.autoSync) {
                return;
            }

            try {
                if (guild) {
                    // íŠ¹ì • ê¸¸ë“œë§Œ ë™ê¸°í™”
                    const guildUsers = allGuildData.filter(u => u.guild === guild);
                    const sheetName = spreadsheetConfig.sheetMappings[guild] || `ì „íˆ¬ë ¥ ì ìˆ˜ì œ(${guild})`;
                    await syncToSpreadsheet(guildUsers, sheetName);
                }
                
                // ì „ì²´ íƒ­ë„ ë™ê¸°í™”
                const allSheetName = spreadsheetConfig.sheetMappings['ì „ì²´'] || 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì „ì²´)';
                await syncToSpreadsheet(allGuildData, allSheetName);
                
            } catch (e) {
                console.error('Auto sync error:', e);
            }
        }

        // êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì„¤ì •
        document.getElementById('sheetSyncBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openGoogleSheetSettings();
        });

        async function openGoogleSheetSettings() {
            openLargeModal('êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì„¤ì •', 'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ ì„¤ì •');
            
            // ê¸°ì¡´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const configRef = doc(db, "config", "googleSheet");
            const configSnap = await getDoc(configRef);
            let config = { scriptUrl: '', sheetId: '', sheetName: 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ', enabled: false };
            if (configSnap.exists()) {
                config = { ...config, ...configSnap.data() };
            }

            const html = `
                <div class="form-group">
                    <label class="form-label">Google Apps Script ì›¹ì•± URL</label>
                    <input type="text" id="scriptUrl" class="form-input" value="${config.scriptUrl || ''}" placeholder="https://script.google.com/...">
                    <p style="font-size:12px; color:#6b7280; margin-top:4px;">â€» Apps Script ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
                <div class="form-group">
                    <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
                    <input type="text" id="sheetId" class="form-input" value="${config.sheetId || ''}" placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URLì—ì„œ /d/ ë’¤ì˜ ID">
                    <p style="font-size:12px; color:#6b7280; margin-top:4px;">â€» ì˜ˆ: https://docs.google.com/spreadsheets/d/<strong>ì—¬ê¸°ID</strong>/edit</p>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œíŠ¸(íƒ­) ì´ë¦„</label>
                    <input type="text" id="sheetName" class="form-input" value="${config.sheetName || 'ì „íˆ¬ë ¥ ì ìˆ˜ì œ'}" placeholder="ì „íˆ¬ë ¥ ì ìˆ˜ì œ">
                    <p style="font-size:12px; color:#6b7280; margin-top:4px;">â€» ë°ì´í„°ê°€ ì…ë ¥ë  ì‹œíŠ¸ íƒ­ ì´ë¦„ (ì˜ˆ: ì „íˆ¬ë ¥ ì ìˆ˜ì œ, ì „íˆ¬ë ¥ ì ìˆ˜ì œ(ì „ì²´) ë“±)</p>
                </div>
                <div class="form-group">
                    <label class="form-label">ìë™ ë™ê¸°í™”</label>
                    <select id="autoSync" class="form-input">
                        <option value="true" ${config.enabled ? 'selected' : ''}>í™œì„±í™” (ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ì „ì†¡)</option>
                        <option value="false" ${!config.enabled ? 'selected' : ''}>ë¹„í™œì„±í™” (ìˆ˜ë™ë§Œ ê°€ëŠ¥)</option>
                    </select>
                </div>
                <div style="margin-top:20px; padding:15px; background:#eff6ff; border-radius:8px; border-left:4px solid #3b82f6;">
                    <p style="font-size:13px; color:#1e40af; margin-bottom:8px;"><strong>ğŸ“ ì„¤ì • ë°©ë²•:</strong></p>
                    <ol style="font-size:12px; color:#1e40af; margin-left:20px; line-height:1.8;">
                        <li>êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—½ë‹ˆë‹¤</li>
                        <li>ìƒë‹¨ ë©”ë‰´ì—ì„œ "í™•ì¥ í”„ë¡œê·¸ë¨" â†’ "Apps Script" í´ë¦­</li>
                        <li>ì œê³µëœ Apps Script ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤</li>
                        <li>"ë°°í¬" â†’ "ìƒˆ ë°°í¬" â†’ "ì›¹ ì•±" ì„ íƒ</li>
                        <li>"ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì" ì„ íƒ í›„ ë°°í¬</li>
                        <li>ìƒì„±ëœ ì›¹ì•± URLì„ ìœ„ì— ì…ë ¥í•©ë‹ˆë‹¤</li>
                    </ol>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-primary" id="saveSheetConfig" style="flex:1">ğŸ’¾ ì„¤ì • ì €ì¥</button>
                    <button class="btn btn-success" id="testSync" style="flex:1">ğŸ”„ ì§€ê¸ˆ ë™ê¸°í™”</button>
                    <button class="btn btn-cancel" onclick="closeModal()">ë‹«ê¸°</button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;

            // ì„¤ì • ì €ì¥
            document.getElementById('saveSheetConfig').onclick = async () => {
                const scriptUrl = document.getElementById('scriptUrl').value.trim();
                const sheetId = document.getElementById('sheetId').value.trim();
                const sheetName = document.getElementById('sheetName').value.trim();
                const enabled = document.getElementById('autoSync').value === 'true';

                if (!scriptUrl || !sheetId || !sheetName) {
                    showAlert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                try {
                    await setDoc(configRef, {
                        scriptUrl: scriptUrl,
                        sheetId: sheetId,
                        sheetName: sheetName,
                        enabled: enabled,
                        updatedAt: Date.now()
                    });
                    showAlert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } catch (e) {
                    console.error(e);
                    showAlert('ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            };

            // ì¦‰ì‹œ ë™ê¸°í™”
            document.getElementById('testSync').onclick = async () => {
                const scriptUrl = document.getElementById('scriptUrl').value.trim();
                const sheetId = document.getElementById('sheetId').value.trim();
                const sheetName = document.getElementById('sheetName').value.trim();

                if (!scriptUrl || !sheetId || !sheetName) {
                    showAlert('ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”', 'error');
                    return;
                }

                await syncToGoogleSheet(scriptUrl, sheetId, sheetName);
            };
        }

        // êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°ì´í„° ì „ì†¡
        async function syncToGoogleSheet(scriptUrl, sheetId, sheetName) {
            if (!scriptUrl || !sheetId || !sheetName) {
                showAlert('êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }

            // ì§„í–‰ìƒí™© íŒì—… í‘œì‹œ
            openSmallModal('êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”', 'ì§„í–‰ ì¤‘...', `
                <div style="text-align:center; padding:30px;">
                    <div id="syncIcon" style="font-size:40px; margin-bottom:15px;">â³</div>
                    <p id="syncStatus" style="font-size:16px; color:#374151; margin-bottom:10px;">ë°ì´í„° ì¤€ë¹„ ì¤‘...</p>
                    <p id="syncDetail" style="font-size:13px; color:#6b7280;"></p>
                    <div style="margin-top:20px; background:#e5e7eb; border-radius:10px; height:10px; overflow:hidden;">
                        <div id="syncProgress" style="background:#3b82f6; height:100%; width:0%; transition:width 0.5s;"></div>
                    </div>
                </div>
            `);
            document.getElementById('modalFooter').style.display = 'none';

            try {
                await new Promise(r => setTimeout(r, 300));
                
                // ì „íˆ¬ë ¥ ìˆœìœ¼ë¡œ ì •ë ¬
                const sortedData = [...allGuildData].sort((a, b) => b.power - a.power);
                
                document.getElementById('syncStatus').textContent = 'ë°ì´í„° ì •ë ¬ ì™„ë£Œ';
                document.getElementById('syncDetail').textContent = `ì´ ${sortedData.length}ëª… â†’ [${sheetName}] ì‹œíŠ¸`;
                document.getElementById('syncProgress').style.width = '20%';
                
                await new Promise(r => setTimeout(r, 500));

                // ê¸¸ë“œë³„ ë°°ê²½ìƒ‰ ì •ì˜
                const guildColors = {
                    'ì‚¬ì‹ ': '#fff2cc',
                    'ì¶•ë³µ': '#cfe2f3',
                    'ë†€ì': '#d9ead3',
                    'ë£¨ë¹„': '#f4cccc'
                };
                const defaultColors = ['#e4d7f5', '#fce5cd', '#d0e0e3', '#ead1dc'];
                let colorIdx = 0;
                sortedData.forEach(user => {
                    if (!guildColors[user.guild]) {
                        guildColors[user.guild] = defaultColors[colorIdx % defaultColors.length];
                        colorIdx++;
                    }
                });

                document.getElementById('syncStatus').textContent = 'êµ¬ê¸€ ì‹œíŠ¸ë¡œ ì „ì†¡ ì¤‘...';
                document.getElementById('syncProgress').style.width = '40%';
                
                await new Promise(r => setTimeout(r, 300));

                // ì „ì²´ ë°ì´í„° ì¤€ë¹„
                const payload = {
                    sheetId: sheetId,
                    sheetName: sheetName,
                    users: sortedData.map(user => ({
                        guild: user.guild,
                        name: user.name,
                        power: user.power,
                        shape_legend: user.shape_legend || 0,
                        shape_myth: user.shape_myth || 0,
                        mount_legend: user.mount_legend || 0,
                        mount_myth: user.mount_myth || 0,
                        bgColor: guildColors[user.guild] || '#ffffff'
                    }))
                };

                // iframe + form ë°©ì‹ìœ¼ë¡œ ì „ì†¡ (CORS ìš°íšŒ)
                const iframeName = 'syncFrame_' + Date.now();
                const iframe = document.createElement('iframe');
                iframe.name = iframeName;
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = scriptUrl;
                form.target = iframeName;
                form.style.display = 'none';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'data';
                input.value = JSON.stringify(payload);
                form.appendChild(input);

                document.body.appendChild(form);
                
                document.getElementById('syncStatus').textContent = 'ì„œë²„ì—ì„œ ì²˜ë¦¬ ì¤‘...';
                document.getElementById('syncProgress').style.width = '60%';
                
                // í¼ ì œì¶œ
                form.submit();

                // ì²˜ë¦¬ ëŒ€ê¸°
                await new Promise(r => setTimeout(r, 2000));
                
                document.getElementById('syncProgress').style.width = '80%';
                document.getElementById('syncStatus').textContent = 'ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì¤‘...';
                
                await new Promise(r => setTimeout(r, 2000));
                
                document.getElementById('syncProgress').style.width = '100%';

                // ì •ë¦¬
                setTimeout(() => {
                    if (form.parentNode) document.body.removeChild(form);
                    if (iframe.parentNode) document.body.removeChild(iframe);
                }, 1000);
                
                // ì„±ê³µ í‘œì‹œ
                document.getElementById('modalBody').innerHTML = `
                    <div style="text-align:center; padding:30px;">
                        <div style="font-size:50px; margin-bottom:15px;">âœ…</div>
                        <p style="font-size:18px; font-weight:600; color:#059669; margin-bottom:10px;">ë™ê¸°í™” ì™„ë£Œ!</p>
                        <p style="font-size:14px; color:#6b7280;">${sortedData.length}ëª…ì˜ ë°ì´í„°ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <p style="font-size:12px; color:#9ca3af; margin-top:8px;">ì‹œíŠ¸: ${sheetName}</p>
                        <button class="btn btn-primary" onclick="closeModal()" style="margin-top:20px;">í™•ì¸</button>
                    </div>
                `;
                
                // ë¡œê·¸ ê¸°ë¡
                await setDoc(doc(collection(db, "logs")), {
                    who: isSuperAdmin ? 'SuperAdmin' : 'Admin',
                    type: 'google_sheet_sync',
                    old_value: '-',
                    new_value: `${sortedData.length}ëª… â†’ ${sheetName}`,
                    createdAt: Date.now(),
                    ip: await getIp()
                });

            } catch (e) {
                console.error('Google Sheet Sync Error:', e);
                document.getElementById('modalBody').innerHTML = `
                    <div style="text-align:center; padding:30px;">
                        <div style="font-size:50px; margin-bottom:15px;">âŒ</div>
                        <p style="font-size:18px; font-weight:600; color:#dc2626; margin-bottom:10px;">ë™ê¸°í™” ì‹¤íŒ¨</p>
                        <p style="font-size:14px; color:#6b7280;">Apps Script ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                        <p style="font-size:12px; color:#9ca3af; margin-top:10px;">${e.message || e}</p>
                        <button class="btn btn-primary" onclick="closeModal()" style="margin-top:20px;">í™•ì¸</button>
                    </div>
                `;
            }
        }

        // ìë™ ë™ê¸°í™” í•¨ìˆ˜

        document.getElementById('lockManageBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            
            let statusMsg = '';
            if (lockStartTime > 0 && lockEndTime > 0) {
                statusMsg = `í˜„ì¬ ì„¤ì •: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
            } else {
                statusMsg = 'í˜„ì¬ ì ê¸ˆ ì„¤ì • ì—†ìŒ';
            }

            const startValue = lockStartTime > 0 ? toDatetimeLocalValue(lockStartTime) : '';
            const endValue = lockEndTime > 0 ? toDatetimeLocalValue(lockEndTime) : '';

            openSmallModal('ì ê¸ˆ ì„¤ì • (KST ê¸°ì¤€)', '', `
                <div style="margin-bottom:15px; color:#374151; font-size:13px; padding:10px; background:#f9fafb; border-radius:8px;">${statusMsg}</div>
                <div class="form-group">
                    <label class="form-label">ì ê¸ˆ ì‹œì‘ ì‹œê°„ (KST)</label>
                    <input type="datetime-local" id="lockStartInput" class="form-input" value="${startValue}">
                </div>
                <div class="form-group">
                    <label class="form-label">ì ê¸ˆ ì¢…ë£Œ ì‹œê°„ (KST)</label>
                    <input type="datetime-local" id="lockEndInput" class="form-input" value="${endValue}">
                </div>
                <div class="form-group">
                    <button id="unlockBtn" class="btn btn-cancel" style="width:100%">ğŸ”“ ì ê¸ˆ í•´ì œ</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">â€» í•œêµ­ í‘œì¤€ì‹œ(KST) ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</p>
            `);

            document.getElementById('unlockBtn').onclick = async () => { 
                if(!await showConfirm('ì ê¸ˆ í•´ì œ', 'ì ê¸ˆì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; 
                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: 0, 
                    lockEndTime: 0 
                }); 
                showAlert('ì ê¸ˆì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000); 
            };

            document.getElementById('modalSubmit').onclick = async () => {
                const startVal = document.getElementById('lockStartInput').value;
                const endVal = document.getElementById('lockEndInput').value;
                
                if (!startVal || !endVal) { 
                    showAlert('ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”', 'error'); 
                    return; 
                }

                const startTime = fromKST(startVal);
                const endTime = fromKST(endVal);

                if (endTime <= startTime) {
                    showAlert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤', 'error');
                    return;
                }

                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: startTime,
                    lockEndTime: endTime
                });
                
                showAlert('ì ê¸ˆì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('userManageBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ìœ ì € ê´€ë¦¬', 'ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ ë° í•„í„°');
            const snap = await getDocs(collection(db, "users")); 
            let users = []; 
            snap.forEach(d => users.push(d.data())); 
            
            // ì´ˆê¸° ì •ë ¬: ê°€ë‚˜ë‹¤ìˆœ
            users.sort((a,b)=>a.name.localeCompare(b.name));
            
            let html = `
                <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                    <div class="form-group" style="flex:2; margin-bottom:0;">
                        <input type="text" id="modalSearchInput" class="form-input" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰...">
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="guildFilter" class="form-input">
                            <option value="">ì „ì²´ ê¸¸ë“œ</option>
                            ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="pwFilter" class="form-input">
                            <option value="">ë¹„ë°€ë²ˆí˜¸ ì „ì²´</option>
                            <option value="set">ì„¤ì •ë¨</option>
                            <option value="unset">ë¯¸ì„¤ì •</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="sortOrder" class="form-input">
                            <option value="name">ê°€ë‚˜ë‹¤ìˆœ</option>
                            <option value="updated">ìµœê·¼ ê°±ì‹ ìˆœ</option>
                        </select>
                    </div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">ì´ <span id="userCount">${users.length}</span>ëª…</p>
                <div class="table-scroll-container">
                    <table class="common-table" id="userManageTable">
                        <thead>
                            <tr>
                                <th style="width:25%;">ë‹‰ë„¤ì„</th>
                                <th style="width:15%;">ê¸¸ë“œ</th>
                                <th style="width:15%;">ë¹„ë°€ë²ˆí˜¸</th>
                                <th style="width:25%;">ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬</th>
                                <th style="width:20%;">ë“±ë¡ í•´ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="userManageTableBody"></tbody>
                    </table>
                </div>
            `;
            
            setModalBody(html);
            
            // í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
            function renderUserTable(filteredUsers) {
                const tbody = document.getElementById('userManageTableBody');
                tbody.innerHTML = '';
                
                filteredUsers.forEach(u => {
                    const pwStatus = u.password 
                        ? '<span style="color:#10b981; font-weight:600;">âœ“ ì„¤ì •ë¨</span>' 
                        : '<span style="color:#ef4444; font-weight:600;">âœ— ë¯¸ì„¤ì •</span>';
                    
                    const resetBtn = u.password 
                        ? `<button class="btn-reset-pw" onclick="window.resetUserPw('${u.name}')">ì´ˆê¸°í™”</button>` 
                        : '-';
                    
                    const deleteBtn = `<button class="btn-delete" onclick="window.deleteUser('${u.name}')" style="background:#ef4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s;">ğŸ—‘ï¸ ë“±ë¡ í•´ì œ</button>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td>${pwStatus}</td>
                        <td>${resetBtn}</td>
                        <td>${deleteBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('userCount').textContent = filteredUsers.length;
            }
            
            // í•„í„°ë§ ë° ì •ë ¬ í•¨ìˆ˜
            function applyFiltersAndSort() {
                const searchText = document.getElementById('modalSearchInput').value.toLowerCase();
                const guildFilter = document.getElementById('guildFilter').value;
                const pwFilter = document.getElementById('pwFilter').value;
                const sortOrder = document.getElementById('sortOrder').value;
                
                let filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    const matchPw = !pwFilter || 
                        (pwFilter === 'set' && u.password) || 
                        (pwFilter === 'unset' && !u.password);
                    
                    return matchSearch && matchGuild && matchPw;
                });
                
                // ì •ë ¬
                if (sortOrder === 'name') {
                    filtered.sort((a,b) => a.name.localeCompare(b.name));
                } else if (sortOrder === 'updated') {
                    filtered.sort((a,b) => {
                        const aTime = (a.updatedAt && a.updatedBy !== 'admin') ? a.updatedAt : 0;
                        const bTime = (b.updatedAt && b.updatedBy !== 'admin') ? b.updatedAt : 0;
                        return bTime - aTime;  // ìµœì‹ ìˆœ
                    });
                }
                
                renderUserTable(filtered);
            }
            
            // ì´ˆê¸° ë Œë”ë§
            renderUserTable(users);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('modalSearchInput').addEventListener('input', applyFiltersAndSort);
            document.getElementById('guildFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('pwFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndSort);
        });

        window.resetUserPw = async function(n) { 
            if(!await showConfirm('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”', `[${n}]ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return; 
            await updateDoc(doc(db, "users", n), { password: null }); 
            showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); 
            closeModal(); 
            setTimeout(() => location.reload(), 1000); 
        };

        // ì‚¬ìš©ì ë“±ë¡ í•´ì œ (ì •ë³´ ì˜êµ¬ ë³´ê´€)
        window.deleteUser = async function(name) {
            // ì‚­ì œ í™•ì¸
            if(!await showConfirm('ì‚¬ìš©ì ë“±ë¡ í•´ì œ', `<span style="color:#ef4444; font-weight:600;">[${name}]ë‹˜ì„ ë“±ë¡ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span><br><br>â€¢ ì‚¬ìš©ì ì •ë³´ëŠ” ì˜êµ¬ ë³´ê´€ë©ë‹ˆë‹¤<br>â€¢ ì‚­ì œëœ ì‚¬ìš©ì ëª©ë¡ì—ì„œ í™•ì¸ ê°€ëŠ¥<br>â€¢ ë³µêµ¬ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤`)) return;
            
            // ì‚­ì œ ì‚¬ìœ  ì…ë ¥
            openSmallModal('ë“±ë¡ í•´ì œ ì‚¬ìœ ', 'ì„ íƒì‚¬í•­ - ë‚˜ì¤‘ì— ì°¸ê³ ìš©', `
                <div class="form-group">
                    <label class="form-label">ì‚¬ìœ  (ì„ íƒì‚¬í•­)</label>
                    <select id="deleteReason" class="form-input">
                        <option value="ìì§„ íƒˆí‡´">ìì§„ íƒˆí‡´</option>
                        <option value="ì¥ê¸° ë¯¸ì ‘ì†">ì¥ê¸° ë¯¸ì ‘ì†</option>
                        <option value="ê¸¸ë“œ ì´ë™">ê¸¸ë“œ ì´ë™</option>
                        <option value="ê·œì • ìœ„ë°˜">ê·œì • ìœ„ë°˜</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒì„¸ ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                    <textarea id="deleteMemo" class="form-input" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨..."></textarea>
                </div>
            `);
            
            document.getElementById('modalSubmit').onclick = async () => {
                const reason = document.getElementById('deleteReason').value;
                const memo = document.getElementById('deleteMemo').value.trim();
                
                try {
                    // 1. ì‚­ì œ ì „ì— ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const userDoc = await getDoc(doc(db, "users", name));
                    if (!userDoc.exists()) {
                        showAlert('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // 2. deletedUsers ì»¬ë ‰ì…˜ì— ë°±ì—… ì €ì¥
                    await setDoc(doc(collection(db, "deletedUsers")), {
                        ...userData,  // ëª¨ë“  ì‚¬ìš©ì ì •ë³´
                        deletedAt: Date.now(),
                        deletedBy: 'admin',
                        deleteReason: reason,
                        deleteMemo: memo || '',
                        originalName: name,
                        deletedIp: await getIp(),
                        deletedDevice: navigator.userAgent
                    });
                    
                    // 3. users ì»¬ë ‰ì…˜ì—ì„œ ì‚­ì œ
                    await deleteDoc(doc(db, "users", name));
                    
                    // 4. ë¡œê·¸ ê¸°ë¡
                    await setDoc(doc(collection(db, "logs")), {
                        who: name,
                        type: 'user_deleted',
                        old_value: 'ì‚¬ìš©ì ì¡´ì¬',
                        new_value: `ë“±ë¡ í•´ì œ (ì‚¬ìœ : ${reason})`,
                        createdAt: Date.now(),
                        ip: await getIp(),
                        device: navigator.userAgent
                    });
                    
                    showAlert('ë“±ë¡ í•´ì œ ì™„ë£Œ (ì •ë³´ëŠ” ì˜êµ¬ ë³´ê´€ë¨)', 'success');
                    closeModal();
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    console.error('Delete error:', e);
                    showAlert('ë“±ë¡ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            };
        };


        document.getElementById('logViewBtn').addEventListener('click', async () => {
            if(!isAdmin) return; 
            openLargeModal('ë¡œê·¸', 'ì „ì²´ ë¡œê·¸ (ê²€ìƒ‰ ê°€ëŠ¥)');
            
            // limit ì œê±°í•˜ì—¬ ëª¨ë“  ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
            const snap = await getDocs(query(collection(db, "logs"), orderBy("createdAt", "desc")));
            
            const logs = [];
            snap.forEach(d => { 
                const l = d.data(); 
                logs.push({
                    time: formatDateTime(l.createdAt),
                    who: l.who || '-',
                    type: l.type || '-',
                    oldValue: l.old_value || '-',
                    newValue: l.new_value || '-',
                    ip: l.ip || '-',
                    device: l.device || '-'
                });
            });
            
            // ë¡œê·¸ íƒ€ì… í•œê¸€ ë³€í™˜ í•¨ìˆ˜
            function formatLogType(type) {
                const typeMap = {
                    'power': 'âš¡ ì „íˆ¬ë ¥ ë³€ê²½',
                    'info_edit': 'âœï¸ ì •ë³´ ìˆ˜ì •',
                    'nickname_change': 'ğŸ”„ ë‹‰ë„¤ì„ ë³€ê²½',
                    'user_approved': 'âœ… ì‚¬ìš©ì ìŠ¹ì¸',
                    'user_rejected': 'âŒ ì‚¬ìš©ì ê±°ë¶€',
                    'user_deleted': 'ğŸ—‘ï¸ ì‚¬ìš©ì ì‚­ì œ',
                    'user_request': 'ğŸ“ ë“±ë¡ ìš”ì²­',
                    'bulk_update': 'ğŸ“‹ ì¼ê´„ ì²˜ë¦¬',
                    'spreadsheet_sync': 'ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë™ê¸°í™”',
                    'google_sheet_sync': 'ğŸ“Š êµ¬ê¸€ì‹œíŠ¸ ë™ê¸°í™”'
                };
                return typeMap[type] || type;
            }
            
            // ë¡œê·¸ ë‚´ìš© í¬ë§·íŒ… í•¨ìˆ˜
            function formatLogContent(log) {
                const type = log.type;
                const oldVal = log.oldValue;
                const newVal = log.newValue;
                
                switch(type) {
                    case 'power':
                        const oldPower = Number(oldVal).toLocaleString();
                        const newPower = Number(newVal).toLocaleString();
                        return `${oldPower} â†’ ${newPower}`;
                    
                    case 'nickname_change':
                        return `${oldVal} â†’ ${newVal}`;
                    
                    case 'info_edit':
                        return newVal === 'ê´€ë¦¬ììˆ˜ì •' ? 'ê´€ë¦¬ìê°€ ìˆ˜ì •í•¨' : 'ë³¸ì¸ì´ ìˆ˜ì •í•¨';
                    
                    case 'user_approved':
                        return 'ìŠ¹ì¸ ì™„ë£Œ';
                    
                    case 'user_rejected':
                        return 'ë“±ë¡ ê±°ë¶€';
                    
                    case 'user_deleted':
                        return newVal;
                    
                    case 'user_request':
                        return newVal;
                    
                    case 'bulk_update':
                        return newVal;
                    
                    case 'spreadsheet_sync':
                    case 'google_sheet_sync':
                        return newVal;
                    
                    default:
                        return newVal;
                }
            }
            
            let html = `
                <div class="form-group" style="margin-bottom: 16px;">
                    <input type="text" id="logSearchInput" class="form-input" placeholder="ëŒ€ìƒ ê²€ìƒ‰..." style="margin-bottom: 0;">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">ì´ ${logs.length}ê°œ ë¡œê·¸</p>
                </div>
                <div class="table-scroll-container">
                    <table class="common-table" id="logTable">
                        <thead>
                            <tr>
                                <th style="min-width: 130px;">ì‹œê°„</th>
                                <th style="min-width: 100px;">ëŒ€ìƒ</th>
                                <th style="min-width: 180px;">ì‘ì—…</th>
                                <th style="min-width: 200px;">ë‚´ìš©</th>
                                <th style="min-width: 120px;">IP</th>
                                <th style="min-width: 200px;">ë¸Œë¼ìš°ì €</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            logs.forEach(l => {
                const deviceShort = l.device.length > 50 ? l.device.substring(0, 50) + '...' : l.device;
                const logType = formatLogType(l.type);
                const logContent = formatLogContent(l);
                
                html += `<tr>
                    <td>${l.time}</td>
                    <td><strong>${l.who}</strong></td>
                    <td><span style="white-space: nowrap;">${logType}</span></td>
                    <td>${logContent}</td>
                    <td><code style="font-size:11px;">${l.ip}</code></td>
                    <td title="${l.device}" style="font-size:11px;">${deviceShort}</td>
                </tr>`; 
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
            // ê²€ìƒ‰ ê¸°ëŠ¥
            document.getElementById('logSearchInput').addEventListener('input', (e) => { 
                const searchText = e.target.value.toLowerCase(); 
                document.querySelectorAll('#logTable tbody tr').forEach(row => {
                    const who = row.cells[1].textContent.toLowerCase();
                    row.style.display = who.includes(searchText) ? '' : 'none';
                });
            });
        });

        // ì‚­ì œëœ ì‚¬ìš©ì ë³´ê¸°
        document.getElementById('deletedUsersBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ì‚­ì œëœ ì‚¬ìš©ì', 'ë“±ë¡ í•´ì œëœ ì‚¬ìš©ì ëª©ë¡ (ì˜êµ¬ ë³´ê´€)');
            
            const snap = await getDocs(query(collection(db, "deletedUsers"), orderBy("deletedAt", "desc")));
            
            const deletedUsers = [];
            snap.forEach(d => {
                const u = d.data();
                deletedUsers.push({
                    name: u.originalName || u.name,
                    guild: u.guild || '-',
                    power: u.power || 0,
                    deletedAt: formatDateTime(u.deletedAt),
                    reason: u.deleteReason || '-',
                    memo: u.deleteMemo || '-',
                    deletedBy: u.deletedBy || 'admin'
                });
            });
            
            let html = `
                <div class="form-group" style="margin-bottom: 16px;">
                    <input type="text" id="deletedSearchInput" class="form-input" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." style="margin-bottom: 0;">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">ì´ ${deletedUsers.length}ëª…</p>
                </div>
                <div class="table-scroll-container">
                    <table class="common-table" id="deletedUsersTable">
                        <thead>
                            <tr>
                                <th style="min-width: 100px;">ë‹‰ë„¤ì„</th>
                                <th style="min-width: 80px;">ê¸¸ë“œ</th>
                                <th style="min-width: 100px;">ì „íˆ¬ë ¥</th>
                                <th style="min-width: 130px;">ì‚­ì œì¼ì‹œ</th>
                                <th style="min-width: 100px;">ì‚¬ìœ </th>
                                <th style="min-width: 150px;">ë©”ëª¨</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            deletedUsers.forEach(u => {
                html += `<tr>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td style="color:#3b82f6; font-weight:600;">${u.power.toLocaleString()}</td>
                    <td style="font-size:12px;">${u.deletedAt}</td>
                    <td><span style="padding:4px 8px; background:#fef2f2; color:#991b1b; border-radius:4px; font-size:12px;">${u.reason}</span></td>
                    <td style="font-size:12px; color:#6b7280;">${u.memo || '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
            // ê²€ìƒ‰ ê¸°ëŠ¥
            document.getElementById('deletedSearchInput').addEventListener('input', (e) => {
                const searchText = e.target.value.toLowerCase();
                document.querySelectorAll('#deletedUsersTable tbody tr').forEach(row => {
                    const name = row.cells[0].textContent.toLowerCase();
                    row.style.display = name.includes(searchText) ? '' : 'none';
                });
            });
        });

        // ì¼ê´„ ë“±ë¡ í•´ì œ
        document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ì¼ê´„ ë“±ë¡ í•´ì œ', 'ì—¬ëŸ¬ ì‚¬ìš©ìë¥¼ í•œ ë²ˆì— ë“±ë¡ í•´ì œ');
            
            const snap = await getDocs(collection(db, "users"));
            let users = [];
            snap.forEach(d => users.push(d.data()));
            
            // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
            users.sort((a,b) => a.name.localeCompare(b.name));
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <input type="text" id="bulkDeleteSearch" class="form-input" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰...">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <select id="bulkDeleteGuildFilter" class="form-input">
                                <option value="">ì „ì²´ ê¸¸ë“œ</option>
                                ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <button id="selectAllBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                            âœ… ì „ì²´ ì„ íƒ
                        </button>
                        <button id="deselectAllBtn" class="btn btn-cancel" style="padding: 8px 16px; font-size: 13px;">
                            âŒ ì „ì²´ í•´ì œ
                        </button>
                        <span id="selectedCount" style="margin-left: auto; font-size: 14px; color: #6b7280;">
                            ì„ íƒ: <strong style="color: #ef4444;">0</strong>ëª…
                        </span>
                    </div>
                </div>
                
                <div class="table-scroll-container" style="max-height: 350px;">
                    <table class="common-table" id="bulkDeleteTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ì„ íƒ</th>
                                <th style="min-width: 120px;">ë‹‰ë„¤ì„</th>
                                <th style="min-width: 80px;">ê¸¸ë“œ</th>
                                <th style="min-width: 100px;">ì „íˆ¬ë ¥</th>
                            </tr>
                        </thead>
                        <tbody id="bulkDeleteTableBody"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">ë“±ë¡ í•´ì œ ì‚¬ìœ  (ê³µí†µ)</label>
                        <select id="bulkDeleteReason" class="form-input">
                            <option value="ìì§„ íƒˆí‡´">ìì§„ íƒˆí‡´</option>
                            <option value="ì¥ê¸° ë¯¸ì ‘ì†">ì¥ê¸° ë¯¸ì ‘ì†</option>
                            <option value="ê¸¸ë“œ ì´ë™">ê¸¸ë“œ ì´ë™</option>
                            <option value="ê·œì • ìœ„ë°˜">ê·œì • ìœ„ë°˜</option>
                            <option value="ì¼ê´„ ì •ë¦¬">ì¼ê´„ ì •ë¦¬</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">ìƒì„¸ ë©”ëª¨ (ê³µí†µ, ì„ íƒì‚¬í•­)</label>
                        <textarea id="bulkDeleteMemo" class="form-input" rows="2" placeholder="ì¶”ê°€ ë©”ëª¨..."></textarea>
                    </div>
                    <button id="executeBulkDelete" class="btn btn-danger" style="width: 100%;">
                        ğŸ—‘ï¸ ì„ íƒí•œ ì‚¬ìš©ì ì¼ê´„ ë“±ë¡ í•´ì œ
                    </button>
                </div>
            `;
            
            setModalBody(html);
            
            // í…Œì´ë¸” ë Œë”ë§
            function renderTable() {
                const tbody = document.getElementById('bulkDeleteTableBody');
                const searchText = document.getElementById('bulkDeleteSearch').value.toLowerCase();
                const guildFilter = document.getElementById('bulkDeleteGuildFilter').value;
                
                const filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    return matchSearch && matchGuild;
                });
                
                tbody.innerHTML = '';
                filtered.forEach(u => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="user-checkbox" data-username="${u.name}" 
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td style="color: #3b82f6; font-weight: 600;">${u.power.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                updateSelectedCount();
            }
            
            // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            function updateSelectedCount() {
                const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                const count = checkboxes.length;
                document.getElementById('selectedCount').innerHTML = 
                    `ì„ íƒ: <strong style="color: #ef4444;">${count}</strong>ëª…`;
            }
            
            renderTable();
            
            // ê²€ìƒ‰ ë° í•„í„° ì´ë²¤íŠ¸
            document.getElementById('bulkDeleteSearch').addEventListener('input', renderTable);
            document.getElementById('bulkDeleteGuildFilter').addEventListener('change', renderTable);
            
            // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
            document.getElementById('bulkDeleteTableBody').addEventListener('change', updateSelectedCount);
            
            // ì „ì²´ ì„ íƒ
            document.getElementById('selectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = true);
                updateSelectedCount();
            });
            
            // ì „ì²´ í•´ì œ
            document.getElementById('deselectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            });
            
            // ì¼ê´„ ì‚­ì œ ì‹¤í–‰
            document.getElementById('executeBulkDelete').addEventListener('click', async (e) => {
                // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                const btn = e.target;
                if (btn.disabled) return;
                
                try {
                    const selected = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                        .map(cb => cb.dataset.username);
                    
                    if (selected.length === 0) {
                        showAlert('ì‚­ì œí•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                        return;
                    }
                    
                    const reason = document.getElementById('bulkDeleteReason').value;
                    const memo = document.getElementById('bulkDeleteMemo').value.trim();
                    
                    // í™•ì¸ (ëª¨ë‹¬ ìœ ì§€)
                    const confirmed = await showConfirm(
                        'ì¼ê´„ ë“±ë¡ í•´ì œ í™•ì¸',
                        `<span style="color:#ef4444; font-weight:600;">${selected.length}ëª…ì˜ ì‚¬ìš©ìë¥¼ ë“±ë¡ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span><br><br>
                        â€¢ ì‚¬ìš©ì ì •ë³´ëŠ” ì˜êµ¬ ë³´ê´€ë©ë‹ˆë‹¤<br>
                        â€¢ ì‚­ì œëœ ì‚¬ìš©ì ëª©ë¡ì—ì„œ í™•ì¸ ê°€ëŠ¥<br>
                        â€¢ ë³µêµ¬ëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤<br><br>
                        <strong>ì„ íƒëœ ì‚¬ìš©ì:</strong><br>
                        ${selected.slice(0, 10).join(', ')}${selected.length > 10 ? '...' : ''}`,
                        true  // ëª¨ë‹¬ ìœ ì§€
                    );
                    
                    if (!confirmed) return;
                    
                    // ëª¨ë‹¬ ì œëª© ë³€ê²½
                    document.getElementById('modalTitle').textContent = 'ì¼ê´„ ë“±ë¡ í•´ì œ ì§„í–‰ ì¤‘';
                    document.getElementById('modalSubtitle').textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...';
                    
                    // ëª¨ë‹¬ ë‚´ìš©ì„ í”„ë¡œê·¸ë ˆìŠ¤ ë°”ë¡œ êµì²´
                    document.getElementById('modalBody').innerHTML = `
                        <div style="padding: 20px 16px;">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <strong style="font-size: 16px; color: #111827;">ì²˜ë¦¬ ì¤‘...</strong>
                                <p style="margin-top: 6px; color: #6b7280; font-size: 13px;">
                                    ì°½ì„ ë‹«ì§€ ë§ˆì‹œê³  ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="background: #e5e7eb; height: 28px; border-radius: 14px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);">
                                        <span id="progressPercent" style="color: white; font-weight: 700; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ì§„í–‰</div>
                                        <div id="progressText" style="font-size: 16px; font-weight: 700; color: #111827;">0 / ${selected.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ì„±ê³µ</div>
                                        <div id="successCount" style="font-size: 16px; font-weight: 700; color: #10b981;">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ì‹¤íŒ¨</div>
                                        <div id="failCount" style="font-size: 16px; font-weight: 700; color: #ef4444;">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="currentUser" style="margin-top: 12px; text-align: center; font-size: 12px; color: #6b7280; min-height: 18px;">
                                ì¤€ë¹„ ì¤‘...
                            </div>
                        </div>
                    `;
                
                
                btn.disabled = true;
                
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < selected.length; i++) {
                    const name = selected[i];
                    
                    // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì‚¬ìš©ì í‘œì‹œ
                    document.getElementById('currentUser').textContent = `ì²˜ë¦¬ ì¤‘: ${name}`;
                    
                    try {
                        // 1. ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        const userDoc = await getDoc(doc(db, "users", name));
                        if (!userDoc.exists()) {
                            failCount++;
                            document.getElementById('failCount').textContent = failCount;
                            continue;
                        }
                        
                        const userData = userDoc.data();
                        
                        // 2. deletedUsersì— ë°±ì—…
                        await setDoc(doc(collection(db, "deletedUsers")), {
                            ...userData,
                            deletedAt: Date.now(),
                            deletedBy: 'admin',
                            deleteReason: reason,
                            deleteMemo: memo || '',
                            originalName: name,
                            deletedIp: await getIp(),
                            deletedDevice: navigator.userAgent
                        });
                        
                        // 3. usersì—ì„œ ì‚­ì œ
                        await deleteDoc(doc(db, "users", name));
                        
                        // 4. ë¡œê·¸ ê¸°ë¡
                        await setDoc(doc(collection(db, "logs")), {
                            who: name,
                            type: 'user_deleted',
                            old_value: 'ì‚¬ìš©ì ì¡´ì¬',
                            new_value: `ì¼ê´„ ë“±ë¡ í•´ì œ (ì‚¬ìœ : ${reason})`,
                            createdAt: Date.now(),
                            ip: await getIp(),
                            device: navigator.userAgent
                        });
                        
                        successCount++;
                        document.getElementById('successCount').textContent = successCount;
                    } catch (e) {
                        console.error(`Failed to delete ${name}:`, e);
                        failCount++;
                        document.getElementById('failCount').textContent = failCount;
                    }
                    
                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
                    const current = i + 1;
                    const percent = Math.round((current / selected.length) * 100);
                    document.getElementById('progressText').textContent = `${current} / ${selected.length}`;
                    document.getElementById('progressBar').style.width = `${percent}%`;
                    document.getElementById('progressPercent').textContent = `${percent}%`;
                    
                    // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ëŒ€ê¸° (100msë¡œ ì¦ê°€)
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // ì™„ë£Œ í‘œì‹œ
                document.getElementById('modalTitle').textContent = 'ë“±ë¡ í•´ì œ ì™„ë£Œ';
                document.getElementById('modalSubtitle').textContent = '';
                document.getElementById('currentUser').innerHTML = `
                    <div style="text-align: center; padding: 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${failCount === 0 ? 'âœ…' : 'âš ï¸'}</div>
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 8px;">
                            ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            ì„±ê³µ: <strong style="color: #10b981;">${successCount}ëª…</strong> / 
                            ì‹¤íŒ¨: <strong style="color: #ef4444;">${failCount}ëª…</strong>
                        </div>
                        <div style="margin-top: 12px; font-size: 12px; color: #9ca3af;">
                            ì ì‹œ í›„ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤...
                        </div>
                    </div>
                `;
                
                // 2ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸° ë° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeModal();
                    showAlert(
                        `ë“±ë¡ í•´ì œ ì™„ë£Œ: ì„±ê³µ ${successCount}ëª…, ì‹¤íŒ¨ ${failCount}ëª…`,
                        failCount === 0 ? 'success' : 'error'
                    );
                    setTimeout(() => location.reload(), 1000);
                }, 2000);
                } catch (error) {
                    console.error('ì¼ê´„ ì‚­ì œ ì—ëŸ¬:', error);
                    closeModal();
                    btn.disabled = false;
                    showAlert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            });
        });

        // --- ê³µí†µ: ì¸ì¦ ë° ëª¨ë‹¬ ---
        async function authenticateAndRun(name, callback) {
            if (isSystemLocked() && !isAdmin) { 
                const lockMsg = `ê´€ë¦¬ìê°€ ìˆ˜ì • ì ê¸ˆì„ í•˜ì—¬ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nê¸°ê°„: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            const u = (await getDoc(doc(db, "users", name))).data();
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalFooter').style.display = 'flex';
            if (!u.password) openPasswordSetupModal(name, u, callback); 
            else openPasswordVerifyModal(name, u, callback);
        }
        
        function handlePowerClick(name) { 
            // ê´€ë¦¬ìëŠ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì—†ì´ ë°”ë¡œ ìˆ˜ì •
            if (isAdmin) {
                getDoc(doc(db, "users", name)).then(snap => {
                    if (snap.exists()) {
                        openPowerEditModal(name, snap.data());
                    }
                });
            } else {
                authenticateAndRun(name, (u) => openPowerEditModal(name, u));
            }
        }

        window.editUserFromInfo = async function(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();
            
            closeModal(); // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
            setTimeout(() => {
                // ê´€ë¦¬ìëŠ” ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì—†ì´ ë°”ë¡œ ìˆ˜ì •
                if (isAdmin) {
                    openUserEditModal(u);
                } else {
                    authenticateAndRun(name, (userData) => openUserEditModal(userData));
                }
            }, 300);
        };
        
        function openPasswordSetupModal(name, u, cb) {
            openSmallModal('ë¹„ë°€ë²ˆí˜¸ ì„¤ì •', '4ìë¦¬ ìˆ«ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”', `<div class="form-group"><input type="password" class="form-input" id="passwordInput" maxlength="4" placeholder="4ìë¦¬ ìˆ«ì" inputmode="numeric"></div>`);
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => { 
                const pw = document.getElementById('passwordInput').value; 
                if(!/^\d{4}$/.test(pw)) { 
                    showAlert('4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); 
                    return; 
                }
                await updateDoc(doc(db, "users", name), { password: pw }); 
                closeModal(); 
                setTimeout(() => cb(u), 500); 
            };
        }

        function openPasswordVerifyModal(name, u, cb) {
            let failCount = 0;
            const maxAttempts = 5;
            
            openSmallModal('ë¹„ë°€ë²ˆí˜¸ í™•ì¸', 'ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', `
                <div class="form-group">
                    <input type="password" class="form-input" id="passwordInput" maxlength="4" inputmode="numeric">
                    <p id="attemptInfo" style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">ë‚¨ì€ ì‹œë„ íšŸìˆ˜: ${maxAttempts}íšŒ</p>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
                        <input type="checkbox" id="rememberPassword" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (ìë™ ë¡œê·¸ì¸)</span>
                    </label>
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 4px; margin-left: 26px;">â€» ë¸Œë¼ìš°ì € ë³€ê²½ ì‹œ ìë™ ë¡œê·¸ì¸ì´ í•´ì œë©ë‹ˆë‹¤</p>
                </div>
            `);
            
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            
            document.getElementById('modalSubmit').onclick = () => { 
                if (document.getElementById('passwordInput').value === u.password || isAdmin) {
                    const rememberChecked = document.getElementById('rememberPassword').checked;
                    
                    // ë¡œê·¸ì¸ ì„±ê³µ
                    loggedInUser = name;
                    
                    // ìë™ ë¡œê·¸ì¸ ì €ì¥ (ì²´í¬ëœ ê²½ìš°)
                    if (rememberChecked && !isAdmin) {
                        localStorage.setItem('autoLogin', JSON.stringify({
                            username: name,
                            password: u.password,
                            timestamp: Date.now()
                        }));
                    }
                    
                    closeModal(); 
                    setTimeout(() => {
                        loadData(); // ë¸”ëŸ¬ í•´ì œë¥¼ ìœ„í•´ ë¦¬ë¡œë“œ
                        cb(u);
                    }, 200); 
                } else {
                    failCount++;
                    const remaining = maxAttempts - failCount;
                    
                    if (failCount >= maxAttempts) {
                        closeModal();
                        setTimeout(() => {
                            openSmallModal(
                                'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì œí•œ', 
                                '5íšŒ ì´ìƒ ë¹„ë°€ë²ˆí˜¸ë¥¼ í‹€ë ¸ìŠµë‹ˆë‹¤', 
                                `
                                <div style="text-align: center; padding: 20px;">
                                    <p style="font-size: 16px; color: #374151; margin-bottom: 20px;">
                                        ë¹„ë°€ë²ˆí˜¸ë¥¼ 5íšŒ ì´ìƒ í‹€ë ¸ìŠµë‹ˆë‹¤.<br>
                                        ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
                                    </p>
                                    <a href="https://open.kakao.com/o/s3LUVM4h" target="_blank" 
                                       style="display: inline-block; padding: 12px 24px; background: #FEE500; color: #000000; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;">
                                        ğŸ“± ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ… ë°”ë¡œê°€ê¸°
                                    </a>
                                </div>
                                `
                            );
                            document.getElementById('modalFooter').style.display = 'none';
                        }, 300);
                        return;
                    }
                    
                    document.getElementById('attemptInfo').textContent = `ë‚¨ì€ ì‹œë„ íšŸìˆ˜: ${remaining}íšŒ`;
                    document.getElementById('attemptInfo').style.color = remaining <= 2 ? '#ef4444' : '#6b7280';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                    showAlert(`ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (${remaining}íšŒ ë‚¨ìŒ)`, 'error'); 
                }
            };
        }

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function openLargeModal(t, s) {
            document.getElementById('modalContent').classList.add('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalFooter').style.display = 'none'; 
            document.getElementById('modalBody').innerHTML = 'ë¡œë”©ì¤‘...'; 
            document.getElementById('modalOverlay').classList.add('active');
        }

        function openSmallModal(t, s, b) {
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalBody').innerHTML = b; 
            document.getElementById('modalFooter').style.display = 'flex'; 
            document.getElementById('modalOverlay').classList.add('active');
        }

        function setModalBody(h) { 
            document.getElementById('modalBody').innerHTML = h + `<div style="text-align:right;margin-top:10px"><button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button></div>`; 
        }

        window.closeModal = () => document.getElementById('modalOverlay').classList.remove('active');
        
        // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ ì œê±° (ë°– í´ë¦­í•´ë„ ë‹«íˆì§€ ì•ŠìŒ)
        // document.getElementById('modalOverlay').addEventListener('click', (e) => { 
        //   if(e.target.id === 'modalOverlay') closeModal(); 
        // });

        // ì»¤ìŠ¤í…€ Confirm ëª¨ë‹¬
        window.showConfirm = (title, message, keepOpen = false) => {
            return new Promise((resolve) => {
                openSmallModal(title, '', `<p style="text-align:center; padding:20px 0; font-size:15px; line-height:1.6; color:#374151;">${message}</p>`);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="window.confirmResolve(false)">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" onclick="window.confirmResolve(true)">í™•ì¸</button>
                `;
                window.confirmResolve = (result) => {
                    if (!keepOpen || !result) {
                        closeModal();
                    }
                    resolve(result);
                    delete window.confirmResolve;
                };
            });
        };

        // ê²€ìƒ‰ í•¨ìˆ˜
        function performSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchText) {
                showAlert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ì „ì²´ ë°ì´í„°ì—ì„œ ê²€ìƒ‰
            let foundUser = null;
            for (let i = 0; i < allGuildData.length; i++) {
                if (allGuildData[i].name.toLowerCase().includes(searchText)) {
                    foundUser = allGuildData[i];
                    break;
                }
            }
            
            if (foundUser) {
                // í•´ë‹¹ ê¸¸ë“œë¡œ ì´ë™
                showGuildDetail(foundUser.guild);
                
                // ì ì‹œ í›„ í•´ë‹¹ ìœ ì € í•˜ì´ë¼ì´íŠ¸
                setTimeout(() => {
                    const rows = document.querySelectorAll('#detailList tr');
                    rows.forEach(r => {
                        const playerName = r.querySelector('.player-name');
                        if (playerName && playerName.textContent.toLowerCase().includes(searchText)) {
                            r.style.background = '#fef3c7';
                            r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // 3ì´ˆ í›„ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                            setTimeout(() => {
                                r.style.background = '';
                            }, 3000);
                        }
                    });
                }, 200);
            } else {
                showAlert('í•´ë‹¹ ë‹‰ë„¤ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        document.getElementById('searchInput').addEventListener('input', (e) => { 
            const searchText = e.target.value.toLowerCase().trim();
            
            // ê¸¸ë“œ ìƒì„¸ í™”ë©´ì—ì„œë§Œ í•„í„°ë§ ì ìš©
            if (currentGuild) {
                document.querySelectorAll('#detailList tr').forEach(r => {
                    const playerName = r.querySelector('.player-name');
                    if (playerName) {
                        r.style.display = playerName.textContent.toLowerCase().includes(searchText) ? '' : 'none';
                    }
                });
            }
        });
        
        // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
        document.getElementById('searchBtn').addEventListener('click', () => {
            performSearch();
        });

        function showAlert(m, t='success') { 
            const a = document.createElement('div'); 
            a.className = `alert alert-${t}`; 
            a.innerHTML = `<div class="alert-title">${t==='success'?'ì„±ê³µ':'ì•Œë¦¼'}</div><p class="alert-message" style="white-space: pre-line;">${m}</p>`; 
            document.body.appendChild(a); 
            setTimeout(() => a.remove(), 5000); 
        }

        async function initializeDatabase() { 
            const uList = [
                { guild: 'ì‚¬ì‹ ', name: 'ê°“ëª…í’ˆ', power: 1347941 }, 
                { guild: 'ì‚¬ì‹ ', name: 'ì¹¼ë¦¬', power: 1292531 }
            ]; 
            for (const u of uList) await setDoc(doc(db, "users", u.name), { 
                ...u, 
                password: null, 
                shape_legend: 0, 
                shape_myth: 0, 
                mount_legend: 0, 
                mount_myth: 0 
            }); 
            showAlert("ì´ˆê¸° ë°ì´í„° ìƒì„± ì™„ë£Œ", "success"); 
            setTimeout(() => location.reload(), 1500); 
        }

        // --- ê´€ë¦¬ì ê´€ë¦¬ ê¸°ëŠ¥ (ìµœì¢… ê´€ë¦¬ì ì „ìš©) ---
        document.getElementById('adminManageBtn').addEventListener('click', async () => {
            if (!isSuperAdmin) {
                showAlert('ìµœì¢… ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }

            openLargeModal('ê´€ë¦¬ì ê´€ë¦¬', 'ì¼ë°˜ ê´€ë¦¬ì ê³„ì •ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì‚­ì œí•©ë‹ˆë‹¤');
            
            // ê´€ë¦¬ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            const adminSnapshot = await getDocs(collection(db, "admins"));
            
            let adminListHtml = '';
            if (adminSnapshot.empty) {
                adminListHtml = '<p style="text-align:center; color:#9ca3af; padding:20px;">ë“±ë¡ëœ ì¼ë°˜ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                adminListHtml = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th>ì•„ì´ë””</th><th>ìƒì„±ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
                adminSnapshot.forEach(docSnap => {
                    const admin = docSnap.data();
                    const createdAt = admin.createdAt ? formatDateTime(admin.createdAt) : '-';
                    adminListHtml += `<tr>
                        <td><strong>${docSnap.id}</strong></td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-reset-pw" onclick="window.resetAdminPw('${docSnap.id}')" style="margin-right:4px;">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
                            <button class="btn btn-danger" onclick="window.deleteAdmin('${docSnap.id}')" style="padding:4px 8px; font-size:12px;">ì‚­ì œ</button>
                        </td>
                    </tr>`;
                });
                adminListHtml += '</tbody></table></div>';
            }

            const html = `
                <div style="margin-bottom:20px; padding:15px; background:#f0fdf4; border-radius:8px; border-left:4px solid #22c55e;">
                    <p style="font-size:13px; color:#166534;"><strong>ğŸ‘‘ ìµœì¢… ê´€ë¦¬ì:</strong> tjdals9328 (ë³€ê²½ ë¶ˆê°€)</p>
                </div>
                
                <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">ğŸ“‹ ì¼ë°˜ ê´€ë¦¬ì ëª©ë¡</h4>
                ${adminListHtml}
                
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                    <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">â• ìƒˆ ê´€ë¦¬ì ì¶”ê°€</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <input type="text" id="newAdminId" class="form-input" placeholder="ì•„ì´ë””" style="flex:1; min-width:120px;">
                        <input type="password" id="newAdminPw" class="form-input" placeholder="ë¹„ë°€ë²ˆí˜¸" style="flex:1; min-width:120px;">
                        <button class="btn btn-primary" onclick="window.addNewAdmin()" style="white-space:nowrap;">ì¶”ê°€</button>
                    </div>
                    <p style="font-size:11px; color:#9ca3af; margin-top:8px;">â€» ì¼ë°˜ ê´€ë¦¬ìëŠ” ê´€ë¦¬ì ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html + `<div style="text-align:right;margin-top:20px"><button class="btn btn-primary" onclick="closeModal()">ë‹«ê¸°</button></div>`;
        });

        // ìƒˆ ê´€ë¦¬ì ì¶”ê°€
        window.addNewAdmin = async function() {
            const adminId = document.getElementById('newAdminId').value.trim();
            const adminPw = document.getElementById('newAdminPw').value;

            if (!adminId || !adminPw) {
                showAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (adminPw.length < 4) {
                showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            const existingAdmin = await getDoc(doc(db, "admins", adminId));
            if (existingAdmin.exists()) {
                showAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤', 'error');
                return;
            }

            try {
                await setDoc(doc(db, "admins", adminId), {
                    password: adminPw,
                    createdAt: Date.now(),
                    createdBy: 'superadmin'
                });

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_add',
                    old_value: '-',
                    new_value: `ê´€ë¦¬ì ì¶”ê°€: ${adminId}`,
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`ê´€ë¦¬ì [${adminId}]ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                closeModal();
                // ë‹¤ì‹œ ì—´ê¸°
                setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ê´€ë¦¬ì ì‚­ì œ
        window.deleteAdmin = async function(adminId) {
            if (!await showConfirm('ê´€ë¦¬ì ì‚­ì œ', `[${adminId}] ê´€ë¦¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                await deleteDoc(doc(db, "admins", adminId));

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_delete',
                    old_value: adminId,
                    new_value: 'ì‚­ì œë¨',
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`ê´€ë¦¬ì [${adminId}]ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                closeModal();
                setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
        window.resetAdminPw = async function(adminId) {
            openSmallModal('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”', `[${adminId}] ê´€ë¦¬ì`, `
                <div class="form-group">
                    <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="resetPwInput" class="form-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const newPw = document.getElementById('resetPwInput').value;
                
                if (!newPw || newPw.length < 4) {
                    showAlert('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                    return;
                }

                try {
                    await updateDoc(doc(db, "admins", adminId), {
                        password: newPw,
                        updatedAt: Date.now()
                    });

                    await setDoc(doc(collection(db, "logs")), {
                        who: 'SuperAdmin',
                        type: 'admin_pw_reset',
                        old_value: adminId,
                        new_value: 'ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”',
                        createdAt: Date.now(),
                        ip: await getIp()
                    });

                    showAlert(`[${adminId}] ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showAlert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            };
        };

        init();
    </script>
</body>
</html>
