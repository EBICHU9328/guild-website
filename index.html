<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fff9f9">
    <title>üê¥ Í∏∏Îìú Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê 2027</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif; 
            background: #ffffff; 
            color: #1a1a1a; 
            line-height: 1.6; 
            user-select: none; 
            -webkit-user-select: none; 
            caret-color: transparent;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: contain;
        }
        input, textarea, select { user-select: text; -webkit-user-select: text; caret-color: auto; }
        
        
        .newyear-title {
            display: inline-flex;
            align-items: center;
            position: relative;
            padding: 8px 12px;
            background: linear-gradient(135deg, #fff9f9 0%, #ffe4e6 25%, #fff1f2 50%, #ffe4e6 75%, #fff9f9 100%);
            background-size: 200% 200%;
            animation: gradientShift 4s ease-in-out infinite;
            border-radius: 14px;
            box-shadow: 
                0 0 15px rgba(244, 114, 182, 0.3),
                0 0 30px rgba(251, 113, 133, 0.15),
                0 4px 20px rgba(198, 40, 40, 0.2),
                inset 0 0 20px rgba(255,255,255,0.9);
            overflow: hidden;
            border: 2px solid transparent;
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .newyear-title::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #f472b6, #fb7185, #fda4af, #fb7185, #f472b6);
            background-size: 300% 300%;
            animation: borderGlow 3s ease-in-out infinite;
            border-radius: 16px;
            z-index: -1;
        }
        .newyear-title * {
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .newyear-title::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 30%, rgba(255,182,193,0.6) 2px, transparent 2px),
                radial-gradient(circle at 30% 70%, rgba(255,192,203,0.5) 1.5px, transparent 1.5px),
                radial-gradient(circle at 70% 25%, rgba(255,182,193,0.55) 2px, transparent 2px),
                radial-gradient(circle at 90% 65%, rgba(255,192,203,0.5) 1.5px, transparent 1.5px);
            animation: petalFloat 3s ease-in-out infinite;
            pointer-events: none;
        }
        /* ÏÉÅÎã® ÌÉÄÏù¥ÌãÄ Î∞òÏßùÏù¥ */
        .newyear-title .title-sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 6px #fff, 0 0 12px #ffc0cb;
            animation: sparkle 2s ease-in-out infinite;
            z-index: 3;
        }
        .newyear-title .title-sparkle:nth-child(1) { top: 15%; left: 8%; animation-delay: 0s; }
        .newyear-title .title-sparkle:nth-child(2) { top: 70%; left: 25%; animation-delay: 0.7s; }
        .newyear-title .title-sparkle:nth-child(3) { top: 25%; right: 15%; animation-delay: 1.4s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        .newyear-title .title-svg {
            height: 36px;
            width: auto;
            position: relative;
            z-index: 2;
        }
        .newyear-title .title-svg .plum-left,
        .newyear-title .title-svg .plum-right {
            animation: plumSway 2.5s ease-in-out infinite;
            transform-origin: left bottom;
        }
        .newyear-title .title-svg .plum-right {
            animation-delay: 0.5s;
            transform-origin: right bottom;
        }
        @keyframes plumSway {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.02); }
            75% { transform: rotate(2deg) scale(1.02); }
        }
        
        
        .guild-select-title {
            text-align: center;
            margin-bottom: 40px;
        }
        .guild-select-title .newyear-box {
            display: inline-flex;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, #fff9f9 0%, #ffe4e6 25%, #fff1f2 50%, #ffe4e6 75%, #fff9f9 100%);
            background-size: 200% 200%;
            animation: gradientShift 4s ease-in-out infinite;
            border-radius: 20px;
            box-shadow: 
                0 0 20px rgba(244, 114, 182, 0.4),
                0 0 40px rgba(251, 113, 133, 0.2),
                0 8px 32px rgba(198, 40, 40, 0.2),
                inset 0 0 30px rgba(255,255,255,0.9);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            background-clip: padding-box;
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .guild-select-title .newyear-box::after {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #f472b6, #fb7185, #fda4af, #fb7185, #f472b6);
            background-size: 300% 300%;
            animation: borderGlow 3s ease-in-out infinite;
            border-radius: 22px;
            z-index: -1;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; opacity: 0.7; }
            50% { background-position: 100% 50%; opacity: 1; }
        }
        .guild-select-title .newyear-box * {
            user-select: none;
            -webkit-user-select: none;
            caret-color: transparent;
        }
        .guild-select-title .newyear-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,182,193,0.6) 4px, transparent 4px),
                radial-gradient(circle at 25% 70%, rgba(255,192,203,0.5) 3px, transparent 3px),
                radial-gradient(circle at 75% 25%, rgba(255,182,193,0.55) 3.5px, transparent 3.5px),
                radial-gradient(circle at 90% 75%, rgba(255,192,203,0.5) 3px, transparent 3px),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8) 2px, transparent 2px);
            animation: petalFloat 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes petalFloat {
            0%, 100% { opacity: 0.6; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-5px) scale(1.1); }
        }
        
        /* Îñ®Ïñ¥ÏßÄÎäî ÍΩÉÏûé Ïª®ÌÖåÏù¥ÎÑà */
        .guild-select-title .petal-container {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        .guild-select-title .falling-petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(ellipse at center, #ffc0cb 0%, #ffb6c1 50%, transparent 70%);
            border-radius: 50% 0 50% 50%;
            opacity: 0;
            animation: petalFall 4s ease-in-out infinite;
        }
        .guild-select-title .falling-petal:nth-child(1) { left: 10%; animation-delay: 0s; }
        .guild-select-title .falling-petal:nth-child(2) { left: 25%; animation-delay: 0.8s; }
        .guild-select-title .falling-petal:nth-child(3) { left: 40%; animation-delay: 1.6s; }
        .guild-select-title .falling-petal:nth-child(4) { left: 55%; animation-delay: 2.4s; }
        .guild-select-title .falling-petal:nth-child(5) { left: 70%; animation-delay: 3.2s; }
        .guild-select-title .falling-petal:nth-child(6) { left: 85%; animation-delay: 0.4s; }
        @keyframes petalFall {
            0% { top: -10px; opacity: 0; transform: rotate(0deg) translateX(0); }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { top: 100%; opacity: 0; transform: rotate(360deg) translateX(20px); }
        }
        
        /* Î∞òÏßùÏù¥ Ìö®Í≥º */
        .guild-select-title .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #ffc0cb, 0 0 30px #ff69b4;
            animation: sparkle 2s ease-in-out infinite;
        }
        .guild-select-title .sparkle:nth-child(1) { top: 20%; left: 15%; animation-delay: 0s; }
        .guild-select-title .sparkle:nth-child(2) { top: 70%; left: 30%; animation-delay: 0.5s; }
        .guild-select-title .sparkle:nth-child(3) { top: 30%; right: 20%; animation-delay: 1s; }
        .guild-select-title .sparkle:nth-child(4) { top: 60%; right: 10%; animation-delay: 1.5s; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .guild-select-title .select-title-svg {
            height: 60px;
            width: auto;
            position: relative;
            z-index: 2;
        }
        .guild-select-title .select-title-svg .plum-left,
        .guild-select-title .select-title-svg .plum-right {
            animation: plumBlossom 3s ease-in-out infinite;
            transform-origin: left bottom;
        }
        .guild-select-title .select-title-svg .plum-right {
            animation-delay: 0.5s;
            transform-origin: right bottom;
        }
        @keyframes plumBlossom {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.03); }
            75% { transform: rotate(2deg) scale(1.03); }
        }
        
        .lock-banner { background: #ef4444; color: white; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; display: none; animation: slideDown 0.3s ease; }
        .lock-banner.active { display: block; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .top-bar { background: rgba(255, 255, 255, 0.95); border-bottom: 1px solid #e5e7eb; padding: 16px 24px; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .top-bar h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
        .top-actions { display: flex; gap: 12px; align-items: center; }
        .search-input { padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; width: 180px; transition: all 0.2s; background: #f9fafb; }
        .search-input:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn-common { padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .btn-user-add { background: #3b82f6; color: white; font-weight: 600; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); }
        .btn-user-add:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-user-add.disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .admin-only { display: none; }
        .super-admin-only { display: none; }
        .btn-excel { background: #10b981; color: white; }
        .btn-admin { background: #1f2937; color: white; position: relative; }
        .btn-admin.logged-in { background: #4b5563; cursor: default; }
        .btn-log { background: #f59e0b; color: white; }
        .btn-manage { background: #6366f1; color: white; }
        .btn-guild-add { background: #8b5cf6; color: white; }
        .btn-lock { background: #ef4444; color: white; }
        .btn-bulk { background: #db2777; color: white; }
        .btn-bulk:hover { background: #be185d; }
        .btn-approve { background: #059669; color: white; }
        .btn-approve:hover { background: #047857; }
        .btn-rename { background: #8b5cf6; color: white; }
        .btn-rename:hover { background: #7c3aed; }
        .btn-reset-pw { padding: 4px 8px; font-size: 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-reset-pw:hover { background: #dc2626; }
        
        
        .pending-badge { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; }

        
        .guild-select-container { max-width: 1200px; margin: 0 auto; padding: 60px 24px; }
        .guild-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .guild-btn { background: #ffffff; border: 2px solid #e5e7eb; border-radius: 16px; padding: 30px 24px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 16px; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .guild-btn * { user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .guild-btn:hover { border-color: #3b82f6; transform: translateY(-4px); box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15); }
        .guild-btn:active { transform: translateY(-2px); }
        .guild-btn-badge { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
        .guild-btn:nth-child(4n+1) .guild-btn-badge { background: #3b82f6; }
        .guild-btn:nth-child(4n+2) .guild-btn-badge { background: #10b981; }
        .guild-btn:nth-child(4n+3) .guild-btn-badge { background: #f59e0b; }
        .guild-btn:nth-child(4n+4) .guild-btn-badge { background: #ef4444; }
        .guild-btn-info { flex: 1; }
        .guild-btn-name { font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .guild-btn-count { font-size: 14px; color: #6b7280; }
        .guild-btn-arrow { font-size: 24px; color: #9ca3af; transition: transform 0.3s; }
        .guild-btn:hover .guild-btn-arrow { transform: translateX(4px); color: #3b82f6; }

        /* Í¥ÄÎ¶¨Ïûê ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ */
        .admin-dropdown { position: relative; display: none; }
        .admin-dropdown.active { display: inline-block; }
        .admin-dropdown-btn { 
            display: flex; align-items: center; gap: 6px;
            padding: 10px 16px; border-radius: 8px; border: none;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .admin-dropdown-btn::after { content: '‚ñº'; font-size: 10px; margin-left: 4px; transition: transform 0.2s; }
        .admin-dropdown:hover .admin-dropdown-btn::after, 
        .admin-dropdown:focus-within .admin-dropdown-btn::after { transform: rotate(180deg); }
        .admin-dropdown-menu {
            position: absolute; top: 100%; left: 0; margin-top: 4px;
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 180px;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: all 0.2s; z-index: 100;
        }
        .admin-dropdown:hover .admin-dropdown-menu,
        .admin-dropdown:focus-within .admin-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .admin-dropdown-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; cursor: pointer; transition: background 0.15s;
            border: none; background: none; width: 100%; text-align: left;
            font-size: 13px; color: #374151;
        }
        .admin-dropdown-item:first-child { border-radius: 12px 12px 0 0; }
        .admin-dropdown-item:last-child { border-radius: 0 0 12px 12px; }
        .admin-dropdown-item:hover { background: #f3f4f6; }
        .admin-dropdown-item.danger { color: #dc2626; }
        .admin-dropdown-item.danger:hover { background: #fef2f2; }
        .admin-dropdown-divider { height: 1px; background: #e5e7eb; margin: 4px 0; }
        
        .dropdown-member { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .dropdown-member:hover { background: linear-gradient(135deg, #2563eb, #1e40af); }
        .dropdown-guild { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .dropdown-guild:hover { background: linear-gradient(135deg, #059669, #047857); }
        .dropdown-data { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .dropdown-data:hover { background: linear-gradient(135deg, #d97706, #b45309); }
        .dropdown-system { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .dropdown-system:hover { background: linear-gradient(135deg, #7c3aed, #6d28d9); }

        
        .guild-detail-container { max-width: 900px; margin: 0 auto; padding: 40px 24px; display: none; }
        .guild-detail-container.active { display: block; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .back-btn:hover { background: #e5e7eb; }
        .guild-detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .guild-detail-badge { width: 12px; height: 12px; border-radius: 50%; }
        .guild-detail-title { font-size: 24px; font-weight: 700; color: #111827; }
        .guild-detail-count { font-size: 14px; color: #6b7280; margin-left: auto; }

        .container { max-width: 1600px; margin: 0 auto; padding: 40px 24px; display: none; grid-template-columns: repeat(auto-fit, minmax(min(100%, 360px), 1fr)); gap: 24px; }
        .card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { border-color: #d1d5db; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; }
        .guild-badge { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: #9ca3af; }
        .card:nth-child(4n+1) .guild-badge { background: #3b82f6; }
        .card:nth-child(4n+2) .guild-badge { background: #10b981; }
        .card:nth-child(4n+3) .guild-badge { background: #f59e0b; }
        .card:nth-child(4n+4) .guild-badge { background: #ef4444; }
        .card-header h2 { font-size: 16px; font-weight: 600; color: #111827; letter-spacing: -0.3px; }
        .card-body { padding: 0; }
        .card-body table { width: 100%; border-collapse: collapse; }
        .card-body thead { background: #f9fafb; border-bottom: 1px solid #f3f4f6; }
        .card-body th { padding: 12px 16px; font-weight: 500; color: #6b7280; font-size: 13px; text-align: left; letter-spacing: 0.3px; }
        .card-body th:first-child { width: 60%; }
        .card-body th:last-child { width: 40%; text-align: right; padding-right: 20px; }
        .card-body td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; height: 60px; }
        .card-body td:first-child { overflow: visible; }
        .card-body td:last-child { text-align: right; width: 40%; padding-right: 20px; }
        .player-cell { display: flex; align-items: center; gap: 4px; flex-wrap: nowrap; }
        .card-body tbody tr { height: 60px; cursor: pointer; -webkit-tap-highlight-color: rgba(59, 130, 246, 0.1); }
        .card-body tbody tr:hover { background: #f0f9ff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-body tbody tr:active { background: #dbeafe; }
        .card-body tbody tr:last-child td { border-bottom: none; }
        .card-body tbody tr { border-bottom: 2px solid #e5e7eb; }
        .rank-number { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; font-size: 14px; font-weight: 700; margin-right: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .rank-number:hover { transform: scale(1.05); }
        tbody tr:nth-child(1) .rank-number { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #92400e; box-shadow: 0 4px 6px rgba(255,215,0,0.4); }
        tbody tr:nth-child(2) .rank-number { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #57534e; box-shadow: 0 4px 6px rgba(192,192,192,0.4); }
        tbody tr:nth-child(3) .rank-number { background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%); color: #78350f; box-shadow: 0 4px 6px rgba(205,127,50,0.4); }
        tbody tr:nth-child(n+4) .rank-number { background: #f3f4f6; color: #374151; font-weight: 600; }
        .player-name { 
            font-weight: 500; 
            color: #111827; 
            cursor: pointer; 
            padding: 6px 10px; 
            border-radius: 6px; 
            transition: all 0.2s; 
            display: inline-block; 
            vertical-align: middle;
            user-select: none;
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.1);
        }
        .player-name:hover { 
            background: #e0e7ff; 
            color: #2563eb; 
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-name:active {
            transform: translateY(0);
            background: #c7d2fe;
        }
        .power-value { font-weight: 600; color: #3b82f6; cursor: pointer; transition: all 0.15s ease; padding: 6px 12px; border-radius: 6px; display: inline-block; }
        .power-value:hover { background: #eff6ff; color: #2563eb; }
        
        
        .power-value.blurred { 
            filter: blur(8px); 
            user-select: none; 
            pointer-events: none;
            color: #9ca3af;
        }
        .power-value.blurred:hover {
            background: transparent;
        }
        
        
        .spec-icons { font-size: 11px; margin-left: 2px; color: #666; display: inline-block; cursor: pointer; vertical-align: middle; flex-shrink: 0; white-space: nowrap; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 1000; animation: fadeIn 0.2s ease; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal { background: #ffffff; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 400px; width: 90%; max-height: calc(100vh - 40px); display: flex; flex-direction: column; animation: slideUp 0.3s ease; position: relative; margin: 20px auto; }
        .modal.modal-lg { max-width: 900px; }
        .modal-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border: none; background: #f3f4f6; border-radius: 50%; color: #6b7280; font-size: 24px; line-height: 1; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .modal-close-btn:hover { background: #e5e7eb; color: #374151; transform: rotate(90deg); }
        .modal-header { padding: 24px 24px 16px; border-bottom: 1px solid #f3f4f6; flex-shrink: 0; }
        .modal-header h3 { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .modal-header p { font-size: 14px; color: #6b7280; margin: 0; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; min-height: 0; }
        .table-scroll-container { max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; -webkit-overflow-scrolling: touch; }
        .common-table { width: 100%; font-size: 13px; table-layout: auto; border-collapse: collapse; }
        .common-table th { position: sticky; top: 0; background: #f3f4f6; text-align: center; padding: 12px 8px; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .common-table td { text-align: center; padding: 10px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .common-table tbody tr:hover { background: #f9fafb; }
        .common-table tbody tr:active { background: #f3f4f6; }
        /* ÎÑìÏùÄ ÌÖåÏù¥Î∏îÏö© */
        .common-table.table-wide { min-width: 800px; }
        .common-table.table-wide td { white-space: nowrap; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 15px; color: #111827; transition: all 0.15s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0; background: #ffffff; border-radius: 0 0 16px 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; user-select: none; -webkit-user-select: none; caret-color: transparent; }
        .btn-cancel { background: #f3f4f6; color: #6b7280; }
        .btn-cancel:hover { background: #e5e7eb; color: #374151; }
        .btn-primary { background: #3b82f6; color: #ffffff; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: #ffffff; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: #ffffff; }
        .btn-danger:hover { background: #dc2626; }
        .alert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 40px 16px 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08); z-index: 2000; animation: alertPopIn 0.3s ease; max-width: 400px; min-width: 250px; }
        @keyframes alertPopIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .alert-close { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border: none; background: #f3f4f6; border-radius: 50%; color: #6b7280; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .alert-close:hover { background: #e5e7eb; color: #374151; }
        .alert-success { border-left: 4px solid #10b981; }
        .alert-error { border-left: 4px solid #ef4444; }
        .alert-title { font-weight: 600; color: #111827; margin-bottom: 4px; }
        .alert-message { font-size: 14px; color: #6b7280; margin: 0; }
        
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .checkbox-label { display: flex; align-items: center; font-size: 14px; cursor: pointer; background: #f3f4f6; padding: 8px 12px; border-radius: 6px; }
        .checkbox-label input { margin-right: 8px; }
        
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { background: #f9fafb; padding: 10px; border-radius: 8px; font-size: 14px; }
        .info-label { color: #6b7280; font-size: 12px; display: block; margin-bottom: 4px; }
        .info-val { font-weight: 600; color: #111827; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px; }
        .badge-on { background: #dbeafe; color: #1e40af; }
        .badge-off { background: #f3f4f6; color: #9ca3af; }
        .spec-count { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-left: 4px; background: #dbeafe; color: #1e40af; }
        .spec-count.zero { background: #f3f4f6; color: #9ca3af; }
        .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
        .spec-input-group { display: flex; flex-direction: column; }
        .spec-input-group label { font-size: 13px; color: #6b7280; margin-bottom: 4px; }
        .form-input.small { padding: 8px 12px; font-size: 14px; }
        
        
        .time-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        @media (max-width: 768px) {
            .top-bar { padding: 14px 16px; flex-direction: column; align-items: flex-start; }
            .top-actions { width: 100%; flex-wrap: wrap; }
            .search-input { flex-grow: 1; width: auto; }
            .container { padding: 24px 16px; gap: 20px; }
            
            
            .modal-overlay { padding: 10px; align-items: flex-start; }
            .modal { 
                width: 95%; 
                max-height: calc(100vh - 20px);
                margin: 10px auto;
                border-radius: 12px;
            }
            .modal.modal-lg { 
                max-width: 95%; 
            }
            .modal-header { 
                padding: 20px 16px 12px; 
            }
            .modal-header h3 { 
                font-size: 16px; 
                padding-right: 30px; 
            }
            .modal-body { 
                padding: 16px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; 
            }
            .modal-footer { 
                padding: 12px 16px;
                flex-shrink: 0;
            }
            .modal-close-btn {
                top: 12px;
                right: 12px;
                width: 28px;
                height: 28px;
                font-size: 20px;
            }
            .table-scroll-container {
                max-height: 300px; 
            }
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            .form-group {
                margin-bottom: 16px; 
            }
            .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            
            td { 
                padding: 10px 12px; 
            }
            .player-name { 
                font-size: 13px;
            }
            .rank-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
                margin-right: 8px;
            }
            .spec-icons {
                font-size: 11px;
            }
            .power-value {
                font-size: 13px;
                padding: 4px 8px;
            }
            
            
            .guild-select-container { padding: 30px 16px; }
            .guild-select-title .newyear-box { padding: 10px 16px; }
            .guild-select-title .select-title-svg { height: 40px; }
            .newyear-title .title-svg { height: 30px; }
            .guild-buttons { gap: 12px; }
            .guild-btn { padding: 20px 16px; }
            .guild-btn-name { font-size: 16px; }
            .guild-btn-count { font-size: 12px; }
            
            
            .guild-detail-container { padding: 20px 16px; }
            .guild-detail-title { font-size: 20px; }
            .back-btn { padding: 8px 14px; font-size: 13px; }
            
            
            .table-scroll-container { 
                max-height: 300px; 
            }
            
            
            .btn { 
                padding: 10px 16px; 
                font-size: 13px; 
            }
            
            
            .form-input { 
                padding: 10px 12px; 
                font-size: 14px; 
            }
            
            
            .spec-grid, .time-input-group { 
                grid-template-columns: 1fr; 
            }
        }
        
        /* ÏûëÏùÄ Ïä§ÎßàÌä∏Ìè∞ (480px Ïù¥Ìïò) */
        @media (max-width: 480px) {
            .top-bar { padding: 12px; }
            .top-actions { gap: 8px; }
            .btn-user-add { padding: 8px 12px; font-size: 12px; }
            .search-input { font-size: 14px; padding: 8px 12px; min-width: 0; }
            
            .newyear-title { padding: 6px 10px; }
            .newyear-title .title-svg { height: 26px; }
            
            .guild-select-container { padding: 20px 12px; }
            .guild-select-title .newyear-box { padding: 8px 12px; }
            .guild-select-title .select-title-svg { height: 35px; }
            .guild-buttons { gap: 10px; }
            .guild-btn { padding: 16px 12px; }
            .guild-btn-name { font-size: 14px; }
            
            .modal { width: 98%; margin: 5px auto; }
            .modal-header { padding: 16px 12px 10px; }
            .modal-header h3 { font-size: 15px; }
            .modal-body { padding: 12px; }
            .modal-footer { padding: 10px 12px; }
            
            .common-table th, .common-table td { padding: 8px 6px; font-size: 12px; }
            .player-name { font-size: 12px; }
            .power-value { font-size: 12px; padding: 3px 6px; }
            .rank-number { width: 20px; height: 20px; font-size: 10px; }
            
            .alert { max-width: 90%; min-width: 200px; padding: 12px 30px 12px 16px; }
            .alert-title { font-size: 13px; }
            .alert-message { font-size: 12px; }
            
            /* ÏûëÏùÄ ÌôîÎ©¥ÏóêÏÑú ÍΩÉÏûé Ìö®Í≥º Ï§ÑÏù¥Í∏∞ */
            .guild-select-title .falling-petal:nth-child(n+4) { display: none; }
            .guild-select-title .sparkle:nth-child(n+3) { display: none; }
        }
        
        /* Ìè¥Îìú Ï†ëÌûò / ÏÜåÌòï ÌÉúÎ∏îÎ¶ø (768px ~ 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .top-bar { padding: 16px 20px; flex-direction: row; }
            .top-actions { width: auto; }
            .container { grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 30px 20px; }
            
            .guild-select-container { padding: 50px 30px; }
            .guild-select-title .newyear-box { padding: 14px 20px; }
            .guild-select-title .select-title-svg { height: 50px; }
            .guild-buttons { grid-template-columns: repeat(2, 1fr); }
            
            .modal.modal-lg { max-width: 90%; }
            .modal-body { max-height: calc(100vh - 200px); }
        }
        
        /* Ìè¥Îìú ÌéºÏπ® / Ï§ëÌòï ÌÉúÎ∏îÎ¶ø (1024px ~ 1440px) */
        @media (min-width: 1024px) and (max-width: 1440px) {
            .container { grid-template-columns: repeat(3, 1fr); max-width: 1200px; }
            .guild-buttons { grid-template-columns: repeat(3, 1fr); }
        }
        
        /* ÎåÄÌòï ÌôîÎ©¥ */
        @media (min-width: 1024px) { .container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1440px) { .container { grid-template-columns: repeat(4, 1fr); max-width: 1440px; } }
        
        /* ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ ÏµúÏ†ÅÌôî */
        @media (hover: none) and (pointer: coarse) {
            .btn, .guild-btn, .admin-dropdown-item { 
                min-height: 44px; /* iOS Í∂åÏû• ÌÑ∞Ïπò ÌÉÄÍ≤ü */
            }
            .form-input, .form-select {
                min-height: 44px;
                font-size: 16px; /* iOS Ï§å Î∞©ÏßÄ */
            }
            .modal-close-btn {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }
            /* Ìò∏Î≤Ñ Ìö®Í≥º ÎπÑÌôúÏÑ±Ìôî */
            .btn:hover, .guild-btn:hover { transform: none; }
            .admin-dropdown-item:hover { background: transparent; }
            /* ÌÑ∞Ïπò Ïãú Ìö®Í≥º */
            .btn:active, .guild-btn:active { 
                transform: scale(0.98); 
                opacity: 0.9;
            }
        }
        
        /* Í∞ÄÎ°ú Î™®Îìú (Landscape) */
        @media (max-height: 500px) and (orientation: landscape) {
            .modal { max-height: 95vh; }
            .modal-body { max-height: calc(95vh - 120px); }
            .guild-select-container { padding: 20px 24px; }
            .guild-select-title { margin-bottom: 20px; }
        }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÑ±Îä• ÏµúÏ†ÅÌôî */
        .newyear-title, .newyear-box, .plum-left, .plum-right, .falling-petal, .sparkle {
            will-change: transform, opacity;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        /* Î™®ÏÖò Í∞êÏÜå ÏÑ†Ìò∏ Ïãú */
        @media (prefers-reduced-motion: reduce) {
            .plum-left, .plum-right, .falling-petal, .sparkle, .newyear-title, .newyear-box {
                animation: none !important;
            }
            .newyear-title::after, .newyear-box::after {
                animation: none !important;
            }
        }
        
        /* Ìè¥Îìú ÌôîÎ©¥ Ï†ÑÌôò ÎåÄÏùë */
        @media (horizontal-viewport-segments: 2) {
            /* Ìè¥Îìú ÌéºÏπ® Ïãú 2Îã® Î†àÏù¥ÏïÑÏõÉ */
            .container { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* ÏÑ∏Ïù¥ÌîÑ ÏóêÏñ¥Î¶¨Ïñ¥ (ÎÖ∏Ïπò/ÌéÄÏπòÌôÄ ÎåÄÏùë) */
        @supports (padding: max(0px)) {
            .top-bar {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
            .modal {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div id="lockBanner" class="lock-banner">‚õî ÌòÑÏû¨ Ï†ïÎ≥¥ ÏàòÏ†ïÏù¥ Ïû†Í≤®ÏûàÏäµÎãàÎã§</div>

    <div class="top-bar">
        <h1 id="mainTitle" class="newyear-title" style="cursor: pointer;" onclick="showGuildSelect()">
            <!-- Î∞òÏßùÏù¥ -->
            <div class="title-sparkle"></div>
            <div class="title-sparkle"></div>
            <div class="title-sparkle"></div>
            
            <svg class="title-svg" viewBox="0 0 500 50" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="petalGradMain" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#fff0f3"/>
                        <stop offset="70%" stop-color="#ffc0cb"/>
                        <stop offset="100%" stop-color="#ff8fa3"/>
                    </radialGradient>
                </defs>
                <!-- ÏôºÏ™Ω Îß§Ìôî -->
                <g class="plum-left">
                    <path d="M5 42 Q15 35 25 38 Q35 36 42 28" stroke="#5d4037" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M25 38 Q28 30 32 24" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    <g transform="translate(40, 26) scale(0.8)">
                        <ellipse cx="0" cy="-6" rx="3" ry="5" fill="url(#petalGradMain)"/>
                        <ellipse cx="5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(72)"/>
                        <ellipse cx="3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(144)"/>
                        <ellipse cx="-3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(216)"/>
                        <ellipse cx="-5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(288)"/>
                        <circle cx="0" cy="0" r="2.5" fill="#ffeb3b"/>
                    </g>
                    <circle cx="28" cy="35" r="3" fill="#ffb6c1"/>
                    <circle cx="18" cy="40" r="2.5" fill="#ffc0cb"/>
                </g>
                <text x="250" y="33" text-anchor="middle" font-family="'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" font-size="22" font-weight="700" fill="#c62828">
                    Í∏∏Îìú Ï†ÑÌà¨Î†• ÌòÑÌô©Ìåê
                </text>
                <!-- Ïò§Î•∏Ï™Ω Îß§Ìôî (ÏßÅÏ†ë Í∑∏Î¶¨Í∏∞) -->
                <g class="plum-right">
                    <path d="M495 42 Q485 35 475 38 Q465 36 458 28" stroke="#5d4037" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M475 38 Q472 30 468 24" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    <g transform="translate(460, 26) scale(0.8)">
                        <ellipse cx="0" cy="-6" rx="3" ry="5" fill="url(#petalGradMain)"/>
                        <ellipse cx="5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(72)"/>
                        <ellipse cx="3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(144)"/>
                        <ellipse cx="-3.5" cy="4.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(216)"/>
                        <ellipse cx="-5.7" cy="-1.8" rx="3" ry="5" fill="url(#petalGradMain)" transform="rotate(288)"/>
                        <circle cx="0" cy="0" r="2.5" fill="#ffeb3b"/>
                    </g>
                    <circle cx="472" cy="35" r="3" fill="#ffb6c1"/>
                    <circle cx="482" cy="40" r="2.5" fill="#ffc0cb"/>
                </g>
            </svg>
        </h1>
        <div class="top-actions">
            <button id="addUserBtn" class="btn-common btn-user-add">‚ûï ÏÇ¨Ïö©Ïûê Îì±Î°ù</button>
            <div style="display: flex; gap: 4px;">
                <input type="text" id="searchInput" class="search-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                <button id="searchBtn" class="btn-common" style="padding: 8px 12px; background: #3b82f6; color: white;">üîç</button>
            </div>
            
            <!-- ÌöåÏõê Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="memberDropdown">
                <button class="admin-dropdown-btn dropdown-member">üë• ÌöåÏõê Í¥ÄÎ¶¨</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="approveBtn">‚úÖ ÏäπÏù∏ Í¥ÄÎ¶¨ <span id="pendingBadge" class="pending-badge" style="display:none; margin-left:auto;">0</span></button>
                    <button class="admin-dropdown-item" id="bulkAddBtn">üìù ÏùºÍ¥Ñ Îì±Î°ù</button>
                    <button class="admin-dropdown-item" id="userManageBtn">üë§ Ïú†Ï†Ä Í¥ÄÎ¶¨</button>
                    <div class="admin-dropdown-divider"></div>
                    <button class="admin-dropdown-item danger" id="bulkDeleteBtn">üóëÔ∏è ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú</button>
                </div>
            </div>
            
            <!-- Í∏∏Îìú Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="guildDropdown">
                <button class="admin-dropdown-btn dropdown-guild">üè∞ Í∏∏Îìú Í¥ÄÎ¶¨</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="guildMoveBtn">üöÄ Í∏∏Îìú Ïù¥Îèô</button>
                    <button class="admin-dropdown-item" id="guildAddBtn">‚ûï Í∏∏Îìú Ï∂îÍ∞Ä</button>
                    <div class="admin-dropdown-divider"></div>
                    <button class="admin-dropdown-item danger" id="guildDeleteBtn">üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú</button>
                </div>
            </div>
            
            <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="dataDropdown">
                <button class="admin-dropdown-btn dropdown-data">üìä Îç∞Ïù¥ÌÑ∞</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="spreadsheetBtn">üìã Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïó∞Îèô</button>
                    <button class="admin-dropdown-item" id="syncExcludeBtn">üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨</button>
                    <button class="admin-dropdown-item" id="excelBtn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                    <button class="admin-dropdown-item" id="backupManageBtn">üì¶ Ï£ºÍ∞Ñ Î∞±ÏóÖ</button>
                </div>
            </div>
            
            <!-- ÏãúÏä§ÌÖú Í¥ÄÎ¶¨ ÎìúÎ°≠Îã§Ïö¥ -->
            <div class="admin-dropdown admin-only" id="systemDropdown">
                <button class="admin-dropdown-btn dropdown-system">‚öôÔ∏è ÏãúÏä§ÌÖú</button>
                <div class="admin-dropdown-menu">
                    <button class="admin-dropdown-item" id="lockManageBtn">üîí Ïû†Í∏à ÏÑ§Ï†ï</button>
                    <button class="admin-dropdown-item" id="deletedUsersBtn">üóëÔ∏è ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê</button>
                    <div class="admin-dropdown-divider super-admin-only" style="display:none;"></div>
                    <button class="admin-dropdown-item super-admin-only" id="logViewBtn" style="display:none;">üìù Î°úÍ∑∏ ÌôïÏù∏</button>
                    <button class="admin-dropdown-item super-admin-only" id="adminManageBtn" style="display:none;">üëë Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨</button>
                </div>
            </div>
            
            <button id="adminLoginBtn" class="btn-common btn-admin">Í¥ÄÎ¶¨Ïûê</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContent">
            <button class="modal-close-btn" onclick="closeModal()" title="Îã´Í∏∞">√ó</button>
            <div class="modal-header">
                <h3 id="modalTitle">Ï†úÎ™©</h3>
                <p id="modalSubtitle">Î∂ÄÏ†úÎ™©</p>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" id="modalSubmit">ÌôïÏù∏</button>
            </div>
        </div>
    </div>
    
    <div class="container" id="mainContainer"></div>
    
    
    <div class="guild-select-container" id="guildSelectContainer">
        <div class="guild-select-title">
            <div class="newyear-box">
                <!-- Îñ®Ïñ¥ÏßÄÎäî ÍΩÉÏûé -->
                <div class="petal-container">
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                    <div class="falling-petal"></div>
                </div>
                <!-- Î∞òÏßùÏù¥ -->
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                
                <svg class="select-title-svg" viewBox="0 0 500 70" xmlns="http://www.w3.org/2000/svg">
                    <!-- ÌïúÏßÄ ÌÖçÏä§Ï≤ò Î∞∞Í≤Ω Ìå®ÌÑ¥ -->
                    <defs>
                        <pattern id="hanji" patternUnits="userSpaceOnUse" width="100" height="100">
                            <rect fill="#fffaf5" width="100" height="100"/>
                            <circle cx="10" cy="10" r="0.5" fill="#f5e6d3" opacity="0.5"/>
                            <circle cx="50" cy="30" r="0.3" fill="#f5e6d3" opacity="0.4"/>
                            <circle cx="80" cy="60" r="0.4" fill="#f5e6d3" opacity="0.3"/>
                            <circle cx="30" cy="80" r="0.5" fill="#f5e6d3" opacity="0.4"/>
                        </pattern>
                        <!-- Îß§ÌôîÍΩÉ Í∑∏ÎùºÎç∞Ïù¥ÏÖò -->
                        <radialGradient id="petalGrad" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="#fff0f3"/>
                            <stop offset="70%" stop-color="#ffc0cb"/>
                            <stop offset="100%" stop-color="#ff8fa3"/>
                        </radialGradient>
                    </defs>
                    
                    <!-- ÏôºÏ™Ω Îß§Ìôî Í∞ÄÏßÄ -->
                    <g class="plum-left">
                        <!-- Í∞ÄÏßÄ -->
                        <path d="M5 55 Q20 45 35 50 Q50 48 60 35" stroke="#5d4037" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M35 50 Q38 40 45 30" stroke="#5d4037" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M50 42 Q55 35 52 25" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        
                        <!-- Îß§ÌôîÍΩÉ 1 (5Ïûé) -->
                        <g transform="translate(55, 32)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                            <circle cx="-1" cy="-1" r="0.8" fill="#ff6b6b"/>
                            <circle cx="1" cy="0" r="0.8" fill="#ff6b6b"/>
                            <circle cx="0" cy="1" r="0.8" fill="#ff6b6b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ 2 -->
                        <g transform="translate(38, 45) scale(0.7)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ Î¥âÏò§Î¶¨ -->
                        <circle cx="48" cy="26" r="4" fill="#ffb6c1"/>
                        <circle cx="25" cy="48" r="3" fill="#ffc0cb"/>
                        
                        <!-- 2027 -->
                        <text x="30" y="65" font-size="10" font-weight="bold" fill="#c62828" font-family="serif">2027</text>
                    </g>
                    
                    <!-- Í∞ÄÏö¥Îç∞ ÌÖçÏä§Ìä∏ -->
                    <text x="250" y="42" text-anchor="middle" font-family="'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif" font-size="26" font-weight="700" fill="#c62828">
                        Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                    </text>
                    <text x="250" y="58" text-anchor="middle" font-family="serif" font-size="11" fill="#d32f2f" opacity="0.7">
                        Êñ∞Âπ¥Á¶èÂ§ö ¬∑ ÏÉàÌï¥ Î≥µ ÎßéÏù¥ Î∞õÏúºÏÑ∏Ïöî
                    </text>
                    
                    <!-- Ïò§Î•∏Ï™Ω Îß§Ìôî Í∞ÄÏßÄ (ÏßÅÏ†ë Í∑∏Î¶¨Í∏∞) -->
                    <g class="plum-right">
                        <!-- Í∞ÄÏßÄ -->
                        <path d="M495 55 Q480 45 465 50 Q450 48 440 35" stroke="#5d4037" stroke-width="3" fill="none" stroke-linecap="round"/>
                        <path d="M465 50 Q462 40 455 30" stroke="#5d4037" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M450 42 Q445 35 448 25" stroke="#5d4037" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                        
                        <!-- Îß§ÌôîÍΩÉ 1 -->
                        <g transform="translate(445, 32)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                            <circle cx="-1" cy="-1" r="0.8" fill="#ff6b6b"/>
                            <circle cx="1" cy="0" r="0.8" fill="#ff6b6b"/>
                            <circle cx="0" cy="1" r="0.8" fill="#ff6b6b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ 2 -->
                        <g transform="translate(462, 45) scale(0.7)">
                            <ellipse cx="0" cy="-8" rx="4" ry="6" fill="url(#petalGrad)"/>
                            <ellipse cx="7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(72)"/>
                            <ellipse cx="4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(144)"/>
                            <ellipse cx="-4.7" cy="6.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(216)"/>
                            <ellipse cx="-7.6" cy="-2.5" rx="4" ry="6" fill="url(#petalGrad)" transform="rotate(288)"/>
                            <circle cx="0" cy="0" r="3" fill="#ffeb3b"/>
                        </g>
                        
                        <!-- Îß§ÌôîÍΩÉ Î¥âÏò§Î¶¨ -->
                        <circle cx="452" cy="26" r="4" fill="#ffb6c1"/>
                        <circle cx="475" cy="48" r="3" fill="#ffc0cb"/>
                    </g>
                </svg>
            </div>
        </div>
        <div class="guild-buttons" id="guildButtons"></div>
    </div>
    
    
    <div class="guild-detail-container" id="guildDetailContainer">
        <button class="back-btn" onclick="showGuildSelect()">‚Üê Í∏∏Îìú Î™©Î°ùÏúºÎ°ú</button>
        <div class="guild-detail-header">
            <div class="guild-detail-badge" id="detailBadge"></div>
            <h2 class="guild-detail-title" id="detailTitle"></h2>
            <span class="guild-detail-count" id="detailCount"></span>
        </div>
        <div class="card">
            <div class="card-body">
                <table>
                    <thead><tr><th>ÌîåÎ†àÏù¥Ïñ¥</th><th>Ï†ÑÌà¨Î†•</th></tr></thead>
                    <tbody id="detailList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, getDoc, query, orderBy, limit, deleteDoc, where } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrW07jxkT-I5k7LXT_IKVdw3o4s45ZRE0",
            authDomain: "guild-power-rank.firebaseapp.com",
            projectId: "guild-power-rank",
            storageBucket: "guild-power-rank.firebasestorage.app",
            messagingSenderId: "312765940928",
            appId: "1:312765940928:web:bdf388e3cdd4f32e699925",
            measurementId: "G-QPVZKMLS70"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

       
        let allGuildData = [];
        let guildList = []; 
        let isAdmin = false;
        let isSuperAdmin = false;
        let loggedInUser = null;
        let loggedInAdminId = null;
        let lockStartTime = 0;
        let lockEndTime = 0;
        let biweeklyBaseTime = 0; // 2Ï£º Î∞òÎ≥µ Í∏∞Ï§Ä ÏãúÍ∞Ñ
        let spreadsheetConfig = null;
        let syncExcludeList = []; // Î∂ÑÎ∞∞ Ï†úÏô∏ Î™©Î°ù
        const _0x = { a: "dGpkYWxzOTMyOA==", b: "dG5hbHM5MzI4QEA=" };
        
       
        const ADMIN_SESSION_TIMEOUT = 2 * 60 * 60 * 1000;
        let adminSessionTimer = null;
        
       
        function resetAdminSessionTimer() {
            if (!isAdmin) return;
            
           
            sessionStorage.setItem('adminLastActivity', Date.now().toString());
            
           
            if (adminSessionTimer) {
                clearTimeout(adminSessionTimer);
            }
            
           
            adminSessionTimer = setTimeout(() => {
                if (isAdmin) {
                    adminLogout(true);
                }
            }, ADMIN_SESSION_TIMEOUT);
        }
        
       
        async function adminLogout(isAuto = false) {
            isAdmin = false;
            isSuperAdmin = false;
            loggedInAdminId = null;
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('isSuperAdmin');
            sessionStorage.removeItem('adminLastActivity');
            sessionStorage.removeItem('loggedInAdminId');
            
            if (adminSessionTimer) {
                clearTimeout(adminSessionTimer);
                adminSessionTimer = null;
            }
            
            if (isAuto) {
                showAlert('2ÏãúÍ∞Ñ ÎèôÏïà ÌôúÎèôÏù¥ ÏóÜÏñ¥ ÏûêÎèô Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§', 'error');
            } else {
                showAlert('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§', 'success');
            }
            
           
            updateAdminUI();
            await loadData();
        }
        
       
        function checkAdminSession() {
            const lastActivity = sessionStorage.getItem('adminLastActivity');
            if (lastActivity && isAdmin) {
                const elapsed = Date.now() - parseInt(lastActivity);
                if (elapsed >= ADMIN_SESSION_TIMEOUT) {
                   
                    adminLogout(true);
                    return false;
                } else {
                   
                    resetAdminSessionTimer();
                }
            }
            return true;
        }
        
       
        ['click', 'keydown', 'mousemove', 'scroll', 'touchstart'].forEach(eventType => {
            document.addEventListener(eventType, () => {
                if (isAdmin) {
                    resetAdminSessionTimer();
                }
            }, { passive: true });
        });

       
        function toKST(timestamp) {
           
            return new Date(timestamp + (9 * 60 * 60 * 1000));
        }

        function fromKST(dateString) {
           
           
            return new Date(dateString + ':00+09:00').getTime();
        }

        function formatKSTDateTime(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function toDatetimeLocalValue(timestamp) {
            const kstDate = toKST(timestamp);
            const year = kstDate.getUTCFullYear();
            const month = String(kstDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getUTCDate()).padStart(2, '0');
            const hours = String(kstDate.getUTCHours()).padStart(2, '0');
            const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

       
        async function init() {
           
            if (sessionStorage.getItem('isAdmin') === 'true') { 
                isAdmin = true;
                if (sessionStorage.getItem('isSuperAdmin') === 'true') {
                    isSuperAdmin = true;
                }
               
                loggedInAdminId = sessionStorage.getItem('loggedInAdminId') || null;
                
               
                if (!checkAdminSession()) {
                    return;
                }
                
                updateAdminUI(); 
                await checkPendingUsers();
                await checkDuplicateNicknames();
            } else {
               
                const autoLoggedIn = await tryAutoLogin();
                if (autoLoggedIn && isAdmin) {
                    await checkDuplicateNicknames();
                }
            }
            
           
            await checkAutoLogin();
            
            await checkLockStatus();
            await loadSpreadsheetConfig();
            await loadData();
        }
        
       
        async function checkDuplicateNicknames() {
            if (!isAdmin) return;
            
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                const nicknameMap = {};
                
                querySnapshot.forEach((docSnap) => {
                    const user = docSnap.data();
                    const name = user.name;
                    const guild = user.guild;
                    
                    if (!nicknameMap[name]) {
                        nicknameMap[name] = [];
                    }
                    nicknameMap[name].push(guild);
                });
                
               
                const duplicates = [];
                for (const [name, guilds] of Object.entries(nicknameMap)) {
                    if (guilds.length > 1) {
                        duplicates.push({ name, guilds });
                    }
                }
                
                if (duplicates.length > 0) {
                    let alertMsg = '‚ö†Ô∏è Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Î∞úÍ≤¨!\n\n';
                    duplicates.forEach(dup => {
                        alertMsg += `‚Ä¢ ${dup.name}: ${dup.guilds.join(', ')}\n`;
                    });
                    alertMsg += '\nÏú†Ï†Ä Í¥ÄÎ¶¨ÏóêÏÑú Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî.';
                    
                   
                    showDuplicateAlert(duplicates);
                }
            } catch (e) {
                console.error('Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Ï≤¥ÌÅ¨ Ïò§Î•ò:', e);
            }
        }
        
       
        function showDuplicateAlert(duplicates) {
            openLargeModal('‚ö†Ô∏è Ï§ëÎ≥µ ÎãâÎÑ§ÏûÑ Í≤ΩÍ≥†', 'Îã§Î•∏ Í∏∏ÎìúÏóê ÎèôÏùºÌïú ÎãâÎÑ§ÏûÑÏù¥ Ï°¥Ïû¨Ìï©ÎãàÎã§');
            
            let html = `
                <div style="background:#fef2f2; border:2px solid #ef4444; border-radius:12px; padding:20px; margin-bottom:16px;">
                    <p style="color:#dc2626; font-weight:600; margin-bottom:12px;">üö® ÏïÑÎûò ÎãâÎÑ§ÏûÑÏù¥ Ïó¨Îü¨ Í∏∏ÎìúÏóê Ï§ëÎ≥µÎêòÏñ¥ ÏûàÏäµÎãàÎã§!</p>
                    <p style="color:#7f1d1d; font-size:13px;">ÎèôÏùºÏù∏Ïù¥ÎùºÎ©¥ ÌïòÎÇòÎ°ú ÌÜµÌï©ÌïòÍ≥†, Îã§Î•∏ ÏÇ¨ÎûåÏù¥ÎùºÎ©¥ ÎãâÎÑ§ÏûÑÏùÑ Î≥ÄÍ≤ΩÌï¥Ï£ºÏÑ∏Ïöî.</p>
                </div>
                <div class="table-scroll-container">
                    <table class="common-table">
                        <thead>
                            <tr>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>ÏÜåÏÜç Í∏∏Îìú</th>
                                <th>Ï§ëÎ≥µ Í∞úÏàò</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            duplicates.forEach(dup => {
                html += `<tr>
                    <td><strong style="color:#dc2626;">${dup.name}</strong></td>
                    <td>${dup.guilds.map(g => `<span style="background:#fee2e2; padding:2px 8px; border-radius:4px; margin:2px; display:inline-block;">${g}</span>`).join(' ')}</td>
                    <td><span style="background:#ef4444; color:white; padding:2px 8px; border-radius:4px; font-weight:600;">${dup.guilds.length}Í∞ú</span></td>
                </tr>`;
            });
            
            html += `</tbody></table></div>
                <div style="margin-top:16px; text-align:right;">
                    <button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>
                </div>`;
            
            setModalBody(html);
            document.getElementById('modalFooter').style.display = 'none';
        }
        
       
        async function checkAutoLogin() {
            const autoLogin = localStorage.getItem('autoLogin');
            if (autoLogin) {
                try {
                    const data = JSON.parse(autoLogin);
                    const userDoc = await getDoc(doc(db, "users", data.username));
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                       
                        if (userData.password === data.password) {
                            loggedInUser = data.username;
                            console.log('ÏûêÎèô Î°úÍ∑∏Ïù∏:', loggedInUser);
                        } else {
                           
                            localStorage.removeItem('autoLogin');
                        }
                    } else {
                       
                        localStorage.removeItem('autoLogin');
                    }
                } catch (e) {
                    console.error('ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏóêÎü¨:', e);
                    localStorage.removeItem('autoLogin');
                }
            }
        }

        async function loadSpreadsheetConfig() {
            try {
                const docRef = doc(db, "config", "spreadsheet");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    spreadsheetConfig = docSnap.data();
                    syncExcludeList = spreadsheetConfig.excludeList || [];
                }
            } catch (e) {
                console.log("Spreadsheet config error", e);
            }
        }

        async function checkLockStatus() {
            try {
                const docRef = doc(db, "config", "system");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lockStartTime = data.lockStartTime || 0;
                    lockEndTime = data.lockEndTime || 0;
                    biweeklyBaseTime = data.biweeklyBaseTime || 0;
                    
                    // 2Ï£º Î∞òÎ≥µÏù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÍ≥†, ÌòÑÏû¨ Ïû†Í∏à Í∏∞Í∞ÑÏù¥ ÏßÄÎÇ¨ÏúºÎ©¥ Îã§Ïùå Í∏∞Í∞ÑÏúºÎ°ú ÏûêÎèô Í∞±Ïã†
                    if (biweeklyBaseTime > 0 && lockEndTime > 0) {
                        const now = Date.now();
                        if (now > lockEndTime) {
                            // Îã§Ïùå 2Ï£º Í∏∞Í∞Ñ Í≥ÑÏÇ∞
                            const twoWeeksMs = 14 * 24 * 60 * 60 * 1000;
                            let newStart = lockStartTime;
                            let newEnd = lockEndTime;
                            
                            // ÌòÑÏû¨ ÏãúÍ∞ÑÏù¥ ÏßÄÎÇ† ÎïåÍπåÏßÄ 2Ï£ºÏî© Ï∂îÍ∞Ä
                            while (newEnd < now) {
                                newStart += twoWeeksMs;
                                newEnd += twoWeeksMs;
                            }
                            
                            // Firebase ÏóÖÎç∞Ïù¥Ìä∏
                            await setDoc(docRef, {
                                lockStartTime: newStart,
                                lockEndTime: newEnd,
                                biweeklyBaseTime: biweeklyBaseTime,
                                lockType: 'biweekly'
                            });
                            
                            lockStartTime = newStart;
                            lockEndTime = newEnd;
                            console.log('2Ï£º Î∞òÎ≥µ Ïû†Í∏à ÏûêÎèô Í∞±Ïã†:', formatKSTDateTime(newStart), '~', formatKSTDateTime(newEnd));
                        }
                    }
                }
                updateLockUI();
            } catch (e) { console.log("Config error", e); }
        }

        function isSystemLocked() { 
            const now = Date.now();
            return (lockStartTime > 0 && lockEndTime > 0 && now >= lockStartTime && now <= lockEndTime); 
        }

        function updateLockUI() {
            const banner = document.getElementById('lockBanner');
            const addUserBtn = document.getElementById('addUserBtn');
            if (isSystemLocked() && !isAdmin) {
                banner.classList.add('active');
                addUserBtn.classList.add('disabled');
                const remainMs = lockEndTime - Date.now();
                const remainHours = Math.ceil(remainMs / (1000 * 60 * 60));
                const biweeklyText = biweeklyBaseTime > 0 ? ' (2Ï£º Î∞òÎ≥µ)' : '';
                banner.innerText = `‚õî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§ | Í∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)}${biweeklyText} (ÏïΩ ${remainHours}ÏãúÍ∞Ñ ÎÇ®Ïùå)`;
            } else {
                banner.classList.remove('active');
                addUserBtn.classList.remove('disabled');
            }
        }

        async function checkPendingUsers() {
            if (!isAdmin) return;
            const q = query(collection(db, "pendingUsers"));
            const snapshot = await getDocs(q);
            const count = snapshot.size;
            
            const badge = document.getElementById('pendingBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
                showAlert(`ÏäπÏù∏ ÏöîÏ≤≠Ïù¥ ${count}Í∞ú ÎèÑÏ∞©ÌïòÏòÄÏäµÎãàÎã§`, 'success');
            } else {
                badge.style.display = 'none';
            }
        }

        function updateAdminUI() {
            const btn = document.getElementById('adminLoginBtn');
            if(isAdmin) {
                btn.textContent = isSuperAdmin ? 'ÏµúÏ¢ÖÍ¥ÄÎ¶¨ÏûêÎãò' : 'Í¥ÄÎ¶¨ÏûêÎãò'; 
                btn.classList.add('logged-in');
                document.querySelectorAll('.admin-only').forEach(el => {
                    if(el.classList.contains('admin-dropdown')) {
                        el.style.display = 'inline-block';
                    } else if(el.classList.contains('admin-dropdown-item')) {
                        el.style.display = 'flex';
                    } else if(el.classList.contains('admin-dropdown-divider')) {
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'inline-flex';
                    }
                });
               
                if(isSuperAdmin) {
                    document.querySelectorAll('.super-admin-only').forEach(el => {
                        if(el.classList.contains('admin-dropdown-item')) {
                            el.style.display = 'flex';
                        } else if(el.classList.contains('admin-dropdown-divider')) {
                            el.style.display = 'block';
                        } else {
                            el.style.display = 'inline-flex';
                        }
                    });
                } else {
                    document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
                }
                updateLockUI();
            } else {
               
                btn.textContent = 'Í¥ÄÎ¶¨Ïûê';
                btn.classList.remove('logged-in');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'none');
            }
        }

        const formatDateTime = (d) => {
            const date = toKST(d);
            return `${date.getUTCFullYear()}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${String(date.getUTCDate()).padStart(2,'0')} ` +
                   `${String(date.getUTCHours()).padStart(2,'0')}:${String(date.getUTCMinutes()).padStart(2,'0')}:${String(date.getUTCSeconds()).padStart(2,'0')}`;
        };

        async function getIp() { try { const res = await fetch('https://api.ipify.org?format=json'); return (await res.json()).ip; } catch (e) { return 'unknown'; } }

        async function fetchGuildList() {
            const docRef = doc(db, "config", "guilds");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) { guildList = docSnap.data().names || []; } 
            else { guildList = ['ÏÇ¨Ïã†', 'Ï∂ïÎ≥µ', 'ÎÜÄÏûê', 'Î£®ÎπÑ']; await setDoc(docRef, { names: guildList }); }
        }

       
        let guildDataMap = {};
        let currentGuild = null;

        async function loadData() {
            await fetchGuildList();
            
            const querySnapshot = await getDocs(collection(db, "users"));
            guildDataMap = {}; 
            guildList.forEach(g => guildDataMap[g] = []); 
            allGuildData = [];

            if (querySnapshot.empty) { await initializeDatabase(); return; }

            querySnapshot.forEach((docSnap) => {
                const user = docSnap.data();
                user.shape_legend = typeof user.shape_legend === 'number' ? user.shape_legend : (user.shape_legend ? 1 : 0);
                user.shape_myth = typeof user.shape_myth === 'number' ? user.shape_myth : (user.shape_myth ? 1 : 0);
                user.mount_legend = typeof user.mount_legend === 'number' ? user.mount_legend : (user.mount_legend ? 1 : 0);
                user.mount_myth = typeof user.mount_myth === 'number' ? user.mount_myth : (user.mount_myth ? 1 : 0);

                if (guildDataMap[user.guild] !== undefined) guildDataMap[user.guild].push(user);
                else if (guildList.includes(user.guild)) guildDataMap[user.guild] = [user];
            });

           
            Object.keys(guildDataMap).forEach(guildName => {
                guildDataMap[guildName].sort((a, b) => b.power - a.power);
                allGuildData.push(...guildDataMap[guildName]);
            });

           
            renderGuildButtons();
            
           
            if (currentGuild && guildList.includes(currentGuild)) {
                showGuildDetail(currentGuild);
            } else {
                showGuildSelect();
            }
        }

        function renderGuildButtons() {
            const container = document.getElementById('guildButtons');
            container.innerHTML = '';
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            
            guildList.forEach((guildName, index) => {
                const count = guildDataMap[guildName]?.length || 0;
                const btn = document.createElement('div');
                btn.className = 'guild-btn';
                btn.innerHTML = `
                    <div class="guild-btn-badge" style="background: ${colors[index % 4]}"></div>
                    <div class="guild-btn-info">
                        <div class="guild-btn-name">${guildName}</div>
                        <div class="guild-btn-count">${count}Î™ÖÏùò Í∏∏ÎìúÏõê</div>
                    </div>
                    <div class="guild-btn-arrow">‚Üí</div>
                `;
                btn.onclick = () => showGuildDetail(guildName);
                container.appendChild(btn);
            });
        }

        window.showGuildSelect = function() {
            currentGuild = null;
            document.getElementById('guildSelectContainer').style.display = 'block';
            document.getElementById('guildDetailContainer').classList.remove('active');
        }

        window.showGuildDetail = function(guildName) {
            currentGuild = guildName;
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            const colorIndex = guildList.indexOf(guildName);
            
            document.getElementById('guildSelectContainer').style.display = 'none';
            document.getElementById('guildDetailContainer').classList.add('active');
            
            document.getElementById('detailBadge').style.background = colors[colorIndex % 4];
            document.getElementById('detailTitle').textContent = guildName;
            
            const users = guildDataMap[guildName] || [];
            document.getElementById('detailCount').textContent = `${users.length}Î™Ö`;
            
            const tbody = document.getElementById('detailList');
            tbody.innerHTML = '';
            
            users.forEach((user, index) => {
                const tr = document.createElement('tr');
                let icons = "";
                if(user.shape_legend > 0) icons += "üõ°Ô∏è";
                if(user.shape_myth > 0) icons += "üëë";
                if(user.mount_legend > 0) icons += "üê¥";
                if(user.mount_myth > 0) icons += "ü¶Ñ";
                
                const shouldBlur = !isAdmin && (loggedInUser !== user.name);
                const blurClass = shouldBlur ? ' blurred' : '';
                
                tr.innerHTML = `<td><div class="player-cell"><span class="rank-number">${index + 1}</span><span class="player-name" title="${user.name}">${user.name}</span><span class="spec-icons">${icons}</span></div></td>
                    <td><span class="power-value${blurClass}">${user.power.toLocaleString()}</span></td>`;
                
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('power-value')) {
                        showUserInfo(user.name);
                    }
                });
                
                const powerValueSpan = tr.querySelector('.power-value');
                powerValueSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handlePowerClick(user.name);
                });
                
                tbody.appendChild(tr);
            });
        }

       
        async function showUserInfo(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();

           
            const isBlurred = !isAdmin && (loggedInUser !== name);

            const showCount = (count) => {
                if (count > 0) {
                    return `<span class="spec-count">${count}Í∞ú</span>`;
                } else {
                    return `<span class="spec-count zero">ÏóÜÏùå</span>`;
                }
            };

                       let updatedInfo = '';
            if (isAdmin && u.updatedAt) {
                const updatedDate = formatDateTime(u.updatedAt);
                const isAdminUpdate = u.updatedBy === 'admin';
                updatedInfo = `<p style="font-size:12px; color:#6b7280; margin-top:8px;">Í∞±Ïã†Ïùº: ${updatedDate}${isAdminUpdate ? ' (Í¥ÄÎ¶¨Ïûê)' : ''}</p>`;
            }

                       const renameButton = isAdmin ? `<button class="btn btn-rename" onclick="window.openRenameModal('${name}')" style="flex:1">üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</button>` : '';

            const content = `
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Í∏∏Îìú</span><span class="info-val">${u.guild}</span></div>
                    <div class="info-item">
                        <span class="info-label">Ï†ÑÌà¨Î†•</span>
                        <span class="info-val ${isBlurred ? 'power-value blurred' : ''}" ${isBlurred ? 'title="Î°úÍ∑∏Ïù∏ ÌõÑ ÌôïÏù∏ Í∞ÄÎä•"' : ''}>
                            ${isBlurred ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : u.power.toLocaleString()}
                        </span>
                    </div>
                </div>
                ${updatedInfo}
                <div class="info-grid" style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd;">
                    <div class="info-item"><span class="info-label">üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</span>${showCount(u.shape_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">üëë ÌòïÏÉÅ Ïã†Ìôî</span>${showCount(u.shape_myth || 0)}</div>
                    <div class="info-item"><span class="info-label">üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</span>${showCount(u.mount_legend || 0)}</div>
                    <div class="info-item"><span class="info-label">ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</span>${showCount(u.mount_myth || 0)}</div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; text-align:center;">‚Äª Ïä§Ìéô Í∞úÏàòÎäî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÑ§Ï†ïÌï©ÎãàÎã§</p>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn btn-primary" onclick="window.editUserFromInfo('${name}')" style="flex:1">‚úèÔ∏è Ï†ïÎ≥¥ ÏàòÏ†ï</button>
                    ${renameButton}
                </div>
            `;
            
            openSmallModal('ÏÉÅÏÑ∏ Ï†ïÎ≥¥', u.name, content);
            document.getElementById('modalFooter').style.display = 'none';
        }

               window.openRenameModal = async function(oldName) {
            if (!isAdmin) {
                showAlert('‚ùå ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÏùÄ Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§', 'error');
                return;
            }

            openSmallModal('ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö©)', `ÌòÑÏû¨: ${oldName}`, `
                <div class="form-group">
                    <label class="form-label">ÏÉà ÎãâÎÑ§ÏûÑ</label>
                    <input type="text" id="newNickname" class="form-input" placeholder="ÏÉàÎ°úÏö¥ ÎãâÎÑ§ÏûÑ ÏûÖÎ†•" autocomplete="off">
                </div>
                <p style="font-size:12px; color:#ef4444; margin-top:8px;">‚ö†Ô∏è ÎãâÎÑ§ÏûÑÏùÑ Î≥ÄÍ≤ΩÌïòÎ©¥ Ïù¥Ï†Ñ ÎãâÎÑ§ÏûÑÏúºÎ°úÎäî Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>
            `);

            setTimeout(() => document.getElementById('newNickname').focus(), 100);

            document.getElementById('modalSubmit').onclick = async () => {
                const newName = document.getElementById('newNickname').value.trim();
                
                if (!newName) {
                    showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                    return;
                }

                if (newName === oldName) {
                    showAlert('ÎèôÏùºÌïú ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error');
                    return;
                }

                               const checkDoc = await getDoc(doc(db, "users", newName));
                if (checkDoc.exists()) {
                    showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error');
                    return;
                }

                try {
                                       const oldDocRef = doc(db, "users", oldName);
                    const oldDocSnap = await getDoc(oldDocRef);
                    const userData = oldDocSnap.data();

                                       userData.name = newName;
                    await setDoc(doc(db, "users", newName), userData);

                                       await deleteDoc(oldDocRef);

                                       await setDoc(doc(collection(db, "logs")), {
                        who: `${oldName} ‚Üí ${newName}`,
                        type: 'nickname_change',
                        old_value: oldName,
                        new_value: newName,
                        editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                        createdAt: Date.now(),
                        ip: await getIp(),
                        device: navigator.userAgent,
                        admin: true
                    });

                    showAlert(`ÎãâÎÑ§ÏûÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§: ${oldName} ‚Üí ${newName}`, 'success');
                    closeModal();
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(userData.guild);
                    }, 500);
                } catch (e) {
                    console.error(e);
                    showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                }
            };
        };

       
        document.getElementById('addUserBtn').addEventListener('click', () => {
            if (isSystemLocked() && !isAdmin) { 
                const lockMsg = `Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.\n\nÍ∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            openSmallModal('ÏÇ¨Ïö©Ïûê Îì±Î°ù', 'Ïã†Í∑ú Ïú†Ï†Ä Îì±Î°ù (Í¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌïÑÏöî)', `
                <div class="form-group"><label class="form-label">Í∏∏Îìú ÏÑ†ÌÉù</label><select id="newUserGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">ÎãâÎÑ§ÏûÑ</label><input type="text" id="newUserName" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ" autocomplete="off"></div>
                <div class="form-group"><label class="form-label">Ï†ÑÌà¨Î†• (Ïà´ÏûêÎßå)</label><input type="text" id="newUserPower" class="form-input" placeholder="Ïòà: 1200000" inputmode="numeric"></div>
                <div class="form-group"><label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏ (4ÏûêÎ¶¨)</label><input type="password" id="newUserPw" class="form-input" maxlength="4" inputmode="numeric" placeholder="Î≥∏Ïù∏Ïù∏Ï¶ùÏö©"></div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">‚Äª Îì±Î°ù ÌõÑ Í¥ÄÎ¶¨Ïûê ÏäπÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§</p>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const guild = document.getElementById('newUserGuild').value;
                const name = document.getElementById('newUserName').value.trim();
                const powerStr = document.getElementById('newUserPower').value.replace(/,/g, "").trim();
                const pw = document.getElementById('newUserPw').value;

                               if (!name) {
                    showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (!powerStr) {
                    showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                if (!/^\d+$/.test(powerStr)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
               
                if (!/^\d{4}$/.test(pw)) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4ÏûêÎ¶¨ Ïà´ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }

                               const userDocRef = doc(db, "users", name);
                const pendingDocRef = doc(db, "pendingUsers", name);
                const [userSnap, pendingSnap] = await Promise.all([
                    getDoc(userDocRef),
                    getDoc(pendingDocRef)
                ]);

                if (userSnap.exists() || pendingSnap.exists()) { 
                    showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÍ±∞ÎÇò ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§', 'error'); 
                    return; 
                }

                try {
                    const power = Number(powerStr);
                                       await setDoc(pendingDocRef, { 
                        guild, 
                        name, 
                        power, 
                        password: pw,
                        shape_legend: 0, 
                        shape_myth: 0,
                        mount_legend: 0, 
                        mount_myth: 0,
                        requestedAt: Date.now(),
                        ip: await getIp()
                    });
                    
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'user_request', 
                        old_value: '-', 
                        new_value: `Îì±Î°ùÏöîÏ≤≠(${guild})`, 
                        createdAt: Date.now(), 
                        ip: await getIp(), 
                        device: navigator.userAgent 
                    });
                    
                    showAlert(`${name}Îãò Îì±Î°ùÏù¥ ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§!\nÍ¥ÄÎ¶¨Ïûê ÏäπÏù∏ ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'success'); 
                    closeModal();
                } catch(e) { 
                    console.error(e); 
                    showAlert('Ïò§Î•ò Î∞úÏÉù', 'error'); 
                }
            };
        });

               document.getElementById('approveBtn').addEventListener('click', async () => {
            if (!isAdmin) return;

            openLargeModal('ÏäπÏù∏ Í¥ÄÎ¶¨', 'Îì±Î°ù ÏöîÏ≤≠ Î™©Î°ù');
            
            const q = query(collection(db, "pendingUsers"), orderBy("requestedAt", "desc"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                setModalBody('<div style="text-align:center; padding:40px; color:#9ca3af;">ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>');
                return;
            }

            let html = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th>ÏöîÏ≤≠ÏãúÍ∞Ñ</th><th>ÎãâÎÑ§ÏûÑ</th><th>Í∏∏Îìú</th><th>Ï†ÑÌà¨Î†•</th><th>Í¥ÄÎ¶¨</th></tr></thead><tbody>';
            
            snapshot.forEach(docSnap => {
                const u = docSnap.data();
                html += `<tr>
                    <td>${formatDateTime(u.requestedAt)}</td>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td>${u.power.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-success" onclick="window.approveUser('${u.name}')" style="padding:6px 12px; font-size:12px; margin-right:4px;">ÏäπÏù∏</button>
                        <button class="btn btn-danger" onclick="window.rejectUser('${u.name}')" style="padding:6px 12px; font-size:12px;">Í±∞Î∂Ä</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
        });

               window.approveUser = async function(name) {
            if (!await showConfirm('ÏÇ¨Ïö©Ïûê ÏäπÏù∏', `[${name}]ÎãòÏùò Îì±Î°ùÏùÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                const pendingSnap = await getDoc(pendingRef);
                
                if (!pendingSnap.exists()) {
                    showAlert('Ìï¥Îãπ ÏöîÏ≤≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }

                const userData = pendingSnap.data();
                
                               await setDoc(doc(db, "users", name), userData);
                
                               await deleteDoc(pendingRef);
                
                               await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_approved',
                    old_value: 'ÏäπÏù∏ÎåÄÍ∏∞',
                    new_value: 'ÏäπÏù∏ÏôÑÎ£å',
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`${name}ÎãòÏù¥ ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                await checkPendingUsers();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(userData.guild);
                }, 500);
            } catch (e) {
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        };

               window.rejectUser = async function(name) {
            if (!await showConfirm('Îì±Î°ù Í±∞Î∂Ä', `[${name}]ÎãòÏùò Îì±Î°ùÏùÑ Í±∞Î∂ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br><span style="color:#ef4444;">Ïù¥ ÏûëÏóÖÏùÄ Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.</span>`)) return;

            try {
                const pendingRef = doc(db, "pendingUsers", name);
                await deleteDoc(pendingRef);
                
                await setDoc(doc(collection(db, "logs")), {
                    who: name,
                    type: 'user_rejected',
                    old_value: 'ÏäπÏù∏ÎåÄÍ∏∞',
                    new_value: 'Í±∞Î∂ÄÎê®',
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`${name}ÎãòÏùò Îì±Î°ùÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                await checkPendingUsers();
            } catch (e) {
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        };

       
        function openUserEditModal(u) {
            const guildOptions = guildList.map(g => `<option value="${g}" ${g===u.guild?'selected':''}>${g}</option>`).join('');
            
            let specSection = '';
            if (isAdmin) {
                specSection = `
                    <div class="form-group"><label class="form-label">Î≥¥Ïú† Ïä§Ìéô (Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© - Í∞úÏàò ÏûÖÎ†•)</label>
                        <div class="spec-grid">
                            <div class="spec-input-group">
                                <label>üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</label>
                                <input type="number" class="form-input small" id="eSL" value="${u.shape_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>üëë ÌòïÏÉÅ Ïã†Ìôî</label>
                                <input type="number" class="form-input small" id="eSM" value="${u.shape_myth || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</label>
                                <input type="number" class="form-input small" id="eML" value="${u.mount_legend || 0}" min="0" max="99">
                            </div>
                            <div class="spec-input-group">
                                <label>ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</label>
                                <input type="number" class="form-input small" id="eMM" value="${u.mount_myth || 0}" min="0" max="99">
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const showCount = (count) => count > 0 ? `<span class="spec-count">${count}Í∞ú</span>` : `<span class="spec-count zero">ÏóÜÏùå</span>`;
                specSection = `
                    <div class="form-group"><label class="form-label">Î≥¥Ïú† Ïä§Ìéô (Ï°∞Ìöå Ï†ÑÏö©)</label>
                        <div class="info-grid" style="margin-top:10px;">
                            <div class="info-item"><span class="info-label">üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</span>${showCount(u.shape_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">üëë ÌòïÏÉÅ Ïã†Ìôî</span>${showCount(u.shape_myth || 0)}</div>
                            <div class="info-item"><span class="info-label">üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</span>${showCount(u.mount_legend || 0)}</div>
                            <div class="info-item"><span class="info-label">ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</span>${showCount(u.mount_myth || 0)}</div>
                        </div>
                        <p style="font-size:12px; color:#6b7280; margin-top:8px;">‚Äª Ïä§Ìéô Í∞úÏàòÎäî Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏÑ§Ï†ïÌï©ÎãàÎã§</p>
                    </div>
                `;
            }
            
           
            const deleteBtn = isAdmin ? `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <button type="button" id="deleteUserBtn" class="btn" style="width:100%; background:#ef4444; color:white;">üóëÔ∏è Ïù¥ ÏÇ¨Ïö©Ïûê Îì±Î°ù Ìï¥Ï†ú</button>
                </div>
            ` : '';
            
            const html = `
                <div class="form-group"><label class="form-label">Í∏∏Îìú</label><select id="editGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">Ï†ÑÌà¨Î†•</label><input type="text" id="editPower" class="form-input" value="${u.power}" inputmode="numeric"><p style="font-size:12px; color:#6b7280; margin-top:4px;">‚Äª Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§</p></div>
                ${specSection}
                ${deleteBtn}
            `;
            openSmallModal('Ï†ïÎ≥¥ ÏàòÏ†ï', u.name, html);

                       if (isAdmin) {
                setTimeout(() => {
                    const deleteBtnEl = document.getElementById('deleteUserBtn');
                    if (deleteBtnEl) {
                        deleteBtnEl.onclick = () => {
                            closeModal();
                            setTimeout(() => deleteUser(u.name), 300);
                        };
                    }
                }, 100);
            }

            document.getElementById('modalSubmit').innerText = "ÏàòÏ†ï ÏôÑÎ£å";
            document.getElementById('modalSubmit').onclick = async () => {
                const nGuild = document.getElementById('editGuild').value;
                const powerInput = document.getElementById('editPower').value.replace(/,/g,"").trim();
                
                               if (!powerInput) {
                    showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                if (!/^\d+$/.test(powerInput)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const nPower = Number(powerInput);
                
                if (isNaN(nPower) || nPower < 0) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïò¨Î∞îÎ•∏ Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                let newData = {
                    guild: nGuild,
                    power: nPower,
                    updatedAt: Date.now(),
                    updatedBy: isAdmin ? 'admin' : 'user'
                };
                
                let newSL = u.shape_legend || 0;
                let newSM = u.shape_myth || 0;
                let newML = u.mount_legend || 0;
                let newMM = u.mount_myth || 0;
                
                if (isAdmin) {
                    newSL = Number(document.getElementById('eSL').value) || 0;
                    newSM = Number(document.getElementById('eSM').value) || 0;
                    newML = Number(document.getElementById('eML').value) || 0;
                    newMM = Number(document.getElementById('eMM').value) || 0;
                    newData.shape_legend = newSL;
                    newData.shape_myth = newSM;
                    newData.mount_legend = newML;
                    newData.mount_myth = newMM;
                }
                
                const changes = [];
                if (u.power !== nPower) {
                    changes.push(`Ï†ÑÌà¨Î†•: ${u.power.toLocaleString()} ‚Üí ${nPower.toLocaleString()}`);
                }
                if (u.guild !== nGuild) {
                    changes.push(`Í∏∏Îìú: ${u.guild} ‚Üí ${nGuild}`);
                }
                if (isAdmin) {
                    if ((u.shape_legend || 0) !== newSL) {
                        changes.push(`ÌòïÏÉÅÏ†ÑÏÑ§: ${u.shape_legend || 0} ‚Üí ${newSL}`);
                    }
                    if ((u.shape_myth || 0) !== newSM) {
                        changes.push(`ÌòïÏÉÅÏã†Ìôî: ${u.shape_myth || 0} ‚Üí ${newSM}`);
                    }
                    if ((u.mount_legend || 0) !== newML) {
                        changes.push(`ÌÉàÍ≤ÉÏ†ÑÏÑ§: ${u.mount_legend || 0} ‚Üí ${newML}`);
                    }
                    if ((u.mount_myth || 0) !== newMM) {
                        changes.push(`ÌÉàÍ≤ÉÏã†Ìôî: ${u.mount_myth || 0} ‚Üí ${newMM}`);
                    }
                }
                
                const oldValues = {
                    power: u.power,
                    guild: u.guild,
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                };
                
                const newValues = {
                    power: nPower,
                    guild: nGuild,
                    shape_legend: newSL,
                    shape_myth: newSM,
                    mount_legend: newML,
                    mount_myth: newMM
                };

                await updateDoc(doc(db, "users", u.name), newData);
                await setDoc(doc(collection(db, "logs")), { 
                    who: u.name, 
                    type: 'info_edit', 
                    old_value: JSON.stringify(oldValues), 
                    new_value: JSON.stringify(newValues),
                    changes: changes.length > 0 ? changes.join(', ') : 'Î≥ÄÍ≤ΩÏóÜÏùå',
                    editedBy: isAdmin ? (loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') : 'self',
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    device: navigator.userAgent
                });
                
                showAlert('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§', 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(nGuild);
                }, 500);
            };
        }

               document.getElementById('bulkAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            
            const html = `
                <div class="form-group"><label class="form-label">1. Ïù¥ÎèôÏãúÌÇ¨ Í∏∏Îìú ÏÑ†ÌÉù</label><select id="bulkGuild" class="form-input">${guildOptions}</select></div>
                <div class="form-group"><label class="form-label">2. Î∂ÄÏó¨Ìï† Ïä§Ìéô Í∞úÏàò</label>
                    <div class="spec-grid">
                        <div class="spec-input-group">
                            <label>üõ°Ô∏è ÌòïÏÉÅ Ï†ÑÏÑ§</label>
                            <input type="number" class="form-input small" id="bSL" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>üëë ÌòïÏÉÅ Ïã†Ìôî</label>
                            <input type="number" class="form-input small" id="bSM" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>üê¥ ÌÉàÍ≤É Ï†ÑÏÑ§</label>
                            <input type="number" class="form-input small" id="bML" value="0" min="0" max="99">
                        </div>
                        <div class="spec-input-group">
                            <label>ü¶Ñ ÌÉàÍ≤É Ïã†Ìôî</label>
                            <input type="number" class="form-input small" id="bMM" value="0" min="0" max="99">
                        </div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">3. ÎãâÎÑ§ÏûÑ ÏûÖÎ†• (ÏÑ∏Î°úÎ°ú ÏóîÌÑ∞Ï≥êÏÑú ÏûÖÎ†•)</label>
                    <textarea id="bulkNames" class="form-input" rows="8" placeholder="ÌôçÍ∏∏Îèô&#10;ÏûÑÍ∫ΩÏ†ï&#10;ÏïÑÎ¨¥Í∞ú"></textarea>
                </div>
                <p style="font-size:12px; color:#666;">‚Äª Í∏∞Ï°¥ Ïú†Ï†ÄÎäî Í∏∏ÎìúÏôÄ Ïä§ÌéôÏù¥ Î≥ÄÍ≤ΩÎêòÍ≥† <b>Ï†ÑÌà¨Î†•ÏùÄ Ïú†ÏßÄ</b>Îê©ÎãàÎã§.<br>‚Äª Ïã†Í∑ú Ïú†Ï†ÄÎäî Ï†ÑÌà¨Î†• 0ÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§.</p>
            `;
            openLargeModal('ÏùºÍ¥Ñ Îì±Î°ù', 'Ïó¨Îü¨ Ïú†Ï†ÄÎ•º Ìïú Î≤àÏóê Îì±Î°ùÌï©ÎãàÎã§.');
            setModalBody(html);

            const footerBtn = document.createElement('button');
            footerBtn.className = "btn btn-primary";
            footerBtn.innerText = "ÏùºÍ¥Ñ Ï†ÅÏö© Ïã§Ìñâ";
            footerBtn.onclick = executeBulkUpdate;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Îã´Í∏∞";
            closeBtn.onclick = closeModal;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.textAlign = "right";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";
            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(footerBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        });

        async function executeBulkUpdate() {
            const targetGuild = document.getElementById('bulkGuild').value;
            const namesText = document.getElementById('bulkNames').value;
            const specs = {
                shape_legend: Number(document.getElementById('bSL').value) || 0,
                shape_myth: Number(document.getElementById('bSM').value) || 0,
                mount_legend: Number(document.getElementById('bML').value) || 0,
                mount_myth: Number(document.getElementById('bMM').value) || 0
            };

            if(!namesText.trim()) { showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); return; }

            const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
            let updateCount = 0;
            let newCount = 0;

            const btn = event.target;
            btn.innerText = "Ï≤òÎ¶¨ Ï§ë...";
            btn.disabled = true;
            
            // ÏßÑÌñâÎ•† Î™®Îã¨ ÌëúÏãú
            const progress = showProgress('üìù ÏùºÍ¥Ñ Îì±Î°ù Ï§ë', `${names.length}Î™Ö Ï≤òÎ¶¨ Ï§ë...`);

            try {
                for(let i = 0; i < names.length; i++) {
                    const name = names[i];
                    const docRef = doc(db, "users", name);
                    const docSnap = await getDoc(docRef);

                    if(docSnap.exists()) {
                        await updateDoc(docRef, {
                            guild: targetGuild,
                            ...specs
                        });
                        updateCount++;
                    } else {
                        await setDoc(docRef, {
                            name: name,
                            guild: targetGuild,
                            power: 0,
                            password: null,
                            ...specs
                        });
                        newCount++;
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    progress.update(((i + 1) / names.length) * 100, `${i + 1}/${names.length} Ï≤òÎ¶¨ Ï§ë... (${name})`);
                }
                
                progress.close();
                
                await setDoc(doc(collection(db, "logs")), { 
                    who: 'Admin', 
                    type: 'bulk_update', 
                    old_value: '-', 
                    new_value: `${names.length}Î™Ö Ï≤òÎ¶¨`, 
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                showAlert(`ÏôÑÎ£å! (ÏàòÏ†ï:${updateCount}, Ïã†Í∑ú:${newCount})`, 'success');
                closeModal();
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(targetGuild);
                }, 500);

            } catch(e) {
                progress.close();
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
                btn.innerText = "ÏùºÍ¥Ñ Ï†ÅÏö© Ïã§Ìñâ";
                btn.disabled = false;
            }
        }

               document.getElementById('guildMoveBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            const guildOptions = guildList.map(g => `<option value="${g}">${g}</option>`).join('');
            
            const html = `
                <div style="background:#f0f9ff; border:2px solid #0ea5e9; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <p style="color:#0369a1; font-weight:600; margin-bottom:8px;">üöÄ Í∏∏Îìú Ïù¥Îèô ÏïàÎÇ¥</p>
                    <ul style="color:#075985; font-size:13px; margin:0; padding-left:20px;">
                        <li>ÏûÖÎ†•Îêú ÎãâÎÑ§ÏûÑÏùÑ ÏÑ†ÌÉùÌïú Í∏∏ÎìúÎ°ú ÏùºÍ¥Ñ Ïù¥ÎèôÌï©ÎãàÎã§.</li>
                        <li>Ïù¥ÎØ∏ Ìï¥Îãπ Í∏∏ÎìúÏóê ÏûàÎäî Ïú†Ï†ÄÎäî ÏûêÎèôÏúºÎ°ú Í±¥ÎÑàÎúÅÎãàÎã§.</li>
                        <li>Ï†ÑÌà¨Î†•Í≥º Ïä§Ìéô Ï†ïÎ≥¥Îäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.</li>
                        <li>Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ ÎãâÎÑ§ÏûÑÏùÄ Î¨¥ÏãúÎê©ÎãàÎã§.</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥ÎèôÌï† Í∏∏Îìú ÏÑ†ÌÉù</label>
                    <select id="moveTargetGuild" class="form-input">${guildOptions}</select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥ÎèôÌï† ÎãâÎÑ§ÏûÑ ÏûÖÎ†• (Ìïú Ï§ÑÏóê ÌïòÎÇòÏî©)</label>
                    <textarea id="moveNames" class="form-input" rows="10" placeholder="ÌôçÍ∏∏Îèô&#10;ÏûÑÍ∫ΩÏ†ï&#10;ÏïÑÎ¨¥Í∞ú&#10;..."></textarea>
                </div>
            `;
            openLargeModal('üöÄ Í∏∏Îìú Ïù¥Îèô', 'Ïó¨Îü¨ Ïú†Ï†ÄÎ•º Ìïú Î≤àÏóê Îã§Î•∏ Í∏∏ÎìúÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
            setModalBody(html);

            const footerBtn = document.createElement('button');
            footerBtn.className = "btn btn-primary";
            footerBtn.style.background = "#0ea5e9";
            footerBtn.innerText = "Í∏∏Îìú Ïù¥Îèô Ïã§Ìñâ";
            footerBtn.onclick = executeGuildMove;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Ï∑®ÏÜå";
            closeBtn.onclick = closeModal;

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.textAlign = "right";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";
            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(footerBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        });

        async function executeGuildMove() {
            const targetGuild = document.getElementById('moveTargetGuild').value;
            const namesText = document.getElementById('moveNames').value;

            if(!namesText.trim()) { 
                showAlert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); 
                return; 
            }

            const names = namesText.split('\n').map(n => n.trim()).filter(n => n);
            
            if(names.length === 0) {
                showAlert('Ïú†Ìö®Ìïú ÎãâÎÑ§ÏûÑÏù¥ ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            const btn = event.target;
            btn.innerText = "Ï≤òÎ¶¨ Ï§ë...";
            btn.disabled = true;
            
            // ÏßÑÌñâÎ•† Î™®Îã¨ ÌëúÏãú
            const progress = showProgress('üöÄ Í∏∏Îìú Ïù¥Îèô Ï§ë', `${names.length}Î™Ö Ï≤òÎ¶¨ Ï§ë...`);

            let movedCount = 0;                 let skippedCount = 0;               let notFoundCount = 0;              const movedUsers = [];
            const skippedUsers = [];
            const notFoundUsers = [];

            try {
                for(let i = 0; i < names.length; i++) {
                    const name = names[i];
                    const docRef = doc(db, "users", name);
                    const docSnap = await getDoc(docRef);

                    if(docSnap.exists()) {
                        const userData = docSnap.data();
                        
                        if(userData.guild === targetGuild) {
                                                       skippedCount++;
                            skippedUsers.push(name);
                        } else {
                                                       const oldGuild = userData.guild;
                            await updateDoc(docRef, {
                                guild: targetGuild,
                                updatedAt: Date.now(),
                                updatedBy: 'admin'
                            });
                            movedCount++;
                            movedUsers.push({ name, from: oldGuild, to: targetGuild });
                        }
                    } else {
                                               notFoundCount++;
                        notFoundUsers.push(name);
                    }
                    
                    // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                    progress.update(((i + 1) / names.length) * 100, `${i + 1}/${names.length} Ï≤òÎ¶¨ Ï§ë... (${name})`);
                }
                
                progress.close();
                
                // Ïù¥ÎèôÎêú Ïú†Ï†Ä Ïù¥Î¶Ñ Î™©Î°ù
                const movedNames = movedUsers.map(u => u.name).join(', ');
                
                               await setDoc(doc(collection(db, "logs")), { 
                    who: movedNames || 'Admin', 
                    type: 'guild_move', 
                    old_value: '-', 
                    new_value: `${targetGuild}ÏúºÎ°ú ${movedCount}Î™Ö Ïù¥Îèô`, 
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(), 
                    ip: await getIp(),
                    device: navigator.userAgent
                });

                               showGuildMoveResult(targetGuild, movedUsers, skippedUsers, notFoundUsers);
                
                setTimeout(async () => {
                    await loadData();
                    await autoSyncIfEnabled(targetGuild);
                }, 500);

            } catch(e) {
                progress.close();
                console.error(e);
                showAlert('Ïò§Î•ò Î∞úÏÉù', 'error');
                btn.innerText = "Í∏∏Îìú Ïù¥Îèô Ïã§Ìñâ";
                btn.disabled = false;
            }
        }

        function showGuildMoveResult(targetGuild, movedUsers, skippedUsers, notFoundUsers) {
            openLargeModal('üöÄ Í∏∏Îìú Ïù¥Îèô ÏôÑÎ£å', `${targetGuild} Í∏∏ÎìúÎ°ú Ïù¥Îèô Í≤∞Í≥º`);
            
            let html = `
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:20px;">
                    <div style="background:#dcfce7; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#16a34a;">${movedUsers.length}</div>
                        <div style="font-size:13px; color:#166534;">‚úÖ Ïù¥Îèô ÏÑ±Í≥µ</div>
                    </div>
                    <div style="background:#fef3c7; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#d97706;">${skippedUsers.length}</div>
                        <div style="font-size:13px; color:#92400e;">‚è≠Ô∏è Í±¥ÎÑàÎúÄ</div>
                    </div>
                    <div style="background:#fee2e2; border-radius:12px; padding:16px; text-align:center;">
                        <div style="font-size:32px; font-weight:700; color:#dc2626;">${notFoundUsers.length}</div>
                        <div style="font-size:13px; color:#991b1b;">‚ùå ÎØ∏Îì±Î°ù</div>
                    </div>
                </div>`;
            
                       if(movedUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;" open>
                        <summary style="cursor:pointer; font-weight:600; color:#16a34a; margin-bottom:8px;">‚úÖ Ïù¥Îèô ÏÑ±Í≥µ (${movedUsers.length}Î™Ö)</summary>
                        <div style="background:#f0fdf4; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${movedUsers.map(u => `<span style="display:inline-block; background:#dcfce7; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u.name} <span style="color:#6b7280;">(${u.from}‚Üí${u.to})</span></span>`).join('')}
                        </div>
                    </details>`;
            }
            
                       if(skippedUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;">
                        <summary style="cursor:pointer; font-weight:600; color:#d97706; margin-bottom:8px;">‚è≠Ô∏è Í±¥ÎÑàÎúÄ - Ïù¥ÎØ∏ ${targetGuild} ÏÜåÏÜç (${skippedUsers.length}Î™Ö)</summary>
                        <div style="background:#fffbeb; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${skippedUsers.map(u => `<span style="display:inline-block; background:#fef3c7; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u}</span>`).join('')}
                        </div>
                    </details>`;
            }
            
                       if(notFoundUsers.length > 0) {
                html += `
                    <details style="margin-bottom:12px;">
                        <summary style="cursor:pointer; font-weight:600; color:#dc2626; margin-bottom:8px;">‚ùå ÎØ∏Îì±Î°ù Ïú†Ï†Ä (${notFoundUsers.length}Î™Ö)</summary>
                        <div style="background:#fef2f2; border-radius:8px; padding:12px; max-height:150px; overflow-y:auto;">
                            ${notFoundUsers.map(u => `<span style="display:inline-block; background:#fee2e2; padding:4px 8px; margin:2px; border-radius:4px; font-size:12px;">${u}</span>`).join('')}
                        </div>
                    </details>`;
            }
            
            html += `<div style="text-align:right; margin-top:20px;">
                <button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>
            </div>`;
            
            setModalBody(html);
            document.getElementById('modalFooter').style.display = 'none';
        }

       
               async function checkLockStatusRealtime() {
            try {
                const docRef = doc(db, "config", "system");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const startTime = data.lockStartTime || 0;
                    const endTime = data.lockEndTime || 0;
                    const now = Date.now();
                    return (startTime > 0 && endTime > 0 && now >= startTime && now <= endTime);
                }
                return false;
            } catch (e) {
                console.log("Lock check error", e);
                return false;
            }
        }

        async function openPowerEditModal(name, u) {
           
            if (!isAdmin) {
                const isLocked = await checkLockStatusRealtime();
                if (isLocked) {
                    showAlert('ÌòÑÏû¨ ÏàòÏ†ï Í∏àÏßÄ ÏãúÍ∞ÑÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    await checkLockStatus();
                    return;
                }
            }
            
            openSmallModal('Ï†ÑÌà¨Î†• ÏàòÏ†ï', `ÌòÑÏû¨: ${u.power.toLocaleString()}`, `
                <div class="form-group">
                    <input type="text" class="form-input" id="editInput" value="${u.power}" inputmode="numeric">
                    <p style="font-size:12px; color:#6b7280; margin-top:8px;">‚Äª Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§</p>
                </div>
            `);
            setTimeout(() => { const i=document.getElementById('editInput'); i.focus(); i.select(); }, 100);
            
            document.getElementById('modalSubmit').onclick = async () => {
                               if (!isAdmin) {
                    const isLocked = await checkLockStatusRealtime();
                    if (isLocked) {
                        showAlert('ÌòÑÏû¨ ÏàòÏ†ï Í∏àÏßÄ ÏãúÍ∞ÑÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        closeModal();
                        await checkLockStatus();
                        return;
                    }
                }
                
                const inputVal = document.getElementById('editInput').value.replace(/,/g, "").trim();
                
                               if (!inputVal) {
                    showAlert('Ï†ÑÌà¨Î†•ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (!/^\d+$/.test(inputVal)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïà´ÏûêÎßå ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const val = Number(inputVal);
                
                               if (isNaN(val)) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ïò¨Î∞îÎ•∏ Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                
                               if (val < 0) {
                    showAlert('ÏàòÏ†ï Î∂àÍ∞ÄÎä•: Ï†ÑÌà¨Î†•ÏùÄ 0 Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                    return;
                }
                
                try {
                    await updateDoc(doc(db, "users", name), { 
                        power: val,
                        updatedAt: Date.now(),
                        updatedBy: isAdmin ? 'admin' : 'user'
                    });
                    await setDoc(doc(collection(db, "logs")), { 
                        who: name, 
                        type: 'power', 
                        old_value: u.power, 
                        new_value: val, 
                        editedBy: isAdmin ? (loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') : 'self',                        createdAt: Date.now(), 
                        ip: await getIp(), 
                        device: navigator.userAgent 
                    });
                    closeModal(); 
                    showAlert('ÏàòÏ†ï ÏôÑÎ£å', 'success'); 
                    setTimeout(async () => {
                        await loadData();
                        await autoSyncIfEnabled(u.guild);
                    }, 500);
                } catch (e) { 
                    showAlert('Ïò§Î•ò Î∞úÏÉù', 'error'); 
                }
            };
        }

               document.getElementById('adminLoginBtn').addEventListener('click', () => {
            if(isAdmin) { 
                openSmallModal('Î°úÍ∑∏ÏïÑÏõÉ', 'Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏùÑ Ìï¥Ï†úÌï©ÎãàÎã§', `<div style="text-align:center; padding:10px 0; color:#374151;">Ï†ïÎßê Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>`);
                const btn = document.getElementById('modalSubmit');
                btn.innerText = "Î°úÍ∑∏ÏïÑÏõÉ"; 
                btn.style.backgroundColor = "#ef4444";
                btn.onclick = async () => { 
                    closeModal();
                   
                    localStorage.removeItem('adminAutoLogin');
                    await adminLogout(false);
                };
                return; 
            }
            openSmallModal('Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏', '', `
                <div class="form-group"><input type="text" class="form-input" id="aid" placeholder="ID" autocomplete="off"></div>
                <div class="form-group"><input type="password" class="form-input" id="apw" placeholder="PW" autocomplete="off"></div>
                <div class="form-group" style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="autoLoginCheck" style="width:18px; height:18px; cursor:pointer;">
                    <label for="autoLoginCheck" style="font-size:14px; color:#374151; cursor:pointer;">ÏûêÎèô Î°úÍ∑∏Ïù∏</label>
                </div>
            `);
            const btn = document.getElementById('modalSubmit'); 
            btn.innerText = "ÌôïÏù∏"; 
            btn.style.backgroundColor = "";
            btn.onclick = async () => {
                const inputId = document.getElementById('aid').value;
                const inputPw = document.getElementById('apw').value;
                const autoLogin = document.getElementById('autoLoginCheck').checked;
                
                               if (btoa(inputId) === _0x.a && btoa(inputPw) === _0x.b) {
                    isAdmin = true;
                    isSuperAdmin = true;
                    loggedInAdminId = inputId;
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('isSuperAdmin', 'true');
                    sessionStorage.setItem('loggedInAdminId', inputId);
                   
                    if (autoLogin) {
                        localStorage.setItem('adminAutoLogin', btoa(JSON.stringify({id: inputId, pw: inputPw, type: 'super'})));
                    }
                    resetAdminSessionTimer();
                    updateAdminUI(); 
                    closeModal(); 
                    showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎ°ú Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                    await checkPendingUsers();
                   
                    await loadData();
                    return;
                }
                
                               try {
                    const adminDoc = await getDoc(doc(db, "admins", inputId));
                    if (adminDoc.exists() && adminDoc.data().password === inputPw) {
                        isAdmin = true;
                        isSuperAdmin = false;
                        loggedInAdminId = inputId;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.removeItem('isSuperAdmin');
                        sessionStorage.setItem('loggedInAdminId', inputId);
                       
                        if (autoLogin) {
                            localStorage.setItem('adminAutoLogin', btoa(JSON.stringify({id: inputId, pw: inputPw, type: 'normal'})));
                        }
                        resetAdminSessionTimer();
                        updateAdminUI();
                        closeModal();
                        showAlert('Í¥ÄÎ¶¨ÏûêÎ°ú Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§', 'success');
                        await checkPendingUsers();
                       
                        await loadData();
                        return;
                    }
                } catch (e) {
                    console.error('Admin check error:', e);
                }
                
                showAlert('Ï†ïÎ≥¥ Î∂àÏùºÏπò', 'error');
            };
        });
        

        async function tryAutoLogin() {
            const saved = localStorage.getItem('adminAutoLogin');
            if (!saved) return false;
            
            try {
                const {id, pw, type} = JSON.parse(atob(saved));
                
                if (type === 'super') {
                    if (btoa(id) === _0x.a && btoa(pw) === _0x.b) {
                        isAdmin = true;
                        isSuperAdmin = true;
                        loggedInAdminId = id;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.setItem('isSuperAdmin', 'true');
                        sessionStorage.setItem('loggedInAdminId', id);
                        resetAdminSessionTimer();
                        updateAdminUI();
                        await checkPendingUsers();
                        return true;
                    }
                } else {
                    const adminDoc = await getDoc(doc(db, "admins", id));
                    if (adminDoc.exists() && adminDoc.data().password === pw) {
                        isAdmin = true;
                        isSuperAdmin = false;
                        loggedInAdminId = id;
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.removeItem('isSuperAdmin');
                        sessionStorage.setItem('loggedInAdminId', id);
                        resetAdminSessionTimer();
                        updateAdminUI();
                        await checkPendingUsers();
                        return true;
                    }
                }
               
                localStorage.removeItem('adminAutoLogin');
            } catch (e) {
                console.error('Auto login error:', e);
                localStorage.removeItem('adminAutoLogin');
            }
            return false;
        }

               document.getElementById('guildAddBtn').addEventListener('click', () => {
            if(!isAdmin) return;
            openSmallModal('Í∏∏Îìú Ï∂îÍ∞Ä', '', `<div class="form-group"><input type="text" class="form-input" id="newGuildInput" autocomplete="off"></div>`);
            setTimeout(() => document.getElementById('newGuildInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => {
                const name = document.getElementById('newGuildInput').value.trim();
                if(!name || guildList.includes(name)) { showAlert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå', 'error'); return; }
                await updateDoc(doc(db, "config", "guilds"), { names: [...guildList, name] });
                showAlert('Ï∂îÍ∞ÄÎê®', 'success'); closeModal(); setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('guildDeleteBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            
            const guildOptions = guildList.map(g => {
                const memberCount = guildDataMap[g] ? guildDataMap[g].length : 0;
                return `<option value="${g}">${g} (${memberCount}Î™Ö)</option>`;
            }).join('');
            
            openLargeModal('üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú', 'ÏÇ≠Ï†úÌï† Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
            
            const html = `
                <div style="background:#fef2f2; border:2px solid #dc2626; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <p style="color:#dc2626; font-weight:600; margin-bottom:8px;">‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠</p>
                    <ul style="color:#991b1b; font-size:13px; margin:0; padding-left:20px;">
                        <li>Í∏∏ÎìúÏóê ÏÜåÏÜçÎêú Ïú†Ï†ÄÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.</li>
                        <li>Î®ºÏ†Ä 'Í∏∏Îìú Ïù¥Îèô' Í∏∞Îä•ÏúºÎ°ú Ïú†Ï†ÄÎ•º Îã§Î•∏ Í∏∏ÎìúÎ°ú Ïù¥ÎèôÏãúÏºúÏ£ºÏÑ∏Ïöî.</li>
                        <li>ÏÇ≠Ï†úÎêú Í∏∏ÎìúÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÇ≠Ï†úÌï† Í∏∏Îìú ÏÑ†ÌÉù</label>
                    <select id="deleteGuildSelect" class="form-input">${guildOptions}</select>
                </div>
                <div id="guildDeleteInfo" style="margin-top:16px; padding:16px; background:#f9fafb; border-radius:8px;">
                    <p style="color:#6b7280; text-align:center;">Í∏∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÎ©¥ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä ÌëúÏãúÎê©ÎãàÎã§.</p>
                </div>
            `;
            
            setModalBody(html);
            
            const updateGuildInfo = () => {
                const selectedGuild = document.getElementById('deleteGuildSelect').value;
                const members = guildDataMap[selectedGuild] || [];
                const infoDiv = document.getElementById('guildDeleteInfo');
                
                if (members.length > 0) {
                    infoDiv.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:48px; margin-bottom:8px;">üö´</div>
                            <p style="color:#dc2626; font-weight:600; font-size:16px;">ÏÇ≠Ï†ú Î∂àÍ∞Ä</p>
                            <p style="color:#991b1b; margin-top:8px;">${selectedGuild} Í∏∏ÎìúÏóê <strong>${members.length}Î™Ö</strong>Ïùò Ïú†Ï†ÄÍ∞Ä ÏûàÏäµÎãàÎã§.</p>
                            <p style="color:#6b7280; font-size:13px; margin-top:12px;">Í∏∏Îìú Ïù¥Îèô Í∏∞Îä•ÏúºÎ°ú Ïú†Ï†ÄÎ•º Î®ºÏ†Ä Ïù¥ÎèôÏãúÏºúÏ£ºÏÑ∏Ïöî.</p>
                            <div style="margin-top:16px; max-height:150px; overflow-y:auto; text-align:left; background:#fee2e2; padding:12px; border-radius:8px;">
                                <p style="font-size:12px; color:#991b1b; margin-bottom:8px;">ÏÜåÏÜç Ïú†Ï†Ä Î™©Î°ù:</p>
                                ${members.map(m => `<span style="display:inline-block; background:#fecaca; padding:2px 8px; margin:2px; border-radius:4px; font-size:11px;">${m.name}</span>`).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size:48px; margin-bottom:8px;">‚úÖ</div>
                            <p style="color:#16a34a; font-weight:600; font-size:16px;">ÏÇ≠Ï†ú Í∞ÄÎä•</p>
                            <p style="color:#166534; margin-top:8px;">${selectedGuild} Í∏∏ÎìúÏóê ÏÜåÏÜçÎêú Ïú†Ï†ÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <button id="confirmDeleteGuildBtn" class="btn btn-primary" style="margin-top:16px; background:#dc2626;">üóëÔ∏è ${selectedGuild} Í∏∏Îìú ÏÇ≠Ï†ú</button>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        const deleteBtn = document.getElementById('confirmDeleteGuildBtn');
                        if (deleteBtn) {
                            deleteBtn.onclick = async () => {
                                if (!await showConfirm('Í∏∏Îìú ÏÇ≠Ï†ú ÌôïÏù∏', `Ï†ïÎßêÎ°ú <strong>${selectedGuild}</strong> Í∏∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br><br><span style="color:#dc2626;">Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.</span>`)) return;
                                
                                try {
                                    const newGuildList = guildList.filter(g => g !== selectedGuild);
                                    await updateDoc(doc(db, "config", "guilds"), { names: newGuildList });
                                    
                                    await setDoc(doc(collection(db, "logs")), {
                                        who: 'Admin',
                                        type: 'guild_delete',
                                        old_value: selectedGuild,
                                        new_value: 'Í∏∏Îìú ÏÇ≠Ï†úÎê®',
                                        editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                                        createdAt: Date.now(),
                                        ip: await getIp()
                                    });
                                    
                                    showAlert(`${selectedGuild} Í∏∏ÎìúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
                                    closeModal();
                                    setTimeout(() => location.reload(), 1000);
                                } catch (e) {
                                    console.error(e);
                                    showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                                }
                            };
                        }
                    }, 100);
                }
            };
            
            document.getElementById('deleteGuildSelect').addEventListener('change', updateGuildInfo);
            updateGuildInfo();
            
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
        });

        document.getElementById('excelBtn').addEventListener('click', () => {
            if(!isAdmin || allGuildData.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(allGuildData.map(u => ({ 
                'Í∏∏Îìú': u.guild, 
                'ÎãâÎÑ§ÏûÑ': u.name, 
                'Ï†ÑÌà¨Î†•': u.power, 
                'ÌòïÏÉÅÏ†ÑÏÑ§': u.shape_legend || 0, 
                'ÌòïÏÉÅÏã†Ìôî': u.shape_myth || 0, 
                'ÌÉàÍ≤ÉÏ†ÑÏÑ§': u.mount_legend || 0, 
                'ÌÉàÍ≤ÉÏã†Ìôî': u.mount_myth || 0 
            })));
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Í∏∏ÎìúÌòÑÌô©"); 
            XLSX.writeFile(wb, "Í∏∏Îìú_Ï†ÑÌà¨Î†•_ÌòÑÌô©.xlsx");
        });

               document.getElementById('spreadsheetBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openSpreadsheetSettingsModal();
        });

        // Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨ Î≤ÑÌäº
        document.getElementById('syncExcludeBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            openSyncExcludeModal();
        });

        async function openSyncExcludeModal() {
            openLargeModal('üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Í¥ÄÎ¶¨', 'Î∂ÑÎ∞∞Í∏à Í≥ÑÏÇ∞ÏóêÏÑú Ï†úÏô∏Ìï† Ïú†Ï†ÄÎ•º ÏÑ†ÌÉùÌï©ÎãàÎã§');
            
            // Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞ UI
            let html = `
                <div style="margin-bottom:16px;">
                    <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                        <p style="color:#92400e; font-size:13px; margin:0;">
                            ‚ö†Ô∏è Ï≤¥ÌÅ¨Îêú Ïú†Ï†ÄÎäî Î∂ÑÎ∞∞Í∏à Í≥ÑÏÇ∞ÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.<br>
                            ÌòÑÏû¨ <b>${syncExcludeList.length}Î™Ö</b>Ïù¥ Ï†úÏô∏ Î™©Î°ùÏóê ÏûàÏäµÎãàÎã§.
                        </p>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                        <div style="flex:2; min-width:200px;">
                            <input type="text" id="excludeSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <select id="excludeGuildFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                                ${guildList.map(g => `<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <select id="excludeStatusFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                                <option value="excluded">Ï†úÏô∏Îêú Ïú†Ï†ÄÎßå</option>
                                <option value="included">Ìè¨Ìï®Îêú Ïú†Ï†ÄÎßå</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="max-height:400px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px;">
                    <table class="common-table" style="margin:0;">
                        <thead style="position:sticky; top:0; background:white; z-index:1;">
                            <tr>
                                <th style="width:50px;">Ï†úÏô∏</th>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>Í∏∏Îìú</th>
                                <th>Ï†ÑÌà¨Î†•</th>
                            </tr>
                        </thead>
                        <tbody id="excludeUserList">
            `;
            
            // Ïú†Ï†Ä Î™©Î°ù ÏÉùÏÑ±
            const sortedUsers = [...allGuildData].sort((a, b) => a.name.localeCompare(b.name));
            sortedUsers.forEach(user => {
                const isExcluded = syncExcludeList.includes(user.name);
                html += `
                    <tr class="exclude-row" data-name="${user.name}" data-guild="${user.guild}" data-excluded="${isExcluded}" style="cursor:pointer;">
                        <td style="text-align:center;">
                            <input type="checkbox" class="exclude-checkbox" data-name="${user.name}" ${isExcluded ? 'checked' : ''}>
                        </td>
                        <td style="font-weight:600;">${user.name}</td>
                        <td>${user.guild}</td>
                        <td>${user.power.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
                    <span id="excludeCount" style="color:#6b7280; font-size:13px;">Ï¥ù ${sortedUsers.length}Î™Ö</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn" onclick="selectAllExclude(true)" style="padding:6px 12px; font-size:12px; background:#ef4444; color:white;">Ï†ÑÏ≤¥ Ï†úÏô∏</button>
                        <button class="btn" onclick="selectAllExclude(false)" style="padding:6px 12px; font-size:12px; background:#10b981; color:white;">Ï†ÑÏ≤¥ Ìè¨Ìï®</button>
                    </div>
                </div>
            `;
            
            setModalBody(html);
            
            // Í≤ÄÏÉâ/ÌïÑÌÑ∞ Ïù¥Î≤§Ìä∏
            document.getElementById('excludeSearchInput').addEventListener('input', filterExcludeList);
            document.getElementById('excludeGuildFilter').addEventListener('change', filterExcludeList);
            document.getElementById('excludeStatusFilter').addEventListener('change', filterExcludeList);
            
            // Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.exclude-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const name = this.dataset.name;
                    const row = this.closest('tr');
                    if (this.checked) {
                        if (!syncExcludeList.includes(name)) {
                            syncExcludeList.push(name);
                        }
                        row.dataset.excluded = 'true';
                    } else {
                        syncExcludeList = syncExcludeList.filter(n => n !== name);
                        row.dataset.excluded = 'false';
                    }
                    updateExcludeCount();
                });
            });
            
            // Ìñâ ÌÅ¥Î¶≠ Ïãú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
            document.querySelectorAll('.exclude-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Ï≤¥ÌÅ¨Î∞ïÏä§ ÏßÅÏ†ë ÌÅ¥Î¶≠ÏùÄ Ï†úÏô∏ (Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê®)
                    if (e.target.type === 'checkbox') return;
                    
                    const checkbox = this.querySelector('.exclude-checkbox');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            });
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="saveExcludeList()">üíæ Ï†ÄÏû•</button>
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
            `;
        }

        function filterExcludeList() {
            const search = document.getElementById('excludeSearchInput').value.toLowerCase();
            const guild = document.getElementById('excludeGuildFilter').value;
            const status = document.getElementById('excludeStatusFilter').value;
            
            let visibleCount = 0;
            document.querySelectorAll('.exclude-row').forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const rowGuild = row.dataset.guild;
                const isExcluded = row.dataset.excluded === 'true';
                
                let show = true;
                if (search && !name.includes(search)) show = false;
                if (guild && rowGuild !== guild) show = false;
                if (status === 'excluded' && !isExcluded) show = false;
                if (status === 'included' && isExcluded) show = false;
                
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            document.getElementById('excludeCount').textContent = `ÌëúÏãú: ${visibleCount}Î™Ö / Ï†ÑÏ≤¥: ${allGuildData.length}Î™Ö`;
        }

        function updateExcludeCount() {
            const infoBox = document.querySelector('.openSyncExcludeModal-info');
            // Ìó§ÎçîÏùò Ï†úÏô∏ Ïù∏Ïõê ÏóÖÎç∞Ïù¥Ìä∏Îäî Ï†ÄÏû• ÌõÑÏóê Î∞òÏòÅ
        }

        window.selectAllExclude = function(exclude) {
            const visibleRows = document.querySelectorAll('.exclude-row:not([style*="display: none"])');
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.exclude-checkbox');
                const name = checkbox.dataset.name;
                checkbox.checked = exclude;
                row.dataset.excluded = exclude ? 'true' : 'false';
                
                if (exclude) {
                    if (!syncExcludeList.includes(name)) {
                        syncExcludeList.push(name);
                    }
                } else {
                    syncExcludeList = syncExcludeList.filter(n => n !== name);
                }
            });
        };

        window.saveExcludeList = async function() {
            try {
                const config = spreadsheetConfig || {};
                const prevList = config.excludeList || [];
                config.excludeList = syncExcludeList;
                
                await setDoc(doc(db, "config", "spreadsheet"), config);
                spreadsheetConfig = config;
                
                // Î≥ÄÍ≤Ω ÎÇ¥Ïó≠ Í≥ÑÏÇ∞
                const added = syncExcludeList.filter(n => !prevList.includes(n));
                const removed = prevList.filter(n => !syncExcludeList.includes(n));
                
                // Î°úÍ∑∏ Í∏∞Î°ù
                let logDetail = '';
                if (added.length > 0) logDetail += `Ï†úÏô∏ Ï∂îÍ∞Ä: ${added.join(', ')}`;
                if (removed.length > 0) logDetail += (logDetail ? ' / ' : '') + `Ï†úÏô∏ Ìï¥Ï†ú: ${removed.join(', ')}`;
                if (!logDetail) logDetail = 'Î≥ÄÍ≤Ω ÏóÜÏùå';
                
                await setDoc(doc(collection(db, "logs")), {
                    who: 'Admin',
                    type: 'exclude_update',
                    old_value: `${prevList.length}Î™Ö Ï†úÏô∏`,
                    new_value: `${syncExcludeList.length}Î™Ö Ï†úÏô∏ (${logDetail})`,
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp(),
                    device: navigator.userAgent
                });
                
                showAlert(`Î∂ÑÎ∞∞ Ï†úÏô∏ Î™©Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§ (${syncExcludeList.length}Î™Ö Ï†úÏô∏)`, 'success');
                closeModal();
            } catch(e) {
                console.error(e);
                showAlert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };

        async function openSpreadsheetSettingsModal() {
            const currentConfig = spreadsheetConfig || {};
            const sheetId = currentConfig.sheetId || '1ySgXwqwDGSW3c9gh8LVYPDBmdkh27q9JmVKId8gQ6uI';
            const webAppUrl = currentConfig.webAppUrl || '';
            const autoSync = currentConfig.autoSync !== false;            
                       let sheetMappingHtml = '<div class="form-group"><label class="form-label">ÏãúÌä∏ ÌÉ≠ Îß§Ìïë (Í∏∏ÎìúÎ™Ö: ÏãúÌä∏ÌÉ≠Î™Ö)</label>';
            guildList.forEach(guild => {
                               let defaultSheet = '';
                if (guild === 'ÏÇ¨Ïã†') {
                    defaultSheet = 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(ÏÇ¨Ïã†)';
                }
                const mappedSheet = (currentConfig.sheetMappings && currentConfig.sheetMappings[guild]) || defaultSheet;
                sheetMappingHtml += `
                    <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                        <input type="text" class="form-input" value="${guild}" readonly style="flex:1; background:#f3f4f6;">
                        <span style="color:#6b7280;">‚Üí</span>
                        <input type="text" class="form-input sheet-mapping" data-guild="${guild}" value="${mappedSheet}" placeholder="${guild === 'ÏÇ¨Ïã†' ? 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(ÏÇ¨Ïã†)' : '(Ï†ÑÏ≤¥ ÏãúÌä∏ÏóêÎßå Ìè¨Ìï®)'}" style="flex:2;">
                    </div>
                `;
            });
            
            
            const allSheetName = (currentConfig.sheetMappings && currentConfig.sheetMappings['Ï†ÑÏ≤¥']) || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
            sheetMappingHtml += `
                <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                    <input type="text" class="form-input" value="Ï†ÑÏ≤¥" readonly style="flex:1; background:#f3f4f6;">
                    <span style="color:#6b7280;">‚Üí</span>
                    <input type="text" class="form-input sheet-mapping" data-guild="Ï†ÑÏ≤¥" value="${allSheetName}" placeholder="Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)" style="flex:2;">
                </div>
            `;
            sheetMappingHtml += '</div>';

            const html = `
                <div class="form-group">
                    <label class="form-label">Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ID</label>
                    <input type="text" id="sheetId" class="form-input" value="${sheetId}" placeholder="Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ URLÏùò /d/ Îí§ ID">
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">Ïòà: docs.google.com/spreadsheets/d/<b>Ïó¨Í∏∞IDÎ∂ÄÎ∂Ñ</b>/edit</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Google Apps Script ÏõπÏï± URL</label>
                    <input type="text" id="webAppUrl" class="form-input" value="${webAppUrl}" placeholder="https://script.google.com/macros/s/.../exec">
                    <p style="font-size:11px; color:#6b7280; margin-top:4px;">Apps Script Î∞∞Ìè¨ ÌõÑ Î∞õÏùÄ ÏõπÏï± URL</p>
                </div>
                ${sheetMappingHtml}
                <div class="form-group">
                    <label class="checkbox-label" style="background:none; padding:0;">
                        <input type="checkbox" id="autoSync" ${autoSync ? 'checked' : ''}>
                        Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú ÏûêÎèôÏúºÎ°ú Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî
                    </label>
                </div>
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button class="btn btn-primary" onclick="window.testSpreadsheetSync()" style="flex:1;">üß™ Ïó∞Îèô ÌÖåÏä§Ìä∏</button>
                    <button class="btn btn-success" onclick="window.syncAllToSpreadsheet()" style="flex:1;">üîÑ Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:12px; padding:10px; background:#f9fafb; border-radius:6px;">
                    <b>ÏÑ§Ï†ï Î∞©Î≤ï:</b><br>
                    1. Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ÏóêÏÑú "ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®" > "Apps Script" ÏÑ†ÌÉù<br>
                    2. Ï†úÍ≥µÎêú GoogleAppsScript.gs ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞<br>
                    3. "Î∞∞Ìè¨" > "ÏÉà Î∞∞Ìè¨" > "Ïõπ Ïï±" ÏÑ†ÌÉù<br>
                    4. "Ïï°ÏÑ∏Ïä§ Í∂åÌïú" > "Î™®Îì† ÏÇ¨Ïö©Ïûê" ÏÑ†ÌÉù<br>
                    5. Î∞∞Ìè¨ ÌõÑ Î∞õÏùÄ URLÏùÑ ÏúÑÏóê ÏûÖÎ†•
                </p>
            `;

            openLargeModal('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïó∞Îèô ÏÑ§Ï†ï', 'Íµ¨Í∏Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏûêÎèô ÎèôÍ∏∞Ìôî');
            setModalBody(html);

            const footerDiv = document.createElement('div');
            footerDiv.style.marginTop = "20px";
            footerDiv.style.display = "flex";
            footerDiv.style.justifyContent = "flex-end";
            footerDiv.style.gap = "10px";

            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-cancel";
            closeBtn.innerText = "Îã´Í∏∞";
            closeBtn.onclick = closeModal;

            const saveBtn = document.createElement('button');
            saveBtn.className = "btn btn-primary";
            saveBtn.innerText = "üíæ ÏÑ§Ï†ï Ï†ÄÏû•";
            saveBtn.onclick = saveSpreadsheetSettings;

            footerDiv.appendChild(closeBtn);
            footerDiv.appendChild(saveBtn);
            document.getElementById('modalBody').appendChild(footerDiv);
        }

        async function saveSpreadsheetSettings() {
            const sheetId = document.getElementById('sheetId').value.trim();
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            const autoSync = document.getElementById('autoSync').checked;

            if (!sheetId || !webAppUrl) {
                showAlert('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ IDÏôÄ ÏõπÏï± URLÏùÑ Î™®Îëê ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

                       const sheetMappings = {};
            document.querySelectorAll('.sheet-mapping').forEach(input => {
                const guild = input.dataset.guild;
                const sheetName = input.value.trim();
                if (sheetName) {
                    sheetMappings[guild] = sheetName;
                }
            });

            const config = {
                sheetId,
                webAppUrl,
                autoSync,
                sheetMappings
            };

            try {
                await setDoc(doc(db, "config", "spreadsheet"), config);
                spreadsheetConfig = config;
                showAlert('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§', 'success');
                closeModal();
            } catch (e) {
                console.error(e);
                showAlert('ÏÑ§Ï†ï Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        }

        window.testSpreadsheetSync = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('Î®ºÏ†Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

                       const testGuild = guildList[0];
            const testUsers = allGuildData.filter(u => u.guild === testGuild).slice(0, 5);

            if (testUsers.length === 0) {
                showAlert('ÌÖåÏä§Ìä∏Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§', 'error');
                return;
            }

            const sheetName = spreadsheetConfig.sheetMappings[testGuild] || `Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(${testGuild})`;

            try {
                showAlert('ÌÖåÏä§Ìä∏ Ï§ë...', 'success');
                const result = await syncToSpreadsheet(testUsers, sheetName);
                if (result.success) {
                    showAlert(`ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ! ${result.message}`, 'success');
                } else {
                    showAlert(`ÌÖåÏä§Ìä∏ Ïã§Ìå®: ${result.error}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showAlert('ÌÖåÏä§Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + e.message, 'error');
            }
        };

        window.syncAllToSpreadsheet = async function() {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                showAlert('Î®ºÏ†Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

            if (!await showConfirm('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî', 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê ÎèôÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

                       openSmallModal('Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî', 'ÎèôÍ∏∞Ìôî ÏßÑÌñâ Ï§ë...', `
                <div style="text-align:center; padding:20px;">
                    <div id="syncIcon" style="font-size:48px; margin-bottom:15px;">üìä</div>
                    <p id="syncStatus" style="font-size:16px; color:#374151; margin-bottom:8px; font-weight:600;">Ï§ÄÎπÑ Ï§ë...</p>
                    <p id="syncDetail" style="font-size:13px; color:#6b7280; margin-bottom:20px;"></p>
                    <div style="background:#e5e7eb; border-radius:12px; height:20px; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="syncProgress" style="background:linear-gradient(90deg, #10b981, #34d399); height:100%; width:0%; transition:width 0.4s ease; border-radius:12px;"></div>
                    </div>
                    <p id="syncPercent" style="font-size:14px; color:#374151; margin-top:10px; font-weight:600;">0%</p>
                </div>
            `);
            document.getElementById('modalFooter').style.display = 'none';

            try {
                let successCount = 0;
                let failCount = 0;
                
                               const sheetsToSync = [];
                guildList.forEach(guild => {
                    const sheetName = spreadsheetConfig.sheetMappings && spreadsheetConfig.sheetMappings[guild];
                    if (sheetName) {
                        sheetsToSync.push({ guild, sheetName, isAll: false });
                    }
                });
                               const allSheetName = (spreadsheetConfig.sheetMappings && spreadsheetConfig.sheetMappings['Ï†ÑÏ≤¥']) || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
                sheetsToSync.push({ guild: 'Ï†ÑÏ≤¥', sheetName: allSheetName, isAll: true });
                
                const totalSheets = sheetsToSync.length;
                let currentSheet = 0;

                for (const sheet of sheetsToSync) {
                    currentSheet++;
                    const progress = Math.round((currentSheet / totalSheets) * 100);
                    
                   
                    document.getElementById('syncStatus').textContent = `${sheet.guild} ÎèôÍ∏∞Ìôî Ï§ë...`;
                    document.getElementById('syncDetail').textContent = `ÏãúÌä∏: ${sheet.sheetName} (${currentSheet}/${totalSheets})`;
                    document.getElementById('syncProgress').style.width = `${progress - 10}%`;
                    document.getElementById('syncPercent').textContent = `${progress - 10}%`;
                    
                    const users = sheet.isAll ? allGuildData : allGuildData.filter(u => u.guild === sheet.guild);
                    
                    try {
                        const result = await syncToSpreadsheet(users, sheet.sheetName);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error(`Failed to sync ${sheet.guild}:`, result.error);
                        }
                    } catch (e) {
                        failCount++;
                        console.error(`Error syncing ${sheet.guild}:`, e);
                    }
                    
                                       document.getElementById('syncProgress').style.width = `${progress}%`;
                    document.getElementById('syncPercent').textContent = `${progress}%`;
                    
                                       await new Promise(resolve => setTimeout(resolve, 500));
                }

                               if (failCount === 0) {
                    document.getElementById('syncIcon').textContent = '‚úÖ';
                    document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å!';
                    document.getElementById('syncDetail').textContent = `${successCount}Í∞ú ÏãúÌä∏ ÎèôÍ∏∞Ìôî ÏÑ±Í≥µ`;
                    document.getElementById('syncProgress').style.width = '100%';
                    document.getElementById('syncProgress').style.background = 'linear-gradient(90deg, #10b981, #34d399)';
                    document.getElementById('syncPercent').textContent = '100%';
                } else {
                    document.getElementById('syncIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å (ÏùºÎ∂Ä Ïã§Ìå®)';
                    document.getElementById('syncDetail').textContent = `ÏÑ±Í≥µ: ${successCount}Í∞ú, Ïã§Ìå®: ${failCount}Í∞ú`;
                    document.getElementById('syncProgress').style.width = '100%';
                    document.getElementById('syncProgress').style.background = 'linear-gradient(90deg, #f59e0b, #fbbf24)';
                    document.getElementById('syncPercent').textContent = 'ÏôÑÎ£å';
                }

                               document.getElementById('modalFooter').style.display = 'flex';
                document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">ÌôïÏù∏</button>';

                await setDoc(doc(collection(db, "logs")), {
                    who: 'Admin',
                    type: 'spreadsheet_sync',
                    old_value: '-',
                    new_value: `Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî (ÏÑ±Í≥µ:${successCount}, Ïã§Ìå®:${failCount})`,
                    editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                    createdAt: Date.now(),
                    ip: await getIp()
                });

            } catch (e) {
                console.error(e);
                document.getElementById('syncIcon').textContent = '‚ùå';
                document.getElementById('syncStatus').textContent = 'ÎèôÍ∏∞Ìôî Ïã§Ìå®';
                document.getElementById('syncDetail').textContent = e.message || 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§';
                document.getElementById('syncProgress').style.background = '#ef4444';
                document.getElementById('modalFooter').style.display = 'flex';
                document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
            }
        };

        async function syncToSpreadsheet(users, sheetName) {
            if (!spreadsheetConfig || !spreadsheetConfig.webAppUrl) {
                return { success: false, error: 'Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÑ§Ï†ïÏù¥ ÏóÜÏäµÎãàÎã§' };
            }

            // Ï†úÏô∏ Î™©Î°ù ÌïÑÌÑ∞ÎßÅ
            const filteredUsers = users.filter(u => !syncExcludeList.includes(u.name));

            const payload = {
                sheetId: spreadsheetConfig.sheetId,
                sheetName: sheetName,
                users: filteredUsers.map(u => ({
                    guild: u.guild,
                    name: u.name,
                    power: u.power,
                    shape_legend: u.shape_legend || 0,
                    shape_myth: u.shape_myth || 0,
                    mount_legend: u.mount_legend || 0,
                    mount_myth: u.mount_myth || 0
                }))
            };

            try {
                const response = await fetch(spreadsheetConfig.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                               return { success: true, message: `${filteredUsers.length}Í∞ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° (${users.length - filteredUsers.length}Î™Ö Ï†úÏô∏)` };

            } catch (e) {
                console.error('Sync error:', e);
                return { success: false, error: e.message };
            }
        }

               async function autoSyncIfEnabled(guild = null) {
            if (!spreadsheetConfig || !spreadsheetConfig.autoSync) {
                return;
            }

            try {
                if (guild) {
                                       const guildUsers = allGuildData.filter(u => u.guild === guild);
                    const sheetName = spreadsheetConfig.sheetMappings[guild] || `Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(${guild})`;
                    await syncToSpreadsheet(guildUsers, sheetName);
                }
                
                               const allSheetName = spreadsheetConfig.sheetMappings['Ï†ÑÏ≤¥'] || 'Ï†ÑÌà¨Î†• Ï†êÏàòÏ†ú(Ï†ÑÏ≤¥)';
                await syncToSpreadsheet(allGuildData, allSheetName);
                
            } catch (e) {
                console.error('Auto sync error:', e);
            }
        }

       
        document.getElementById('lockManageBtn').addEventListener('click', () => {
            if (!isAdmin) return;
            
            let statusMsg = '';
            let biweeklyStatusMsg = '';
            
            if (lockStartTime > 0 && lockEndTime > 0) {
                statusMsg = `ÌòÑÏû¨ Ïû†Í∏à: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
            } else {
                statusMsg = 'ÌòÑÏû¨ Ïû†Í∏à ÏÑ§Ï†ï ÏóÜÏùå';
            }
            
            if (biweeklyBaseTime > 0) {
                biweeklyStatusMsg = `<div style="background:#d1fae5; border:1px solid #10b981; border-radius:8px; padding:10px; margin-bottom:12px;">
                    <p style="color:#065f46; font-weight:600; margin:0; font-size:13px;">‚úÖ 2Ï£º Î∞òÎ≥µ ÌôúÏÑ±ÌôîÎê®</p>
                    <p style="color:#047857; font-size:12px; margin:4px 0 0;">Ïû†Í∏à Ï¢ÖÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú 2Ï£º Îí§Î°ú Í∞±Ïã†Îê©ÎãàÎã§</p>
                </div>`;
            }

            const startValue = lockStartTime > 0 ? toDatetimeLocalValue(lockStartTime) : '';
            const endValue = lockEndTime > 0 ? toDatetimeLocalValue(lockEndTime) : '';

            openSmallModal('Ïû†Í∏à ÏÑ§Ï†ï (KST Í∏∞Ï§Ä)', '', `
                <div style="margin-bottom:15px; color:#374151; font-size:13px; padding:10px; background:#f9fafb; border-radius:8px;">${statusMsg}</div>
                ${biweeklyStatusMsg}
                
                <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                    <p style="color:#92400e; font-weight:600; margin:0 0 8px; font-size:13px;">‚è∞ 2Ï£º Î∞òÎ≥µ Ïû†Í∏à (Í∏∏ÎìúÏ†ÑÏö©)</p>
                    <p style="color:#a16207; font-size:12px; margin:0 0 10px;">ÏµúÏ¥à 1Ìöå ÏÑ§Ï†ïÌïòÎ©¥ 2Ï£ºÎßàÎã§ ÏûêÎèô Î∞òÎ≥µÎê©ÎãàÎã§<br>ÌÜ†ÏöîÏùº 0Ïãú ~ ÏõîÏöîÏùº 0Ïãú (KST)</p>
                    <div style="display:flex; gap:8px;">
                        <button id="biweeklyLockBtn" class="btn btn-primary" style="flex:1; background:#f59e0b;">${biweeklyBaseTime > 0 ? 'üîÑ Îã§Ïùå Í∏∞Í∞Ñ ÌôïÏù∏' : 'üîÑ 2Ï£º Î∞òÎ≥µ ÏãúÏûë'}</button>
                        ${biweeklyBaseTime > 0 ? '<button id="biweeklyStopBtn" class="btn btn-cancel" style="flex:1;">‚èπÔ∏è Î∞òÎ≥µ Ï§ëÏßÄ</button>' : ''}
                    </div>
                </div>
                
                <hr style="border:none; border-top:1px solid #e5e7eb; margin:16px 0;">
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">ÎòêÎäî ÏàòÎèôÏúºÎ°ú ÏßÅÏ†ë ÏÑ§Ï†ï (1ÌöåÏÑ±):</p>
                
                <div class="form-group">
                    <label class="form-label">Ïû†Í∏à ÏãúÏûë ÏãúÍ∞Ñ (KST)</label>
                    <input type="datetime-local" id="lockStartInput" class="form-input" value="${startValue}">
                </div>
                <div class="form-group">
                    <label class="form-label">Ïû†Í∏à Ï¢ÖÎ£å ÏãúÍ∞Ñ (KST)</label>
                    <input type="datetime-local" id="lockEndInput" class="form-input" value="${endValue}">
                </div>
                <div class="form-group">
                    <button id="unlockBtn" class="btn btn-cancel" style="width:100%">üîì Ïû†Í∏à Ìï¥Ï†ú (Î∞òÎ≥µÎèÑ Ï§ëÏßÄ)</button>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-top:-10px;">‚Äª ÌïúÍµ≠ ÌëúÏ§ÄÏãú(KST) Í∏∞Ï§ÄÏúºÎ°ú ÏÑ§Ï†ïÎê©ÎãàÎã§</p>
            `);

            // 2Ï£º Î∞òÎ≥µ Ï§ëÏßÄ Î≤ÑÌäº
            if (biweeklyBaseTime > 0) {
                document.getElementById('biweeklyStopBtn').onclick = async () => {
                    if (!await showConfirm('2Ï£º Î∞òÎ≥µ Ï§ëÏßÄ', '2Ï£º Î∞òÎ≥µÏùÑ Ï§ëÏßÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\\nÌòÑÏû¨ Ïû†Í∏àÏùÄ Ïú†ÏßÄÎêòÍ≥† Î∞òÎ≥µÎßå Ï§ëÏßÄÎê©ÎãàÎã§.')) return;
                    
                    await setDoc(doc(db, "config", "system"), { 
                        lockStartTime: lockStartTime,
                        lockEndTime: lockEndTime,
                        biweeklyBaseTime: 0,
                        lockType: 'manual'
                    });
                    
                    showAlert('2Ï£º Î∞òÎ≥µÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§', 'success'); 
                    closeModal(); 
                    setTimeout(() => location.reload(), 1000);
                };
            }

            // 2Ï£º Î∞òÎ≥µ Ïû†Í∏à Î≤ÑÌäº Ìï∏Îì§Îü¨
            document.getElementById('biweeklyLockBtn').onclick = async () => {
                // Îã§Ïùå ÌÜ†ÏöîÏùº 0Ïãú(KST) Ï∞æÍ∏∞
                const now = toKST(Date.now());
                const dayOfWeek = now.getUTCDay(); // 0=Ïùº, 6=ÌÜ†
                
                let daysUntilSaturday;
                if (dayOfWeek === 6) {
                    // ÌÜ†ÏöîÏùºÏù¥Î©¥ Îã§ÏùåÏ£º ÌÜ†ÏöîÏùº
                    daysUntilSaturday = 7;
                } else if (dayOfWeek === 0) {
                    // ÏùºÏöîÏùºÏù¥Î©¥ Îã§ÏùåÏ£º ÌÜ†ÏöîÏùº (6Ïùº ÌõÑ)
                    daysUntilSaturday = 6;
                } else {
                    // ÌèâÏùºÏù¥Î©¥ Ïù¥Î≤àÏ£º ÌÜ†ÏöîÏùº
                    daysUntilSaturday = 6 - dayOfWeek;
                }
                
                // Îã§Ïùå ÌÜ†ÏöîÏùº 0Ïãú KST
                const nextSaturdayKST = new Date(Date.UTC(
                    now.getUTCFullYear(),
                    now.getUTCMonth(),
                    now.getUTCDate() + daysUntilSaturday,
                    0, 0, 0
                ));
                
                // ÏõîÏöîÏùº 0Ïãú KST (ÌÜ†ÏöîÏùº + 2Ïùº)
                const nextMondayKST = new Date(nextSaturdayKST.getTime() + 2 * 24 * 60 * 60 * 1000);
                
                // KSTÎ•º UTC timestampÎ°ú Î≥ÄÌôò (KST = UTC+9)
                const startTime = nextSaturdayKST.getTime() - 9 * 60 * 60 * 1000;
                const endTime = nextMondayKST.getTime() - 9 * 60 * 60 * 1000;
                
                const startStr = formatKSTDateTime(startTime);
                const endStr = formatKSTDateTime(endTime);
                
                const confirmMsg = biweeklyBaseTime > 0 
                    ? `Îã§Ïùå Ïû†Í∏à Í∏∞Í∞Ñ:\\n${startStr} ~ ${endStr}\\n\\n(2Ï£º Î∞òÎ≥µ Ïú†ÏßÄ)`
                    : `Îã§Ïùå Ïû†Í∏à Í∏∞Í∞Ñ:\\n${startStr} ~ ${endStr}\\n\\nÏù¥ÌõÑ 2Ï£ºÎßàÎã§ ÏûêÎèô Î∞òÎ≥µÎê©ÎãàÎã§.\\nÏÑ§Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
                
                if (!await showConfirm('2Ï£º Î∞òÎ≥µ Ïû†Í∏à ÏÑ§Ï†ï', confirmMsg)) return;
                
                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: startTime,
                    lockEndTime: endTime,
                    biweeklyBaseTime: startTime, // Í∏∞Ï§Ä ÏãúÍ∞Ñ Ï†ÄÏû•
                    lockType: 'biweekly'
                });
                
                showAlert('2Ï£º Î∞òÎ≥µ Ïû†Í∏àÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000);
            };

            document.getElementById('unlockBtn').onclick = async () => { 
                if(!await showConfirm('Ïû†Í∏à Ìï¥Ï†ú', 'Ïû†Í∏àÏùÑ Ìï¥Ï†úÌïòÍ≥† 2Ï£º Î∞òÎ≥µÎèÑ Ï§ëÏßÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return; 
                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: 0, 
                    lockEndTime: 0,
                    biweeklyBaseTime: 0, // Î∞òÎ≥µÎèÑ Ìï¥Ï†ú
                    lockType: null
                }); 
                showAlert('Ïû†Í∏àÏù¥ Ìï¥Ï†úÎêòÏóàÏäµÎãàÎã§', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000); 
            };

            document.getElementById('modalSubmit').onclick = async () => {
                const startVal = document.getElementById('lockStartInput').value;
                const endVal = document.getElementById('lockEndInput').value;
                
                if (!startVal || !endVal) { 
                    showAlert('ÏãúÏûë ÏãúÍ∞ÑÍ≥º Ï¢ÖÎ£å ÏãúÍ∞ÑÏùÑ Î™®Îëê ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', 'error'); 
                    return; 
                }

                const startTime = fromKST(startVal);
                const endTime = fromKST(endVal);

                if (endTime <= startTime) {
                    showAlert('Ï¢ÖÎ£å ÏãúÍ∞ÑÏù¥ ÏãúÏûë ÏãúÍ∞ÑÎ≥¥Îã§ Îπ†Î¶ÖÎãàÎã§', 'error');
                    return;
                }

                await setDoc(doc(db, "config", "system"), { 
                    lockStartTime: startTime,
                    lockEndTime: endTime,
                    biweeklyBaseTime: 0, // ÏàòÎèô ÏÑ§Ï†ïÏùÄ Î∞òÎ≥µ ÏóÜÏùå
                    lockType: 'manual'
                });
                
                showAlert('Ïû†Í∏àÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§ (1ÌöåÏÑ±)', 'success'); 
                closeModal(); 
                setTimeout(() => location.reload(), 1000);
            };
        });

        document.getElementById('userManageBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('Ïú†Ï†Ä Í¥ÄÎ¶¨', 'ÎπÑÎ∞ÄÎ≤àÌò∏ Í¥ÄÎ¶¨ Î∞è ÌïÑÌÑ∞');
            const snap = await getDocs(collection(db, "users")); 
            let users = []; 
            snap.forEach(d => users.push(d.data())); 
            
                       users.sort((a,b)=>a.name.localeCompare(b.name));
            
            let html = `
                <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                    <div class="form-group" style="flex:2; margin-bottom:0;">
                        <input type="text" id="modalSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="guildFilter" class="form-input">
                            <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                            ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="pwFilter" class="form-input">
                            <option value="">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÑÏ≤¥</option>
                            <option value="set">ÏÑ§Ï†ïÎê®</option>
                            <option value="unset">ÎØ∏ÏÑ§Ï†ï</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1; margin-bottom:0;">
                        <select id="sortOrder" class="form-input">
                            <option value="name">Í∞ÄÎÇòÎã§Ïàú</option>
                            <option value="updated">ÏµúÍ∑º Í∞±Ïã†Ïàú</option>
                        </select>
                    </div>
                </div>
                <p style="font-size:12px; color:#6b7280; margin-bottom:12px;">Ï¥ù <span id="userCount">${users.length}</span>Î™Ö</p>
                <div class="table-scroll-container">
                    <table class="common-table" id="userManageTable">
                        <thead>
                            <tr>
                                <th style="width:25%;">ÎãâÎÑ§ÏûÑ</th>
                                <th style="width:15%;">Í∏∏Îìú</th>
                                <th style="width:15%;">ÎπÑÎ∞ÄÎ≤àÌò∏</th>
                                <th style="width:25%;">ÎπÑÎ∞ÄÎ≤àÌò∏ Í¥ÄÎ¶¨</th>
                                <th style="width:20%;">Îì±Î°ù Ìï¥Ï†ú</th>
                            </tr>
                        </thead>
                        <tbody id="userManageTableBody"></tbody>
                    </table>
                </div>
            `;
            
            setModalBody(html);
            
                       function renderUserTable(filteredUsers) {
                const tbody = document.getElementById('userManageTableBody');
                tbody.innerHTML = '';
                
                filteredUsers.forEach(u => {
                    const pwStatus = u.password 
                        ? '<span style="color:#10b981; font-weight:600;">‚úì ÏÑ§Ï†ïÎê®</span>' 
                        : '<span style="color:#ef4444; font-weight:600;">‚úó ÎØ∏ÏÑ§Ï†ï</span>';
                    
                    const resetBtn = u.password 
                        ? `<button class="btn-reset-pw" onclick="window.resetUserPw('${u.name}')">Ï¥àÍ∏∞Ìôî</button>` 
                        : '-';
                    
                    const deleteBtn = `<button class="btn-delete" onclick="window.deleteUser('${u.name}')" style="background:#ef4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s;">üóëÔ∏è Îì±Î°ù Ìï¥Ï†ú</button>`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td>${pwStatus}</td>
                        <td>${resetBtn}</td>
                        <td>${deleteBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('userCount').textContent = filteredUsers.length;
            }
            
                       function applyFiltersAndSort() {
                const searchText = document.getElementById('modalSearchInput').value.toLowerCase();
                const guildFilter = document.getElementById('guildFilter').value;
                const pwFilter = document.getElementById('pwFilter').value;
                const sortOrder = document.getElementById('sortOrder').value;
                
                let filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    const matchPw = !pwFilter || 
                        (pwFilter === 'set' && u.password) || 
                        (pwFilter === 'unset' && !u.password);
                    
                    return matchSearch && matchGuild && matchPw;
                });
                
                               if (sortOrder === 'name') {
                    filtered.sort((a,b) => a.name.localeCompare(b.name));
                } else if (sortOrder === 'updated') {
                    filtered.sort((a,b) => {
                        const aTime = (a.updatedAt && a.updatedBy !== 'admin') ? a.updatedAt : 0;
                        const bTime = (b.updatedAt && b.updatedBy !== 'admin') ? b.updatedAt : 0;
                        return bTime - aTime;                     });
                }
                
                renderUserTable(filtered);
            }
            
                       renderUserTable(users);
            
                       document.getElementById('modalSearchInput').addEventListener('input', applyFiltersAndSort);
            document.getElementById('guildFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('pwFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndSort);
        });

        window.resetUserPw = async function(n) { 
            if(!await showConfirm('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî', `[${n}]ÎãòÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return; 
            await updateDoc(doc(db, "users", n), { password: null }); 
            showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'success'); 
            closeModal(); 
            setTimeout(() => location.reload(), 1000); 
        };

               window.deleteUser = async function(name) {
                       if(!await showConfirm('ÏÇ¨Ïö©Ïûê Îì±Î°ù Ìï¥Ï†ú', `<span style="color:#ef4444; font-weight:600;">[${name}]ÎãòÏùÑ Îì±Î°ù Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</span><br><br>‚Ä¢ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§<br>‚Ä¢ ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ùÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•<br>‚Ä¢ Î≥µÍµ¨Îäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§`)) return;
            
                       setTimeout(() => {
                openSmallModal('Îì±Î°ù Ìï¥Ï†ú ÏÇ¨Ïú†', 'ÏÑ†ÌÉùÏÇ¨Ìï≠ - ÎÇòÏ§ëÏóê Ï∞∏Í≥†Ïö©', `
                    <div class="form-group">
                        <label class="form-label">ÏÇ¨Ïú† (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <select id="deleteReason" class="form-input">
                            <option value="ÏûêÏßÑ ÌÉàÌá¥">ÏûêÏßÑ ÌÉàÌá¥</option>
                            <option value="Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç">Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç</option>
                            <option value="Í∏∏Îìú Ïù¥Îèô">Í∏∏Îìú Ïù¥Îèô</option>
                            <option value="Í∑úÏ†ï ÏúÑÎ∞ò">Í∑úÏ†ï ÏúÑÎ∞ò</option>
                            <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÏÉÅÏÑ∏ Î©îÎ™® (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="deleteMemo" class="form-input" rows="3" placeholder="Ï∂îÍ∞Ä Î©îÎ™®..."></textarea>
                    </div>
                `);
                
                setTimeout(() => {
                    document.getElementById('modalSubmit').onclick = async () => {
                        const reason = document.getElementById('deleteReason').value;
                        const memo = document.getElementById('deleteMemo').value.trim();
                        
                        try {
                                                       const userDoc = await getDoc(doc(db, "users", name));
                            if (!userDoc.exists()) {
                                showAlert('ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                                return;
                            }
                            
                            const userData = userDoc.data();
                            
                                                       await setDoc(doc(collection(db, "deletedUsers")), {
                                ...userData,                                 deletedAt: Date.now(),
                                deletedBy: 'admin',
                                deleteReason: reason,
                                deleteMemo: memo || '',
                                originalName: name,
                                deletedIp: await getIp(),
                                deletedDevice: navigator.userAgent
                            });
                            
                                                       await deleteDoc(doc(db, "users", name));
                            
                                                       await setDoc(doc(collection(db, "logs")), {
                                who: name,
                                type: 'user_deleted',
                                old_value: 'ÏÇ¨Ïö©Ïûê Ï°¥Ïû¨',
                                new_value: `Îì±Î°ù Ìï¥Ï†ú (ÏÇ¨Ïú†: ${reason})`,
                                editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                                createdAt: Date.now(),
                                ip: await getIp(),
                                device: navigator.userAgent
                            });
                            
                            showAlert('Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å (Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê®)', 'success');
                            closeModal();
                            setTimeout(() => location.reload(), 1000);
                        } catch (e) {
                            console.error('Delete error:', e);
                            showAlert('Îì±Î°ù Ìï¥Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                        }
                    };
                }, 100);
            }, 300);
        };


        document.getElementById('logViewBtn').addEventListener('click', async () => {
            if(!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }
            openLargeModal('Î°úÍ∑∏', 'Ï†ÑÏ≤¥ Î°úÍ∑∏ (Í≤ÄÏÉâ Í∞ÄÎä•)');
            
                       const snap = await getDocs(query(collection(db, "logs"), orderBy("createdAt", "desc")));
            
            const logs = [];
            snap.forEach(d => { 
                const l = d.data(); 
                logs.push({
                    time: formatDateTime(l.createdAt),
                    who: l.who || '-',
                    type: l.type || '-',
                    oldValue: l.old_value || '-',
                    newValue: l.new_value || '-',
                    changes: l.changes || '',
                    editedBy: l.editedBy || '-',
                    ip: l.ip || '-',
                    device: l.device || '-'
                });
            });
            
            // Ï†ÑÏó≠ Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏÉÅÏÑ∏Î≥¥Í∏∞Ïö©)
            window.currentLogs = logs;
            
            // Í¥ÄÎ¶¨Ïûê Î™©Î°ù Ï∂îÏ∂ú (self, admin, ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù, - Ï†úÏô∏)
            const adminSet = new Set();
            logs.forEach(l => {
                if (l.editedBy && l.editedBy !== 'self' && l.editedBy !== 'admin' && l.editedBy !== 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù' && l.editedBy !== '-') {
                    adminSet.add(l.editedBy);
                }
            });
            const adminList = Array.from(adminSet).sort();
            
            // ÎåÄÏÉÅÏù¥ Ïó¨Îü¨ Î™ÖÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ≥† ÌëúÏãúÏö© ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
            function formatWho(who) {
                if (!who || who === '-') return '-';
                // ÏâºÌëúÎÇò Í≥µÎ∞±ÏúºÎ°ú Ïó¨Îü¨ Î™Ö Íµ¨Î∂Ñ
                const names = who.split(/[,\s]+/).filter(n => n.trim());
                if (names.length > 2) {
                    return `${names[0]} Ïô∏ ${names.length - 1}Î™Ö`;
                }
                return who;
            }
            
                       function formatLogType(type) {
                const typeMap = {
                    'power': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                    'info_edit': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                    'nickname_change': 'üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω',
                    'user_approved': '‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏',
                    'user_rejected': '‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä',
                    'user_deleted': 'üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú',
                    'user_request': 'üìù Îì±Î°ù ÏöîÏ≤≠',
                    'bulk_update': 'üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨',
                    'guild_move': 'üöÄ Í∏∏Îìú Ïù¥Îèô',
                    'guild_delete': 'üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú',
                    'exclude_update': 'üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Î≥ÄÍ≤Ω',
                    'spreadsheet_sync': 'üìä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî',
                    'google_sheet_sync': 'üìä Íµ¨Í∏ÄÏãúÌä∏ ÎèôÍ∏∞Ìôî'
                };
                return typeMap[type] || type;
            }
            
                       function formatLogContent(log) {
                const type = log.type;
                const oldVal = log.oldValue;
                const newVal = log.newValue;
                
                switch(type) {
                    case 'power':
                        const oldPower = Number(oldVal).toLocaleString();
                        const newPower = Number(newVal).toLocaleString();
                        return `${oldPower} ‚Üí ${newPower}`;
                    
                    case 'nickname_change':
                        return `${oldVal} ‚Üí ${newVal}`;
                    
                    case 'info_edit':
                        return newVal === 'Í¥ÄÎ¶¨ÏûêÏàòÏ†ï' ? 'Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ïÌï®' : 'Î≥∏Ïù∏Ïù¥ ÏàòÏ†ïÌï®';
                    
                    case 'user_approved':
                        return 'ÏäπÏù∏ ÏôÑÎ£å';
                    
                    case 'user_rejected':
                        return 'Îì±Î°ù Í±∞Î∂Ä';
                    
                    case 'user_deleted':
                        return newVal;
                    
                    case 'user_request':
                        return newVal;
                    
                    case 'bulk_update':
                        return newVal;
                    
                    case 'spreadsheet_sync':
                    case 'google_sheet_sync':
                        return newVal;
                    
                    default:
                        return newVal;
                }
            }
            
            // Í¥ÄÎ¶¨Ïûê ÏòµÏÖò HTML ÏÉùÏÑ±
            let adminOptionsHtml = adminList.map(admin => 
                `<option value="admin:${admin}">üëë ${admin}</option>`
            ).join('');
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
                        <input type="text" id="logSearchInput" class="form-input" placeholder="ÎåÄÏÉÅ Í≤ÄÏÉâ..." autocomplete="off" style="flex:1; min-width:150px;">
                        <select id="logTypeFilter" class="form-input" style="flex:1; min-width:130px;">
                            <option value="">Ï†ÑÏ≤¥ ÏûëÏóÖ</option>
                            <option value="info_edit,power">‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï</option>
                            <option value="nickname_change">üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω</option>
                            <option value="user_approved">‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏</option>
                            <option value="user_rejected">‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä</option>
                            <option value="user_deleted">üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú</option>
                            <option value="user_request">üìù Îì±Î°ù ÏöîÏ≤≠</option>
                            <option value="bulk_update">üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨</option>
                            <option value="guild_move">üöÄ Í∏∏Îìú Ïù¥Îèô</option>
                            <option value="exclude_update">üö´ Î∂ÑÎ∞∞ Ï†úÏô∏</option>
                            <option value="spreadsheet_sync,google_sheet_sync">üìä ÎèôÍ∏∞Ìôî</option>
                        </select>
                        <select id="logWorkerFilter" class="form-input" style="flex:1; min-width:130px;">
                            <option value="">Ï†ÑÏ≤¥ ÏûëÏóÖÏûê</option>
                            <option value="self">üë§ Î≥∏Ïù∏ Î≥ÄÍ≤Ω</option>
                            <option value="admin">üëë Í¥ÄÎ¶¨Ïûê Ï†ÑÏ≤¥</option>
                            ${adminOptionsHtml}
                        </select>
                    </div>
                    <p style="font-size: 12px; color: #6b7280;">Ï¥ù <span id="logCount">${logs.length}</span>Í∞ú Î°úÍ∑∏</p>
                </div>
                <div style="max-height: 450px; overflow-y: auto; overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; -webkit-overflow-scrolling: touch;">
                    <table class="common-table" id="logTable" style="width: 100%; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 15%;">ÏãúÍ∞Ñ</th>
                                <th style="width: 12%;">ÎåÄÏÉÅ</th>
                                <th style="width: 13%;">ÏûëÏóÖ</th>
                                <th style="width: 12%;">ÏàòÏ†ïÏ†Ñ</th>
                                <th style="width: 12%;">ÏàòÏ†ïÌõÑ</th>
                                <th style="width: 26%;">ÎÇ¥Ïö©</th>
                                <th style="width: 10%;">ÏûëÏóÖÏûê</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            logs.forEach(l => {
                const logType = formatLogType(l.type);
                
                               let oldDisplay = '-';
                let newDisplay = '-';
                let contentDisplay = '-';
                
                switch(l.type) {
                    case 'power':
                        oldDisplay = Number(l.oldValue).toLocaleString();
                        newDisplay = Number(l.newValue).toLocaleString();
                        contentDisplay = `Ï†ÑÌà¨Î†•: ${oldDisplay} ‚Üí ${newDisplay}`;
                        break;
                    
                    case 'nickname_change':
                        oldDisplay = l.oldValue;
                        newDisplay = l.newValue;
                        contentDisplay = `ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω`;
                        break;
                    
                    case 'info_edit':
                        try {
                            const oldData = JSON.parse(l.oldValue);
                            const newData = JSON.parse(l.newValue);
                            oldDisplay = oldData.power ? oldData.power.toLocaleString() : '-';
                            newDisplay = newData.power ? newData.power.toLocaleString() : '-';
                            contentDisplay = l.changes || 'Ï†ÑÌà¨Î†• ÏàòÏ†ïÎê®';
                        } catch(e) {
                            oldDisplay = '-';
                            newDisplay = '-';
                            contentDisplay = 'Ï†ÑÌà¨Î†• ÏàòÏ†ïÎê®';
                        }
                        break;
                    
                    case 'user_approved':
                        oldDisplay = 'ÎåÄÍ∏∞';
                        newDisplay = 'ÏäπÏù∏Îê®';
                        contentDisplay = 'ÏÇ¨Ïö©Ïûê ÏäπÏù∏ ÏôÑÎ£å';
                        break;
                    
                    case 'user_rejected':
                        oldDisplay = 'ÎåÄÍ∏∞';
                        newDisplay = 'Í±∞Î∂ÄÎê®';
                        contentDisplay = 'Îì±Î°ù Í±∞Î∂ÄÎê®';
                        break;
                    
                    case 'user_deleted':
                        oldDisplay = 'Îì±Î°ùÎê®';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = l.newValue || 'Îì±Î°ù Ìï¥Ï†ú';
                        break;
                    
                    case 'user_request':
                        oldDisplay = '-';
                        newDisplay = 'ÏöîÏ≤≠Îê®';
                        contentDisplay = l.newValue || 'Îì±Î°ù ÏöîÏ≤≠';
                        break;
                    
                    case 'bulk_update':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'ÏùºÍ¥Ñ Ï≤òÎ¶¨';
                        break;
                    
                    case 'guild_move':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'Í∏∏Îìú Ïù¥Îèô';
                        break;
                    
                    case 'guild_delete':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = `${l.oldValue} Í∏∏Îìú ÏÇ≠Ï†ú`;
                        break;
                    
                    case 'spreadsheet_sync':
                    case 'google_sheet_sync':
                        oldDisplay = '-';
                        newDisplay = '-';
                        contentDisplay = l.newValue || 'ÎèôÍ∏∞Ìôî ÏôÑÎ£å';
                        break;
                    
                    case 'admin_add':
                        oldDisplay = '-';
                        newDisplay = l.newValue || '-';
                        contentDisplay = 'Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä';
                        break;
                    
                    case 'admin_delete':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = 'ÏÇ≠Ï†úÎê®';
                        contentDisplay = 'Í¥ÄÎ¶¨Ïûê ÏÇ≠Ï†ú';
                        break;
                    
                    case 'admin_pw_reset':
                        oldDisplay = l.oldValue || '-';
                        newDisplay = '-';
                        contentDisplay = 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî';
                        break;
                    
                    default:
                        oldDisplay = l.oldValue || '-';
                        newDisplay = l.newValue || '-';
                        contentDisplay = '-';
                }
                
                let workerDisplay = '-';
                let workerTitle = l.editedBy || '-';
                let workerType = 'unknown';
                
                if (l.editedBy === 'self') {
                    workerDisplay = '<span style="color:#6b7280;">Î≥∏Ïù∏</span>';
                    workerType = 'self';
                } else if (l.editedBy === 'admin' || l.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') {
                    workerDisplay = '<span style="color:#8b5cf6; font-weight:600;">üëë Í¥ÄÎ¶¨Ïûê</span>';
                    workerType = 'admin';
                } else if (l.editedBy && l.editedBy !== '-') {
                    workerDisplay = `<span style="color:#8b5cf6; font-weight:600;">üëë ${l.editedBy}</span>`;
                    workerType = 'admin';
                } else {
                    workerDisplay = '<span style="color:#9ca3af;">-</span>';
                }
                
                const whoDisplay = formatWho(l.who);
                const logIndex = logs.indexOf(l);
                
                html += `<tr data-type="${l.type}" data-worker="${workerType}" data-admin-id="${l.editedBy}" data-index="${logIndex}" style="cursor:pointer;" onclick="showLogDetail(${logIndex})">
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${l.time}">${l.time}</td>
                    <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${l.who}"><strong>${whoDisplay}</strong></td>
                    <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${logType}</td>
                    <td style="color:#ef4444; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${oldDisplay}">${oldDisplay}</td>
                    <td style="color:#10b981; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${newDisplay}">${newDisplay}</td>
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${contentDisplay}">${contentDisplay}</td>
                    <td style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${workerTitle}">${workerDisplay}</td>
                </tr>`; 
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
                       // ÌïÑÌÑ∞ Ìï®Ïàò
            function applyLogFilters() {
                const searchText = document.getElementById('logSearchInput').value.toLowerCase();
                const typeFilter = document.getElementById('logTypeFilter').value;
                const workerFilter = document.getElementById('logWorkerFilter').value;
                const types = typeFilter ? typeFilter.split(',') : [];
                
                let visibleCount = 0;
                document.querySelectorAll('#logTable tbody tr').forEach(row => {
                    const who = row.cells[1].textContent.toLowerCase();
                    const rowType = row.dataset.type;
                    const rowWorker = row.dataset.worker;
                    const rowAdminId = row.dataset.adminId;
                    
                    const matchSearch = !searchText || who.includes(searchText);
                    const matchType = types.length === 0 || types.includes(rowType);
                    
                    // ÏûëÏóÖÏûê ÌïÑÌÑ∞ Î°úÏßÅ
                    let matchWorker = true;
                    if (workerFilter) {
                        if (workerFilter === 'self') {
                            matchWorker = rowWorker === 'self';
                        } else if (workerFilter === 'admin') {
                            matchWorker = rowWorker === 'admin';
                        } else if (workerFilter.startsWith('admin:')) {
                            // ÌäπÏ†ï Í¥ÄÎ¶¨Ïûê ÏÑ†ÌÉù
                            const selectedAdmin = workerFilter.replace('admin:', '');
                            matchWorker = rowAdminId === selectedAdmin;
                        }
                    }
                    
                    if (matchSearch && matchType && matchWorker) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                document.getElementById('logCount').textContent = visibleCount;
            }
            
            document.getElementById('logSearchInput').addEventListener('input', applyLogFilters);
            document.getElementById('logTypeFilter').addEventListener('change', applyLogFilters);
            document.getElementById('logWorkerFilter').addEventListener('change', applyLogFilters);
        });
        
        // Î°úÍ∑∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ìï®Ïàò
        window.showLogDetail = function(index) {
            const log = window.currentLogs[index];
            if (!log) return;
            
            const typeMap = {
                'power': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                'info_edit': '‚úèÔ∏è Ï†ÑÌà¨Î†• ÏàòÏ†ï',
                'nickname_change': 'üîÑ ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤Ω',
                'user_approved': '‚úÖ ÏÇ¨Ïö©Ïûê ÏäπÏù∏',
                'user_rejected': '‚ùå ÏÇ¨Ïö©Ïûê Í±∞Î∂Ä',
                'user_deleted': 'üóëÔ∏è ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†ú',
                'user_request': 'üìù Îì±Î°ù ÏöîÏ≤≠',
                'bulk_update': 'üìã ÏùºÍ¥Ñ Ï≤òÎ¶¨',
                'guild_move': 'üöÄ Í∏∏Îìú Ïù¥Îèô',
                'guild_delete': 'üèöÔ∏è Í∏∏Îìú ÏÇ≠Ï†ú',
                'exclude_update': 'üö´ Î∂ÑÎ∞∞ Ï†úÏô∏ Î≥ÄÍ≤Ω',
                'spreadsheet_sync': 'üìä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÎèôÍ∏∞Ìôî',
                'google_sheet_sync': 'üìä Íµ¨Í∏ÄÏãúÌä∏ ÎèôÍ∏∞Ìôî'
            };
            
            const logType = typeMap[log.type] || log.type;
            
            // ÏûëÏóÖÏûê ÌëúÏãú
            let workerDisplay = '-';
            if (log.editedBy === 'self') {
                workerDisplay = 'üë§ Î≥∏Ïù∏';
            } else if (log.editedBy === 'admin' || log.editedBy === 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù') {
                workerDisplay = 'üëë Í¥ÄÎ¶¨Ïûê';
            } else if (log.editedBy && log.editedBy !== '-') {
                workerDisplay = `üëë ${log.editedBy}`;
            }
            
            // ÎåÄÏÉÅ Î™©Î°ù (Ïó¨Îü¨ Î™ÖÏù∏ Í≤ΩÏö∞ Ï§ÑÎ∞îÍøàÏúºÎ°ú ÌëúÏãú)
            let whoDisplay = log.who;
            if (log.who && log.who.includes(',')) {
                const names = log.who.split(',').map(n => n.trim()).filter(n => n);
                whoDisplay = names.map(n => `<span style="display:inline-block; background:#f3f4f6; padding:2px 8px; margin:2px; border-radius:4px;">${n}</span>`).join(' ');
            }
            
            // ÏàòÏ†ïÏ†Ñ/ÏàòÏ†ïÌõÑ Í∞í ÌååÏã±
            let oldDisplay = log.oldValue || '-';
            let newDisplay = log.newValue || '-';
            let contentDisplay = log.changes || '-';
            
            // JSON ÌòïÌÉúÏù∏ Í≤ΩÏö∞ ÌååÏã±
            if (log.type === 'info_edit' || log.type === 'power') {
                try {
                    if (log.oldValue && log.oldValue.startsWith('{')) {
                        const oldData = JSON.parse(log.oldValue);
                        oldDisplay = oldData.power ? Number(oldData.power).toLocaleString() : '-';
                    } else if (log.oldValue && !isNaN(log.oldValue)) {
                        oldDisplay = Number(log.oldValue).toLocaleString();
                    }
                } catch(e) { }
                
                try {
                    if (log.newValue && log.newValue.startsWith('{')) {
                        const newData = JSON.parse(log.newValue);
                        newDisplay = newData.power ? Number(newData.power).toLocaleString() : '-';
                    } else if (log.newValue && !isNaN(log.newValue)) {
                        newDisplay = Number(log.newValue).toLocaleString();
                    }
                } catch(e) { }
                
                if (oldDisplay !== '-' && newDisplay !== '-') {
                    contentDisplay = `Ï†ÑÌà¨Î†•: ${oldDisplay} ‚Üí ${newDisplay}`;
                }
            }
            
            // Í∏∏Îìú Ïù¥ÎèôÏù∏ Í≤ΩÏö∞
            if (log.type === 'guild_move') {
                oldDisplay = '-';
                // newValueÏóêÏÑú Í∏∏ÎìúÎ™Ö Ï∂îÏ∂ú (Ïòà: "ÏÇ¨Ïã†ÏúºÎ°ú 1Î™Ö Ïù¥Îèô")
                const match = log.newValue ? log.newValue.match(/(.+?)ÏúºÎ°ú/) : null;
                const targetGuild = match ? match[1] : '-';
                
                // who ÌïÑÎìúÏóê Ïù¥ÎèôÎêú Ïú†Ï†Ä Ïù¥Î¶ÑÎì§Ïù¥ ÏûàÏùå
                if (log.who && log.who !== 'Admin' && log.who !== '-') {
                    const names = log.who.split(',').map(n => n.trim()).filter(n => n);
                    newDisplay = `${targetGuild} Í∏∏ÎìúÎ°ú Ïù¥Îèô`;
                    contentDisplay = `Ïù¥Îèô Ïù∏Ïõê: ${names.length}Î™Ö<br><br>${names.map(n => `<span style="display:inline-block; background:#dbeafe; padding:2px 8px; margin:2px; border-radius:4px;">${n}</span>`).join(' ')}`;
                } else {
                    newDisplay = log.newValue || '-';
                }
            }
            
            // ÎãâÎÑ§ÏûÑ Î≥ÄÍ≤ΩÏù∏ Í≤ΩÏö∞
            if (log.type === 'nickname_change') {
                contentDisplay = `${log.oldValue} ‚Üí ${log.newValue}`;
            }
            
            // ÏÇ¨Ïö©Ïûê ÏÇ≠Ï†úÏù∏ Í≤ΩÏö∞
            if (log.type === 'user_deleted') {
                oldDisplay = 'Îì±Î°ùÎê®';
                newDisplay = 'ÏÇ≠Ï†úÎê®';
                contentDisplay = log.newValue || 'Îì±Î°ù Ìï¥Ï†ú';
            }
            
            const html = `
                <div style="padding: 10px 0; max-height: 60vh; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; width: 80px; white-space: nowrap;">ÏãúÍ∞Ñ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${log.time}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÎåÄÏÉÅ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-weight: 600;">${whoDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏûëÏóÖ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${logType}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏàòÏ†ï Ï†Ñ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #ef4444; font-weight: 500;">${oldDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏàòÏ†ï ÌõÑ</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #10b981; font-weight: 500;">${newDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÎÇ¥Ïö©</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb;">${contentDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">ÏûëÏóÖÏûê</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; color: #8b5cf6; font-weight: 600;">${workerDisplay}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">IP</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">${log.ip || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 16px; background: #f9fafb; border: 1px solid #e5e7eb; font-weight: 600; white-space: nowrap;">Í∏∞Í∏∞</td>
                            <td style="padding: 12px 16px; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; word-break: break-all;">${log.device || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            // Î™®Îã¨ Ïó¥Í∏∞ (ÌÅ∞ ÏÇ¨Ïù¥Ï¶à)
            openSmallModal('üìã Î°úÍ∑∏ ÏÉÅÏÑ∏', log.who.length > 20 ? log.who.substring(0, 20) + '...' : log.who, html);
            document.getElementById('modalContent').style.maxWidth = '500px';
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };

               document.getElementById('deletedUsersBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê', 'Îì±Î°ù Ìï¥Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ù (ÏòÅÍµ¨ Î≥¥Í¥Ä)');
            
            const snap = await getDocs(query(collection(db, "deletedUsers"), orderBy("deletedAt", "desc")));
            
            const deletedUsers = [];
            snap.forEach(d => {
                const u = d.data();
                deletedUsers.push({
                    name: u.originalName || u.name,
                    guild: u.guild || '-',
                    power: u.power || 0,
                    deletedAt: formatDateTime(u.deletedAt),
                    reason: u.deleteReason || '-',
                    memo: u.deleteMemo || '-',
                    deletedBy: u.deletedBy || 'admin'
                });
            });
            
            let html = `
                <div class="form-group" style="margin-bottom: 16px;">
                    <input type="text" id="deletedSearchInput" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off" style="margin-bottom: 0;">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">Ï¥ù ${deletedUsers.length}Î™Ö</p>
                </div>
                <div class="table-scroll-container">
                    <table class="common-table" id="deletedUsersTable">
                        <thead>
                            <tr>
                                <th>ÎãâÎÑ§ÏûÑ</th>
                                <th>Í∏∏Îìú</th>
                                <th>Ï†ÑÌà¨Î†•</th>
                                <th>ÏÇ≠Ï†úÏùºÏãú</th>
                                <th>ÏÇ¨Ïú†</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            deletedUsers.forEach(u => {
                html += `<tr>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.guild}</td>
                    <td style="color:#3b82f6; font-weight:600;">${u.power.toLocaleString()}</td>
                    <td style="font-size:12px;">${u.deletedAt}</td>
                    <td><span style="padding:4px 8px; background:#fef2f2; color:#991b1b; border-radius:4px; font-size:12px;">${u.reason}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            setModalBody(html);
            
                       document.getElementById('deletedSearchInput').addEventListener('input', (e) => {
                const searchText = e.target.value.toLowerCase();
                document.querySelectorAll('#deletedUsersTable tbody tr').forEach(row => {
                    const name = row.cells[0].textContent.toLowerCase();
                    row.style.display = name.includes(searchText) ? '' : 'none';
                });
            });
        });

               document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            if(!isAdmin) return;
            openLargeModal('ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú', 'Ïó¨Îü¨ ÏÇ¨Ïö©ÏûêÎ•º Ìïú Î≤àÏóê Îì±Î°ù Ìï¥Ï†ú');
            
            const snap = await getDocs(collection(db, "users"));
            let users = [];
            snap.forEach(d => users.push(d.data()));
            
                       users.sort((a,b) => a.name.localeCompare(b.name));
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <input type="text" id="bulkDeleteSearch" class="form-input" placeholder="ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ..." autocomplete="off">
                        </div>
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <select id="bulkDeleteGuildFilter" class="form-input">
                                <option value="">Ï†ÑÏ≤¥ Í∏∏Îìú</option>
                                ${[...new Set(users.map(u=>u.guild))].sort().map(g=>`<option value="${g}">${g}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <button id="selectAllBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 13px;">
                            ‚úÖ Ï†ÑÏ≤¥ ÏÑ†ÌÉù
                        </button>
                        <button id="deselectAllBtn" class="btn btn-cancel" style="padding: 8px 16px; font-size: 13px;">
                            ‚ùå Ï†ÑÏ≤¥ Ìï¥Ï†ú
                        </button>
                        <span id="selectedCount" style="margin-left: auto; font-size: 14px; color: #6b7280;">
                            ÏÑ†ÌÉù: <strong style="color: #ef4444;">0</strong>Î™Ö
                        </span>
                    </div>
                </div>
                
                <div class="table-scroll-container" style="max-height: 350px;">
                    <table class="common-table" id="bulkDeleteTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ÏÑ†ÌÉù</th>
                                <th style="min-width: 120px;">ÎãâÎÑ§ÏûÑ</th>
                                <th style="min-width: 80px;">Í∏∏Îìú</th>
                                <th style="min-width: 100px;">Ï†ÑÌà¨Î†•</th>
                            </tr>
                        </thead>
                        <tbody id="bulkDeleteTableBody"></tbody>
                    </table>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">Îì±Î°ù Ìï¥Ï†ú ÏÇ¨Ïú† (Í≥µÌÜµ)</label>
                        <select id="bulkDeleteReason" class="form-input">
                            <option value="ÏûêÏßÑ ÌÉàÌá¥">ÏûêÏßÑ ÌÉàÌá¥</option>
                            <option value="Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç">Ïû•Í∏∞ ÎØ∏Ï†ëÏÜç</option>
                            <option value="Í∏∏Îìú Ïù¥Îèô">Í∏∏Îìú Ïù¥Îèô</option>
                            <option value="Í∑úÏ†ï ÏúÑÎ∞ò">Í∑úÏ†ï ÏúÑÎ∞ò</option>
                            <option value="ÏùºÍ¥Ñ Ï†ïÎ¶¨">ÏùºÍ¥Ñ Ï†ïÎ¶¨</option>
                            <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label">ÏÉÅÏÑ∏ Î©îÎ™® (Í≥µÌÜµ, ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="bulkDeleteMemo" class="form-input" rows="2" placeholder="Ï∂îÍ∞Ä Î©îÎ™®..."></textarea>
                    </div>
                    <button id="executeBulkDelete" class="btn btn-danger" style="width: 100%;">
                        üóëÔ∏è ÏÑ†ÌÉùÌïú ÏÇ¨Ïö©Ïûê ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú
                    </button>
                </div>
            `;
            
            setModalBody(html);
            
                       function renderTable() {
                const tbody = document.getElementById('bulkDeleteTableBody');
                const searchText = document.getElementById('bulkDeleteSearch').value.toLowerCase();
                const guildFilter = document.getElementById('bulkDeleteGuildFilter').value;
                
                const filtered = users.filter(u => {
                    const matchSearch = u.name.toLowerCase().includes(searchText);
                    const matchGuild = !guildFilter || u.guild === guildFilter;
                    return matchSearch && matchGuild;
                });
                
                tbody.innerHTML = '';
                filtered.forEach(u => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="user-checkbox" data-username="${u.name}" 
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td><strong>${u.name}</strong></td>
                        <td>${u.guild}</td>
                        <td style="color: #3b82f6; font-weight: 600;">${u.power.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                updateSelectedCount();
            }
            
                       function updateSelectedCount() {
                const checkboxes = document.querySelectorAll('.user-checkbox:checked');
                const count = checkboxes.length;
                document.getElementById('selectedCount').innerHTML = 
                    `ÏÑ†ÌÉù: <strong style="color: #ef4444;">${count}</strong>Î™Ö`;
            }
            
            renderTable();
            
                       document.getElementById('bulkDeleteSearch').addEventListener('input', renderTable);
            document.getElementById('bulkDeleteGuildFilter').addEventListener('change', renderTable);
            
                       document.getElementById('bulkDeleteTableBody').addEventListener('change', updateSelectedCount);
            
                       document.getElementById('selectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = true);
                updateSelectedCount();
            });
            
                       document.getElementById('deselectAllBtn').addEventListener('click', () => {
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            });
            
                       document.getElementById('executeBulkDelete').addEventListener('click', async (e) => {
                               const btn = e.target;
                if (btn.disabled) return;
                
                try {
                    const selected = Array.from(document.querySelectorAll('.user-checkbox:checked'))
                        .map(cb => cb.dataset.username);
                    
                    if (selected.length === 0) {
                        showAlert('ÏÇ≠Ï†úÌï† ÏÇ¨Ïö©ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                        return;
                    }
                    
                    const reason = document.getElementById('bulkDeleteReason').value;
                    const memo = document.getElementById('bulkDeleteMemo').value.trim();
                    
                                       const confirmed = await showConfirm(
                        'ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú ÌôïÏù∏',
                        `<span style="color:#ef4444; font-weight:600;">${selected.length}Î™ÖÏùò ÏÇ¨Ïö©ÏûêÎ•º Îì±Î°ù Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</span><br><br>
                        ‚Ä¢ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Îäî ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§<br>
                        ‚Ä¢ ÏÇ≠Ï†úÎêú ÏÇ¨Ïö©Ïûê Î™©Î°ùÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•<br>
                        ‚Ä¢ Î≥µÍµ¨Îäî Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§<br><br>
                        <strong>ÏÑ†ÌÉùÎêú ÏÇ¨Ïö©Ïûê:</strong><br>
                        ${selected.slice(0, 10).join(', ')}${selected.length > 10 ? '...' : ''}`,
                        true                     );
                    
                    if (!confirmed) return;
                    
                                       document.getElementById('modalTitle').textContent = 'ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú ÏßÑÌñâ Ï§ë';
                    document.getElementById('modalSubtitle').textContent = 'Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...';
                    
                                       document.getElementById('modalBody').innerHTML = `
                        <div style="padding: 20px 16px;">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <strong style="font-size: 16px; color: #111827;">Ï≤òÎ¶¨ Ï§ë...</strong>
                                <p style="margin-top: 6px; color: #6b7280; font-size: 13px;">
                                    Ï∞ΩÏùÑ Îã´ÏßÄ ÎßàÏãúÍ≥† Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="background: #e5e7eb; height: 28px; border-radius: 14px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);">
                                        <span id="progressPercent" style="color: white; font-weight: 700; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">0%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ÏßÑÌñâ</div>
                                        <div id="progressText" style="font-size: 16px; font-weight: 700; color: #111827;">0 / ${selected.length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">ÏÑ±Í≥µ</div>
                                        <div id="successCount" style="font-size: 16px; font-weight: 700; color: #10b981;">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">Ïã§Ìå®</div>
                                        <div id="failCount" style="font-size: 16px; font-weight: 700; color: #ef4444;">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="currentUser" style="margin-top: 12px; text-align: center; font-size: 12px; color: #6b7280; min-height: 18px;">
                                Ï§ÄÎπÑ Ï§ë...
                            </div>
                        </div>
                    `;
                
                
                btn.disabled = true;
                
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < selected.length; i++) {
                    const name = selected[i];
                    
                                       document.getElementById('currentUser').textContent = `Ï≤òÎ¶¨ Ï§ë: ${name}`;
                    
                    try {
                                               const userDoc = await getDoc(doc(db, "users", name));
                        if (!userDoc.exists()) {
                            failCount++;
                            document.getElementById('failCount').textContent = failCount;
                            continue;
                        }
                        
                        const userData = userDoc.data();
                        
                                               await setDoc(doc(collection(db, "deletedUsers")), {
                            ...userData,
                            deletedAt: Date.now(),
                            deletedBy: 'admin',
                            deleteReason: reason,
                            deleteMemo: memo || '',
                            originalName: name,
                            deletedIp: await getIp(),
                            deletedDevice: navigator.userAgent
                        });
                        
                                               await deleteDoc(doc(db, "users", name));
                        
                                               await setDoc(doc(collection(db, "logs")), {
                            who: name,
                            type: 'user_deleted',
                            old_value: 'ÏÇ¨Ïö©Ïûê Ï°¥Ïû¨',
                            new_value: `ÏùºÍ¥Ñ Îì±Î°ù Ìï¥Ï†ú (ÏÇ¨Ïú†: ${reason})`,
                            editedBy: loggedInAdminId || 'ÏïÑÏù¥ÎîîÎØ∏Í∏∞Î°ù',
                            createdAt: Date.now(),
                            ip: await getIp(),
                            device: navigator.userAgent
                        });
                        
                        successCount++;
                        document.getElementById('successCount').textContent = successCount;
                    } catch (e) {
                        console.error(`Failed to delete ${name}:`, e);
                        failCount++;
                        document.getElementById('failCount').textContent = failCount;
                    }
                    
                                       const current = i + 1;
                    const percent = Math.round((current / selected.length) * 100);
                    document.getElementById('progressText').textContent = `${current} / ${selected.length}`;
                    document.getElementById('progressBar').style.width = `${percent}%`;
                    document.getElementById('progressPercent').textContent = `${percent}%`;
                    
                   
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                               document.getElementById('modalTitle').textContent = 'Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å';
                document.getElementById('modalSubtitle').textContent = '';
                document.getElementById('currentUser').innerHTML = `
                    <div style="text-align: center; padding: 16px;">
                        <div style="font-size: 40px; margin-bottom: 12px;">${failCount === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                        <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 8px;">
                            Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                            ÏÑ±Í≥µ: <strong style="color: #10b981;">${successCount}Î™Ö</strong> / 
                            Ïã§Ìå®: <strong style="color: #ef4444;">${failCount}Î™Ö</strong>
                        </div>
                        <div style="margin-top: 12px; font-size: 12px; color: #9ca3af;">
                            Ïû†Ïãú ÌõÑ ÌéòÏù¥ÏßÄÍ∞Ä ÏÉàÎ°úÍ≥†Ïπ®Îê©ÎãàÎã§...
                        </div>
                    </div>
                `;
                
                               setTimeout(() => {
                    closeModal();
                    showAlert(
                        `Îì±Î°ù Ìï¥Ï†ú ÏôÑÎ£å: ÏÑ±Í≥µ ${successCount}Î™Ö, Ïã§Ìå® ${failCount}Î™Ö`,
                        failCount === 0 ? 'success' : 'error'
                    );
                    setTimeout(() => location.reload(), 1000);
                }, 2000);
                } catch (error) {
                    console.error('ÏùºÍ¥Ñ ÏÇ≠Ï†ú ÏóêÎü¨:', error);
                    closeModal();
                    btn.disabled = false;
                    showAlert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                }
            });
        });

               async function authenticateAndRun(name, callback) {
            if (isSystemLocked() && !isAdmin) { 
                const lockMsg = `Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏàòÏ†ï Ïû†Í∏àÏùÑ ÌïòÏó¨ ÏàòÏ†ïÏù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.\n\nÍ∏∞Í∞Ñ: ${formatKSTDateTime(lockStartTime)} ~ ${formatKSTDateTime(lockEndTime)} (KST)`;
                showAlert(lockMsg, 'error'); 
                return; 
            }
            const u = (await getDoc(doc(db, "users", name))).data();
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalFooter').style.display = 'flex';
            if (!u.password) openPasswordSetupModal(name, u, callback); 
            else openPasswordVerifyModal(name, u, callback);
        }
        
        function handlePowerClick(name) { 
           
            if (isAdmin) {
                getDoc(doc(db, "users", name)).then(snap => {
                    if (snap.exists()) {
                        openPowerEditModal(name, snap.data());
                    }
                });
            } else {
                authenticateAndRun(name, (u) => openPowerEditModal(name, u));
            }
        }

        window.editUserFromInfo = async function(name) {
            const docRef = doc(db, "users", name);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();
            
            closeModal();            setTimeout(() => {
               
                if (isAdmin) {
                    openUserEditModal(u);
                } else {
                    authenticateAndRun(name, (userData) => openUserEditModal(userData));
                }
            }, 300);
        };
        
        function openPasswordSetupModal(name, u, cb) {
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï', '4ÏûêÎ¶¨ Ïà´Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî', `<div class="form-group"><input type="password" class="form-input" id="passwordInput" maxlength="4" placeholder="4ÏûêÎ¶¨ Ïà´Ïûê" inputmode="numeric"></div>`);
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            document.getElementById('modalSubmit').onclick = async () => { 
                const pw = document.getElementById('passwordInput').value; 
                if(!/^\d{4}$/.test(pw)) { 
                    showAlert('4ÏûêÎ¶¨ Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error'); 
                    return; 
                }
                await updateDoc(doc(db, "users", name), { password: pw }); 
                closeModal(); 
                setTimeout(() => cb(u), 500); 
            };
        }

        function openPasswordVerifyModal(name, u, cb) {
            let failCount = 0;
            const maxAttempts = 5;
            
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏', 'Î≥∏Ïù∏ ÌôïÏù∏ÏùÑ ÏúÑÌï¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', `
                <div class="form-group">
                    <input type="password" class="form-input" id="passwordInput" maxlength="4" inputmode="numeric">
                    <p id="attemptInfo" style="font-size: 12px; color: #6b7280; margin-top: 8px; text-align: center;">ÎÇ®ÏùÄ ÏãúÎèÑ ÌöüÏàò: ${maxAttempts}Ìöå</p>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
                        <input type="checkbox" id="rememberPassword" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÄÏû• (ÏûêÎèô Î°úÍ∑∏Ïù∏)</span>
                    </label>
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 4px; margin-left: 26px;">‚Äª Î∏åÎùºÏö∞Ï†Ä Î≥ÄÍ≤Ω Ïãú ÏûêÎèô Î°úÍ∑∏Ïù∏Ïù¥ Ìï¥Ï†úÎê©ÎãàÎã§</p>
                </div>
            `);
            
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            
            document.getElementById('modalSubmit').onclick = () => { 
                if (document.getElementById('passwordInput').value === u.password || isAdmin) {
                    const rememberChecked = document.getElementById('rememberPassword').checked;
                    
                                       loggedInUser = name;
                    
                   
                    if (rememberChecked && !isAdmin) {
                        localStorage.setItem('autoLogin', JSON.stringify({
                            username: name,
                            password: u.password,
                            timestamp: Date.now()
                        }));
                    }
                    
                    closeModal(); 
                    setTimeout(() => {
                        loadData();
                        cb(u);
                    }, 200); 
                } else {
                    failCount++;
                    const remaining = maxAttempts - failCount;
                    
                    if (failCount >= maxAttempts) {
                        closeModal();
                        setTimeout(() => {
                            openSmallModal(
                                'ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• Ï†úÌïú', 
                                '5Ìöå Ïù¥ÏÉÅ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌãÄÎ†∏ÏäµÎãàÎã§', 
                                `
                                <div style="text-align: center; padding: 20px;">
                                    <p style="font-size: 16px; color: #374151; margin-bottom: 20px;">
                                        ÎπÑÎ∞ÄÎ≤àÌò∏Î•º 5Ìöå Ïù¥ÏÉÅ ÌãÄÎ†∏ÏäµÎãàÎã§.<br>
                                        Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.
                                    </p>
                                    <a href="https://open.kakao.com/o/s3LUVM4h" target="_blank" 
                                       style="display: inline-block; padding: 12px 24px; background: #FEE500; color: #000000; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;">
                                        üì± Ïπ¥Ïπ¥Ïò§ÌÜ° Ïò§ÌîàÏ±ÑÌåÖ Î∞îÎ°úÍ∞ÄÍ∏∞
                                    </a>
                                </div>
                                `
                            );
                            document.getElementById('modalFooter').style.display = 'none';
                        }, 300);
                        return;
                    }
                    
                    document.getElementById('attemptInfo').textContent = `ÎÇ®ÏùÄ ÏãúÎèÑ ÌöüÏàò: ${remaining}Ìöå`;
                    document.getElementById('attemptInfo').style.color = remaining <= 2 ? '#ef4444' : '#6b7280';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                    showAlert(`ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§ (${remaining}Ìöå ÎÇ®Ïùå)`, 'error'); 
                }
            };
        }

               // Î™®Îã¨ Ïä§ÌÉù (Ï§ëÏ≤© Î™®Îã¨ ÏßÄÏõê)
        let modalStack = [];
        
        function openLargeModal(t, s) {
            // ÌòÑÏû¨ Î™®Îã¨ ÏÉÅÌÉú Ï†ÄÏû•
            const currentContent = document.getElementById('modalBody').innerHTML;
            const currentTitle = document.getElementById('modalTitle').textContent;
            const currentSubtitle = document.getElementById('modalSubtitle').textContent;
            const currentFooter = document.getElementById('modalFooter').innerHTML;
            const currentFooterDisplay = document.getElementById('modalFooter').style.display;
            const isLarge = document.getElementById('modalContent').classList.contains('modal-lg');
            const isActive = document.getElementById('modalOverlay').classList.contains('active');
            
            if (isActive) {
                modalStack.push({ title: currentTitle, subtitle: currentSubtitle, body: currentContent, footer: currentFooter, footerDisplay: currentFooterDisplay, isLarge });
            }
            
            document.getElementById('modalContent').classList.add('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalFooter').style.display = 'none'; 
            document.getElementById('modalBody').innerHTML = 'Î°úÎî©Ï§ë...'; 
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openSmallModal(t, s, b) {
            // ÌòÑÏû¨ Î™®Îã¨ ÏÉÅÌÉú Ï†ÄÏû•
            const currentContent = document.getElementById('modalBody').innerHTML;
            const currentTitle = document.getElementById('modalTitle').textContent;
            const currentSubtitle = document.getElementById('modalSubtitle').textContent;
            const currentFooter = document.getElementById('modalFooter').innerHTML;
            const currentFooterDisplay = document.getElementById('modalFooter').style.display;
            const isLarge = document.getElementById('modalContent').classList.contains('modal-lg');
            const isActive = document.getElementById('modalOverlay').classList.contains('active');
            
            if (isActive) {
                modalStack.push({ title: currentTitle, subtitle: currentSubtitle, body: currentContent, footer: currentFooter, footerDisplay: currentFooterDisplay, isLarge });
            }
            
            document.getElementById('modalContent').classList.remove('modal-lg'); 
            document.getElementById('modalTitle').textContent = t; 
            document.getElementById('modalSubtitle').textContent = s;
            document.getElementById('modalBody').innerHTML = b; 
                       document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" id="modalSubmit">ÌôïÏù∏</button>
            `;
            document.getElementById('modalFooter').style.display = 'flex'; 
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function setModalBody(h) { 
            document.getElementById('modalBody').innerHTML = h + `<div style="text-align:right;margin-top:10px"><button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button></div>`; 
        }

        window.closeModal = () => {
            if (modalStack.length > 0) {
                // Ïù¥Ï†Ñ Î™®Îã¨Î°ú Î≥µÏõê
                const prev = modalStack.pop();
                document.getElementById('modalTitle').textContent = prev.title;
                document.getElementById('modalSubtitle').textContent = prev.subtitle;
                document.getElementById('modalBody').innerHTML = prev.body;
                document.getElementById('modalFooter').innerHTML = prev.footer;
                document.getElementById('modalFooter').style.display = prev.footerDisplay;
                if (prev.isLarge) {
                    document.getElementById('modalContent').classList.add('modal-lg');
                } else {
                    document.getElementById('modalContent').classList.remove('modal-lg');
                }
            } else {
                // Î™®Îã¨ Îã´Í∏∞
                document.getElementById('modalOverlay').classList.remove('active');
                document.body.style.overflow = '';
            }
        };
        
        // Î™®Îã¨ ÏôÑÏ†ÑÌûà Îã´Í∏∞ (Ïä§ÌÉù Î¨¥Ïãú)
        window.closeAllModals = () => {
            modalStack = [];
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        };
        
       
               window.showConfirm = (title, message, keepOpen = false) => {
            return new Promise((resolve) => {
                openSmallModal(title, '', `<p style="text-align:center; padding:20px 0; font-size:15px; line-height:1.6; color:#374151;">${message}</p>`);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="window.confirmResolve(false)">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="window.confirmResolve(true)">ÌôïÏù∏</button>
                `;
                window.confirmResolve = (result) => {
                    if (!keepOpen || !result) {
                        closeModal();
                    }
                    resolve(result);
                    delete window.confirmResolve;
                };
            });
        };

        // Ïª§Ïä§ÌÖÄ ÌîÑÎ°¨ÌîÑÌä∏ (ÏûÖÎ†•Ï∞Ω)
        window.showPrompt = (title, message, defaultValue = '') => {
            return new Promise((resolve) => {
                openSmallModal(title, '', `
                    <p style="text-align:center; padding:10px 0 20px; font-size:14px; color:#374151;">${message}</p>
                    <input type="text" id="promptInput" class="form-input" value="${defaultValue}" style="text-align:center; font-size:15px;" autofocus>
                `);
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-cancel" onclick="window.promptResolve(null)">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="window.promptResolve(document.getElementById('promptInput').value)">ÌôïÏù∏</button>
                `;
                
                // Ìè¨Ïª§Ïä§ Î∞è ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    if (input) {
                        input.focus();
                        input.select();
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                window.promptResolve(input.value);
                            }
                        });
                    }
                }, 100);
                
                window.promptResolve = (result) => {
                    closeModal();
                    resolve(result);
                    delete window.promptResolve;
                };
            });
        };

        // ÏßÑÌñâÎ•† ÌëúÏãú Î™®Îã¨
        window.showProgress = (title, message = '') => {
            // Í∏∞Ï°¥ ÏßÑÌñâÎ•† Î™®Îã¨ Ï†úÍ±∞
            const existing = document.getElementById('progressModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'progressModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center;
                justify-content: center; z-index: 10000;
            `;
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 8px; color: #374151; font-size: 18px;">${title}</h3>
                    <p id="progressMessage" style="margin: 0 0 20px; color: #6b7280; font-size: 14px;">${message}</p>
                    <div style="background: #e5e7eb; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 12px;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <p id="progressPercent" style="margin: 0; color: #374151; font-weight: 600; font-size: 16px;">0%</p>
                </div>
            `;
            document.body.appendChild(modal);
            
            return {
                update: (percent, msg = null) => {
                    const bar = document.getElementById('progressBar');
                    const pct = document.getElementById('progressPercent');
                    const msgEl = document.getElementById('progressMessage');
                    if (bar) bar.style.width = percent + '%';
                    if (pct) pct.textContent = Math.round(percent) + '%';
                    if (msg && msgEl) msgEl.textContent = msg;
                },
                close: () => {
                    const m = document.getElementById('progressModal');
                    if (m) m.remove();
                }
            };
        };

               function performSearch() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!searchText) {
                showAlert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }
            
                       let foundUser = null;
            for (let i = 0; i < allGuildData.length; i++) {
                if (allGuildData[i].name.toLowerCase().includes(searchText)) {
                    foundUser = allGuildData[i];
                    break;
                }
            }
            
            if (foundUser) {
                               showGuildDetail(foundUser.guild);
                
                               setTimeout(() => {
                    const rows = document.querySelectorAll('#detailList tr');
                    rows.forEach(r => {
                        const playerName = r.querySelector('.player-name');
                        if (playerName && playerName.textContent.toLowerCase().includes(searchText)) {
                            r.style.background = '#fef3c7';
                            r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                                                       setTimeout(() => {
                                r.style.background = '';
                            }, 3000);
                        }
                    });
                }, 200);
            } else {
                showAlert('Ìï¥Îãπ ÎãâÎÑ§ÏûÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
            }
        }

        document.getElementById('searchInput').addEventListener('input', (e) => { 
            const searchText = e.target.value.toLowerCase().trim();
            
                       if (currentGuild) {
                document.querySelectorAll('#detailList tr').forEach(r => {
                    const playerName = r.querySelector('.player-name');
                    if (playerName) {
                        r.style.display = playerName.textContent.toLowerCase().includes(searchText) ? '' : 'none';
                    }
                });
            }
        });
        
               document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
               document.getElementById('searchBtn').addEventListener('click', () => {
            performSearch();
        });

        function showAlert(m, t='success') { 
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) existingAlert.remove();
            
            const a = document.createElement('div'); 
            a.className = `alert alert-${t}`; 
            a.innerHTML = `<button class="alert-close" onclick="this.parentElement.remove()">√ó</button><div class="alert-title">${t==='success'?'ÏÑ±Í≥µ':'ÏïåÎ¶º'}</div><p class="alert-message" style="white-space: pre-line;">${m}</p>`; 
            document.body.appendChild(a); 
            setTimeout(() => { if(a.parentElement) a.remove(); }, 5000); 
        }

        async function initializeDatabase() { 
            const uList = [
                { guild: 'ÏÇ¨Ïã†', name: 'Í∞ìÎ™ÖÌíà', power: 1347941 }, 
                { guild: 'ÏÇ¨Ïã†', name: 'ÏπºÎ¶¨', power: 1292531 }
            ]; 
            for (const u of uList) await setDoc(doc(db, "users", u.name), { 
                ...u, 
                password: null, 
                shape_legend: 0, 
                shape_myth: 0, 
                mount_legend: 0, 
                mount_myth: 0 
            }); 
            showAlert("Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å", "success"); 
            setTimeout(() => location.reload(), 1500); 
        }

               document.getElementById('backupManageBtn').addEventListener('click', async () => {
            if (!isAdmin) return;
            
            openLargeModal('üì¶ Ï£ºÍ∞Ñ Î∞±ÏóÖ Í¥ÄÎ¶¨', 'Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ Î∞±ÏóÖÌïòÍ≥† Í≥ºÍ±∞ Í∏∞Î°ùÏùÑ Ï°∞ÌöåÌï©ÎãàÎã§');
            
            let lastBackupTime = null;
            let backupsList = [];
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(50)));
                backupsSnap.forEach(doc => {
                    const data = doc.data();
                    backupsList.push({ id: doc.id, ...data });
                });
                if (backupsList.length > 0) {
                    lastBackupTime = backupsList[0].createdAt;
                }
            } catch(e) { console.error(e); }
            
            const lastBackupStr = lastBackupTime ? formatDateTime(lastBackupTime) : 'ÏóÜÏùå';
            
            // ÎπÑÍµê Î∞±ÏóÖ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
            let compareOptions = '<option value="">ÏµúÍ∑º Î∞±ÏóÖÍ≥º ÎπÑÍµê (Í∏∞Î≥∏)</option>';
            backupsList.forEach(b => {
                const name = b.backupName || formatDateTime(b.createdAt);
                compareOptions += `<option value="${b.id}">${name}</option>`;
            });
            
            const html = `
                <div style="margin-bottom:24px;">
                    <div style="background:#f0f9ff; border:1px solid #0891b2; border-radius:12px; padding:16px; margin-bottom:20px;">
                        <p style="color:#0891b2; font-weight:600; margin-bottom:8px;">üìå Î∞±ÏóÖ ÏïàÎÇ¥</p>
                        <ul style="color:#0e7490; font-size:13px; margin:0; padding-left:20px;">
                            <li>Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Îäî FirebaseÏóê ÏòÅÍµ¨ Ï†ÄÏû•Îê©ÎãàÎã§</li>
                            <li>Î™á Îã¨, Î™á ÎÖÑ Îí§ÏóêÎèÑ Ï°∞Ìöå Í∞ÄÎä•Ìï©ÎãàÎã§</li>
                            <li>Îß§Ï£º ÌÜ†ÏöîÏùº Ïò§ÌõÑ 9Ïãú(KST)Ïóê ÏûêÎèô Î∞±ÏóÖÎê©ÎãàÎã§</li>
                            <li>Î∞±ÏóÖ ÎÇ¥Ïö©: ÎãâÎÑ§ÏûÑ, Í∏∏Îìú, Ï†ÑÌà¨Î†•, Ï£ºÍ∞Ñ Ï¶ùÍ∞ÄÎüâ</li>
                        </ul>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;">
                        <div style="background:#fef3c7; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#92400e; font-size:13px; margin:0;">ÎßàÏßÄÎßâ Î∞±ÏóÖ</p>
                            <p style="color:#b45309; font-size:16px; font-weight:600; margin:8px 0 0;">${lastBackupStr}</p>
                        </div>
                        <div style="background:#d1fae5; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#065f46; font-size:13px; margin:0;">ÌòÑÏû¨ Ïú†Ï†Ä Ïàò</p>
                            <p style="color:#047857; font-size:16px; font-weight:600; margin:8px 0 0;">${allGuildData.length}Î™Ö</p>
                        </div>
                        <div style="background:#e0e7ff; padding:20px; border-radius:12px; text-align:center;">
                            <p style="color:#3730a3; font-size:13px; margin:0;">Ï¥ù Ï†ÑÌà¨Î†•</p>
                            <p style="color:#4338ca; font-size:16px; font-weight:600; margin:8px 0 0;">${allGuildData.reduce((sum, u) => sum + u.power, 0).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div style="background:#f9fafb; border-radius:12px; padding:16px; margin-bottom:20px;">
                        <div class="form-group" style="margin-bottom:12px;">
                            <label class="form-label" style="font-size:13px;">üìù Î∞±ÏóÖ Ïù¥Î¶Ñ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                            <input type="text" id="backupNameInput" class="form-input" placeholder="Ïòà: 1Ïõî 2Ï£ºÏ∞®, Í∏∏ÎìúÏ†Ñ Ï†ÑÎÇ† Îì±" maxlength="50">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label" style="font-size:13px;">üìä ÎπÑÍµê Í∏∞Ï§Ä Î∞±ÏóÖ</label>
                            <select id="compareBackupSelect" class="form-input">${compareOptions}</select>
                            <p style="font-size:11px; color:#6b7280; margin-top:4px;">Ï†ÑÌà¨Î†• Ï¶ùÍ∞êÏùÑ Ïñ¥Îäê Î∞±ÏóÖÍ≥º ÎπÑÍµêÌï†ÏßÄ ÏÑ†ÌÉùÌï©ÎãàÎã§</p>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="runManualBackup()" style="background:#0891b2;">üì¶ ÏßÄÍ∏à Î∞±ÏóÖÌïòÍ∏∞</button>
                        <button class="btn" onclick="viewBackupHistory()" style="background:#6366f1; color:white;">üìã Î∞±ÏóÖ Í∏∞Î°ù Î≥¥Í∏∞</button>
                    </div>
                </div>
            `;
            
            setModalBody(html);
            document.getElementById('modalFooter').innerHTML = '<button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>';
        });
        
        window.runManualBackup = async function() {
            const backupName = document.getElementById('backupNameInput')?.value.trim() || '';
            const compareBackupId = document.getElementById('compareBackupSelect')?.value || '';
            
            const confirmMsg = backupName 
                ? `"${backupName}" Ïù¥Î¶ÑÏúºÎ°ú Î∞±ÏóÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?` 
                : 'ÌòÑÏû¨ Ï†ÑÌà¨Î†• ÌòÑÌô©ÏùÑ Î∞±ÏóÖÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            
            if (!await showConfirm('Î∞±ÏóÖ ÌôïÏù∏', confirmMsg)) return;
            
            showAlert('Î∞±ÏóÖ Ï§ë...', 'success');
            
            const now = Date.now();
            
            let lastBackupData = {};
            try {
                // ÎπÑÍµêÌï† Î∞±ÏóÖ ÏÑ†ÌÉù
                if (compareBackupId) {
                    const compareDoc = await getDoc(doc(db, "backups", compareBackupId));
                    if (compareDoc.exists()) {
                        const compareBackup = compareDoc.data();
                        if (compareBackup.users) {
                            compareBackup.users.forEach(u => {
                                lastBackupData[u.name] = u.power;
                            });
                        }
                    }
                } else {
                    // Í∏∞Î≥∏: ÏµúÍ∑º Î∞±ÏóÖÍ≥º ÎπÑÍµê
                    const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                    if (!backupsSnap.empty) {
                        const lastBackup = backupsSnap.docs[0].data();
                        if (lastBackup.users) {
                            lastBackup.users.forEach(u => {
                                lastBackupData[u.name] = u.power;
                            });
                        }
                    }
                }
            } catch(e) { console.error(e); }
            
            const backupUsers = allGuildData.map(u => ({
                name: u.name,
                guild: u.guild,
                power: u.power,
                prevPower: lastBackupData[u.name] || u.power,
                diff: u.power - (lastBackupData[u.name] || u.power),
                shape_legend: u.shape_legend || 0,
                shape_myth: u.shape_myth || 0,
                mount_legend: u.mount_legend || 0,
                mount_myth: u.mount_myth || 0
            })).sort((a, b) => b.power - a.power);
            
            const guildStats = {};
            backupUsers.forEach(u => {
                if (!guildStats[u.guild]) {
                    guildStats[u.guild] = { count: 0, totalPower: 0, totalDiff: 0, activeCount: 0 };
                }
                guildStats[u.guild].count++;
                if (u.power > 0) {
                    guildStats[u.guild].activeCount++;
                    guildStats[u.guild].totalPower += u.power;
                }
                guildStats[u.guild].totalDiff += u.diff;
            });
            
            const backupId = `backup_${now}`;
            try {
                await setDoc(doc(db, "backups", backupId), {
                    users: backupUsers,
                    guildStats: guildStats,
                    totalUsers: backupUsers.length,
                    totalPower: backupUsers.reduce((sum, u) => sum + u.power, 0),
                    totalDiff: backupUsers.reduce((sum, u) => sum + u.diff, 0),
                    createdAt: now,
                    createdBy: loggedInAdminId || 'admin',
                    type: 'manual',
                    backupName: backupName || null,
                    compareBackupId: compareBackupId || null
                });
                
                showAlert('Î∞±ÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                setTimeout(() => document.getElementById('backupManageBtn').click(), 1000);
            } catch(e) {
                console.error(e);
                showAlert('Î∞±ÏóÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        window.viewBackupHistory = async function() {
            openLargeModal('üìã Î∞±ÏóÖ Í∏∞Î°ù', 'Í≥ºÍ±∞ Î∞±ÏóÖ ÎÇ¥Ïó≠ÏùÑ Ï°∞ÌöåÌïòÍ≥† ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏Ìï©ÎãàÎã§');
            setModalBody('<p style="text-align:center; padding:40px;">Î°úÎî© Ï§ë...</p>');
            
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(50)));
                
                if (backupsSnap.empty) {
                    setModalBody('<p style="text-align:center; color:#9ca3af; padding:40px;">Î∞±ÏóÖ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</p>');
                    document.getElementById('modalFooter').innerHTML = `
                        <button class="btn" onclick="document.getElementById('backupManageBtn').click()" style="background:#0891b2; color:white;">‚Üê Î∞±ÏóÖ Í¥ÄÎ¶¨</button>
                        <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
                    `;
                    return;
                }
                
                let html = `<div style="overflow-x:auto;"><table class="common-table table-wide"><thead><tr>
                    <th>Î∞±ÏóÖ Ïù¥Î¶Ñ</th>
                    <th>ÏùºÏãú</th>
                    <th>Ïú†Ï†Ä Ïàò</th>
                    <th>Ï¥ù Ï†ÑÌà¨Î†•</th>
                    <th>Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</th>
                    <th>Ïú†Ìòï</th>
                    <th>Í¥ÄÎ¶¨</th>
                </tr></thead><tbody>`;
                
                backupsSnap.forEach(docSnap => {
                    const backup = docSnap.data();
                    const backupId = docSnap.id;
                    const time = formatDateTime(backup.createdAt);
                    const backupName = backup.backupName || '-';
                    const backupNameEscaped = (backup.backupName || '').replace(/'/g, "\\'");
                    const totalPower = backup.totalPower ? backup.totalPower.toLocaleString() : '-';
                    const totalDiff = backup.totalDiff || 0;
                    const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                    const diffSign = totalDiff >= 0 ? '+' : '';
                    const type = backup.type === 'manual' ? '<span style="color:#f59e0b;">ÏàòÎèô</span>' : '<span style="color:#10b981;">ÏûêÎèô</span>';
                    
                    html += `<tr id="backup-row-${backupId}">
                        <td style="font-weight:600; color:#374151;">
                            <span id="backup-name-${backupId}">${backupName}</span>
                            <button onclick="editBackupName('${backupId}', '${backupNameEscaped}')" style="background:none; border:none; cursor:pointer; padding:2px 4px; font-size:12px;" title="Ïù¥Î¶Ñ Î≥ÄÍ≤Ω">‚úèÔ∏è</button>
                        </td>
                        <td style="font-size:12px;">${time}</td>
                        <td>${backup.totalUsers || 0}Î™Ö</td>
                        <td style="font-weight:600;">${totalPower}</td>
                        <td style="color:${diffColor}; font-weight:600;">${diffSign}${totalDiff.toLocaleString()}</td>
                        <td>${type}</td>
                        <td style="white-space:nowrap;">
                            <button class="btn" onclick="viewBackupDetail('${backupId}')" style="padding:4px 8px; font-size:12px; background:#6366f1; color:white;">ÏÉÅÏÑ∏</button>
                            <button class="btn" onclick="downloadBackupExcel('${backupId}')" style="padding:4px 8px; font-size:12px; background:#10b981; color:white;">ÏóëÏÖÄ</button>
                            <button class="btn" onclick="deleteBackup('${backupId}')" style="padding:4px 8px; font-size:12px; background:#ef4444; color:white;">ÏÇ≠Ï†ú</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                setModalBody(html);
            } catch(e) {
                console.error(e);
                setModalBody('<p style="text-align:center; color:#ef4444; padding:40px;">Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn" onclick="document.getElementById('backupManageBtn').click()" style="background:#0891b2; color:white;">‚Üê Î∞±ÏóÖ Í¥ÄÎ¶¨</button>
                <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };
        
        // Î∞±ÏóÖ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
        window.editBackupName = async function(backupId, currentName) {
            const newName = await showPrompt('Î∞±ÏóÖ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω', 'ÏÉà Î∞±ÏóÖ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', currentName || '');
            if (newName === null) return; // Ï∑®ÏÜå
            
            try {
                await updateDoc(doc(db, "backups", backupId), {
                    backupName: newName.trim() || null
                });
                
                // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                const nameSpan = document.getElementById(`backup-name-${backupId}`);
                if (nameSpan) {
                    nameSpan.textContent = newName.trim() || '-';
                }
                
                showAlert('Î∞±ÏóÖ Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch(e) {
                console.error(e);
                showAlert('Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        // Î∞±ÏóÖ ÏÇ≠Ï†ú
        window.deleteBackup = async function(backupId) {
            if (!await showConfirm('Î∞±ÏóÖ ÏÇ≠Ï†ú', 'Ïù¥ Î∞±ÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\\nÏÇ≠Ï†úÎêú Î∞±ÏóÖÏùÄ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.')) return;
            
            try {
                await deleteDoc(doc(db, "backups", backupId));
                
                // UIÏóêÏÑú Ìñâ Ï†úÍ±∞
                const row = document.getElementById(`backup-row-${backupId}`);
                if (row) {
                    row.remove();
                }
                
                showAlert('Î∞±ÏóÖÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
            } catch(e) {
                console.error(e);
                showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        window.viewBackupDetail = async function(backupId) {
            openLargeModal('üìä Î∞±ÏóÖ ÏÉÅÏÑ∏', 'Ìï¥Îãπ ÏãúÏ†êÏùò Ï†ÑÌà¨Î†• ÌòÑÌô©');
            setModalBody('<p style="text-align:center; padding:40px;">Î°úÎî© Ï§ë...</p>');
            
            try {
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) {
                    setModalBody('<p style="text-align:center; color:#ef4444;">Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</p>');
                    return;
                }
                
                const backup = backupDoc.data();
                const time = formatDateTime(backup.createdAt);
                const users = backup.users || [];
                const guildStats = backup.guildStats || {};
                
                let guildStatsHtml = '';
                Object.keys(guildStats).sort().forEach(guild => {
                    const stats = guildStats[guild];
                    const activeCount = stats.activeCount || stats.count;
                    const avgPower = activeCount > 0 ? Math.round(stats.totalPower / activeCount).toLocaleString() : '0';
                    const diffSign = stats.totalDiff >= 0 ? '+' : '';
                    const diffColor = stats.totalDiff >= 0 ? '#10b981' : '#ef4444';
                    guildStatsHtml += `<tr>
                        <td style="font-weight:600;">${guild}</td>
                        <td style="text-align:center;">${stats.count}Î™Ö</td>
                        <td style="text-align:right;">${avgPower}</td>
                        <td style="text-align:right; color:${diffColor};">${diffSign}${stats.totalDiff.toLocaleString()}</td>
                    </tr>`;
                });
                
                let usersHtml = '';
                users.forEach((u, idx) => {
                    const diffSign = u.diff >= 0 ? '+' : '';
                    const diffColor = u.diff >= 0 ? '#10b981' : '#ef4444';
                    const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1);
                    usersHtml += `<tr>
                        <td style="text-align:center;">${medal}</td>
                        <td>${u.name}</td>
                        <td style="text-align:center;">${u.guild}</td>
                        <td style="text-align:right; font-weight:600;">${u.power.toLocaleString()}</td>
                        <td style="text-align:right; color:${diffColor};">${diffSign}${u.diff.toLocaleString()}</td>
                    </tr>`;
                });
                
                const totalDiff = backup.totalDiff || 0;
                const diffSign = totalDiff >= 0 ? '+' : '';
                const diffColor = totalDiff >= 0 ? '#10b981' : '#ef4444';
                
                const html = `
                    <div style="margin-bottom:20px;">
                        <p style="color:#6b7280; margin:0;">Î∞±ÏóÖ ÏùºÏãú: <strong>${time}</strong> | Ïú†Ìòï: ${backup.type === 'manual' ? 'ÏàòÎèô' : 'ÏûêÎèô'}</p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:24px;">
                        <div style="background:#fef3c7; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#92400e; font-size:12px; margin:0;">Ï¥ù Ïù∏Ïõê</p>
                            <p style="color:#b45309; font-size:20px; font-weight:700; margin:4px 0 0;">${backup.totalUsers}Î™Ö</p>
                        </div>
                        <div style="background:#d1fae5; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#065f46; font-size:12px; margin:0;">Ï¥ù Ï†ÑÌà¨Î†•</p>
                            <p style="color:#047857; font-size:20px; font-weight:700; margin:4px 0 0;">${backup.totalPower.toLocaleString()}</p>
                        </div>
                        <div style="background:#e0e7ff; padding:16px; border-radius:8px; text-align:center;">
                            <p style="color:#3730a3; font-size:12px; margin:0;">Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</p>
                            <p style="color:${diffColor}; font-size:20px; font-weight:700; margin:4px 0 0;">${diffSign}${totalDiff.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <h4 style="margin:0 0 12px; color:#374151;">üìä Í∏∏ÎìúÎ≥Ñ ÌòÑÌô©</h4>
                    <div style="overflow-x:auto; margin-bottom:24px;">
                        <table class="common-table">
                            <thead><tr><th>Í∏∏Îìú</th><th>Ïù∏Ïõê</th><th>ÌèâÍ∑† Ï†ÑÌà¨Î†•</th><th>Ï£ºÍ∞Ñ Ï¶ùÍ∞ê</th></tr></thead>
                            <tbody>${guildStatsHtml}</tbody>
                        </table>
                    </div>
                    
                    <h4 style="margin:0 0 12px; color:#374151;">üë• Ï†ÑÏ≤¥ Î™ÖÎã® (${users.length}Î™Ö)</h4>
                    <div style="max-height:400px; overflow-y:auto; overflow-x:auto;">
                        <table class="common-table">
                            <thead><tr><th>ÏàúÏúÑ</th><th>ÎãâÎÑ§ÏûÑ</th><th>Í∏∏Îìú</th><th>Ï†ÑÌà¨Î†•</th><th>Ï¶ùÍ∞ê</th></tr></thead>
                            <tbody>${usersHtml}</tbody>
                        </table>
                    </div>
                `;
                
                setModalBody(html);
            } catch(e) {
                console.error(e);
                setModalBody('<p style="text-align:center; color:#ef4444;">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</p>');
            }
            
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn" onclick="downloadBackupExcel('${backupId}')" style="background:#10b981; color:white;">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                <button class="btn" onclick="viewBackupHistory()" style="background:#6366f1; color:white;">‚Üê Î∞±ÏóÖ Í∏∞Î°ù</button>
                <button class="btn btn-cancel" onclick="closeModal()">Îã´Í∏∞</button>
            `;
        };
        
        window.downloadBackupExcel = async function(backupId) {
            try {
                const backupDoc = await getDoc(doc(db, "backups", backupId));
                if (!backupDoc.exists()) {
                    showAlert('Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§', 'error');
                    return;
                }
                
                const backup = backupDoc.data();
                const users = backup.users || [];
                const time = formatDateTime(backup.createdAt).replace(/[:\s]/g, '-');
                
                const ws = XLSX.utils.json_to_sheet(users.map((u, idx) => ({
                    'ÏàúÏúÑ': idx + 1,
                    'ÎãâÎÑ§ÏûÑ': u.name,
                    'Í∏∏Îìú': u.guild,
                    'Ï†ÑÌà¨Î†•': u.power,
                    'Ïù¥Ï†Ñ Ï†ÑÌà¨Î†•': u.prevPower,
                    'Ï£ºÍ∞Ñ Ï¶ùÍ∞ê': u.diff,
                    'ÌòïÏÉÅ Ï†ÑÏÑ§': u.shape_legend || 0,
                    'ÌòïÏÉÅ Ïã†Ìôî': u.shape_myth || 0,
                    'ÌÉàÍ≤É Ï†ÑÏÑ§': u.mount_legend || 0,
                    'ÌÉàÍ≤É Ïã†Ìôî': u.mount_myth || 0
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Î∞±ÏóÖÎç∞Ïù¥ÌÑ∞');
                XLSX.writeFile(wb, `Í∏∏ÎìúÏ†ÑÌà¨Î†•_Î∞±ÏóÖ_${time}.xlsx`);
                
                showAlert('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!', 'success');
            } catch(e) {
                console.error(e);
                showAlert('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };
        
        async function checkAutoBackup() {
            if (!isAdmin) return;
            
            const now = new Date();
            const kstNow = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const dayOfWeek = kstNow.getDay();
            const hour = kstNow.getHours();
            
            if (dayOfWeek === 6 && hour >= 21) {
                const todayStart = new Date(kstNow);
                todayStart.setHours(21, 0, 0, 0);
                const todayStartTimestamp = todayStart.getTime();
                
                try {
                    const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                    
                    let needBackup = true;
                    if (!backupsSnap.empty) {
                        const lastBackup = backupsSnap.docs[0].data();
                        if (lastBackup.createdAt >= todayStartTimestamp) {
                            needBackup = false;
                        }
                    }
                    
                    if (needBackup) {
                        console.log('ÏûêÎèô Î∞±ÏóÖ Ïã§Ìñâ...');
                        await performAutoBackup();
                    }
                } catch(e) {
                    console.error('ÏûêÎèô Î∞±ÏóÖ Ï≤¥ÌÅ¨ Ïò§Î•ò:', e);
                }
            }
        }
        
        async function performAutoBackup() {
            const now = Date.now();
            
            let lastBackupData = {};
            try {
                const backupsSnap = await getDocs(query(collection(db, "backups"), orderBy("createdAt", "desc"), limit(1)));
                if (!backupsSnap.empty) {
                    const lastBackup = backupsSnap.docs[0].data();
                    if (lastBackup.users) {
                        lastBackup.users.forEach(u => {
                            lastBackupData[u.name] = u.power;
                        });
                    }
                }
            } catch(e) { console.error(e); }
            
            const backupUsers = allGuildData.map(u => ({
                name: u.name,
                guild: u.guild,
                power: u.power,
                prevPower: lastBackupData[u.name] || u.power,
                diff: u.power - (lastBackupData[u.name] || u.power),
                shape_legend: u.shape_legend || 0,
                shape_myth: u.shape_myth || 0,
                mount_legend: u.mount_legend || 0,
                mount_myth: u.mount_myth || 0
            })).sort((a, b) => b.power - a.power);
            
            const guildStats = {};
            backupUsers.forEach(u => {
                if (!guildStats[u.guild]) {
                    guildStats[u.guild] = { count: 0, totalPower: 0, totalDiff: 0, activeCount: 0 };
                }
                guildStats[u.guild].count++;
                if (u.power > 0) {
                    guildStats[u.guild].activeCount++;
                    guildStats[u.guild].totalPower += u.power;
                }
                guildStats[u.guild].totalDiff += u.diff;
            });
            
            const backupId = `backup_${now}`;
            try {
                await setDoc(doc(db, "backups", backupId), {
                    users: backupUsers,
                    guildStats: guildStats,
                    totalUsers: backupUsers.length,
                    totalPower: backupUsers.reduce((sum, u) => sum + u.power, 0),
                    totalDiff: backupUsers.reduce((sum, u) => sum + u.diff, 0),
                    createdAt: now,
                    createdBy: 'auto',
                    type: 'auto'
                });
                console.log('ÏûêÎèô Î∞±ÏóÖ ÏôÑÎ£å!');
            } catch(e) {
                console.error('ÏûêÎèô Î∞±ÏóÖ Ïã§Ìå®:', e);
            }
        }
        
        setTimeout(checkAutoBackup, 3000);

               document.getElementById('adminManageBtn').addEventListener('click', async () => {
            if (!isSuperAdmin) {
                showAlert('ÏµúÏ¢Ö Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§', 'error');
                return;
            }

            openLargeModal('Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨', 'ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏùÑ Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò ÏÇ≠Ï†úÌï©ÎãàÎã§');
            
           
            const adminSnapshot = await getDocs(collection(db, "admins"));
            
            let adminListHtml = '';
            if (adminSnapshot.empty) {
                adminListHtml = '<p style="text-align:center; color:#9ca3af; padding:20px;">Îì±Î°ùÎêú ÏùºÎ∞ò Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</p>';
            } else {
                adminListHtml = '<div class="table-scroll-container"><table class="common-table"><thead><tr><th>ÏïÑÏù¥Îîî</th><th>ÏÉùÏÑ±Ïùº</th><th>Í¥ÄÎ¶¨</th></tr></thead><tbody>';
                adminSnapshot.forEach(docSnap => {
                    const admin = docSnap.data();
                    const createdAt = admin.createdAt ? formatDateTime(admin.createdAt) : '-';
                    adminListHtml += `<tr>
                        <td><strong>${docSnap.id}</strong></td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-reset-pw" onclick="window.resetAdminPw('${docSnap.id}')" style="margin-right:4px;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî</button>
                            <button class="btn btn-danger" onclick="window.deleteAdmin('${docSnap.id}')" style="padding:4px 8px; font-size:12px;">ÏÇ≠Ï†ú</button>
                        </td>
                    </tr>`;
                });
                adminListHtml += '</tbody></table></div>';
            }

            const html = `
                <div style="margin-bottom:20px; padding:15px; background:#f0fdf4; border-radius:8px; border-left:4px solid #22c55e;">
                    <p style="font-size:13px; color:#166534;"><strong>üëë ÏµúÏ¢Ö Í¥ÄÎ¶¨Ïûê:</strong> tjdals9328 (Î≥ÄÍ≤Ω Î∂àÍ∞Ä)</p>
                </div>
                
                <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">üìã ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê Î™©Î°ù</h4>
                ${adminListHtml}
                
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                    <h4 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">‚ûï ÏÉà Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <input type="text" id="newAdminId" class="form-input" placeholder="ÏïÑÏù¥Îîî" style="flex:1 1 150px; min-width:120px; max-width:250px;">
                        <input type="password" id="newAdminPw" class="form-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" style="flex:1 1 150px; min-width:120px; max-width:250px;">
                        <button class="btn btn-primary" onclick="window.addNewAdmin()" style="white-space:nowrap;">Ï∂îÍ∞Ä</button>
                    </div>
                    <p style="font-size:11px; color:#9ca3af; margin-top:8px;">‚Äª ÏùºÎ∞ò Í¥ÄÎ¶¨ÏûêÎäî Í¥ÄÎ¶¨Ïûê Í¥ÄÎ¶¨ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§</p>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html + `<div style="text-align:right;margin-top:20px"><button class="btn btn-primary" onclick="closeModal()">Îã´Í∏∞</button></div>`;
        });

               window.addNewAdmin = async function() {
            const adminId = document.getElementById('newAdminId').value.trim();
            const adminPw = document.getElementById('newAdminPw').value;

            if (!adminId || !adminPw) {
                showAlert('ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî', 'error');
                return;
            }

            if (adminPw.length < 4) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                return;
            }

                       const existingAdmin = await getDoc(doc(db, "admins", adminId));
            if (existingAdmin.exists()) {
                showAlert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏïÑÏù¥ÎîîÏûÖÎãàÎã§', 'error');
                return;
            }

            try {
                await setDoc(doc(db, "admins", adminId), {
                    password: adminPw,
                    createdAt: Date.now(),
                    createdBy: 'superadmin'
                });

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_add',
                    old_value: '-',
                    new_value: `Í¥ÄÎ¶¨Ïûê Ï∂îÍ∞Ä: ${adminId}`,
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`Í¥ÄÎ¶¨Ïûê [${adminId}]Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                               setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };


        window.deleteAdmin = async function(adminId) {
            if (!await showConfirm('Í¥ÄÎ¶¨Ïûê ÏÇ≠Ï†ú', `[${adminId}] Í¥ÄÎ¶¨ÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

            try {
                await deleteDoc(doc(db, "admins", adminId));

                await setDoc(doc(collection(db, "logs")), {
                    who: 'SuperAdmin',
                    type: 'admin_delete',
                    old_value: adminId,
                    new_value: 'ÏÇ≠Ï†úÎê®',
                    createdAt: Date.now(),
                    ip: await getIp()
                });

                showAlert(`Í¥ÄÎ¶¨Ïûê [${adminId}]Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`, 'success');
                closeModal();
                setTimeout(() => document.getElementById('adminManageBtn').click(), 300);
            } catch (e) {
                console.error(e);
                showAlert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
            }
        };


        window.resetAdminPw = async function(adminId) {
            openSmallModal('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî', `[${adminId}] Í¥ÄÎ¶¨Ïûê`, `
                <div class="form-group">
                    <label class="form-label">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="resetPwInput" class="form-input" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•">
                </div>
            `);

            document.getElementById('modalSubmit').onclick = async () => {
                const newPw = document.getElementById('resetPwInput').value;
                
                if (!newPw || newPw.length < 4) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§', 'error');
                    return;
                }

                try {
                    await updateDoc(doc(db, "admins", adminId), {
                        password: newPw,
                        updatedAt: Date.now()
                    });

                    await setDoc(doc(collection(db, "logs")), {
                        who: 'SuperAdmin',
                        type: 'admin_pw_reset',
                        old_value: adminId,
                        new_value: 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî',
                        createdAt: Date.now(),
                        ip: await getIp()
                    });

                    showAlert(`[${adminId}] ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§`, 'success');
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showAlert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                }
            };
        };

        init();
    </script>
</body>
</html>
